(function(b,c){function a(){this.next=null;this.prev=null;this.nextDraw=null;this.prevDraw=null;this._relateEntity=null;this._params=null;this._tempParams=LowAPI.Gen_Array([DAI.MAX_PARAM_COUNT],0);this._posX=0;this._posY=0;this._vX=0;this._vY=0;this._boundingBox=LowAPI.Gen_Array([4],0);this._state=0;this._subState=0;this._classID=-1;this._id=0;this._flags=0;this._exFlags=0;this._hp=3;this._zOrder=0;this._zOrderAI=0;this._boundingBox=LowAPI.Gen_Array([4],0);this._dynamicBox=LowAPI.Gen_Array([4],0);this._sprite=null;this._animationPlayer=null;this._stateDuration=0;this._stateFlow=null;this._preFullState=0;this._nextFullState=0;this._stateIndex=0;this._stateElapsedTime=0;this._stateSequence=null;this._curSequenceHeaderIndex=0;this._curSequenceIndex=0;this._frameVX=0;this._frameVY=0;this._pos_ox=0;this._pos_oy=0;this._destX=0;this._destY=0;this._curTrace=-1;this._phyFlags=0;this._phyInfo=0;this._phyEntity=-1;this._phyStandOn=-1;this._lastPhyStandOn=0;this._lastPhyInfo=0;this._lastPhyEntity=0;this._lastLineIndex=0}a.root=null;a.last=null;a.rootDraw=null;a.lastDraw=null;a._TempIntArray=LowAPI.Gen_Array([32],0);a._hero=null;a._bullet=null;a._boss=null;a._bulletIndex=0;a._lastBulletIndex=0;a._arrowShakeNum=0;a._ThiefSoundBubbleLeft=null;a._ThiefSoundBubbleRight=null;a._heroHpBeforeDie=0;a._inMiniGame=false;a._checkDropToGound=false;a.prototype.UpdateAnimation=function(){if((this._exFlags&DFlags.EX_NO_UPDATE_ANIMATION)!=0){return}if(this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){this._pos_ox=Math_IntToFixedPoint(this.GetAFramesOX());this._pos_oy=Math_IntToFixedPoint(this.GetAFramesOY())}if(this._animationPlayer!=null&&!this.CheckFlag(DFlags.ANIM_NO_UPDATE)){var d=this._animationPlayer.GetAnim();var e=this._animationPlayer.GetFrame();if(this.CheckFlag(DFlags.MULTI_BOUNDING_BOX)){this._tempParams[DTempParamIndex.LAST_ANIMATION]=d;this._tempParams[DTempParamIndex.LAST_FRAME]=e}if(this.CheckFlag(DFlags.CENIMATIC)&&this.IsAnimOver()){this._animationPlayer.SetAnim(d,1)}this._animationPlayer.Update(CGame._frameDT);this.UpdateBoundingBox();if(this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){if(this._animationPlayer.GetFrame()<e){this._pos_ox=0;this._pos_oy=0}}}};a.prototype.Update=function(){if(!this.CheckFlag(DFlags.NO_UPDATE_AI)){this.StateMachineUpdateState()}};a.CheckActive=function(){var f;if(a._cameraDefault==null){a._camera=a.GetDefaultCamera()}for(var d=0;d<CGame._entityRowDataCount;d++){var e=CGame._entitiesRowData[d];if(e==null){continue}f=false;if((e[DParamIndex.FLAGS]&(DFlags.ACTIVED|DFlags.DESTROYED|DFlags.ACTIVE_BY_TRIGGER))==0&&a.NeedActive(e,Math_IntToFixedPoint(e[DParamIndex.POSX]),Math_IntToFixedPoint(e[DParamIndex.POSY]))){f=true}if((e[DParamIndex.FLAGS]&DFlags.DESTROYED)!=0&&e[DParamIndex.CLASS_ID]!=DClassID.RANDOMBONUS&&e[DParamIndex.CLASS_ID]!=DClassID.BONUS&&e[DParamIndex.CLASS_ID]!=DClassID.HIT_BONUS&&e[DParamIndex.CLASS_ID]!=DClassID.CAMERA&&e[DParamIndex.CLASS_ID]!=DClassID.TRIGGER&&e[DParamIndex.CLASS_ID]!=DClassID.MOBS_MONSTERINCHEST&&e[DParamIndex.CLASS_ID]!=DClassID.CHECK_POINT&&!a.NeedActive(e,Math_IntToFixedPoint(e[DParamIndex.POSX]),Math_IntToFixedPoint(e[DParamIndex.POSY]))){e[DParamIndex.FLAGS]&=~DFlags.DESTROYED}if(f){if(e[DParamIndex.CLASS_ID]==DClassID.BONUS&&e[DParamIndex.ANIMID]==DAnimID.BONUS_STAR){if(a.IsStarGot(e[DParamIndex.POSX],e[DParamIndex.POSY],false,false)){e[DParamIndex.ANIMID]=DAnimID.BONUS_CRYSTAL_FLOWER}}a.Create(e)}}};a.NeedActive=function(h,l,j){var e=h[DParamIndex.CLASS_ID]==DClassID.HERO||h[DParamIndex.CLASS_ID]>=DClassID.PHY||h[DParamIndex.ID]==a.GetDefaultCamera()._id;if(e){return true}if(h[DParamIndex.CLASS_ID]==DClassID.BOSS_OCTOPUS_TENTACLE||(h[DParamIndex.CLASS_ID]==DClassID.DECOR&&(h[DParamIndex.DECOR_PARAM]&DValueList.DECOR_PARAM_MOVING_WITH_BTM)!=0)){return true}if(h[DParamIndex.CLASS_ID]==DClassID.DECOR||h[DParamIndex.CLASS_ID]==DClassID.LIGHTINGBALL){var d=0;var i=0;var k=0;if(h[DParamIndex.CLASS_ID]==DClassID.LIGHTINGBALL){k=DParamIndex.LIGHTINGBALL_CLONE_X-DParamIndex.DECOR_CLONE_X}d=Math_IntToFixedPoint(h[DParamIndex.DECOR_DISTANCE_X+k])*(h[DParamIndex.DECOR_CLONE_X+k]);i=Math_IntToFixedPoint(h[DParamIndex.DECOR_DISTANCE_Y+k])*(h[DParamIndex.DECOR_CLONE_Y+k]);e=a.InScreenM2(l,j,d,i)}else{if(h[DParamIndex.CLASS_ID]==DClassID.CAMERA&&h[DParamIndex.ID]!=a._cameraDefault._id&&a._hero!=null){a._tempBox[0]=Math_IntToFixedPoint(h[DParamIndex.POSX]);a._tempBox[1]=Math_IntToFixedPoint(h[DParamIndex.POSY]);a._tempBox[2]=Math_IntToFixedPoint(h[DParamIndex.POSX]+h[DParamIndex.CAMERA_WIDTH]);a._tempBox[3]=Math_IntToFixedPoint(h[DParamIndex.POSY]+h[DParamIndex.CAMERA_HEIGHT]);if((h[DParamIndex.CAMERA_LIMIT]&DValueList.CAMERA_LIMIT_BOTTOM)!=0&&h[DParamIndex.CAMERA_TYPE]!=DValueList.CAMERA_TYPE_NORMAL){a._tempBox[DEF.BOX_BOTTOM]+=DEF.TILE_H_FLOAT*3;if(h[DParamIndex.CAMERA_HEIGHT]<DEF.VIEW_H){a._tempBox[DEF.BOX_TOP]=a._tempBox[DEF.BOX_BOTTOM]-DEF.VIEW_H_FLOAT}}e=a.InBox(a._hero._posX,a._hero._posY,a._tempBox)}else{if(h[DParamIndex.CLASS_ID]==DClassID.PHYFIELD){e=a.InScreenM2(l,j,Math_IntToFixedPoint(h[DParamIndex.PHYFIELD_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.PHYFIELD_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.TRIGGER){e=a.InScreenM2(l,j,Math_IntToFixedPoint(h[DParamIndex.TRIGGER_W]),Math_IntToFixedPoint(h[DParamIndex.TRIGGER_H]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.ELECTRIC_FIELD){e=a.InScreenM2(l,j,Math_IntToFixedPoint(h[DParamIndex.ELECTRIC_FIELD_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.ELECTRIC_FIELD_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.SEGMENT){e=a.InScreenM2(l+Math_IntToFixedPoint(h[DParamIndex.SEGMENT_LEFT]),j+Math_IntToFixedPoint(h[DParamIndex.SEGMENT_TOP]),Math_IntToFixedPoint(h[DParamIndex.SEGMENT_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.SEGMENT_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.TRANSMISSION){var d=Math_IntToFixedPoint(h[DParamIndex.TRANSMISSION_DISTANCE])*(h[DParamIndex.TRANSMISSION_CLONE]);e=a.InScreenM2(l,j,d,0)}else{if(h[DParamIndex.CLASS_ID]==DClassID.WATER){e=a.InScreenM2(l,j,Math_IntToFixedPoint(h[DParamIndex.WATER_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.WATER_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.CANNON||h[DParamIndex.CLASS_ID]==DClassID.CANNONBALL||h[DParamIndex.CLASS_ID]==DClassID.TRACE_CANNON){e=a.InScreenM2LimitBox(h)}else{if(h[DParamIndex.CLASS_ID]==DClassID.TRACE_RENDER){e=a.InScreenM2(Math_IntToFixedPoint(h[DParamIndex.POSX]),Math_IntToFixedPoint(h[DParamIndex.POSY]),Math_IntToFixedPoint(h[DParamIndex.TRACE_RENDER_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.TRACE_RENDER_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.PLATFORM){e=a.InScreenM2(Math_IntToFixedPoint(h[DParamIndex.POSX]),Math_IntToFixedPoint(h[DParamIndex.POSY]),Math_IntToFixedPoint(h[DParamIndex.PLATFORM_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.PLATFORM_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.ROLLING_PLATFORM){e=a.InScreenM2(Math_IntToFixedPoint(h[DParamIndex.POSX]),Math_IntToFixedPoint(h[DParamIndex.POSY]),Math_IntToFixedPoint(h[DParamIndex.ROLLING_PLATFORM_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.ROLLING_PLATFORM_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.OBJ_DAMAGE_STONE){e=a.InScreenM2(Math_IntToFixedPoint(h[DParamIndex.POSX])-DEF.SCR_W_FLOAT,Math_IntToFixedPoint(h[DParamIndex.POSY]),Math_IntToFixedPoint(h[DParamIndex.OBJ_DAMAGE_STONE_WIDTH])+DEF.SCR_W_FLOAT<<1,Math_IntToFixedPoint(h[DParamIndex.OBJ_DAMAGE_STONE_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.MOBS_UFO){e=a.InScreenM2(Math_IntToFixedPoint(h[DParamIndex.POSX]),Math_IntToFixedPoint(h[DParamIndex.POSY]),Math_IntToFixedPoint(h[DParamIndex.MOBS_UFO_WIDTH]),Math_IntToFixedPoint(h[DParamIndex.MOBS_UFO_HEIGHT]))}else{if(h[DParamIndex.CLASS_ID]==DClassID.TRANSFORM_PLATFORM){var f=Math_IntToFixedPoint(h[DParamIndex.TRANSFORM_PLATFORM_CLONE_X]*h[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX]);var m=f;e=a.InScreenM2(l-(f>>1),j-(m>>1),f,m)}else{if((h[DParamIndex.EX_FLAGS]&DFlags.EX_BOSS)!=0){e=a.InScreenM2(l-DEF.VIEW_W,j-DEF.VIEW_H,DEF.VIEW_W<<1,DEF.VIEW_H<<1)}else{e=a.InScreenM2(l,j)}}}}}}}}}}}}}}}}return e};a.InitSprite=function(f){var d=-1;var e=f[DParamIndex.CLASS_ID];if(e==DClassID.DECOR){d=f[DParamIndex.DECOR_SPRITE]}else{if(e<DClassID.PHY){if(CGame._class2sprites[e]>=0){d=CGame._class2sprites[e]}}}return d};a.GetSpriteLoadMask=function(e){var d=0;if(e!=-1){d=1<<e}if(e==DSpriteID.HERO){d|=1<<DSpriteID.EFFECT;d|=1<<DSpriteID.INTERFACE}else{if(e==DSpriteID.OBJ_WAVE){d|=1<<DSpriteID.EFFECT_WATER;d|=1<<DSpriteID.SWORD_FISH}else{if(e==DSpriteID.BOSS_EATER){d|=1<<DSpriteID.MOBS_DANDELIONBOMB;d|=1<<DSpriteID.MOBS_WHITE}else{if(e==DSpriteID.BOSS_UFO){d|=1<<DSpriteID.ACTOR_TRACECANNON}else{if(e==DSpriteID.BOSS_WATCH){d|=1<<DSpriteID.FIRE;d|=1<<DSpriteID.LIGHTING_BALL;d|=1<<DSpriteID.MOBS_WHITE;d|=1<<DSpriteID.MOBS_FLY}else{if(e==DSpriteID.MOBS_UFO){d|=1<<DSpriteID.MOBS_WHITE;d|=1<<DSpriteID.MOBS_FLY}else{if(e==DSpriteID.BOSS_OCTOPUS){d|=1<<DSpriteID.MOBS_WHITE;d|=1<<DSpriteID.EFFECT_WATER}}}}}}}return d};a.prototype.SaveRuntimeData=function(){this._params[DParamIndex.POSX]=Math_FixedPointToInt(this._posX);this._params[DParamIndex.POSY]=Math_FixedPointToInt(this._posY)};a.prototype.LoadRuntimeData=function(){};a.prototype.Unload=function(){this.SetInactived(false);if(this.CheckExFlag(DFlags.EX_SAVE_RUNTIME_DATA)){if((this._params[DParamIndex.FLAGS]&DFlags.DESTROYED)==0){this.SaveRuntimeData()}}CGame._entityMap.remove(this._id);CGame._entityCount--;this._classID=-1;this._id=-1;this._state=0;this._nextFullState=DFSM.FULLSTATE_NONE;this._vX=0;this.SetVY(0);this._destX=0;this._destY=0;this._params=null;this._sprite=null;this._animationPlayer=null};a.prototype.SetInactived=function(d){if(this.CheckExFlag(DFlags.EX_ENEMY)&&this._classID!=DClassID.HIT_BONUS&&this._classID!=DClassID.MOBS_MONSTERINCHEST){d=true}else{if(this._classID==DClassID.BONUS&&this.CheckFlag(DFlags.GRAVITY)){if(this._phyStandOn==-1&&this._posY>a._camY+DEF.VIEW_H_D2_FLOAT){d=true}}}if(d){if(this.NotifyEvent(this,DEvent.DESTROY,0,0,0)==DEvent.RESULT_CANCEL){return}}else{if(this.NotifyEvent(this,DEvent.INACTIVE,0,0,0)==DEvent.RESULT_CANCEL){return}}this._params[DParamIndex.FLAGS]&=~DFlags.ACTIVED;this.ClearFlag(DFlags.ACTIVED);if(d){this._params[DParamIndex.FLAGS]|=DFlags.DESTROYED;this.SetFlag(DFlags.DESTROYED)}if((this._params[DParamIndex.FLAGS]&DFlags.DYNAMIC_CREATE)!=0){CGame._entitiesRowTable.remove(this._id);CGame._entitiesRowData[this._params[this._params.length-1]]=null}this.Remove()};a.prototype.SetActive=function(){this._params[DParamIndex.FLAGS]|=DFlags.ACTIVED;this.SetFlag(DFlags.ACTIVED);this.InitAI(true);if(this._classID==DClassID.HERO){a._hero=this;a.SetCameraFocus(this,true)}};a.prototype.CheckFlag=function(d){return(this._flags&d)!=0};a.prototype.CheckExFlag=function(d){return(this._exFlags&d)!=0};a.prototype.SetFlag=function(d){this._flags|=d};a.prototype.ClearFlag=function(d){this._flags&=~d};a.prototype.IsFlipX=function(){return this.CheckFlag(DFlags.FLIP_X)};a.prototype.SetFlipX=function(e){if(e==this.CheckFlag(DFlags.FLIP_X)){return}if(e){this._flags|=DFlags.FLIP_X}else{this._flags&=~DFlags.FLIP_X}var d=this._boundingBox[0];this._boundingBox[0]=-this._boundingBox[2];this._boundingBox[2]=-d};a.prototype.TurnBack=function(){this.SetFlipX(!this.IsFlipX());this._vX=-this._vX};a.prototype.TurnOver=function(){switch(this._classID){default:break}this.TurnBack()};a.GetRand=function(f,d){if(f==d){return f}var e=Math_Rand();if(e<0){e=-e}return f+e%(d-f+1)};a.prototype.GetFrameRectCount=function(d,e){if(d<0){d=this._animationPlayer.GetAnim();e=this._animationPlayer.GetFrame()}return this._sprite.GetFrameRectCount(this._sprite.GetAnimFrame(d,e))};a.prototype.GetFrameRect=function(h,e,d,f){if(this._sprite==null||this._animationPlayer.GetAnim()==-1||this.CheckFlag(DFlags.INVISIBLE)){h[0]=0;h[1]=0;h[2]=0;h[3]=0;return h}if(d<0){d=this._animationPlayer.GetAnim();f=this._animationPlayer.GetFrame()}if((this._sprite._bs_flags&ASprite.BS_FRAME_RECTS)!=0){this._sprite.GetAFrameRect(d,f,e,h,this._flags&(ASprite.FLAG_FLIP_Y));if(h[2]==0){h[0]=0;h[1]=0;h[2]=0;h[3]=0;return h}var j=this._sprite._anims_af_start[d]+f;var k=0,i=0;if(!this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){k=this._sprite.GetAFramesOX(j);i=this._sprite.GetAFramesOY(j)}h[0]=Math_IntToFixedPoint(h[0]+k);h[1]=Math_IntToFixedPoint(h[1]+i);h[2]=h[0]+Math_IntToFixedPoint(h[2]);h[3]=h[1]+Math_IntToFixedPoint(h[3])}else{if(e==0){this._sprite.GetAFrameRect(h,d,f,0,0,this._flags&(ASprite.FLAG_FLIP_Y));h[0]=Math_IntToFixedPoint(h[0]);h[1]=Math_IntToFixedPoint(h[1]);h[2]=Math_IntToFixedPoint(h[2]);h[3]=Math_IntToFixedPoint(h[3])}else{h[0]=0;h[1]=0;h[2]=0;h[3]=0}}return h};a.prototype.GetAFramesOX=function(){if(arguments){switch(arguments.length){case 0:return this.GetAFramesOX_0.apply(this,arguments);case 2:return this.GetAFramesOX_2.apply(this,arguments)}}throw new Error("InvalidArguments")};a.prototype.GetAFramesOY=function(){if(arguments){switch(arguments.length){case 0:return this.GetAFramesOY_0.apply(this,arguments);case 2:return this.GetAFramesOY_2.apply(this,arguments)}}throw new Error("InvalidArguments")};a.prototype.GetAFramesOX_0=function(){if(this._sprite!=null&&this._animationPlayer.GetAnim()!=-1){var d=this._sprite._anims_af_start[this._animationPlayer.GetAnim()]+this._animationPlayer.GetFrame();if(this.IsFlipX()){return -this._sprite.GetAFramesOX(d)}else{return this._sprite.GetAFramesOX(d)}}return 0};a.prototype.GetAFramesOY_0=function(){if(this._sprite!=null&&this._animationPlayer.GetAnim()!=-1){var d=this._sprite._anims_af_start[this._animationPlayer.GetAnim()]+this._animationPlayer.GetFrame();return this._sprite.GetAFramesOY(d)}return 0};a.prototype.GetAFramesOX_2=function(d,e){if(this._sprite!=null&&d!=-1){e=this._sprite._anims_af_start[d]+e;if(this.IsFlipX()){return -this._sprite.GetAFramesOX(e)}else{return this._sprite.GetAFramesOX(e)}}return 0};a.prototype.GetAFramesOY_2=function(d,e){if(this._sprite!=null&&d!=-1){e=this._sprite._anims_af_start[d]+e;return this._sprite.GetAFramesOY(e)}return 0};a.prototype.GetNbFrame=function(d){return this._animationPlayer.sprite.GetAFrames(d)};a.SETANIM_FORCE=1<<0;a.SETANIM_ONCE=1<<1;a.SETANIM_KEEPBOTTOM=1<<2;a.SETANIM_KEEPTOP=1<<3;a.SETANIM_TOLASTFRAME=1<<4;a.SETANIM_NOUPDATE=1<<5;a.SETANIM_CLEARVELOCITY=1<<6;a.prototype.SetAnim=function(f,e){if(!(this._animationPlayer!=null)){Dbg("this._animationPlayer is null")}if(this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){if(f!=this._animationPlayer.GetAnim()){this._pos_ox=0;this._pos_oy=0}else{this._pos_ox=Math_IntToFixedPoint(this.GetAFramesOX());this._pos_oy=Math_IntToFixedPoint(this.GetAFramesOY())}}if(DEF.dbgEnable){if(this._animationPlayer==null){Dbg("this._animationPlayer is NNNNNUUUUULLLLLLLLLL!!!!!!!!!!!!!!!!   "+this._classID)}}var d=-1;var h=this._posY;if((e&a.SETANIM_ONCE)!=0){d=1}if((e&a.SETANIM_FORCE)!=0&&this._animationPlayer.GetAnim()==f){this._animationPlayer.SetAnim(-1,d)}if((e&a.SETANIM_KEEPBOTTOM)!=0){h+=this._boundingBox[DEF.BOX_BOTTOM]}if((e&a.SETANIM_KEEPTOP)!=0){h+=this._boundingBox[DEF.BOX_TOP]}this._animationPlayer.SetAnim(f,d);if((e&a.SETANIM_TOLASTFRAME)!=0){this._animationPlayer.SetFrame(this._animationPlayer.GetNbFrame()-1)}this.UpdateBoundingBox();if((e&a.SETANIM_KEEPBOTTOM)!=0){h-=this._boundingBox[DEF.BOX_BOTTOM]}if((e&a.SETANIM_KEEPTOP)!=0){h-=this._boundingBox[DEF.BOX_TOP]}this._posY=h;if((e&a.SETANIM_NOUPDATE)==0){this.ClearFlag(DFlags.ANIM_NO_UPDATE)}else{this.SetFlag(DFlags.ANIM_NO_UPDATE)}if((e&a.SETANIM_CLEARVELOCITY)!=0){this._vX=0;this.SetVY(0)}};a.prototype.IsAnimOver=function(){return this._animationPlayer==null||this._animationPlayer.IsAnimOver()};a.prototype.SetFrame=function(d){this._animationPlayer.SetFrame(d);this.UpdateBoundingBox()};a.CreateDynamicEntity=function(){if(arguments){switch(arguments.length){case 6:return a.CreateDynamicEntity_6.apply(this,arguments);case 7:return a.CreateDynamicEntity_7.apply(this,arguments)}}throw new Error("InvalidArguments")};a.CreateDynamicEntity_6=function(j,h,f,k,i,d){var e=LowAPI.Gen_Array([j.length+1],0);System.arraycopy(j,0,e,0,j.length);j=e;j[DParamIndex.CLASS_ID]=h;j[DParamIndex.ID]=CGame._entityMaxId++;j[DParamIndex.POSX]=Math_FixedPointToInt(k);j[DParamIndex.POSY]=Math_FixedPointToInt(i);j[DParamIndex.FLAGS]=(d|DFlags.DYNAMIC_CREATE);j[DParamIndex.ANIMID]=f;j[j.length-1]=CGame._entityRowDataCount;CGame._entitiesRowData[CGame._entityRowDataCount++]=j;CGame._entitiesRowTable.put(j[DParamIndex.ID],j);return a.Create(j)};a.CreateDynamicEntity_7=function(h,f,l,k,d,e,i){var j=LowAPI.Gen_Array([Math.max(DParamIndex.ANIMID+1,i)],0);j[DParamIndex.EX_FLAGS]=e;return a.CreateDynamicEntity(j,h,f,l,k,d)};a.Create=function(e){if((e[DParamIndex.FLAGS]&DFlags.ACTIVED)!=0){return a.GetEntityByID(e[DParamIndex.ID],false)}var d=new a();d.Set(e);a.InsertInList(d);return d};a.UpdateList=function(d){a.UpdateAiList(d);a.UpdateDrawList(d)};a.UpdateAiList=function(e){if(e.next!=null&&(e._zOrderAI>e.next._zOrderAI||(e._zOrderAI==e.next._zOrderAI&&e._id>=e.next._id))||e.prev!=null&&(e._zOrderAI<e.prev._zOrderAI||(e._zOrderAI==e.prev._zOrderAI&&e._id<e.prev._id))){var f=e.next;var d=e.prev;if(f!=null){f.prev=d}else{a.last=d}if(d==null){a.root=f}else{d.next=f}a.InsertInList(e)}};a.UpdateDrawList=function(e){if(e.nextDraw!=null&&(e._zOrder>e.nextDraw._zOrder||(e._zOrder==e.nextDraw._zOrder&&e._id>=e.nextDraw._id))||e.prevDraw!=null&&(e._zOrder<e.prevDraw._zOrder||(e._zOrder==e.prevDraw._zOrder&&e._id<e.prevDraw._id))){var f=e.nextDraw;var d=e.prevDraw;if(f!=null){f.prevDraw=d}else{a.lastDraw=d}if(d==null){a.rootDraw=f}else{d.nextDraw=f}a.InsertInDrawList(e)}};a.InsertInList=function(d){if(d._zOrderAI<Z.NONE_AI){a.InsertInAiList(d)}a.InsertInDrawList(d)};a.InsertInAiList=function(f){var d=null;var e=a.root;while((e!=null)&&(f._zOrderAI>e._zOrderAI||(f._zOrderAI==e._zOrderAI&&f._id>=e._id))){d=e;e=e.next}f.prev=d;f.next=e;if(d==null){a.root=f}else{d.next=f}if(e!=null){e.prev=f}else{a.last=d}};a.InsertInDrawList=function(f){var d=null;var e=a.rootDraw;while(e!=null&&(f._zOrder>e._zOrder||(f._zOrder==e._zOrder&&f._id>=e._id))){d=e;e=e.nextDraw}f.prevDraw=d;f.nextDraw=e;if(d==null){a.rootDraw=f}else{d.nextDraw=f}if(e!=null){e.prevDraw=f}else{a.lastDraw=d}};a.prototype.Remove=function(){if(this._zOrderAI>=Z.NONE_AI){}else{this.RemoveFromAiList()}this.RemoveFromDrawList();CGame._entityMap.remove(this._id);this._relateEntity=null};a.prototype.RemoveFromAiList=function(){if(this.prev!=null){this.prev.next=this.next}else{a.root=this.next}if(this.next!=null){this.next.prev=this.prev}else{a.last=this.prev}};a.prototype.RemoveFromDrawList=function(){if(this.prevDraw!=null){this.prevDraw.nextDraw=this.nextDraw}else{a.rootDraw=this.nextDraw}if(this.nextDraw!=null){this.nextDraw.prevDraw=this.prevDraw}else{a.lastDraw=this.prevDraw}};a.RemoveAll=function(){while(a.root!=null){a.root.Remove()}while(a.rootDraw!=null){a.rootDraw.Remove()}};a.InitAIAll=function(d){var e=a.root;while(e!=null){if((d==-1)||((1<<e._classID)&d)!=0){e.InitAI(true)}e=e.next}};a.DrawAll=function(d){var e=a.rootDraw;while(e!=null){e.Draw();if(!CGame.bIsPaused){e.UpdateAnimation()}e=e.nextDraw}};a.UpdateAll=function(e){a.PrepareHeroKeys();a.CheckActive();DTimer.startTimer(DTimer.INDEX_COLLIDE);var h=a.root;while(h!=null&&h._zOrderAI<Z.NONE_MOVE){h.PreUpdate();h=h.next}a._HeroInWater=false;a._HeroInElectricField=0;DTimer.startTimer(DTimer.INDEX_DETECT);h=a.root;while(h!=null){if(!h.CheckFlag(DFlags.CENIMATIC)){if(h.CheckFlag(DFlags.COLLIDING)&&!h.CheckFlag(DFlags.FIXED)&&h._zOrderAI<Z.DEFAULT_NORMAL_AI){var d=false;System.arraycopy(h._dynamicBox,0,a._tempBox,0,h._dynamicBox.length);h.CollideResetPhyInfo();a._collideRetryCount=0;do{h.CollideDetect();d=h.CollideCompute();a._collideRetryCount++}while(d)}h.UpdatePosition();h.Update();if(CGame.isAnyPointPressed()&&(h._classID==DClassID.RANDOMBONUS||(h.CheckExFlag(DFlags.EX_ENEMY|DFlags.EX_BOSS)&&!h.CheckExFlag(DFlags.EX_CANNOT_HIT_BY_BULLET)))&&(h._classID!=DClassID.BOSS_OCTOPUS&&h._classID!=DClassID.BOSS_OCTOPUS_HEAD&&h._classID!=DClassID.BOSS_OCTOPUS_TENTACLE&&h._classID!=DClassID.BOSS_UFO)&&(h._posY+h._boundingBox[DEF.BOX_TOP]<a._hero._posY+a._hero._boundingBox[DEF.BOX_BOTTOM]&&h._posY+h._boundingBox[DEF.BOX_BOTTOM]>a._hero._posY+a._hero._boundingBox[DEF.BOX_TOP])){if(h._classID==DClassID.BOSS_EATER&&h._subState!=DState.SS_BOSS_FLOWEREATER_TIRE){return}var f=h.GetAbsoluteBox(h._boundingBox);f[DEF.BOX_LEFT]-=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;f[DEF.BOX_TOP]-=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;f[DEF.BOX_RIGHT]+=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;f[DEF.BOX_BOTTOM]+=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;if(CGame.isPointInRectAbs_FixedPoint(f[0],f[1],f[2],f[3])){CGame.s_isEnemyPointed=true;if(a._hero.CheckFlag(DFlags.FLIP_X)&&h._posX>a._hero._posX){a._hero.ClearFlag(DFlags.FLIP_X)}else{if(!a._hero.CheckFlag(DFlags.FLIP_X)&&h._posX<a._hero._posX){a._hero.SetFlag(DFlags.FLIP_X)}}}}}h=h.next}DTimer.endTimer(DTimer.INDEX_DETECT);DTimer.endTimer(DTimer.INDEX_COLLIDE)};a.prototype.Set=function(h){CGame._entityMap.put(h[DParamIndex.ID],this);if(!(this._classID==-1)){Dbg("CEntity.Load().Entify is not release")}h[DParamIndex.FLAGS]|=DFlags.ACTIVED;this._classID=h[DParamIndex.CLASS_ID];this._id=h[DParamIndex.ID];this._exFlags=h[DParamIndex.EX_FLAGS];this._params=h;this._hp=3;this._pos_ox=0;this._pos_oy=0;for(var e=this._tempParams.length-1;e>=0;e--){this._tempParams[e]=0}if((this._params[DParamIndex.EX_FLAGS]&DFlags.EX_SAVE_RUNTIME_DATA)!=0){var d=h[DParamIndex.ID];this.LoadRuntimeData()}this._flags=h[DParamIndex.FLAGS];this.SetPos(Math_IntToFixedPoint(h[DParamIndex.POSX]),Math_IntToFixedPoint(h[DParamIndex.POSY]));this._sprite=null;var f=a.InitSprite(h);if(this._classID==DClassID.BLACK_HOLE||this._classID==DClassID.SPAWN_POINT){this._sprite=CGame.blendSpriteArray[DATA.EFFECT_SPAWN]}else{if(f!=-1){this._sprite=CGame.spriteArray[f]}}if(this._sprite!=null){this._animationPlayer=new GLLibPlayer(this._sprite,h[DParamIndex.POSX],h[DParamIndex.POSY])}this.UpdateBoundingBox();this.SetActive()};a.GetEntityByID=function(i,h){var e=null;if(i>0){e=CGame._entityMap.get(i);if(e==null&&h){var f=CGame._entitiesRowTable.get(i);var d;if(f!=null){d=(f[DParamIndex.FLAGS]&DFlags.CENIMATIC)!=0&&(f[DParamIndex.FLAGS]&DFlags.DESTROYED)!=0;if(!d){e=a.Create(f)}}}}return e};a.GetRowDataByID=function(d){if(d>0){return CGame._entitiesRowTable.get(d)}else{return null}};a.prototype.CreateCloneEntity=function(d){const l=0;const k=1;const t=2;const s=3;const n=4;const m=5;this._params[d+l]=Math.max(this._params[d+l],1);this._params[d+k]=Math.max(this._params[d+k],1);var u=this._params[d+l];var r=this._params[d+k];this._params[d+l]=0;this._params[d+k]=0;var q=this._params[DParamIndex.POSX];var p=this._params[DParamIndex.POSY];if(u>1||r>1){for(var h=0;h<r;h++){q=this._params[DParamIndex.POSX];for(var f=0;f<u;f++){if(h!=0||f!=0){var e=LowAPI.Gen_Array([this._params.length],0);System.arraycopy(this._params,0,e,0,this._params.length);e[DParamIndex.FLAGS]&=~DFlags.ACTIVED;e[DParamIndex.POSX]=q;e[DParamIndex.POSY]=p;var o=a.CreateDynamicEntity(e,this._classID,e[DParamIndex.ANIMID],Math_IntToFixedPoint(e[DParamIndex.POSX]),Math_IntToFixedPoint(e[DParamIndex.POSY]),e[DParamIndex.FLAGS]);if(o!=null){o._params[DParamIndex.FLAGS]&=~DFlags.DYNAMIC_CREATE;o.ClearFlag(DFlags.DYNAMIC_CREATE)}}q+=this._params[d+t];q+=this._params[d+n];p+=this._params[d+m]}p=(this._params[DParamIndex.POSY]+(h+1)*this._params[d+s])}}};a._limitBox=LowAPI.Gen_Array([4],0);a._absoluteBoundingBox=LowAPI.Gen_Array([4],0);a._tempBox=LowAPI.Gen_Array([4],0);a._attackBox=LowAPI.Gen_Array([4],0);a.prototype.GetPositionWithAngularVelocity=function(d,i,h,f,e){a._TempIntArray[DParamIndex.POSX]=f+Math_FixedPointToInt((d-f)*Math_Cos(h)-(i-e)*Math_Sin(h));a._TempIntArray[DParamIndex.POSY]=e+Math_FixedPointToInt((i-e)*Math_Cos(h)+(d-f)*Math_Sin(h))};a.prototype.GetPositionWithAngle=function(d,h,f,e){a._TempIntArray[DParamIndex.POSX]=f+Math_FixedPoint_Multiply(d,Math_Cos(h));a._TempIntArray[DParamIndex.POSY]=e+Math_FixedPoint_Multiply(d,Math_Sin(h))};a.prototype.UpdatePosition=function(){if(!this.CheckFlag(DFlags.FIXED)){this._posX+=this._frameVX;this._posY+=this._frameVY}};a.prototype.UpdateDynamicBox=function(){if(arguments){if(arguments.length==0){return this.UpdateDynamicBox_0()}else{if(arguments.length==3){return this.UpdateDynamicBox_3.apply(this,arguments)}}}throw new Error("InvalidArguments")};a.prototype.UpdateDynamicBox_0=function(){this.UpdateDynamicBox_3(this._frameVX,this._frameVY,false)};a.prototype.UpdateDynamicBox_3=function(h,e,i){if(this._boundingBox[2]-this._boundingBox[0]==0||this._boundingBox[3]-this._boundingBox[1]==0){this._dynamicBox[0]=0;this._dynamicBox[1]=0;this._dynamicBox[2]=0;this._dynamicBox[3]=0;return}if(!i){this._dynamicBox[0]=this._boundingBox[0]+this._posX;this._dynamicBox[1]=this._boundingBox[1]+this._posY;this._dynamicBox[2]=this._boundingBox[2]+this._posX;this._dynamicBox[3]=this._boundingBox[3]+this._posY}var f=0;var d=1;if(h>=0){f=2}if(e>=0){d=3}this._dynamicBox[f]+=h;this._dynamicBox[d]+=e;if(this._classID==DClassID.CAMERA){this._dynamicBox[2-f]+=h;this._dynamicBox[4-d]+=e}};a.prototype.CheckPhysics=function(d){return(this._phyInfo&d)!=0};a.GetVelocity=function(d){return Math_FixedPoint_Multiply(d,CGame._velocityRate)};a.GetSecondVelocity=function(d){return Math_FixedPoint_Divide(d,CGame._velocityRate)};a.CS_TOP=1;a.CS_BOTTOM=2;a.CS_RIGHT=4;a.CS_LEFT=8;a.CompOutcode=function(e,k,j,h,f,d){var i=0;if(k>d){i|=a.CS_TOP}if(k<h){i|=a.CS_BOTTOM}if(e>f){i|=a.CS_RIGHT}if(e<j){i|=a.CS_LEFT}return i};a.LineClipping=function(){if(arguments){switch(arguments.length){case 5:return a.LineClipping_5.apply(this,arguments);case 8:return a.LineClipping_8.apply(this,arguments)}}throw new Error("InvalidArguments")};a.LineClipping_5=function(e,i,d,f,h){return a.LineClipping(e,i,d,f,h[0],h[1],h[2],h[3])};a.LineClipping_8=function(i,p,e,o,d,q,l,j){var k,h,f;var n=0,m=0;k=a.CompOutcode(i,p,d,q,l,j);h=a.CompOutcode(e,o,d,q,l,j);while(true){if((k|h)==0){return true}if((k&h)!=0){return false}f=(k!=0)?k:h;if((f&a.CS_TOP)!=0){n=i+(e-i)*(j-p)/(o-p);m=j}else{if((f&a.CS_BOTTOM)!=0){n=i+(e-i)*(q-p)/(o-p);m=q}else{if((f&a.CS_RIGHT)!=0){m=p+(o-p)*(l-i)/(e-i);n=l}else{if((f&a.CS_LEFT)!=0){m=p+(o-p)*(d-i)/(e-i);n=d}}}}if(f==k){i=n;p=m;k=a.CompOutcode(i,p,d,q,l,j)}else{e=n;o=m;h=a.CompOutcode(e,o,d,q,l,j)}}};a.prototype.SetVX=function(d){if(this._vX!=d){this._vX=d}};a.prototype.SetVY=function(d){if(this._vY!=d){this._vY=d}};a.prototype.AddVX=function(d){this._vX+=a.GetVelocity(d)};a.prototype.AddVY=function(d){this._vY+=a.GetVelocity(d)};a.prototype.SetVelocityByDest=function(f,e,d){var h=Math_Atan(e,d);this.SetVelocityByAngle(f,h)};a.prototype.GetVelocityByDest=function(f,e,d){var h=Math_Atan(e,d);this.SetVelocityByAngle(f,h)};a.prototype.SetVelocityByAngle=function(d,e){this._vX=Math_FixedPoint_Multiply(d,Math_Cos(e));this.SetVY(Math_FixedPoint_Multiply(d,Math_Sin(e)))};a.prototype.GetAngleOfVelocity=function(){return Math_Atan(this._vX,this._vY)};a.prototype.VelocityByDamp=function(e,d){if(e>d){e-=d}else{if(e<-d){e+=d}else{e=0}}return e};a.prototype.SetPos=function(d,e){this._posX=d;this._posY=e};a.GetBoxMiddleX=function(d){return(d[DEF.BOX_LEFT]+d[DEF.BOX_RIGHT])>>1};a.GetBoxMiddleY=function(d){return(d[DEF.BOX_TOP]+d[DEF.BOX_BOTTOM])>>1};a.GetBoxWidth=function(d){return(d[DEF.BOX_RIGHT]-d[DEF.BOX_LEFT])};a.GetBoxHight=function(d){return(d[DEF.BOX_BOTTOM]-d[DEF.BOX_TOP])};a.IntersectBoxFlag=function(f,e){var d=0;if(f[2]<e[0]){d|=1<<DEF.BOX_RIGHT}if(f[0]>e[2]){d|=1<<DEF.BOX_LEFT}if(f[3]<e[1]){d|=1<<DEF.BOX_BOTTOM}if(f[1]>e[3]){d|=1<<DEF.BOX_TOP}return d};a.IntersectBox=function(e,d){if(e[2]-e[0]==0){return false}if(d[2]-d[0]==0){return false}if(e[2]<d[0]){return false}if(e[0]>d[2]){return false}if(e[3]<d[1]){return false}if(e[1]>d[3]){return false}return true};a.CheckInBox=function(e,h,f){var d=0;if(e<f[0]){d|=1<<DEF.BOX_LEFT}if(e>f[2]){d|=1<<DEF.BOX_RIGHT}if(h<f[1]){d|=1<<DEF.BOX_TOP}if(h>f[3]){d|=1<<DEF.BOX_BOTTOM}return d};a.InBox=function(){if(arguments){switch(arguments.length){case 2:return a.InBox_2.apply(this,arguments);case 3:return a.InBox_3.apply(this,arguments)}}throw new Error("InvalidArguments")};a.InBox_2=function(d,e){if(d[2]-d[0]==0){return false}if(e[2]-e[0]==0){return false}if(d[0]<e[0]){return false}if(d[2]>e[2]){return false}if(d[1]<e[1]){return false}if(d[3]>e[3]){return false}return true};a.InBox_3=function(d,f,e){if(d<e[0]){return false}if(d>e[2]){return false}if(f<e[1]){return false}if(f>e[3]){return false}return true};a.prototype.IntersectBox=function(f){if(this._boundingBox[2]-this._boundingBox[0]==0){return false}var e=-this._posX;var d=-this._posY;if(this._boundingBox[2]<f[0]+e){return false}if(this._boundingBox[0]>f[2]+e){return false}if(this._boundingBox[3]<f[1]+d){return false}if(this._boundingBox[1]>f[3]+d){return false}return true};a.prototype.IntersectEntity=function(f){if(this._boundingBox[2]-this._boundingBox[0]==0){return false}if(f._boundingBox[2]-f._boundingBox[0]==0){return false}var e=f._posX-this._posX;var d=f._posY-this._posY;if(this._boundingBox[2]<f._boundingBox[0]+e){return false}if(this._boundingBox[0]>f._boundingBox[2]+e){return false}if(this._boundingBox[3]<f._boundingBox[1]+d){return false}if(this._boundingBox[1]>f._boundingBox[3]+d){return false}return true};a.IsPointInShortRect=function(d,h,e,f){d>>=DEF.SHIFT;h>>=DEF.SHIFT;return d>=e[f]&&d<=e[f+2]&&h>=e[f+1]&&h<=e[f+3]};a.prototype.GetAbsoluteBox=function(e){var f=e[0];var d=e[2];a._absoluteBoundingBox[0]=this._posX+f;a._absoluteBoundingBox[1]=this._posY+e[1];a._absoluteBoundingBox[2]=this._posX+d;a._absoluteBoundingBox[3]=this._posY+e[3];return a._absoluteBoundingBox};a.prototype.GetAttackBox=function(){var e=this.GetFrameRect(a._attackBox,1,-1,-1);if(this.IsFlipX()){var d=e[DEF.BOX_LEFT];e[DEF.BOX_LEFT]=-e[DEF.BOX_RIGHT];e[DEF.BOX_RIGHT]=-d}return e};a.GetLimitBox=function(e){var d=e[DParamIndex.CLASS_ID];if(d==DClassID.MOBS_WHITE||d==DClassID.MOBS_BEE){a._limitBox[DEF.BOX_LEFT]=Math_IntToFixedPoint(e[DParamIndex.POSX]+e[DParamIndex.MOBS_WHITE_AREALEFT]);a._limitBox[DEF.BOX_TOP]=Math_IntToFixedPoint(e[DParamIndex.POSY]+e[DParamIndex.MOBS_WHITE_AREATOP]);a._limitBox[DEF.BOX_RIGHT]=a._limitBox[DEF.BOX_LEFT]+Math_IntToFixedPoint(e[DParamIndex.MOBS_WHITE_AREAWIDTH]);a._limitBox[DEF.BOX_BOTTOM]=a._limitBox[DEF.BOX_TOP]+Math_IntToFixedPoint(e[DParamIndex.MOBS_WHITE_AREAHEIGHT])}else{a._limitBox[DEF.BOX_LEFT]=0;a._limitBox[DEF.BOX_TOP]=0;a._limitBox[DEF.BOX_RIGHT]=0;a._limitBox[DEF.BOX_BOTTOM]=0}return a._limitBox};a.prototype.UpdateBoundingBox=function(){if(this._classID==DClassID.TRIGGER||this._classID==DClassID.PHYFIELD){this._boundingBox[DEF.BOX_LEFT]=0;this._boundingBox[DEF.BOX_TOP]=0;this._boundingBox[DEF.BOX_RIGHT]=Math_IntToFixedPoint(this._params[DParamIndex.TRIGGER_W]);this._boundingBox[DEF.BOX_BOTTOM]=Math_IntToFixedPoint(this._params[DParamIndex.TRIGGER_H])}else{if(this._classID==DClassID.CAMERA){this._boundingBox[DEF.BOX_LEFT]=0;this._boundingBox[DEF.BOX_TOP]=0;this._boundingBox[DEF.BOX_RIGHT]=DEF.VIEW_W_FLOAT;this._boundingBox[DEF.BOX_BOTTOM]=DEF.VIEW_H_FLOAT}else{if(this._classID==DClassID.WATER){this._boundingBox[DEF.BOX_LEFT]=0;this._boundingBox[DEF.BOX_TOP]=0;this._boundingBox[DEF.BOX_RIGHT]=Math_IntToFixedPoint(this._params[DParamIndex.WATER_WIDTH]);this._boundingBox[DEF.BOX_BOTTOM]=Math_IntToFixedPoint(this._params[DParamIndex.WATER_HEIGHT])}else{if(this._classID==DClassID.ELECTRIC_FIELD){this._boundingBox[DEF.BOX_LEFT]=0;this._boundingBox[DEF.BOX_TOP]=0;this._boundingBox[DEF.BOX_RIGHT]=Math_IntToFixedPoint(this._params[DParamIndex.ELECTRIC_FIELD_WIDTH]);this._boundingBox[DEF.BOX_BOTTOM]=Math_IntToFixedPoint(this._params[DParamIndex.ELECTRIC_FIELD_HEIGHT])}else{if(this._classID==DClassID.SEGMENT){this._boundingBox[DEF.BOX_LEFT]=Math_IntToFixedPoint(this._params[DParamIndex.SEGMENT_LEFT]);this._boundingBox[DEF.BOX_TOP]=Math_IntToFixedPoint(this._params[DParamIndex.SEGMENT_TOP]);this._boundingBox[DEF.BOX_RIGHT]=Math_IntToFixedPoint(this._params[DParamIndex.SEGMENT_LEFT]+this._params[DParamIndex.SEGMENT_WIDTH]);this._boundingBox[DEF.BOX_BOTTOM]=Math_IntToFixedPoint(this._params[DParamIndex.SEGMENT_TOP]+this._params[DParamIndex.SEGMENT_HEIGHT])}else{if(this._classID==DClassID.HERO&&this._state==DState.STATE_CHANGE){this._boundingBox[DEF.BOX_LEFT]=-8<<DEF.SHIFT;this._boundingBox[DEF.BOX_TOP]=-30<<DEF.SHIFT;this._boundingBox[DEF.BOX_RIGHT]=8<<DEF.SHIFT;this._boundingBox[DEF.BOX_BOTTOM]=0<<DEF.SHIFT;if(this.CheckFlag(DFlags.FLIP_Y)){var f=this._boundingBox[DEF.BOX_TOP];this._boundingBox[DEF.BOX_TOP]=-this._boundingBox[DEF.BOX_BOTTOM];this._boundingBox[DEF.BOX_BOTTOM]=-f}}else{if(this._classID==DClassID.BULLET&&this._subState==DState.SS_ARROW_FLY){this.GetFrameRect(this._boundingBox,1,-1,-1)}else{this.GetFrameRect(this._boundingBox,0,-1,-1)}}}}}}}if(this._classID==DClassID.DECOR||this._classID==DClassID.LIGHTINGBALL){var i=0;if(this._classID==DClassID.LIGHTINGBALL){i=DParamIndex.LIGHTINGBALL_CLONE_X-DParamIndex.DECOR_CLONE_X}var e=this._params[DParamIndex.DECOR_DISTANCE_X+i]*(this._params[DParamIndex.DECOR_CLONE_X+i]-1);var d=this._params[DParamIndex.DECOR_DISTANCE_Y+i]*(this._params[DParamIndex.DECOR_CLONE_Y+i]-1);this._boundingBox[DEF.BOX_RIGHT]+=Math_IntToFixedPoint(e);this._boundingBox[DEF.BOX_BOTTOM]+=Math_IntToFixedPoint(d)}else{if(this._classID==DClassID.TRANSMISSION){var e=this._params[DParamIndex.TRANSMISSION_DISTANCE]*(this._params[DParamIndex.TRANSMISSION_CLONE]-1);this._boundingBox[DEF.BOX_RIGHT]+=Math_IntToFixedPoint(e)}}if(this.IsFlipX()){var f=this._boundingBox[DEF.BOX_LEFT];this._boundingBox[DEF.BOX_LEFT]=-this._boundingBox[DEF.BOX_RIGHT];this._boundingBox[DEF.BOX_RIGHT]=-f}if(this._classID==DClassID.BALANCE){if(this._params[DParamIndex.BALANCE_SEGMENT_ID]!=-1){var h=CGame._segments[this._params[DParamIndex.BALANCE_SEGMENT_ID]];this._boundingBox[DEF.BOX_LEFT]=Math.min(h[0],h[2])-1;this._boundingBox[DEF.BOX_TOP]=Math.min(h[1],h[3])-1;this._boundingBox[DEF.BOX_RIGHT]=Math.max(h[0],h[2])+1;this._boundingBox[DEF.BOX_BOTTOM]=Math.max(h[1],h[3])+1}}this.UpdateDynamicBox()};a.prototype.NotifyEvent=function(E,v,n,m,l){var u=DEvent.RESULT_OK;if(v==DEvent.BE_ATTACKED&&this.CheckExFlag(DFlags.EX_ENEMY)&&E._classID==DClassID.BULLET){switch(this._classID){case DClassID.MOBS_FLY:case DClassID.MOBS_BEE:if(this._subState!=DState.SS_DISAPPEAR){if(E._classID!=DClassID.BULLET||(E._classID==DClassID.BULLET&&E._subState!=DState.SS_ARROW_FLY&&E._subState!=DState.SS_BULLET_CLOSE_AXE)){var w=(this._relateEntity!=null&&this._relateEntity._classID==DClassID.BOSS_WITCH);if(!w){var J=a.CreateDynamicEntity(DClassID.STONE,0,this._posX,this._posY,0,0,0)}}a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY+a.GetBoxMiddleY(this._boundingBox));this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}break;case DClassID.HIT_BONUS:this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);break;case DClassID.STONE:if((this._subState!=DState.SS_DISAPPEARING&&this._subState!=DState.SS_DISAPPEAR&&this._subState!=DState.SS_APPEARING&&!a._bullet[a._lastBulletIndex].CheckFlag(DFlags.INVISIBLE))){this._hp--;if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEARING,0);this._exFlags&=~DFlags.EX_ENEMY}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_STONE_MOVE,0);if(this._vX<0){this._vX=-this._vX}if(a._hero._posX>this._posX){this._vX=-this._vX}}}break;case DClassID.MOBS_DANDELIONBOMB:if(this._subState!=DState.SS_DANDELION_SEED_JET&&this._subState!=DState.SS_DANDELION_SEED_OPEN&&this._subState!=DState.SS_DANDELION_SEED_FALL){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_DANDELION_BE_WEAK,0)}else{this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}break;case DClassID.BOSS_EATER:if(this._subState==DState.SS_BOSS_FLOWEREATER_TIRE){this._hp--;if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_HURT,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_BE_ATTACK,0)}}break;case DClassID.BOSS_OCTOPUS_HEAD:if(a._BossOctopusHurt){a._boss._hp--;a._BossOctopusHurtBySit=false;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_OCTOPUS_HEAD_CRY,0)}break;case DClassID.BOSS_WITCH:if(this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK)){this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);this._hp--;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_HURT,0)}break;case DClassID.BOSS_WITCH_EX_PART:break;case DClassID.BOSS_KILLERBEE:if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_1||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_2||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2){this.SetFlipX(this._posX<a._hero._posX);if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_1){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_BEAT_1,0)}if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_2){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_BEAT_2,0)}if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_FORK_BEAT_1,0)}if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_FORK_BEAT_2,0)}return u}break;case DClassID.MOBS_MONSTERINCHEST:if(this._subState==DState.SS_MONSTERINCHEST_BONUS){this._hp=1}if(this._subState!=DState.SS_MONSTERINCHEST_HURT){if(this._hp<=1){this.DumpBonus(this._params[DParamIndex.MOBS_MONSTERINCHEST_DROP1],this._posX,this._posY+this._boundingBox[DEF.BOX_TOP]-DEF.TILE_H_FLOAT);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_HURT,0)}}break;case DClassID.BOSS_UFO:break;case DClassID.TRACE_CANNON_BALL:this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_CANNONBALL_EXPLODE,0);break;default:if(this._classID!=DClassID.MOBS_WHITE||this._params[DParamIndex.MOBS_WHITE_TYPE]!=DValueList.MOBS_MOUSE_TYPE_THIEF){if(this._classID==DClassID.MOBS_WHITE){if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_SHIELD){if(a._bullet[a._lastBulletIndex].CheckFlag(DFlags.INVISIBLE)){if(a._hero.IsFlipX()!=this.IsFlipX()){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BACK_WALK,0);break}}else{if(a._bullet[a._lastBulletIndex]._subState==DState.SS_BULLET_CLOSE_RUN){if(a._bullet[a._lastBulletIndex].IsFlipX()!=this.IsFlipX()){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BACK_WALK,0);break}}}}if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_LIGHT){if(this._subState==DState.SS_LIGHT_IDLE){break}}}if(E._classID!=DClassID.BULLET||(E._classID==DClassID.BULLET&&E._subState!=DState.SS_ARROW_FLY&&E._subState!=DState.SS_BULLET_CLOSE_AXE)){var r;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){r=this._posY+a.GetBoxHight(this._boundingBox)}else{r=this._posY}var J=a.CreateDynamicEntity(DClassID.STONE,0,this._posX,r,0,0,0);if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.SPAWN_POINT){J._relateEntity=this._relateEntity;this._relateEntity=null}}else{a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY+a.GetBoxMiddleY(this._boundingBox))}this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}}}else{if(v==DEvent.UFO_HIT){var h=((E._classID==DClassID.MOBS_UFO&&E._subState==DState.SS_UFO_FIRE_LIGHT)||(E._classID==DClassID.BOSS_UFO));if(this._classID==DClassID.HERO&&h){E._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]=DAI.UFO_LIGHT_BEAM_HURT_INTERVER_FRAME;var M=(this._state==DState.STATE_CHANGE)&&(this._subState==DState.SS_HERO_CHANGE_MOBS||this._subState==DState.SS_HERO_CHANGE_MOBS_IDLE||this._subState==DState.SS_HERO_CHANGE_MOBS_WALK);var N=(this._state==DState.STATE_CHANGE)&&(this._subState==DState.SS_HERO_CHANGE_FLY||this._subState==DState.SS_HERO_CHANGE_FLY_FLY);if(this._state!=DState.STATE_CHANGE){if(n==DValueList.UFO_FIRE_TYPE_YELLOW){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_FLY,0);return DEvent.RESULT_OK}else{this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_MOBS,0);return DEvent.RESULT_OK}}else{if(M){if(n==DValueList.UFO_FIRE_TYPE_YELLOW){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_FLY,0);return DEvent.RESULT_OK}}else{if(N){if(n==DValueList.UFO_FIRE_TYPE_PURPLE){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_MOBS,0);return DEvent.RESULT_OK}}}a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);a._HeroStateTick=0;a._HeroMorphEnergy=1<<DAI.CHANGE_MOBS_MAX_ENERGY}}else{return DEvent.RESULT_OK}}}switch(this._classID){case DClassID.HERO:switch(v){case DEvent.HERO_DIE:if(this._state!=DState.STATE_DIE){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY)}a._heroHpBeforeDie=(this._hp>=0)?this._hp:0;a._HeroParams[DAI.HPI_LIVES]--;a._hero.StateMachineChangeState(DState.STATE_DIE,DState.SS_DIE_PREPARE,0);CGame.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_LOSE)}break;case DEvent.STAND_ON_ENTITY:if(this._state==DState.STATE_INAIR&&this._subState!=DState.SS_INAIR_JUMP_VER_START&&this._subState!=DState.SS_INAIR_JUMP_DIAG_START){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0)}break;case DEvent.BE_ATTACKED:if(E._classID==DClassID.FLY_CANNON){if(E._subState==DState.SS_CANNON_IDLE_FLY_ON){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_HERO_IN_FLY_CANNON,0);E.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNON_IDLE_FLY_HERO_IN,0)}break}if(this.AI_Hero_IsSmash()&&E._classID==DClassID.BOSS_WITCH){if(E.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK)){E.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);E._hp--;E.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_HURT,0);break}}if(E._classID==DClassID.INK_BOMB){E.StateMachineGotoNextState(DState.SS_INKBOMB_BLAST,0)}if(E._classID==DClassID.BOSS_WITCH&&(E.CheckFlag(DFlags.INVISIBLE)||E._subState==DState.SS_BOSS_WITCH_MAGIC_OUT_BEE||E._subState==DState.SS_BOSS_WITCH_MAGIC_OUT_MOBS||E._subState==DState.SS_BOSS_WITCH_MAGIC_IN_BEE||E._subState==DState.SS_BOSS_WITCH_MAGIC_IN_MOBS)){break}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)||this._state==DState.STATE_DIE||this._subState==DState.SS_HURT||this._subState==DState.SS_HURT_LIGHTENED||a._HeroInvincibilityFrame!=0){break}if(DEF.dbgEnableCheat){if(a._debugCheatNoHurt){a._HeroInvincibilityFrame=DAI.HERO_INVINCIBILITY_FRAMES;break}}if(E!=null&&E._classID==DClassID.MOBS_BARREL){if(E._subState!=DState.SS_MOBS_BARREL_IDLE){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HURT,0);a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_BUMP_EFFECT_V,0,this._posX,this._posY);this._vX=this._vX+this._vX/4}break}if(E!=null&&E._classID==DClassID.STONE){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HURT,0);break}if(a._HeroInvincibilityFrame==0){var t=DAI.HERO_HP_DUMP_COUNT;var d=this._hp;if(this._hp<DAI.HERO_HP_DUMP_COUNT){t=this._hp}if(this._hp>DAI.HERO_HP_DROP){this._hp-=DAI.HERO_HP_DROP}else{if(this._hp>0){this._hp=0}else{this._hp=-1}}if(a._HeroPoweredBullet){this._hp=d;t=0}if(DEF.dbgEnableCheat){if(a._debugCheatNoDecreaseHP){this._hp++}}if(this._hp>=0){a._HeroInvincibilityFrame=DAI.HERO_INVINCIBILITY_FRAMES;this.AI_Hint_ShowSoundEffect(DAnimID.HINT_AH_,-1,-1);if(this._state!=DState.STATE_SWIM){if((this._preFullState&DFSM.STATE_MASK)==DState.STATE_CHANGE&&(this._preFullState&DFSM.SUBSTATE_MASK)!=DState.SS_HERO_CHANGE_HURT_BACK){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_HURT_BACK,0)}if(E!=null&&(E._classID==DClassID.LIGHTINGBALL||E._classID==DClassID.BOSS_UFO)){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HURT_LIGHTENED,0)}else{if((E._classID==DClassID.MOBS_WHITE&&E._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_LIGHT&&E._subState==DState.SS_LIGHT_IDLE)){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HURT_LIGHTENED,0)}else{this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HURT,0)}}}else{if(this._state==DState.STATE_SWIM&&a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH)){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_HURT_BACK,0)}}if((!a._HeroPoweredBullet&&a.AI_Hero_CheckMorph(DAI.HERO_MORPH_NONE))&&this._state!=DState.STATE_FREEZED){var I=DAI.HP_BONUS_DROP_START_ANGLE;var L=0;var q=this._posX;if(t>1){L=(Math_Angle90-DAI.HP_BONUS_DROP_START_ANGLE)*2/(t-1)}else{I=Math_Angle90}for(var G=0;G<t;G++){var J=this.DumpBonus(DValueList.BONUS_TYPE_CRYSTAL,q,this._posY+a.GetBoxMiddleY(this._boundingBox));if(J._boundingBox[DEF.BOX_TOP]<this._boundingBox[DEF.BOX_TOP]){J._posY+=this._boundingBox[DEF.BOX_TOP]-J._boundingBox[DEF.BOX_TOP]}J.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE,0);J._vX=0;J._vY=-(DAI.HP_BONUS_HERO_DROP_VELOCITY);J._tempParams[DTempParamIndex.BONUS_DROP_BY_HERO]=1;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){J._vY=-J._vY;J.SetFlag(DFlags.REVERSAL_GRAVITY)}if(Math.abs(J._vY)<DEF.TILE_W_FLOAT/2){if(J._vY>0){J._vY=DEF.TILE_W_FLOAT/2}else{J._vY=-DEF.TILE_W_FLOAT/2}}J._tempParams[DTempParamIndex.BONUS_DROP_NO_COLLIDE_ANGLE]=I;I+=L}}}else{this.NotifyEvent(this,DEvent.HERO_DIE,0,0,0)}if(a._HeroPoweredBullet&&this._state!=DState.STATE_FREEZED){a._HeroPoweredBullet=false}if(this._state!=DState.STATE_FREEZED&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_NONE)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){CGame._popUpEnded=false;a._HeroMorphEnergy=0;a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE)}}break;case DEvent.SPRING_JUMP:if(this._subState==DState.SS_INAIR_SMASH_FALL||this._subState==DState.SS_COMBAT){break}var D=this._vX;this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_JUMP_SPRING_DIAG,0);a._HeroInStateFlags&=~DAI.ISF_INAIR_HAS_EXTEND_JUMPED;if(D==0){this._vX=0}return DEvent.RESULT_PHY_KEEP_VELOCITY;case DEvent.DESTROY:CGame.initIngameMenu(STATE.GAMEOVER);break}break;case DClassID.BULLET:if(v==DEvent.BULLET_HIT){var A=DAnimID.EFFECT_STONE;if(E._classID==DClassID.CANNON||E._classID==DClassID.EXPLOSION){A=DAnimID.EFFECT_HIT_EFFECT_NOUSE}var s=this._posX,r=this._posY;var k=a.RENDER_TYPE_ANIMATION;if(a._HeroPoweredBullet){if(this.IsFlipX()){k|=DFlags.FLIP_X}}else{if(a._hero.IsFlipX()){k|=DFlags.FLIP_X}}a.PrepareRender(k,-1,DSpriteID.EFFECT,A,0,s,r);if(A==DAnimID.EFFECT_HIT_EFFECT_NOUSE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0)}}break;case DClassID.MOBS_WHITE:if(v==DEvent.BLOCK_VIRTUALBLOCK||v==DEvent.COLLIDE_VIRTUALBLOCK){if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_BLOW){if(this._subState==DState.SS_MOBS_BLOW_BLOWING){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BLOW_HARD,0)}}}else{if(v==DEvent.BE_ATTACKED&&E._classID==DClassID.BOSS_OCTOPUS_TENTACLE){this._hp=0;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);return DEvent.RESULT_CANCEL}else{if(v==DEvent.DESTROY){if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.SPAWN_POINT){this._relateEntity._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]--}}}}break;case DClassID.MOBS_ACALEPH:if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.SPAWN_POINT){if(v==DEvent.INACTIVE){this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}if(v==DEvent.DESTROY){this._relateEntity._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]--}}break;case DClassID.MOBS_BEE:if(this._params[DParamIndex.MOBS_BEE_TRACE]!=DAI.NON_TRACE&&this._params[DParamIndex.MOBS_BEE_TRACE]<0){if(v==DEvent.DESTROY||v==DEvent.INACTIVE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0);return DEvent.RESULT_CANCEL}}break;case DClassID.CAMERA:if(v==DEvent.INACTIVE||v==DEvent.DESTROY){if(a._hero._state==DState.STATE_DIE){return DEvent.RESULT_CANCEL}if(a._camera==this){a.SetCurrentCamera(null)}}break;case DClassID.MOBS_DANDELIONBOMB:if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.MOBS_DANDELIONBOMB){if(v==DEvent.INACTIVE){this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}if(v==DEvent.DESTROY){this._relateEntity._tempParams[DTempParamIndex.DANDELION_SEED_COUNT]--}}if(this._subState!=DState.SS_DANDELION_SEED_JET&&this._subState!=DState.SS_DANDELION_SEED_OPEN&&this._subState!=DState.SS_DANDELION_SEED_FALL){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_DANDELION_BE_WEAK,0)}break;case DClassID.BONUS:if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.SPAWN_POINT){if(v==DEvent.DESTROY||v==DEvent.INACTIVE){this._relateEntity._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]--}}if(v==DEvent.BE_TRIGGERED&&n==DEvent.ACTION_ACTIVE_NEXT){var C=this._params[DParamIndex.BONUS_CLONE_X];var B=this._params[DParamIndex.BONUS_CLONE_Y];var s=this._params[DParamIndex.POSX];var r=this._params[DParamIndex.POSY];var o=0;for(var G=0;G<B;G++){s=this._params[DParamIndex.POSX];for(var F=0;F<C;F++){if(G!=0||F!=0){if(this._tempParams[DTempParamIndex.BONUS_CURRENT_CLONE_ITEM]==o){this._tempParams[DTempParamIndex.BONUS_CURRENT_CLONE_ITEM]++;var K=LowAPI.Gen_Array([this._params.length],0);System.arraycopy(this._params,0,K,0,this._params.length);K[DParamIndex.FLAGS]&=~DFlags.ACTIVED;K[DParamIndex.POSX]=s;K[DParamIndex.POSY]=r;K[DParamIndex.BONUS_CLONE_X]=0;K[DParamIndex.BONUS_CLONE_Y]=0;var J=a.CreateDynamicEntity(K,DClassID.BONUS,K[DParamIndex.ANIMID],Math_IntToFixedPoint(K[DParamIndex.POSX]),Math_IntToFixedPoint(K[DParamIndex.POSY]),K[DParamIndex.FLAGS]);if(J!=null){J._params[DParamIndex.FLAGS]&=~DFlags.DYNAMIC_CREATE;J.ClearFlag(DFlags.DYNAMIC_CREATE)}if(E!=this){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.BONUS,DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL,0,Math_IntToFixedPoint(s),Math_IntToFixedPoint(r))}return DEvent.RESULT_OK}o++}s+=this._params[DParamIndex.BONUS_DISTANCE_X];s+=this._params[DParamIndex.BONUS_OFFSET_X];r+=this._params[DParamIndex.BONUS_OFFSET_Y]}r=(this._params[DParamIndex.POSY]+(G+1)*this._params[DParamIndex.BONUS_DISTANCE_Y])}this._params[DParamIndex.BONUS_CLONE_X]=0;this._params[DParamIndex.BONUS_CLONE_Y]=0;return DEvent.RESULT_CANCEL}break;case DClassID.STONE:if(v==DEvent.DESTROY){if(this._relateEntity!=null&&this._relateEntity._classID==DClassID.SPAWN_POINT){this._relateEntity._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]--}}break;case DClassID.TRANSFORM_PLATFORM:if(v==DEvent.INACTIVE||v==DEvent.DESTROY){var C=this._params[DParamIndex.TRANSFORM_PLATFORM_CLONE_X];for(var G=0;G<C;G++){var J=a.GetEntityByID(this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_INDEX_START+G],false);if(J!=null){J.SetInactived(true)}}}break;case DClassID.BOSS_EATER:if(this._subState==DState.SS_BOSS_FLOWEREATER_TIRE){this._hp--;if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_HURT,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_BE_ATTACK,0)}}break;case DClassID.BOSS_OCTOPUS_HEAD:if(E._classID==DClassID.HERO&&this._subState==DState.SS_OCTOPUS_HEAD_REST){a._boss._hp--;if(!a._BossOctopusHurt){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_OCTOPUS_HEAD_BE_ATTACK,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_OCTOPUS_HEAD_CRY,0)}a._BossOctopusHurtBySit=true;this.AI_Hint_ShowSoundEffect(DAnimID.HINT_BOING_,-1,-1)}break;case DClassID.INK_BOMB:if(v==DEvent.INACTIVE||v==DEvent.DESTROY){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_INKBOMB_IDLE,0)}break;case DClassID.EXPLOSION:if(v==DEvent.BE_ATTACKED){if(E.CheckExFlag(DFlags.EX_BOSS)){E.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}else{if(E.CheckExFlag(DFlags.EX_ENEMY)){E._hp--;if(E._hp==0){E.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,E._posX,E._posY)}}}}break;case DClassID.BOSS_KILLERBEE:if(v==DEvent.BE_ATTACKED){if(this._subState!=DState.SS_BOSS_KILLER_BEE_HURT){this._hp--;if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_PIERCE_COUNT]=DAI.BOSS_KILLER_BEE_PIERCE_COUNT;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_HURT,0);this.DumpBonus(DValueList.BONUS_TYPE_CRYSTALFLOWER,this._posX,this._posY)}}}break;case DClassID.BOSS_UFO:if(v==DEvent.BE_ATTACKED&&E._classID!=DClassID.BULLET){if(this._subState!=DState.SS_BOSS_UFO_HURT&&this._subState!=DState.SS_DISAPPEAR&&this._tempParams[DTempParamIndex.BOSS_UFO_HURT_TICK]==0){a.PrepareRender(a.RENDER_TYPE_ANIMATION|a.RENDER_FLAG_POSITION_RELATIVE,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_EXPLORE_UFO,0,0,0);this._hp--;if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{this._tempParams[DTempParamIndex.BOSS_UFO_HURT_TICK]=DAI.BOSS_UFO_HURT_TICK}}}break;case DClassID.RANDOMBONUS:if(v==DEvent.BE_ATTACKED){if(this._subState==DState.SS_RANDOMBONUS_B_IDLE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BREAK,0);this._phyFlags&=~(DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER);var J=a.CreateDynamicEntity(DClassID.RANDOMBONUS,DAnimID.BONUS_RANDOM_BONUS_EIDOLON_APPEAR,this._posX,this._posY+DAI.RANDOMBONUS_BONUS_APPEAR_DELTAY,0,0,10);J.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_APPEAR,0)}}else{if(v==DEvent.INACTIVE||v==DEvent.DESTROY){if(this._subState==DState.SS_RANDOMBONUS_BONUS_FLY||this._subState==DState.SS_RANDOMBONUS_BONUS_GOT||this._subState==DState.SS_RANDOMBONUS_BONUS_APPEAR){if(a._boss!=null){a._boss._relateEntity=this;this.StateMachineModifyStatus(DFSM.CSF_INVISIBLE);this._posX=a._camX-DEF.TILE_W_FLOAT;this._vX=0;return DEvent.RESULT_CANCEL}}}}break;case DClassID.COTTONCLOUD:if(v==DEvent.ENTITY_DROP_ON){if(this._subState==DState.SS_COTTON_IDLE&&E._classID==DClassID.HERO){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);var p=this._params[DParamIndex.COTTONCLOUD_LINK];if(p>=0){var J=a.GetEntityByID(p,true);if(J!=null&&J._subState==DState.SS_COTTON_DASHED){J.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_COTTON_APPEARING,0)}}}}break;case DClassID.BALANCE:if(v==DEvent.ENTITY_DROP_ON&&this._params[DParamIndex.BALANCE_TYPE]==DValueList.BALANCE_TYPE_NORMAL){if(E._classID==DClassID.BONUS){return u}var f=this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY];var H=Math_DegreeToFixedPointAngle(3);var I=this._tempParams[DTempParamIndex.BALANCE_ANGLE];var e=this._posX+Math_FixedPoint_Multiply(DAI.BALANCE_HEIGHT,Math_Tan(I));H=(E._posX-e)*H/Math_IntToFixedPoint(this._params[DParamIndex.BALANCE_RADIUS]);var z=H;if(E._lastPhyStandOn!=E._id){f=z<<1}f+=z;this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY]=f}break;case DClassID.BOSS_WITCH:if(E!=null&&(E._classID==DClassID.STONE|E._classID==DClassID.HERO)&&this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK)){this._hp--;this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_HURT,0);if(E._classID==DClassID.STONE){E.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEARING,0)}}break}return u};a.GetStateFlow=function(d){return DStateFlow.StateFlow[d]};a.prototype.InitAI=function(l){var v=false;var f=null;var G=null;var z=DEF.TILE_H_FLOAT;var w;if(this._animationPlayer!=null&&this._animationPlayer.GetNbanim()>this._params[DParamIndex.ANIMID]){this.SetAnim(this._params[DParamIndex.ANIMID],0)}this.StateMachineSetStateFlow(null,0);this._zOrder=Z.DEFAULT;var B=Z.ZMap.length;for(w=0;w<B;w+=2){if(Z.ZMap[w]==this._classID){this._zOrder=Z.ZMap[w+1];break}}this._zOrderAI=Z.DEFAULT_AI;var h=Z.ZMap_AI.length;for(w=0;w<h;w+=2){if(Z.ZMap_AI[w]==this._classID){this._zOrderAI=Z.ZMap_AI[w+1];break}}switch(this._classID){case DClassID.BOSS_EATER:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSFLOWEREATER),DFSM.SSF_MATCH_ANIM);if(this._subState!=DState.SS_BOSS_FLOWEREATER_SCAPE_IDLE){this._hp=5;this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_BOSS|DFlags.EX_CAN_STANDON;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK}break;case DClassID.BOSS_OCTOPUS:this._hp=5;v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSOCTOPUS),DFSM.SSF_MATCH_ANIM);this._exFlags|=DFlags.EX_BOSS;break;case DClassID.BOSS_OCTOPUS_HEAD:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSOCTOPUS_HEAD),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.MULTI_BOUNDING_BOX|DFlags.BE_ATTACK_COMPUTE);this._phyFlags|=DFlags.PHY_BLOCK_TOPUNDER|DFlags.PHY_BLOCK_FRONTBACK;this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CAN_STANDON;break;case DClassID.BOSS_OCTOPUS_TENTACLE:v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_TENTACLE),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.INVISIBLE);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONT;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE|DFlags.EX_ENEMY|DFlags.EX_CANNOT_HIT_BY_BULLET;break;case DClassID.INK_BOMB:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_INKBOMB),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY|DFlags.INVISIBLE);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CANNOT_HIT_BY_BULLET;break;case DClassID.BOSS_KILLERBEE:this._hp=5;v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSKILLERBEE),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_1||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_2||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1||this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2){this._exFlags|=DFlags.EX_ENEMY}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_FLY,0);this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_BOSS}break;case DClassID.BOSS_UFO:this._hp=5;v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSUFO),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_UFO_ATTACK1_MOVE_TO_ORIGINAL,0);this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_BOSS;break;case DClassID.UFO_DESTROY:this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this._zOrderAI=Z.DEFAULT_FULL_COLLIDED_AI;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_UFOEXPLODE),DFSM.SSF_MATCH_ANIM);break;case DClassID.BOSS_WITCH:this._hp=5;v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSWITCH),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.CUSTOM_VELOCITY);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this._exFlags|=DFlags.EX_ENEMY;this.ClearFlag(DFlags.INVISIBLE);break;case DClassID.BOSS_WITCH_EX_PART:this._hp=3;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BOSSWITCHBODYPART),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_BOSS;if(this._params[DParamIndex.BOSS_WITCH_EX_PART_EX_PART_TYPE]==DValueList.BOSS_WITCH_EX_PART_TYPE_DRAGON){this._zOrder=Z.DEFAULT+1}else{if(this._params[DParamIndex.BOSS_WITCH_EX_PART_EX_PART_TYPE]==DValueList.BOSS_WITCH_EX_PART_TYPE_SHIELD){this._zOrder=Z.BOSS_WITCH+1}}break;case DClassID.HERO:a._hero=this;f=a.GetStateFlow(DStateFlowID.STATEFLOW_HERO);a._bullet=LowAPI.Gen_Array([DAI.BULLET_MAX_NUM],null);for(var u=0;u<DAI.BULLET_MAX_NUM;u++){a._bullet[u]=a.CreateDynamicEntity(DClassID.BULLET,DAnimID.EFFECT_MAGIC,this._posX,this._posY,DFlags.COLLIDING_WITH_SEGMENT|DFlags.ACTIVE_BY_TRIGGER,0,0);if(a._bullet[u]!=null){a._bullet[u]._params[DParamIndex.FLAGS]&=~DFlags.DYNAMIC_CREATE;a._bullet[u].ClearFlag(DFlags.DYNAMIC_CREATE)}}for(w=a._HeroParams.length-1;w>=0;w--){if(w!=DAI.HPI_LIVES){a._HeroParams[w]=0}}a._HeroInStateFlags=0;a._HeroInvincibilityFrame=0;a._HeroInStateKey=0;a._HeroKickableEntity=null;a._HeroPoweredBullet=false;a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE);a._HeroIce=null;this._tempParams[DTempParamIndex.HERO_MINIGAME_RESULT]=0;break;case DClassID.CAMERA:a.SetCurrentCamera(this);this.InitTrace(this._params[DParamIndex.CAMERA_TRACE]);this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_CAMERA),0);if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_HERO_BLOCK){this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags=this._params[DParamIndex.CAMERA_LIMIT]&~DValueList.CAMERA_LIMIT_BOTTOM}if(this._curTrace>0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RUN,0);this._posX=this._posX-DEF.VIEW_W_D2_FLOAT;this._posY=this._posY-DEF.VIEW_H_D2_FLOAT;this._destX=this._posX;this._destY=this._posY;if(this._params[DParamIndex.CAMERA_TYPE]!=DValueList.CAMERA_TYPE_MOVE_HORIZONTAL&&this._params[DParamIndex.CAMERA_TYPE]!=DValueList.CAMERA_TYPE_MOVE_VERTICAL){this._params[DParamIndex.POSX]=a._cameraDefault._params[DParamIndex.POSX];this._params[DParamIndex.POSY]=a._cameraDefault._params[DParamIndex.POSY];this._params[DParamIndex.CAMERA_WIDTH]=a._cameraDefault._params[DParamIndex.CAMERA_WIDTH];this._params[DParamIndex.CAMERA_HEIGHT]=a._cameraDefault._params[DParamIndex.CAMERA_HEIGHT]}this._exFlags|=DFlags.EX_CAN_CRUSH_HERO;this._phyFlags&=~DFlags.PHY_BLOCK_TOPUNDER}break;case DClassID.BULLET:f=a.GetStateFlow(DStateFlowID.STATEFLOW_BULLET);break;case DClassID.MOBS_WHITE:v=true;this._exFlags|=DFlags.EX_ENEMY;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY);switch(this._params[DParamIndex.MOBS_WHITE_TYPE]){case DValueList.MOBS_MOUSE_TYPE_NORMAL:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_WHITE);break;case DValueList.MOBS_MOUSE_TYPE_RED:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_RED);this._sprite.SetCurrentPalette(1);break;case DValueList.MOBS_MOUSE_TYPE_THIEF:this._hp=3;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_THIEF);break;case DValueList.MOBS_MOUSE_TYPE_HAT:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_WHITE);break;case DValueList.MOBS_MOUSE_TYPE_SHIELD:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_SHIELD);this._phyFlags|=DFlags.PHY_BLOCK_FRONTBACK;this._phyFlags&=~DFlags.PHY_COLLIDE_FRONTBACK;break;case DValueList.MOBS_MOUSE_TYPE_PIRATE:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_WHITE);break;case DValueList.MOBS_MOUSE_TYPE_DEATH_PIRATE:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_DEATHPIRATE);break;case DValueList.MOBS_MOUSE_TYPE_BLOW:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_BLOW);break;case DValueList.MOBS_MOUSE_TYPE_LIGHT:this._hp=1;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_LIGHT);break}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetFlipForReversalGravity(true)}break;case DClassID.BONUS:if(this.CheckFlag(DFlags.GRAVITY)){this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_SEGMENT)}if(this._params[DParamIndex.BONUS_TYPE]==DValueList.BONUS_TYPE_SWORD_FISH){this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_SEGMENT)}for(w=0;w<3;w++){if(this._params[DParamIndex.BONUS_SATELLITE1+w]>0){this.SetFlag(DFlags.CUSTOM_VELOCITY)}}this._zOrderAI=Z.DEFAULT_FULL_COLLIDED_AI;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BONUS),DFSM.SSF_MATCH_ANIM);this._params[DParamIndex.BONUS_CLONE_X]=Math.max(this._params[DParamIndex.BONUS_CLONE_X],1);this._params[DParamIndex.BONUS_CLONE_Y]=Math.max(this._params[DParamIndex.BONUS_CLONE_Y],1);if(!this.CheckFlag(DFlags.ACTIVE_BY_TRIGGER)){if(this._params[DParamIndex.BONUS_CLONE_X]>1||this._params[DParamIndex.BONUS_CLONE_Y]>1){while(DEvent.RESULT_OK==this.NotifyEvent(this,DEvent.BE_TRIGGERED,DEvent.ACTION_ACTIVE_NEXT,0,0)){}}}if(this._params[DParamIndex.BONUS_TRACE]>0){this.InitTrace(this._params[DParamIndex.BONUS_TRACE])}break;case DClassID.PHYFIELD:this.SetFlag(DFlags.COLLIDING_WITH_HERO);break;case DClassID.JELLY:this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO);f=a.GetStateFlow(DStateFlowID.STATEFLOW_JELLY);break;case DClassID.LEAF:this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO);f=a.GetStateFlow(DStateFlowID.STATEFLOW_LEAF);break;case DClassID.STONE:this._hp=2;this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CAN_STANDON|DFlags.EX_CAN_TRANSPORT|DFlags.EX_CAN_CRUSH_HERO;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE|DFlags.PHY_BLOCK_FRONTBACK;this._phyFlags|=DFlags.PHY_COLLIDE_UNDERSIDE;f=a.GetStateFlow(DStateFlowID.STATEFLOW_STONE);break;case DClassID.HINT:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_HINT),DFSM.SSF_MATCH_ANIM);if(this._stateFlow==null){this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_HINT),DFSM.SSF_MATCH_ANIM);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_HINT_DUMMY,0)}break;case DClassID.CHECK_POINT:f=a.GetStateFlow(DStateFlowID.STATEFLOW_CHECKPOINT);break;case DClassID.DOOR:var u=0;if((this._params[DParamIndex.DOOR_TRANSPORT_WORLD]>0)&&(this._params[DParamIndex.DOOR_TRANSPORT_WORLD]<DAI.FINAL_WORLD)){while(true){if((this._params[DParamIndex.DOOR_TRANSPORT_WORLD]>>u)==1){break}u++}this.SetAnim(this._params[DParamIndex.DOOR_ANIMID]-DAI.TRANSPORT_DOOR_CLOSE_ANIM_OFFSET-u,0)}this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_DOOR),DFSM.SSF_MATCH_ANIM);if(this._params[DParamIndex.DOOR_TRANSPORT_WORLD]>0){this.SetAnim(this._params[DParamIndex.DOOR_ANIMID],0)}if((this._params[DParamIndex.DOOR_LINK]==-1)&&(this._params[DParamIndex.DOOR_TRANSPORT_WORLD]==0)){this.SetFlag(DFlags.INVISIBLE)}if(this._params[DParamIndex.DOOR_LINK]<-1){if(this._subState==DState.SS_IDLE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_GO_DOWN,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_INSCENE_GO_DOWN,0)}}break;case DClassID.DOOR_EFFECT:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_DOOR_EFFECT),DFSM.SSF_MATCH_ANIM);this.StateMachineModifyStatus(DFSM.CSF_INVISIBLE);break;case DClassID.RANDOMBONUS:this._exFlags|=DFlags.EX_USE_AFRAME_OX_OY;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_RANDOMBONUS),DFSM.SSF_MATCH_ANIM);if(this._subState==DState.SS_RANDOMBONUS_BONUS_APPEAR||this._subState==DState.SS_RANDOMBONUS_BONUS_FLY){this._zOrder=Z.BONUS+1;this._tempParams[DAI.SVI_RANDOMBONUS_BONUS_COUNTER]=3}else{if(this._subState==DState.SS_RANDOMBONUS_IDLE){if(this.CheckFlag(DFlags.COLLIDING_WITH_SEGMENT)){this._zOrderAI=Z.DEFAULT_FULL_COLLIDED_AI}}else{this._phyFlags|=DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER;this._exFlags|=DFlags.EX_CAN_STANDON;this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._zOrderAI=Z.DEFAULT_COLLIDED_HERO_AI}}break;case DClassID.HIT_BONUS:this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CAN_STANDON;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE|DFlags.PHY_BLOCK_FRONTBACK;this.SetFlag(DFlags.COLLIDING_WITH_HERO);f=a.GetStateFlow(DStateFlowID.STATEFLOW_HITBONUS);break;case DClassID.SPAWN_POINT:f=a.GetStateFlow(DStateFlowID.STATEFLOW_SPAWNPOINT);this.StateMachineSetStateFlow(f,0);this.SetAnim(0,0);if(this._params[DParamIndex.SPAWN_POINT_MAXCOUNT]>0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_SPAWNPOINT_SPAWN,0)}this.SetFlag(this._params[DParamIndex.FLAGS]);break;case DClassID.MOBS_BEE:this._exFlags|=DFlags.EX_ENEMY;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO);this.ClearFlag(DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY);this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_BEE),0);if(this._params[DParamIndex.MOBS_BEE_TRACE]>0){this.InitTrace(this._params[DParamIndex.MOBS_BEE_TRACE]);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOVE_WITH_TRACE,0)}else{if(this._params[DParamIndex.MOBS_BEE_TRACE]==DAI.NON_TRACE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BEE_WITHNOT_TRACE,0)}}break;case DClassID.MOBS_UFO:this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CAN_STANDON|DFlags.EX_CAN_TRANSPORT|DFlags.EX_CANNOT_HIT_BY_BULLET;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_HERO);f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_UFO);if(this._params[DParamIndex.MOBS_UFO_TRACE]>0){this._subState=DState.SS_MOVE_WITH_TRACE;this.InitTrace(this._params[DParamIndex.MOBS_UFO_TRACE]);this.StateMachineSetStateFlow(f,0);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOVE_WITH_TRACE,0)}break;case DClassID.PLATFORM:f=a.GetStateFlow(DStateFlowID.STATEFLOW_PLATFORM);this._exFlags|=DFlags.EX_USE_AFRAME_OX_OY|DFlags.EX_CAN_TRANSPORT|DFlags.EX_CAN_CRUSH_HERO;this.InitTrace(this._params[DParamIndex.PLATFORM_TRACE]);if(this._params[DParamIndex.PLATFORM_SATELLITE]!=-1){this.SetFlag(DFlags.CUSTOM_VELOCITY);var s=a.GetEntityByID(this._params[DParamIndex.PLATFORM_SATELLITE],true)}if(this._params[DParamIndex.PLATFORM_SEGMENT_ID]<0){if(this.CheckFlag(DFlags.FLIP_Y)){this.ClearFlag(DFlags.FLIP_Y);this.UpdateBoundingBox();this._boundingBox[DEF.BOX_TOP]=this._boundingBox[DEF.BOX_BOTTOM]}this._params[DParamIndex.PLATFORM_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox);this.UpdateBoundingBox();if(this._params[DParamIndex.PLATFORM_PROPERTY]==DValueList.PLATFORM_PROPERTY_BINDING){CGame._segmentParams[this._params[DParamIndex.PLATFORM_SEGMENT_ID]]|=DFlags.PHY_SEG_BINDING}}if(this.CheckFlag(DFlags.FLIP_Y)){this.ClearFlag(DFlags.FLIP_Y)}if(this._params[DParamIndex.PLATFORM_TYPE]==DValueList.PLATFORM_TYPE_MOVING){this.StateMachineSetStateFlow(f,0);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RUN,0)}break;case DClassID.DECOR:if((this._params[DParamIndex.DECOR_PARAM]&DValueList.DECOR_PARAM_MOVING_WITH_BTM)!=0){this.SetFlag(DFlags.ACTIVE_BY_TRIGGER)}this._params[DParamIndex.DECOR_CLONE_X]=Math.max(this._params[DParamIndex.DECOR_CLONE_X],1);this._params[DParamIndex.DECOR_CLONE_Y]=Math.max(this._params[DParamIndex.DECOR_CLONE_Y],1);if(this._params[DParamIndex.DECOR_PARAM]==DValueList.DECOR_PARAM_RANDOM_FRAME){if(this._animationPlayer!=null){this._animationPlayer.SetFrame(Math_Rand(0,this._animationPlayer.GetNbFrame()))}}this._zOrder=this._params[DParamIndex.DECOR_Z_ORDER];break;case DClassID.HALO:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_HALO),DFSM.SSF_MATCH_ANIM);break;case DClassID.COTTONCLOUD:this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_COTTONCLOUD),0);if(this._params[DParamIndex.ANIMID]==DAnimID.CLOUD_APPEAR){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_COTTON_DASHED,0)}break;case DClassID.CANNON:this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE|DFlags.PHY_BLOCK_FRONTBACK;this._exFlags|=DFlags.EX_CAN_STANDON;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_CANNON),0);var e=this._params[DParamIndex.CANNON_LINK];if(e>=0){var E=a.GetRowDataByID(e);if(E!=null){E[DParamIndex.FLAGS]|=DFlags.ACTIVE_BY_TRIGGER}var n=a.GetEntityByID(e,true);if(n!=null){n.ClearFlag(DFlags.GRAVITY);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNON_IDLE,0)}}break;case DClassID.TRACE_CANNON:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_TRACECANNON),0);break;case DClassID.TRACE_CANNON_BALL:this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._exFlags|=DFlags.EX_ENEMY;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_TRACECANNONBALL),0);break;case DClassID.CANNONBALL:this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._exFlags|=DFlags.EX_CAN_STANDON|DFlags.EX_CAN_TRANSPORT;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_CANNONBALL),0);break;case DClassID.EXPLOSION:this._hp=1;this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_EXPLOSION),0);break;case DClassID.SEAGULL:this._exFlags|=DFlags.EX_SEGMENT|DFlags.EX_CAN_TRANSPORT;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO);this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_SEAGULL),0);if(this._params[DParamIndex.SEAGULL_SEGMENT_ID]<=0){this._params[DParamIndex.SEAGULL_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox)}this._exFlags|=DFlags.EX_USE_AFRAME_OX_OY;this.InitTrace(this._params[DParamIndex.SEAGULL_TRACE]);break;case DClassID.TRANSMISSION:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_TRANSMISSION),0);if(this._params[DParamIndex.TRANSMISSION_VX]>0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TRANSMISSION_CLOCKWISE,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TRANSMISSION_ANTICLOCKWISE,0)}if(this._params[DParamIndex.TRANSMISSION_SATELLITE]!=-1){this.SetFlag(DFlags.CUSTOM_VELOCITY);var s=a.GetEntityByID(this._params[DParamIndex.TRANSMISSION_SATELLITE],true)}this._exFlags|=DFlags.EX_SEGMENT|DFlags.EX_CAN_TRANSPORT;this._phyFlags|=DFlags.PHY_BLOCK_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_HERO);if(this._params[DParamIndex.TRANSMISSION_SEGMENT_ID]<=0){this._params[DParamIndex.TRANSMISSION_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox)}break;case DClassID.REEF:this.CreateCloneEntity(DParamIndex.REEF_CLONE_X);break;case DClassID.FIRE:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_FIRE),0);break;case DClassID.MOBS_MONSTERINCHEST:v=true;this._hp=a.MonsterchestGetHP(this._id);this._exFlags|=DFlags.EX_ENEMY|DFlags.EX_CAN_STANDON;this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY);this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_MONSTERINCHEST),0);if(this._params[DParamIndex.ANIMID]==0){this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE|DFlags.PHY_BLOCK_FRONTBACK;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_BONUS,0)}else{this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_IDLE,0)}break;case DClassID.LAYERSTONE:this._exFlags|=DFlags.EX_SEGMENT|DFlags.EX_CAN_TRANSPORT;this._phyFlags|=DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_HERO);if(this._params[DParamIndex.LAYERSTONE_SEGMENT_ID]<0){this._params[DParamIndex.LAYERSTONE_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox)}this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_LAYERSTONE),0);this.CreateCloneEntity(DParamIndex.LAYERSTONE_CLONE_X);break;case DClassID.ROLLING_PLATFORM:this.SetFlag(DFlags.CUSTOM_VELOCITY);this.InitTrace(this._params[DParamIndex.ROLLING_PLATFORM_TRACE]);if(this._params[DParamIndex.ROLLING_PLATFORM_TYPE]==DValueList.ROLLING_PLATFORM_TYPE_AUTO){if(this.IsFlipX()){this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY]=Math_FixedPoint_DegreesToAngleFixedPoint(this._params[DParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY])/DAI.PARAM_ANGULAR_VELOCITY_BASE}else{this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY]=Math_FixedPoint_DegreesToAngleFixedPoint(this._params[DParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY])/DAI.PARAM_ANGULAR_VELOCITY_BASE}}var k=0;for(w=0;w<4;w++){var n=this._params[DParamIndex.ROLLING_PLATFORM_PLATFORM1+w];if(n>0){var F=a.GetEntityByID(n,true);if(F!=null){F.SetFlag(DFlags.ACTIVE_BY_TRIGGER)}k++}}this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE_STEP]=Math_Angle360/k;break;case DClassID.TRANSFORM_PLATFORM:this.SetFlag(DFlags.CUSTOM_VELOCITY);f=a.GetStateFlow(DStateFlowID.STATEFLOW_TRANSFORM_PLATFORM);this._params[DParamIndex.TRANSFORM_PLATFORM_CLONE_X]=Math.max(this._params[DParamIndex.BONUS_CLONE_X],1);var r=this._params[DParamIndex.TRANSFORM_PLATFORM_CLONE_X];var d=r>>1;this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X]=this._params[DParamIndex.POSX]+((r/2)*this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX]);var p=this._params[DParamIndex.POSX];var o=this._params[DParamIndex.POSY];var A=Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX]);var m=0;if(this.CheckFlag(DFlags.FLIP_Y)){m=DFlags.FLIP_Y;this.ClearFlag(DFlags.FLIP_Y)}for(w=0;w<r;w++){var E=LowAPI.Gen_Array([DParamIndex.PLATFORM_HEIGHT+1],0);o=((p-this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X])*Math_Sin(A)/Math_Cos(A));o+=this._params[DParamIndex.POSY];E[DParamIndex.POSX]=p;E[DParamIndex.POSY]=o;E[DParamIndex.ANIMID]=this._params[DParamIndex.ANIMID];if(d==w){E[DParamIndex.ANIMID]=DAnimID.ACTOR_PLATFORM_FLEX_PF_CENTER}E[DParamIndex.FLAGS]=(DFlags.ACTIVE_BY_TRIGGER|m);E[DParamIndex.EX_FLAGS]=DFlags.EX_SEGMENT;E[DParamIndex.PLATFORM_SEGMENT_ID]=-1;E[DParamIndex.PLATFORM_TYPE]=DValueList.PLATFORM_TYPE_MOVING;E[DParamIndex.PLATFORM_TRACE]=-1;E[DParamIndex.PLATFORM_SATELLITE]=-1;E[DParamIndex.PLATFORM_PROPERTY]=DValueList.PLATFORM_PROPERTY_NORMAL;var D=a.CreateDynamicEntity(E,DClassID.PLATFORM,E[DParamIndex.ANIMID],Math_IntToFixedPoint(E[DParamIndex.POSX]),Math_IntToFixedPoint(E[DParamIndex.POSY]),E[DParamIndex.FLAGS]);this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_INDEX_START+w]=D._params[DParamIndex.ID];if(d==w){D._zOrder++;a.UpdateDrawList(D)}p+=this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX]}this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X]=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X]);this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE]=Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX]);this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX]);break;case DClassID.LIGHTINGBALL:this.InitTrace(this._params[DParamIndex.LIGHTINGBALL_TRACE]);this._params[DParamIndex.LIGHTINGBALL_CLONE_X]=Math.max(this._params[DParamIndex.LIGHTINGBALL_CLONE_X],1);this._params[DParamIndex.LIGHTINGBALL_CLONE_Y]=Math.max(this._params[DParamIndex.LIGHTINGBALL_CLONE_Y],1);break;case DClassID.MOBS_FLY:this._exFlags|=DFlags.EX_ENEMY;this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_FLY);this.InitTrace(this._params[DParamIndex.MOBS_FLY_TRACE]);break;case DClassID.MOBS_DANDELIONBOMB:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_DANDELION),DFSM.SSF_MATCH_ANIM);this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ENEMY;break;case DClassID.MOBS_BARREL:v=true;f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_BARREL);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY);this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE|DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE|DFlags.PHY_BLOCK_FRONTBACK;this._exFlags|=DFlags.EX_CAN_STANDON|DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;break;case DClassID.MOBS_ACALEPH:f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_ACALEPH);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;break;case DClassID.MOBS_BALLOONFISH:f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_BALLONFISH);this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;break;case DClassID.MOBS_ROLLING_STARFISH:f=a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_STARFISH);this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;this.InitTrace(this._params[DParamIndex.MOBS_ROLLING_STARFISH_TRACE]);break;case DClassID.MOBS_SHELL:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_SHELL),0);this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;if(this._params[DParamIndex.ANIMID]==DAnimID.MOBS_SHELL_BULLET){this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._zOrderAI=Z.DEFAULT_COLLIDED_HERO_AI;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_SHELL_BULLET,0)}break;case DClassID.MOBS_FIRE:v=true;this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MOBS_FIRE),0);this.SetFlag(DFlags.COLLIDING);this._phyFlags|=DFlags.PHY_COLLIDE_TOPUNDER|DFlags.PHY_COLLIDE_FRONTBACK;this._exFlags|=DFlags.EX_ATTACK_HERO_WHEN_COLLIDE;break;case DClassID.OBJ_DAMAGE_STONE:this.InitTrace(this._params[DParamIndex.OBJ_DAMAGE_STONE_TRACE]);this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_DAMAGE_STONE),0);this._exFlags|=DFlags.EX_CAN_STANDON|DFlags.EX_CAN_TRANSPORT;this._exFlags|=DFlags.EX_CAN_CRUSH_HERO;this._phyFlags|=DFlags.PHY_BLOCK_TOPUNDER|DFlags.PHY_BLOCK_FRONTBACK;this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT);break;case DClassID.BALANCE:this._exFlags|=DFlags.EX_SEGMENT|DFlags.EX_CAN_TRANSPORT;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.CUSTOM_VELOCITY);this.SetFlag(DFlags.COLLIDING_WITH_HERO);if(this._params[DParamIndex.BALANCE_SEGMENT_ID]<=0){this._params[DParamIndex.BALANCE_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox)}else{var C=this._params[DParamIndex.BALANCE_SEGMENT_ID];this._params[DParamIndex.BALANCE_SEGMENT_ID]=-1;this.UpdateBoundingBox();this._params[DParamIndex.BALANCE_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox,C)}break;case DClassID.EFFECT_WATER:this.SetFlag(DFlags.INVISIBLE);break;case DClassID.WATER:break;case DClassID.VIRTUALBLOCK:this._phyFlags=this._params[DParamIndex.VIRTUALBLOCK_PHYFLAGS];this._exFlags=DFlags.EX_CAN_STANDON|DFlags.EX_CAN_TRANSPORT;this.SetFlag(DFlags.COLLIDING_WITH_HERO);break;case DClassID.TRIGGER:f=a.GetStateFlow(DStateFlowID.STATEFLOW_TRIGGER);break;case DClassID.ELECTRIC_FIELD:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_ELECTRIC_FIELD),0);break;case DClassID.ELECTRIC_DEVICE:f=a.GetStateFlow(DStateFlowID.STATEFLOW_ELECTRIC_DEVICE);break;case DClassID.BLACK_HOLE:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_BLACK_HOLD),0);this._phyFlags|=DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER;this.SetFlag(DFlags.COLLIDING_WITH_HERO);this.SetFlag(DFlags.CUSTOM_VELOCITY);if(this._params[DParamIndex.BLACK_HOLE_TYPE]==DValueList.BLACK_HOLE_TYPE_CLOCKWISE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BLACK_HOLE_CLOCKWISE,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BLACK_HOLE_ANTICLOCKWISE,0)}this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]=this._params[DParamIndex.BLACK_HOLE_CIRCLES];if(this._params[DParamIndex.BLACK_HOLE_SATELLITE]!=-1){this.SetFlag(DFlags.CUSTOM_VELOCITY);var s=a.GetEntityByID(this._params[DParamIndex.BLACK_HOLE_SATELLITE],true)}break;case DClassID.LIGHTINGBALL_CENTER:for(w=DParamIndex.LIGHTINGBALL_CENTER_SATELLITE1;w<=DParamIndex.LIGHTINGBALL_CENTER_SATELLITE4;w++){if(this._params[w]!=-1){this.SetFlag(DFlags.CUSTOM_VELOCITY);var s=a.GetEntityByID(this._params[w],true)}}break;case DClassID.FLY_CANNON:this.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_MINIGAMECANNON),0);this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._exFlags|=DFlags.EX_CAN_STANDON;this._phyFlags|=DFlags.PHY_BLOCK_TOPUNDER|DFlags.PHY_BLOCK_FRONTBACK;break;case DClassID.WOOD_PLATFORM:this._exFlags|=DFlags.EX_SEGMENT|DFlags.EX_CAN_STANDON;this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this.SetFlag(DFlags.COLLIDING_WITH_HERO);if(this._params[DParamIndex.WOOD_PLATFORM_SEGMENT_ID]<=0){this._params[DParamIndex.WOOD_PLATFORM_SEGMENT_ID]=a.CreatePlatformSegment(this._boundingBox)}break}if(this.CheckExFlag(DFlags.EX_BOSS)){this.InitBoss()}if(this._stateFlow==null){this.StateMachineSetStateFlow(f,0)}this.StateMachineSetCurrentSequence(G,0);v=v&&(this._params[DParamIndex.MOVE_AREA]<=0||this._params[DParamIndex.MOVE_AREA+1]<=0||this._params[DParamIndex.MOVE_AREA+2]<=0||this._params[DParamIndex.MOVE_AREA+3]<=0);if(v){this._params[DParamIndex.MOVE_AREA+2]+=this._params[DParamIndex.MOVE_AREA+0];this._params[DParamIndex.MOVE_AREA+3]+=this._params[DParamIndex.MOVE_AREA+1];this._params[DParamIndex.MOVE_AREA]+=this._posX>>DEF.SHIFT;this._params[DParamIndex.MOVE_AREA+1]+=this._posY>>DEF.SHIFT;this._params[DParamIndex.MOVE_AREA+2]+=this._posX>>DEF.SHIFT;this._params[DParamIndex.MOVE_AREA+3]+=this._posY>>DEF.SHIFT;if(this._params[DParamIndex.MOVE_AREA]>this._params[DParamIndex.MOVE_AREA+2]){var q=this._params[DParamIndex.MOVE_AREA];this._params[DParamIndex.MOVE_AREA]=this._params[DParamIndex.MOVE_AREA+2];this._params[DParamIndex.MOVE_AREA+2]=q}if(this._params[DParamIndex.MOVE_AREA+1]>this._params[DParamIndex.MOVE_AREA+3]){var q=this._params[DParamIndex.MOVE_AREA+1];this._params[DParamIndex.MOVE_AREA+1]=this._params[DParamIndex.MOVE_AREA+3];this._params[DParamIndex.MOVE_AREA+3]=q}switch(this._classID){case DClassID.BOSS_KILLERBEE:if(this._subState!=DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_1&&this._subState!=DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_2&&this._subState!=DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1&&this._subState!=DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2){this._posY=this._params[DParamIndex.BOSS_KILLERBEE_AREATOP]<<DEF.SHIFT;if(this.IsFlipX()){this._posX=this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT]<<DEF.SHIFT}else{this._posX=this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]<<DEF.SHIFT}}break}}};a.SEF_I_FACE_TO=1<<0;a.SEF_BOX_COLLIDE_Y=1<<1;a.SEF_RUN_TO_ME=1<<2;a.prototype.ScanEntity=function(d,f,e,j){var h=a.root;var i=a.root;while(true){h=i;if(h==null){break}i=i.next;if(h.CheckExFlag(DFlags.EX_SEGMENT)){continue}if(h._classID==f){if(e>=0&&e!=h._state+h._subState){continue}if(Math.abs(this._posX-h._posX)>j){continue}if((d&a.SEF_I_FACE_TO)!=0){if(this.IsFlipX()!=h._posX<this._posX){continue}}if((d&a.SEF_RUN_TO_ME)!=0){if(this.IsFlipX()!=h._vX>0){continue}}if((d&a.SEF_BOX_COLLIDE_Y)!=0){if(this._posY+this._boundingBox[DEF.BOX_TOP]>h._posY+h._boundingBox[DEF.BOX_BOTTOM]||h._posY+h._boundingBox[DEF.BOX_TOP]>this._posY+this._boundingBox[DEF.BOX_BOTTOM]){continue}}return h}}return null};a.prototype.CreateVirtualBlock=function(e,d){var h=LowAPI.Gen_Array([DParamIndex.VIRTUALBLOCK_PHYFLAGS+1],0);h[DParamIndex.VIRTUALBLOCK_AREALEFT]=((e[DEF.BOX_LEFT])>>DEF.SHIFT);h[DParamIndex.VIRTUALBLOCK_AREAWIDTH]=((e[DEF.BOX_RIGHT]-e[DEF.BOX_LEFT])>>DEF.SHIFT);h[DParamIndex.VIRTUALBLOCK_AREATOP]=((e[DEF.BOX_TOP])>>DEF.SHIFT);h[DParamIndex.VIRTUALBLOCK_AREAHEIGHT]=((e[DEF.BOX_BOTTOM]-e[DEF.BOX_TOP])>>DEF.SHIFT);h[DParamIndex.VIRTUALBLOCK_PHYFLAGS]=d;h[DParamIndex.VIRTUALBLOCK_OWNERID]=this._id;var f=a.CreateDynamicEntity(h,DClassID.VIRTUALBLOCK,0,this._posX,this._posY,0);if(f!=null){f._params[DParamIndex.FLAGS]&=~DFlags.DYNAMIC_CREATE;f.ClearFlag(DFlags.DYNAMIC_CREATE)}return f};a.prototype.EnableVirtualBlock=function(d){if(this._classID==DClassID.VIRTUALBLOCK){if(d){this._flags&=~DFlags.INVISIBLE}else{this._flags|=DFlags.INVISIBLE}if((this._flags&DFlags.INVISIBLE)==0){this._boundingBox[DEF.BOX_LEFT]=this._params[DParamIndex.VIRTUALBLOCK_AREALEFT]<<DEF.SHIFT;this._boundingBox[DEF.BOX_TOP]=this._params[DParamIndex.VIRTUALBLOCK_AREATOP]<<DEF.SHIFT;this._boundingBox[DEF.BOX_RIGHT]=(this._params[DParamIndex.VIRTUALBLOCK_AREALEFT]+this._params[DParamIndex.VIRTUALBLOCK_AREAWIDTH])<<DEF.SHIFT;this._boundingBox[DEF.BOX_BOTTOM]=(this._params[DParamIndex.VIRTUALBLOCK_AREATOP]+this._params[DParamIndex.VIRTUALBLOCK_AREAHEIGHT])<<DEF.SHIFT}else{this._boundingBox[DEF.BOX_LEFT]=0;this._boundingBox[DEF.BOX_RIGHT]=0;this._boundingBox[DEF.BOX_TOP]=0;this._boundingBox[DEF.BOX_BOTTOM]=0}}};a.prototype.SetReboundVelocity=function(s,q){var n=-q;var m=s;var e=n>>8;var d=m>>8;var o=Math_Sqrt((e*e)+(d*d));if(o==0){return}o<<=8;var r=Math_FixedPoint_Divide(n,o);var p=Math_FixedPoint_Divide(m,o);var k=-Math_FixedPoint_Multiply(Math_FixedPoint_Multiply(this._vX,r)+Math_FixedPoint_Multiply(this._vY,p),r);var i=-Math_FixedPoint_Multiply(Math_FixedPoint_Multiply(this._vX,r)+Math_FixedPoint_Multiply(this._vY,p),p);var l=this._vX+k;var j=this._vY+i;var h=2*l-this._vX;var f=2*j-this._vY;this._vX=h;this._vY=f};a.prototype.FaceTo=function(d){return this.IsFlipX()&&this._posX>=d._posX||!this.IsFlipX()&&this._posX<=d._posX};a.AddAndLimitVelocity=function(e,h,d,f){if(f){e-=a.GetVelocity(h);if(e<-d){e=-d}}else{e+=a.GetVelocity(h);if(e>d){e=d}}return e};a.AddAndLimitMaxVelocity=function(e,h,d,f){if(Math.abs(e)>d){return e}return a.AddAndLimitVelocity(e,h,d,f)};a.prototype.StateMachineGetAnim=function(d){switch(this._classID){case DClassID.HERO:if(this._state==DState.STATE_ONGROUND){switch(this._subState){case DState.SS_IDLE:if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DAnimID.HERO_NOMOVE_WAIT}break;case DState.SS_SHOOT:if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return a._HeroPoweredBullet?DAnimID.HERO_NOMOVE_LONG_SHOOT:DAnimID.HERO_NOMOVE_CLOSE_SHOOT}return a._HeroPoweredBullet?DAnimID.HERO_LONG_SHOOT:DAnimID.HERO_CLOSE_SHOOT;case DState.SS_COMBAT:if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DAnimID.HERO_NOMOVE_CLOSE_SHOOT}return DAnimID.HERO_CLOSE_SHOOT;case DState.SS_SMASH_FALL_SIT:if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DAnimID.HERO_FAT_FALL_HIP}break;case DState.SS_WALK:if(this.CheckIcePhysics()){return DAnimID.HERO_ICE_WALK}break;case DState.SS_SLOWDOWN:if(this.CheckIcePhysics()){return DAnimID.HERO_STOP_SNOW}break}}if(this._state==DState.STATE_INAIR){switch(this._subState){case DState.SS_SHOOT:return a._HeroPoweredBullet?DAnimID.HERO_LONG_SHOOT_INAIR:DAnimID.HERO_CLOSE_SHOOT_INAIR;case DState.SS_INAIR_SMASH_FALL:case DState.SS_INAIR_SMASH_FALL_HOLD:case DState.SS_INAIR_SMASH_FALL_SHAKE:if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DAnimID.HERO_FAT_FALL_HIP}break}}break;case DClassID.STONE:if(d){if(this._subState==DState.SS_APPEARING){this._tempParams[DTempParamIndex.STONE_ANIM]=a.GetRand(0,DAI.STONE_ANIM_COUNT-1)}}if(this._subState==DState.SS_APPEARING){return DAnimID.STONE_MOBS_STONE_1_APPEAR+this._tempParams[DTempParamIndex.STONE_ANIM]}if(this._subState==DState.SS_DISAPPEARING){return DAnimID.STONE_MOBS_STONE_1_DISAPPEAR+this._tempParams[DTempParamIndex.STONE_ANIM]}if(this._hp==1){return DAnimID.STONE_MOBS_STONE_1_BAD+this._tempParams[DTempParamIndex.STONE_ANIM]}return DAnimID.STONE_MOBS_STONE_1+this._tempParams[DTempParamIndex.STONE_ANIM];case DClassID.HINT:return this._params[DParamIndex.HINT_HINTID];case DClassID.PLATFORM:if(a._hero.CheckFlag(DFlags.REVERSAL_GRAVITY)&&this._params[DParamIndex.ANIMID]==DAnimID.ACTOR_PLATFORM_FLEX_PF_CENTER||this._params[DParamIndex.ANIMID]==DAnimID.ACTOR_PLATFORM_FLEX_PF_BLOCK){return this._subState==DState.SS_PLATFORM_SHAKE||this._subState==DState.SS_PLATFORM_HOLD_SHAKE?this._params[DParamIndex.ANIMID]+2:this._params[DParamIndex.ANIMID]}else{return this._subState==DState.SS_PLATFORM_SHAKE||this._subState==DState.SS_PLATFORM_HOLD_SHAKE?this._params[DParamIndex.ANIMID]+1:this._params[DParamIndex.ANIMID]}case DClassID.MOBS_WHITE:if(this._subState==DState.SS_DROP_OUT){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)||a._HurtByTentacle){return DAnimID.MOBS_WHITE_DIE_FLY}}break;case DClassID.DOOR:if(this._subState==DState.SS_IDLE||this._subState==DState.SS_DOOR_INSCENE_WAITE||this._subState==DState.SS_DOOR_CAN_ENTER||this._subState==DState.SS_DOOR_INSCENE_CAN_ENTER){return this._params[DParamIndex.ANIMID]}break}return DFSM.ANIM_NONE};a.prototype.StateMachineTranslateState=function(e,d){a._returnState=e;a._returnSubState=d;if(this._classID==DClassID.HERO){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)&&(e==DState.STATE_ONGROUND||e==DState.STATE_INAIR||e==DState.STATE_NO_CONTROL)){switch(d){case DState.SS_IDLE:case DState.SS_SLOWDOWN:a._returnSubState=DState.SS_FAT_IDLE;break;case DState.SS_INAIR_FALL:a._returnSubState=DState.SS_FAT_INAIR_FALL;break;case DState.SS_INAIR_JUMP_DIAG_START:case DState.SS_INAIR_JUMP_DIAG_PRE:case DState.SS_INAIR_JUMP_DIAG:a._returnSubState=DState.SS_FAT_INAIR_JUMP_DIAG;break;case DState.SS_INAIR_JUMP_VER_START:case DState.SS_INAIR_JUMP_VER_PRE:case DState.SS_INAIR_JUMP_VER:a._returnSubState=DState.SS_FAT_INAIR_JUMP_VER;break;case DState.SS_PRE_ROCKET:a._returnSubState=DState.SS_FAT_PRE_ROCKET;break;case DState.SS_INAIR_ROCKET:a._returnSubState=DState.SS_FAT_INAIR_ROCKET;break}}}return(a._returnState!=e)||(a._returnSubState!=d)};a.prototype.StateMachineNotifyEnter=function(f,m,y){var k=f+m;if(this.CheckExFlag(DFlags.EX_BOSS)){if(k==DFSM.FULLSTATE_DESTROY){CGame._playerInfo[DAI.HPI_LIVES]=a._HeroParams[DAI.HPI_LIVES];CGame._playerInfo[DAI.HPI_HP_MAX]=a._hero._hp;CGame.GotoNextLevel(true);return true}}switch(this._classID){case DClassID.HERO:if(this._state!=f){a._HeroInStateFlags=0;if(f==DState.STATE_SWIM){a._HeroOxygen=DAI.HERO_MAX_OXYGEN;var p=DAnimID.EFFECT_WATER_WATER;if((this._state==DState.STATE_INAIR&&this._stateElapsedTime>DAI.HERO_SWIM_FALL_IN_WATER_DURATION)||this.AI_Hero_IsSmash()){p=DAnimID.EFFECT_WATER_WATER_BIG}if(this._state!=DState.STATE_CHANGE){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,p,0,this._posX,this._posY-DAI.HERO_FALL_SWIM_DELTA_Y)}}}switch(k){case DState.STATE_INAIR+DState.SS_INAIR_FLOAT_UP:this._exFlags|=DFlags.EX_USE_AFRAME_OX_OY;break;case DState.STATE_INAIR+DState.SS_INAIR_JUMP_EXTEND_DIAG:case DState.STATE_INAIR+DState.SS_INAIR_JUMP_EXTEND_VER:a._HeroInStateFlags|=DAI.ISF_INAIR_HAS_EXTEND_JUMPED;this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_POSX]=this._posX;this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_POSY]=this._posY;this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FRAME_NUM]=0;break;case DState.STATE_INAIR+DState.SS_INAIR_JUMP_VER_PRE:case DState.STATE_INAIR+DState.SS_INAIR_JUMP_DIAG_PRE:if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,this._posX,this._posY)}}else{if(this.CheckPhysics(DFlags.PHY_SEG_WATER_SURFACE)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_WATER,0,this._posX,this._posY)}else{a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE,0,this._posX,this._posY)}}break;case DState.STATE_DIE+DState.SS_DIE_PREPARE:break;case DState.STATE_ONGROUND+DState.SS_RUN:var h=a.RENDER_TYPE_ANIMATION|a.RENDER_FLAG_POSITION_RELATIVE;if(this.IsFlipX()){h|=a.RENDER_FLAG_FLIPX}a.PrepareRender(h,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE_RUN,0,0,0);break}if(this._state==DState.STATE_INAIR){if(this._subState!=DState.SS_INAIR_JUMP_EXTEND_DIAG&&this._subState!=DState.SS_INAIR_JUMP_EXTEND_VER&&this._subState!=DState.SS_INAIR_JUMP_DIAG_START&&this._subState!=DState.SS_INAIR_JUMP_DIAG&&this._subState!=DState.SS_INAIR_ROCKCRAFT_JUMP&&this._subState!=DState.SS_INAIR_JUMP_VER_START&&this._subState!=DState.SS_INAIR_JUMP_VER&&this._subState!=DState.SS_INAIR_FLOAT_UP&&this._subState!=DState.SS_INAIR_FLOAT_FLY){a._HeroInStateKey=0}}break;case DClassID.HINT:if((m==DState.SS_HINT_BOOK_OPENED||m==DState.SS_HINT_BOOK_OPENED2)&&this._subState!=DState.SS_HINT_BOOK_DELAY_CLOSE&&(this._subState!=DState.SS_HINT_BOOK_OPENED&&this._subState!=DState.SS_HINT_BOOK_OPENED2)){this._relateEntity=a.CreateDynamicEntity(DClassID.HINT,DAnimID.HINT_HINT_SPREAD_OUT,this._posX,this._posY,0,0,this._params.length);this._relateEntity._zOrder=this._zOrder-1;a.UpdateDrawList(this._relateEntity);this._relateEntity._params[DParamIndex.HINT_HINTID]=this._params[DParamIndex.HINT_HINTID];this._relateEntity._params[DParamIndex.HINT_HERO_FRAME]=this._params[DParamIndex.HINT_HERO_FRAME];this._relateEntity._params[DParamIndex.HINT_CINEMATIC_LINK]=this._params[DParamIndex.HINT_CINEMATIC_LINK]}break;case DClassID.CHECK_POINT:if(m==DState.SS_CHECK_POINT_OPEN){if(a._hero._state!=DState.STATE_DIE){CGame.SaveCheckPoint(this._id,this._params[DParamIndex.CHECK_POINT_LINK],this._posX,this._posY)}}break;case DClassID.SPAWN_POINT:if(m==DState.SS_SPAWNPOINT_SPAWN){var t=null;var u=null;var x=0,r=0;switch(this._params[DParamIndex.SPAWN_POINT_TYPE]){case DValueList.SPAWN_TYPE_MOBS_WHITE:case DValueList.SPAWN_TYPE_MOBS_RED:case DValueList.SPAWN_TYPE_MOBS_THIEF:case DValueList.SPAWN_TYPE_MOBS_HAT:case DValueList.SPAWN_TYPE_MOBS_PIRATE:case DValueList.SPAWN_TYPE_MOBS_DEATH_PIRATE:case DValueList.SPAWN_TYPE_MOBS_SHIELD:r=0;x=2;u=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_IDLEINTERVAL+1],0);u[DParamIndex.MOBS_WHITE_TYPE]=(this._params[DParamIndex.SPAWN_POINT_TYPE]-r);u[DParamIndex.MOBS_WHITE_MODULE_MAP]=(this._params[DParamIndex.SPAWN_POINT_TYPE]-x);for(var q=0;q<4;q++){u[DParamIndex.MOVE_AREA+q]=this._params[DParamIndex.MOVE_AREA+q]}break;case DValueList.SPAWN_TYPE_MOBS_ACALEPH:case DValueList.SPAWN_TYPE_MOBS_BALLOONFISH:case DValueList.SPAWN_TYPE_MOBS_BLOW:u=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_IDLEINTERVAL+1],0);u[DParamIndex.MOBS_WHITE_MODULE_MAP]=(this._params[DParamIndex.SPAWN_POINT_TYPE]-x);for(var q=0;q<4;q++){u[DParamIndex.MOVE_AREA+q]=this._params[DParamIndex.MOVE_AREA+q]}break;case DValueList.SPAWN_TYPE_BONUS_FISH:u=LowAPI.Gen_Array([DParamIndex.BONUS_SATELLITE3+1],0);u[DParamIndex.BONUS_TYPE]=DValueList.BONUS_TYPE_SWORD_FISH;break;case DValueList.SPAWN_TYPE_MOBS_LIGHT:r=3;x=5;u=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_IDLEINTERVAL+1],0);u[DParamIndex.MOBS_WHITE_TYPE]=(this._params[DParamIndex.SPAWN_POINT_TYPE]-r);u[DParamIndex.MOBS_WHITE_MODULE_MAP]=(this._params[DParamIndex.SPAWN_POINT_TYPE]-x);for(var q=0;q<4;q++){u[DParamIndex.MOVE_AREA+q]=this._params[DParamIndex.MOVE_AREA+q]}break}switch(this._params[DParamIndex.SPAWN_POINT_TYPE]){case DValueList.SPAWN_TYPE_MOBS_ACALEPH:t=a.CreateDynamicEntity(u,DClassID.MOBS_ACALEPH,0,this._posX,this._posY,0);break;case DValueList.SPAWN_TYPE_MOBS_BALLOONFISH:t=a.CreateDynamicEntity(u,DClassID.MOBS_BALLOONFISH,0,this._posX,this._posY,0);break;case DValueList.SPAWN_TYPE_BONUS_FISH:t=a.CreateDynamicEntity(u,DClassID.BONUS,DAnimID.BONUS_FISH_2,this._posX,this._posY,0);break;default:t=a.CreateDynamicEntity(u,DClassID.MOBS_WHITE,0,this._posX,this._posY,0);if(this._params[DParamIndex.SPAWN_POINT_TYPE]==DValueList.SPAWN_TYPE_MOBS_LIGHT){t._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]=(30);t._params[DParamIndex.MOBS_WHITE_ACTIONINTERVAL]=(30)}break}if(t==null){break}if(this.IsFlipX()){t.TurnBack()}this._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]++;t._relateEntity=this}if(m==DState.SS_SPAWNPOINT_BEFORE_SPAWN){if(!this.InScreen()){return false}if((this._params[DParamIndex.FLAGS]&DFlags.INVISIBLE)==0){this.AI_Hint_ShowSoundEffect(DAnimID.HINT_ZAZING_,-1,-1)}}break;case DClassID.HIT_BONUS:var d=0;if(m==DState.SS_LINK1){d=3}else{if(m==DState.SS_LINK2){d=5}else{if(m==DState.SS_LINK3){d=10}else{if(m==DState.SS_DISAPPEAR){d=15}}}}var s=DAI.HP_BONUS_DROP_START_ANGLE;var v=0;var j=this._posX;var l=(a.GetBoxWidth(this._boundingBox)-DAI.BONUS_WIDTH)>>1;if(d>1){v=(Math_Angle90-DAI.HP_BONUS_DROP_START_ANGLE)*2/(d-1)}else{s=Math_Angle90}for(var q=0;q<d;q++){j+=Math_FixedPointToInt(l*Math_Cos(s));var t=this.DumpBonus(DValueList.BONUS_TYPE_CRYSTAL,j,this._posY+a.GetBoxMiddleY(this._boundingBox));if(t._boundingBox[DEF.BOX_TOP]<this._boundingBox[DEF.BOX_TOP]){t._posY+=this._boundingBox[DEF.BOX_TOP]-t._boundingBox[DEF.BOX_TOP]}t.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE,0);t._vX=0;t._vY=Math_FixedPointToInt(-(DAI.HP_BONUS_DROP_VELOCITY*Math_Sin(s)+DAI.FRAME_GRAVITY));if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){t._vY=-t._vY;t.SetFlag(DFlags.REVERSAL_GRAVITY)}if(Math.abs(t._vY)<DEF.TILE_W_FLOAT/2){if(t._vY>0){t._vY=DEF.TILE_W_FLOAT/2}else{t._vY=-DEF.TILE_W_FLOAT/2}}t._tempParams[DTempParamIndex.BONUS_DROP_NO_COLLIDE_ANGLE]=s;s+=v}break;case DClassID.PLATFORM:if(m==DState.SS_RUN){this._params[DParamIndex.PLATFORM_TYPE]=DValueList.PLATFORM_TYPE_MOVING}break;case DClassID.BULLET:if(m==DState.SS_IDLE){this._tempParams[DTempParamIndex.BULLET_BORN_TICK]++}else{if(m==DState.SS_BULLET_RUN){this._tempParams[DTempParamIndex.BULLET_REBOUND_COUNTER]=0}}break;case DClassID.MOBS_DANDELIONBOMB:if(m==DState.SS_DANDELION_STONE_IN){this._phyFlags|=DFlags.PHY_BLOCK_TOPSIDE;this._exFlags|=DFlags.EX_CAN_STANDON}break;case DClassID.ELECTRIC_DEVICE:if(m==DState.SS_DEVICE_ACTIVATE){if(a._hero._state!=DState.STATE_ONGROUND){return false}else{a._hero.SetPos(this._posX,this._posY);a._hero._frameVX=0;a._hero._frameVY=0;a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_ELECTRIC_DEVICE,0)}}break;case DClassID.BOSS_WITCH:var o=a.GetEntityByID(this._params[DParamIndex.BOSS_WITCH_BOSS_WITCH_DRAGON],true);var n=a.GetEntityByID(this._params[DParamIndex.BOSS_WITCH_BOSS_WITCH_LEG],true);switch(m){case DState.SS_BOSS_WITCH_MAGIC_OUT_BEE:case DState.SS_BOSS_WITCH_MAGIC_OUT_MOBS:this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]=0;break;case DState.SS_BOSS_WITCH_MAGIC_IN_BEE:case DState.SS_BOSS_WITCH_MAGIC_IN_MOBS:this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]=DAI.BOSS_WITCH_MAGIC_IN_MAX_COUNT;break;case DState.SS_BOSS_HURT:var e=(this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE])&255;if(e==DAI.BOSS_WITCH_CALL_MOBS){this.ClearFlag(DFlags.GRAVITY);if(this._hp<=2){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_FLY}else{this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_BEE}}else{if(e==DAI.BOSS_WITCH_CALL_BEE||e==DAI.BOSS_WITCH_CALL_FLY){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_MOBS}}break;case DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY:a._BossResidueShadowIndex=0;for(var q=a._BossResidueShadowData.length-1;q>=0;q--){a._BossResidueShadowData[q]=0}break}break}return true};a.prototype.StateMachineNotifyExit=function(l,f,d){var j=l+f;switch(this._classID){case DClassID.HERO:if(j==DState.STATE_INAIR+DState.SS_INAIR_FLOAT_UP){this._exFlags&=~DFlags.EX_USE_AFRAME_OX_OY}if(this._sprite!=CGame.spriteArray[DSpriteID.HERO]){var e=(l!=DState.STATE_SWIM)||(l==DState.STATE_SWIM&&(f<DState.SS_SWIM_FISH_START));if((l!=DState.STATE_CHANGE&&e)||(f==DState.SS_HERO_CHANGE_BACK||f==DState.SS_HERO_CHANGE_HURT_BACK)){this._sprite=CGame.spriteArray[DSpriteID.HERO];this._animationPlayer.SetSprite(this._sprite);this.SetFlag(DFlags.GRAVITY);a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetFlipForReversalGravity(true)}}}if(l==DState.STATE_DIE){if(this._state==DState.STATE_SWIM||this._state==DState.STATE_CHANGE){this._sprite=CGame.spriteArray[DSpriteID.HERO];this._animationPlayer.SetSprite(this._sprite);this.SetFlag(DFlags.GRAVITY)}}if(this._subState==DState.SS_HERO_END_MINIGAME){CGame.PlaySound(DSound_Channel.BGM,DATA.SOUND_BGM_LEVEL_CLEAR);var k=a.root;while(k!=null){if(k._classID==DClassID.BONUS){k.SetFlag(DFlags.INVISIBLE)}k=k.next}CGame.initIngameMenu(STATE.GAME_STATISTIC)}if(this._subState==DState.SS_GO_OUTDOOR){if(this._relateEntity!=null&&this._relateEntity._params[DParamIndex.DOOR_LINK]==-2){this._relateEntity.SetFlag(DFlags.INVISIBLE);this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_HIDE,0);this._relateEntity=null}}break;case DClassID.MOBS_WHITE:if(this._subState==DState.SS_DISAPPEAR){if(this._hp==0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY)}else{if(j==DFSM.FULLSTATE_DESTROY){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0);return false}}}else{if(this._subState==DState.SS_DROP_OUT){a._HurtByTentacle=false}else{if(this._subState==DState.SS_MOBS_FLY){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE_STONE,0,this._posX,this._posY+2*a.GetBoxHight(this._boundingBox))}}}break;case DClassID.MOBS_FLY:case DClassID.MOBS_BEE:if(f==DState.SS_DISAPPEAR){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY+a.GetBoxMiddleY(this._boundingBox))}break;case DClassID.JELLY:if(this._subState==DState.SS_ACTION){a._hero.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);a._hero.SetVY(-DAI.JELLY_ROCKET_START_VY1);this.AI_Hint_ShowSoundEffect(DAnimID.HINT_BOING_,-1,-1)}break;case DClassID.LEAF:if(this._subState==DState.SS_ACTION){a._hero.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);a._hero.SetVY(-DAI.LEAF_ROCKET_START_VY1);this.AI_Hint_ShowSoundEffect(DAnimID.HINT_BOING_,-1,-1)}break;case DClassID.HINT:if(this._subState==DState.SS_HINT_BOOK_DELAY_CLOSE&&(f!=DState.SS_HINT_BOOK_OPENED||this._subState!=DState.SS_HINT_BOOK_OPENED2)){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_HINT_BOOK_POPIN,0)}else{if(this._subState==DState.SS_HINT_BOOK_CONTENT){var m=CGame.GetCinematicIndex(this._params[DParamIndex.HINT_CINEMATIC_LINK]);if(m>=0){CGame._cinematicsStatus[m]&=~DCinematic.STATUS_CIRCLE;CGame.EndCinemitic(m)}}}break;case DClassID.RANDOMBONUS:if(f==DState.SS_RANDOMBONUS_IDLE){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);this.SetFlag(DFlags.ACTIVE_BY_TRIGGER)}if(f==DState.SS_RANDOMBONUS_BONUS_GOT){if(!a._HeroPoweredBullet){CGame._popUpEnded=false;CGame._initArrayForPalette=true}a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.BONUS,DAnimID.BONUS_EFFECT_GETBONUS_STAR,0,this._posX,this._posY);a._HeroPoweredBullet=true;for(var h=0;h<a._bullet.length;h++){a._bullet[h].StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0)}if(!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_NONE)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE)}if(a._boss!=null){a._boss._relateEntity=this;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_FLY,0);this.StateMachineModifyStatus(DFSM.CSF_INVISIBLE);this._posX=a._camX-DEF.TILE_W_FLOAT;this._vX=0}else{this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}break;case DClassID.HALO:if(this._subState==DState.SS_HALO_IDLE_HOR||this._subState==DState.SS_HALO_IDLE_VER){if(a._hero._state!=DState.STATE_CHANGE){return true}if(this._subState==DState.SS_HALO_IDLE_HOR){if(a._hero._frameVY==0){return false}}else{if(a._hero._frameVX==0){return false}}a._HeroStateTick=0;a._HeroMorphEnergy=1<<DAI.CHANGE_MOBS_MAX_ENERGY}break;case DClassID.ELECTRIC_DEVICE:if(this._subState==DState.SS_DEVICE_WORK){if(a._HeroInElectric!=DValueList.ELECTRIC_FIELD_TYPE_POSITIVE){a._HeroInElectric=DValueList.ELECTRIC_FIELD_TYPE_POSITIVE}else{a._HeroInElectric=0}a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0)}break;case DClassID.STONE:if(this._subState==DState.SS_APPEARING){this.SetFlag(DFlags.COLLIDING_WITH_HERO|DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY)}if(this._subState==DState.SS_STONE_DISAPPEAR_ON_WATER){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY)}break;case DClassID.BOSS_OCTOPUS_HEAD:switch(this._subState){case DState.SS_OCTOPUS_HEAD_GO_DOWN:a.AI_CameraQuake(a.k_camQuake_OffsetY<<3);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE_STONE,0,this._posX-(a.GetBoxWidth(this._boundingBox)>>2),this._posY);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE_STONE,0,this._posX,this._posY);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE_STONE,0,this._posX+(a.GetBoxWidth(this._boundingBox)>>2),this._posY);break;case DState.SS_OCTOPUS_HEAD_BE_ATTACK:a._BossOctopusHurt=true;break;case DState.SS_OCTOPUS_HEAD_REST:if(!a._BossOctopusHurt){var m=CGame.GetCinematicIndex(a._boss._params[DParamIndex.BOSS_OCTOPUS_CINEMATIC_LINK]);if(m>=0){CGame._cinematicsStatus[m]&=~DCinematic.STATUS_CIRCLE;CGame.EndCinemitic(m)}}break;case DState.SS_OCTOPUS_HEAD_BACK:a._boss.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_OCTOPUS_RECOVER_GO_DOWN,0);break}}if((this.CheckExFlag(DFlags.EX_BOSS)||this._classID==DClassID.BOSS_OCTOPUS_HEAD)&&this._subState==DState.SS_DISAPPEAR){this.AI_BOSS_SetCheckFlag(DFlags.BOSS_SHARE_DEAD_PROCESS_END_MASK);this.SetFlag(DFlags.INVISIBLE)}return true};a.prototype.StateMachineNotifyHasEntered=function(n,v,H){var t=this._state+this._subState;var o=this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS];if((o&DFSM.SF_CHECK_MOVE_AREA)!=0){if(this._params[DParamIndex.MOVE_AREA+2]==this._params[DParamIndex.MOVE_AREA]){this._vX=0;if(this._classID==DClassID.MOBS_WHITE){if(this._subState==DState.SS_WALK){this.SetAnim(DAnimID.MOBS_WHITE_IDEL,0)}}}}if((o&DFSM.SF_PLAY_SOUND_ON_ENTER)!=0){var x=(o&DFSM.SF_ID_MASK)>>DFSM.SF_ID_SHIFT;if(x==DATA.SOUND_MAGIC_ATTACK||x==DATA.SOUND_STONE_BREAK){CGame.PlaySound(DSound_Channel.ATTACK,x)}else{CGame.PlaySound(DSound_Channel.SFX,x)}}switch(this._classID){case DClassID.HERO:if(v==DState.SS_SHOOT||v==DState.SS_COMBAT){this._vY=0}if(this._state==DState.STATE_ONGROUND){if(this._subState==DState.SS_WALK||this._subState==DState.SS_RUN||this._subState==DState.SS_SLOWDOWN){this.AI_Hero_CheckTransmission()}}if(this._state==DState.STATE_CHANGE){switch(this._subState){case DState.SS_HERO_CHANGE_FLY:a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);a._HeroPoweredBullet=false;if(a._HeroMorphEnergy<=0){CGame._popUpEnded=false;CGame._initArrayForPalette=true}a._HeroStateTick=0;a._HeroMorphEnergy=1<<DAI.CHANGE_MOBS_MAX_ENERGY;this._sprite=CGame.spriteArray[DSpriteID.MOBS_FLY];this._animationPlayer.SetSprite(this._sprite);if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetFlipForReversalGravity(false)}break;case DState.SS_HERO_CHANGE_MOBS:a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);a._HeroPoweredBullet=false;if(a._HeroMorphEnergy<=0){CGame._popUpEnded=false;CGame._initArrayForPalette=true}a._HeroStateTick=0;a._HeroMorphEnergy=1<<DAI.CHANGE_MOBS_MAX_ENERGY;this._sprite=CGame.spriteArray[DSpriteID.MOBS_WHITE];this._animationPlayer.SetSprite(this._sprite);break;case DState.SS_HERO_CHANGE_FISH:a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);this._sprite=CGame.spriteArray[DSpriteID.SWORD_FISH];this._animationPlayer.SetSprite(this._sprite);this.ClearFlag(DFlags.GRAVITY);break;case DState.SS_HERO_CHANGE_BACK:case DState.SS_HERO_CHANGE_HURT_BACK:if(n==DState.STATE_SWIM){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_MOVE,0)}break}}if(t==DState.STATE_SWIM+DState.SS_SWIM_FISH_ATTACK){a.AI_Hero_SetMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)}if(t==DState.STATE_SWIM+DState.SS_SWIM_FISH_MOVE||t==DState.STATE_SWIM+DState.SS_SWIM_FISH_IDLE){a.AI_Hero_SetMorph(DAI.HERO_MORPH_SWORD_FISH)}if(t==DState.STATE_INAIR+DState.SS_INAIR_JUMP_DIAG_START||t==DState.STATE_INAIR+DState.SS_INAIR_JUMP_DIAG||t==DState.STATE_INAIR+DState.SS_INAIR_JUMP_VER_START||t==DState.STATE_INAIR+DState.SS_INAIR_JUMP_VER||t==DState.STATE_INAIR+DState.SS_INAIR_ROCKCRAFT_JUMP){if(v==DState.SS_SLOWDOWN){}break}if(t==DState.STATE_ONGROUND+DState.SS_WALK){if(!this.CheckIcePhysics()){this._vX=DAI.HERO_WALK_VX;if(this.IsFlipX()){this._vX=-this._vX}}}if(this._subState==DState.SS_HERO_END_MINIGAME){if(this._tempParams[DTempParamIndex.HERO_MINIGAME_RESULT]==0){this._stateDuration=500}}if(this.CheckIcePhysics()){switch(this._subState){case DState.SS_RUN:if(this._vX<0){this._vX=-this._vX}this._vX=DAI.HERO_ICE_RUN_VX;if(this.IsFlipX()){this._vX=-this._vX}break}}break;case DClassID.BONUS:var u=-1;var y=false;switch(this._subState){case DState.SS_BONUS_CRYSTAL_GOT:a._hero._hp++;if(a._hero._hp>=100){a._hero._hp-=100;if(a._HeroParams[DAI.HPI_LIVES]<DAI.HERO_MAX_LIVES){a._HeroParams[DAI.HPI_LIVES]++}CGame.ShowInterfaceElement(DValueList.BONUS_TYPE_1UP)}a._HeroParams[DAI.HPI_CRYSTAL_COUNT]=a._hero._hp;u=DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL;this._params[DParamIndex.BONUS_TYPE]=DValueList.BONUS_TYPE_CRYSTAL;var z=LowAPI.Gen_Array([4],0);this._sprite.GetAFrameRect(z,this._animationPlayer.GetAnim(),this._animationPlayer.GetFrame(),0,0,this._flags);var F=DEF.useNewDesign?DGUI.INTERFACE_MARGIN_HORIZONTAL:DGUI.INTERFACE_CRYSTAL_OFFSET_X;var E=DEF.useNewDesign?(DGUI.INTERFACE_CRYSTAL_Y+DGUI.INTERFACE_CRYSTAL_OFFSET_Y):DGUI.INTERFACE_CRYSTAL_OFFSET_Y;this._destX=F-z[DEF.BOX_LEFT];this._destY=E-z[DEF.BOX_TOP];if(this._tempParams[DTempParamIndex.BONUS_NOT_PLAY_SOUND]==0){CGame.PlaySound(DSound_Channel.SFX,DATA.SOUND_DIAMOND_PICK)}break;case DState.SS_BONUS_CRYSTALFLOWER_GOT:this.ClearFlag(DFlags.GRAVITY|DFlags.COLLIDING_WITH_SEGMENT|DFlags.COLLIDING_WITH_HERO);if(this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]==0){CGame.PlaySound(DSound_Channel.SFX,DATA.SOUND_PICK_BIGDIAMOND)}if(this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]<10){var m=a.CreateDynamicEntity(DClassID.BONUS,DAnimID.BONUS_CRYSTAL,this._posX,this._posY,0,0,DParamIndex.BONUS_SATELLITE3+1);m._tempParams[DTempParamIndex.BONUS_NOT_PLAY_SOUND]=1;m.StateMachineChangeState(DState.STATE_BONUS_GOT_EFFECT,DState.SS_BONUS_CRYSTAL_GOT,0);this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]++}else{this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}break;case DState.SS_BONUS_1UP_GOT:y=true;if(a._HeroParams[DAI.HPI_LIVES]<DAI.HERO_MAX_LIVES){a._HeroParams[DAI.HPI_LIVES]++}u=DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL;this._params[DParamIndex.BONUS_TYPE]=DValueList.BONUS_TYPE_1UP;this._destX=DGUI.INTERFACE_1UP_OFFSET_X;this._destY=DGUI.INTERFACE_1UP_OFFSET_Y;break;case DState.SS_BONUS_STAR_GOT:y=true;a._HeroParams[DAI.HPI_STAR_COUNT]++;var w=false;if((this._params[DParamIndex.FLAGS]&(DFlags.DYNAMIC_CREATE))!=0){w=true}a.IsStarGot(this._params[DParamIndex.POSX],this._params[DParamIndex.POSY],true,w);u=DAnimID.BONUS_EFFECT_GETBONUS_STAR;this._params[DParamIndex.BONUS_TYPE]=DValueList.BONUS_TYPE_STAR;this._destX=DGUI.INTERFACE_STAR_OFFSET_X;this._destY=DGUI.INTERFACE_STAR_OFFSET_Y+5;break;case DState.SS_BONUS_GOLDCOIN_GOT:y=true;a._HeroParams[DAI.HPI_GOLDCOIN_COUNT]++;u=DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL;this._params[DParamIndex.BONUS_TYPE]=DValueList.BONUS_TYPE_GOLD_COIN;this._destX=DEF.VIEW_W-DGUI.INTERFACE_GOLDEN_COIN_OFFSET_X;this._destY=DGUI.INTERFACE_GOLDEN_COIN_OFFSET_Y;break;case DState.SS_BONUS_HEALTH_GOT:y=true;a._hero._hp=a._HeroParams[DAI.HPI_HP_MAX];u=DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL;this._destX=DGUI.INTERFACE_LIFE_OFFSET_X;this._destY=DEF.VIEW_H-DGUI.INTERFACE_LIFE_OFFSET_Y;break;case DState.SS_BONUS_POWERUP_GOT:y=true;CGame._initArrayForPalette=true;a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.BONUS,DAnimID.BONUS_EFFECT_GETBONUS_STAR,0,this._posX,this._posY);this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);a._HeroPoweredBullet=true;break;case DState.SS_BONUS_ROBIN_HOOD_GOT:a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_ROBIN_HOOD);this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);break;case DState.SS_BONUS_ESKIMO_GOT:a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_ESKIMO);this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);break;case DState.SS_BONUS_FISH_GOT:if(a._hero._state==DState.STATE_SWIM){a._HeroPoweredBullet=false;if(a._HeroMorphEnergy<=0){CGame._popUpEnded=false;CGame._initArrayForPalette=true;CGame.ShowInterfaceElement(DValueList.BONUS_TYPE_CAKE)}a._HeroMorphEnergy=DAI.MORPH_MAX_ENERGY;a._hero.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_FISH,0)}break;case DState.SS_BONUS_CAKE_GOT:this.AI_Hero_StartMorph(DAI.HERO_MORPH_FAT);break;case DState.SS_BONUS_STRAWBERRY_GOT:if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){u=DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL;this._destX=DEF.useNewDesign?DEF.VIEW_W-DGUI.INTERFACE_FAT_FRAME_OFFSET_X:DGUI.INTERFACE_FAT_FRAME_OFFSET_X;this._destY=DEF.VIEW_H-DGUI.INTERFACE_LIFE_OFFSET_Y;a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.BONUS,DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL,0,this._posX,this._posY);a._HeroMorphEnergy+=DAI.MORPH_ENERGY_INCREASE_ENERGY;if(a._HeroMorphEnergy>DAI.MORPH_MAX_ENERGY){a._HeroMorphEnergy=DAI.MORPH_MAX_ENERGY}}break;case DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE2:var B=this._tempParams[DTempParamIndex.BONUS_DROP_NO_COLLIDE_ANGLE];this._vX=Math_FixedPointToInt(DAI.HP_BONUS_DROP_VELOCITY*Math_Cos(B));this._vY=0;if(Math.abs(this._vY)<DEF.TILE_W_FLOAT/2){if(this._vY>0){this._vY=DEF.TILE_W_FLOAT/2}else{this._vY=-DEF.TILE_W_FLOAT/2}}break}if(y){this.AI_Hint_ShowSoundEffect(DAnimID.HINT_YEAH_,-1,-1)}if(u>=0){this._phyFlags=0;a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.BONUS,u,0,this._posX,this._posY);this._destX=Math_IntToFixedPoint(this._destX);this._destY=Math_IntToFixedPoint(this._destY);this.ClearFlag(DFlags.GRAVITY|DFlags.COLLIDING_WITH_SEGMENT|DFlags.COLLIDING_WITH_HERO)}break;case DClassID.COTTONCLOUD:if(this._subState==DState.SS_COTTON_INVISIBLE){this._stateDuration=this._params[DParamIndex.COTTONCLOUD_REBORNTIME]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DClassID.DOOR:if(this._subState==DState.SS_DOOR_CAN_ENTER||this._subState==DState.SS_DOOR_INSCENE_CAN_ENTER){CGame._starsCurrentPos_X=0;CGame._moveSpeed=0;CGame._stopMove=false;CGame._actionSpeed=0;CGame._stopAdd=false;CGame._moveSpeed=0;CGame._currentPosY=-50;CGame._firstEnterIntoThisFunction=true}break;case DClassID.CANNON:var k=this._params[DParamIndex.CANNON_LINK];var G=null;if(k>=0){G=a.GetEntityByID(k,false);if(G!=null){if(G._subState==DState.SS_DISAPPEAR||G._subState==DState.SS_DISAPPEARING||G._subState==DState.SS_DROP_OUT){G=null}}}if(this._subState==DState.SS_CANNON_IDLE){this._stateDuration=this._params[DParamIndex.CANNON_LAUNCHTIME]*DAI.PARAM_INTERVAL_TIME_BASE;if(G==null){this._stateDuration=DFSM.DURATION_ENDLESS;break}}if(G==null&&this._subState!=DState.SS_CANNON_IDLE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNON_IDLE,0);break}if(this._subState==DState.SS_CANNON_IDLE||this._subState==DState.SS_CANNON_LAUNCH){if(G!=null){G.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DEATHPIRATE_SHOOTER_IDLE,0)}}if(this._subState==DState.SS_CANNON_PREPARE_LAUNCH){if(G!=null){G.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DEATHPIRATE_SHOOTER_FIRE,0)}}break;case DClassID.TRACE_CANNON:if(this._subState==DState.SS_CANNON_IDLE){this._stateDuration=this._params[DParamIndex.TRACE_CANNON_LAUNCHTIME]*DAI.PARAM_INTERVAL_TIME_BASE}if(this._subState==DState.SS_CANNON_LAUNCH){a._tempBox[0]=Math_IntToFixedPoint(this._params[DParamIndex.POSX]+this._params[DParamIndex.TRACE_CANNON_AREALEFT]);a._tempBox[1]=Math_IntToFixedPoint(this._params[DParamIndex.POSY]+this._params[DParamIndex.TRACE_CANNON_AREATOP]);a._tempBox[2]=a._tempBox[0]+Math_IntToFixedPoint(this._params[DParamIndex.TRACE_CANNON_AREAWIDTH]);a._tempBox[3]=a._tempBox[0]+Math_IntToFixedPoint(this._params[DParamIndex.TRACE_CANNON_AREAHEIGHT]);if(!a.InBox(a._hero._posX,a._hero._posY,a._tempBox)){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNON_IDLE,0)}}break;case DClassID.TRACE_CANNON_BALL:if(this._subState==DState.SS_CANNONBALL_EXPLODE){var s;s=a.CreateDynamicEntity(DClassID.EXPLOSION,DAnimID.EFFECT_EXPLORE,this._posX,this._posY,o,0,DParamIndex.EXPLOSION_ANIMID+1)}break;case DClassID.CANNONBALL:if(this._subState==DState.SS_CANNONBALL_EXPLODE){var s;s=a.CreateDynamicEntity(DClassID.EXPLOSION,DAnimID.EFFECT_EXPLORE,this._posX,this._posY,o,0,DParamIndex.EXPLOSION_ANIMID+1)}break;case DClassID.FIRE:if(this._subState==DState.SS_FIRE_BURN){this._stateDuration=this._params[DParamIndex.FIRE_BURNTIME]*DAI.PARAM_INTERVAL_TIME_BASE;if(this._stateDuration<=0){this._stateDuration=DFSM.DURATION_ENDLESS}}if(this._subState==DState.SS_FIRE_DISAPPEAR){this._stateDuration=this._params[DParamIndex.FIRE_NOTBURNTIME]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DClassID.MOBS_WHITE:switch(this._params[DParamIndex.MOBS_WHITE_TYPE]){case DValueList.MOBS_MOUSE_TYPE_DEATH_PIRATE:if(this._subState==DState.SS_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DValueList.MOBS_MOUSE_TYPE_LIGHT:if(this._subState==DState.SS_IDLE||this._subState==DState.SS_WALK){this._stateDuration=this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}if(this._subState==DState.SS_LIGHT_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_WHITE_ACTIONINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DValueList.MOBS_MOUSE_TYPE_BLOW:if(this._subState==DState.SS_MOBS_BLOW_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}if(this._subState==DState.SS_MOBS_BLOW_BLOWING){this._stateDuration=this._params[DParamIndex.MOBS_WHITE_ACTIONINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;if(this._params[DParamIndex.MOBS_WHITE_DROP1]<=0){var r=this.GetAttackBox();this._params[DParamIndex.MOBS_WHITE_DROP1]=this.CreateVirtualBlock(r,DFlags.PHY_BLOCK_TOPSIDE)._id}var C=a.GetEntityByID(this._params[DParamIndex.MOBS_WHITE_DROP1],true);C.EnableVirtualBlock(true)}else{if(this._subState!=DState.SS_MOBS_BLOW_HARD){if(this._params[DParamIndex.MOBS_WHITE_DROP1]>0){var C=a.GetEntityByID(this._params[DParamIndex.MOBS_WHITE_DROP1],true);C.EnableVirtualBlock(false)}}}break}if((a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)||a._HurtByTentacle)&&this._subState==DState.SS_DISAPPEAR){this._vX=(180<<DEF.SHIFT)*DScreen.ZOOM_MUL/DScreen.ZOOM_DIV;if(a._HurtByTentacle){if(a._TentacleSide==DAI.TENTACLE_RIGHT){this._vX=-this._vX}}else{if(a._hero._posX>this._posX){this._vX=-this._vX}}this.SetAnim(DAnimID.MOBS_WHITE_DIE_FLY,a.SETANIM_ONCE)}break;case DClassID.MOBS_ACALEPH:if(this._subState==DState.SS_ACALEPH_RUSH){this._vX=a.GetRand(0,DAI.ACALEPH_RUSH_MAX_VX);if(a.GetRand(0,1)==0){this._vX=-this._vX}if(this._params[DParamIndex.MOVE_AREA]!=this._params[DParamIndex.MOVE_AREA+2]){if((this._posX>>DEF.SHIFT)<=this._params[DParamIndex.MOVE_AREA]){this._vX=Math.abs(this._vX)}else{if((this._posX>>DEF.SHIFT)>=this._params[DParamIndex.MOVE_AREA+2]){this._vX=-Math.abs(this._vX)}}}}break;case DClassID.MOBS_BALLOONFISH:if(this._subState==DState.SS_BALLOONFISH_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_BALLOONFISH_NOTMORPHINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;if(this._stateDuration==0){this._stateDuration=DFSM.DURATION_ENDLESS}}if(this._subState==DState.SS_BALLOONFISH_ZOOMINED){this._stateDuration=this._params[DParamIndex.MOBS_BALLOONFISH_MORPHINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DClassID.MOBS_SHELL:if(this._subState==DState.SS_SHELL_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_SHELL_SHOOTINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DClassID.TRANSFORM_PLATFORM:if(this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MAX||this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MIN){this._stateDuration=this._params[DParamIndex.TRANSFORM_PLATFORM_HALT_TIME]*DAI.PARAM_INTERVAL_TIME_BASE}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_SHRINK||this._subState==DState.SS_TRANSFORM_PLATFORM_EXPAND){this._stateDuration=this._params[DParamIndex.TRANSFORM_PLATFORM_TRANSFORM_TIME]*DAI.PARAM_INTERVAL_TIME_BASE}}break;case DClassID.MOBS_UFO:if(this._subState==DState.SS_UFO_PRE_FIRE_IDLE){if(this._params[DParamIndex.MOBS_UFO_TYPE]==DValueList.UFO_FIRE_TYPE_YELLOW){this.SetAnim(DAnimID.MOBS_UFO_PRE_FIRE_YELLOW,a.SETANIM_ONCE)}else{this.SetAnim(DAnimID.MOBS_UFO_PRE_FIRE_PURPLE,a.SETANIM_ONCE)}this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP]=0}if(this._subState==DState.SS_UFO_MOVE_IDLE||this._subState==DState.SS_MOVE_WITH_TRACE){this._stateDuration=this._params[DParamIndex.MOBS_UFO_FIREINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}if(this._subState==DState.SS_UFO_FIRE_LIGHT){this._stateDuration=this._params[DParamIndex.MOBS_UFO_FIREDURATION]*DAI.PARAM_INTERVAL_TIME_BASE}break;case DClassID.FLY_CANNON:this._tempParams[DTempParamIndex.MINIGAME_MAGIC_EFFECT]=0;var p=this._params[DParamIndex.FLY_CANNON_LIMIT_CAMERA_TYPE];var h=p==DValueList.FLY_CANNON_CAMMERA_TYPE_IN_CANNON_ACTIVE;switch(this._subState){case DState.SS_CANNON_IDLE_FLY_ON:a._miniGameEffectDrawStep=0;if(!h){a._miniGameTriger=a.GetEntityByID(this._params[DParamIndex.FLY_CANNON_LIMIT_TRIGER],true);if(a._miniGameTriger!=null){a._miniGameTriger.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_TRIGGER_ACTIVED,0);a._miniGameTriger._params[DParamIndex.TRIGGER_RESULT_TYPE]=DValueList.TRIGGER_RESULT_TYPE_ACTIVE}}break;case DState.SS_CANNON_IDLE_FLY_HERO_IN:a._hero.SetFlipX(this.IsFlipX());a._inMiniGame=true;if(h){a._miniGameTriger=a.GetEntityByID(this._params[DParamIndex.FLY_CANNON_LIMIT_TRIGER],true);if(a._miniGameTriger!=null){if(a._camera!=a.GetDefaultCamera()){a._camera.SetInactived(true)}a._miniGameTriger.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_TRIGGER_ACTIVED,0);a._miniGameTriger._params[DParamIndex.TRIGGER_RESULT_TYPE]=DValueList.TRIGGER_RESULT_TYPE_ACTIVE}}break;case DState.SS_CANNON_IDLE_FLY_FIRE:var d=DState.STATE_INAIR+DState.SS_HERO_BROKEN_BIG_CRYSTAL;a._HeroResidueShadowIndex=0;for(var A=a._HeroResidueShadowData.length-1;A>=0;A--){a._HeroResidueShadowData[A]=0}a._hero.StateMachineGotoNextState(d,0);a._miniGameTriger=a.GetEntityByID(this._params[DParamIndex.FLY_CANNON_LIMIT_TRIGER],true);if(a._miniGameTriger!=null){if(a._miniGameTriger._subState==DState.SS_IDLE){a._miniGameTriger.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_TRIGGER_ACTIVED,0)}a._miniGameTriger._params[DParamIndex.TRIGGER_RESULT_TYPE]=DValueList.TRIGGER_RESULT_TYPE_INACTIVE}var f,e;var l,j;var B=Math_DegreeToFixedPointAngle(this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]);f=this._boundingBox[DEF.BOX_RIGHT]+a._hero._boundingBox[DEF.BOX_RIGHT];e=a.GetBoxMiddleY(this._boundingBox)-a.GetBoxMiddleY(a._hero._boundingBox);l=this._posX+this._boundingBox[DEF.BOX_LEFT]+a.GetBoxWidth(this._boundingBox)/3;j=this._posY+a.GetBoxMiddleY(this._boundingBox);if(this.IsFlipX()){f=this._boundingBox[DEF.BOX_LEFT]+a._hero._boundingBox[DEF.BOX_LEFT];l=this._posX+this._boundingBox[DEF.BOX_RIGHT]-a.GetBoxWidth(this._boundingBox)/3}this.GetPositionWithAngularVelocity(this._posX+f,this._posY+e,-B,l,j);a._hero._posX=a._TempIntArray[DParamIndex.POSX];a._hero._posY=a._TempIntArray[DParamIndex.POSY];var q=DAI.MINIGAME_CANNON_BALL_SHOOT_HERO_VELOCITY;if(this.IsFlipX()){q=-q}a._hero.SetVelocityByAngle(q,Math_Angle360-B);a.PrepareRender(a.RENDER_TYPE_ANIMATION,a._hero._id,DSpriteID.EFFECT,DAnimID.EFFECT_STONE,0,a._TempIntArray[DParamIndex.POSX],a._TempIntArray[DParamIndex.POSY]);break}break;case DClassID.BOSS_EATER:switch(this._subState){case DState.SS_BOSS_IDLE:this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_COUNTER]=1;this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_GOAL_COUNTER]++;this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_GOAL_COUNTER]=Math.min(DAI.BOSS_FLOWER_ATTACK_PRE_MAX,this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_GOAL_COUNTER]);break;case DState.SS_BOSS_FLOWEREATER_ATTACK:this._stateDuration=DAI.BOSS_FLOWER_ATTACK_DURATION;break;case DState.SS_BOSS_FLOWEREATER_TIRE:this._stateDuration=DAI.BOSS_FLOWER_TIRE_DURATION;this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_COUNTER]=0;this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_GOAL_COUNTER]=0;break;case DState.SS_BOSS_BE_ATTACK:this._stateDuration=DAI.BOSS_FLOWER_BE_ATTACK_DURATION;break}break;case DClassID.BOSS_OCTOPUS:switch(this._subState){case DState.SS_BOSS_OCTOPUS_IDLE:this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TOSS_COUNT]=(this._hp<3)?2:1;case DState.SS_BOSS_OCTOPUS_TOSS_IDLE:this._stateDuration=this._params[DParamIndex.BOSS_OCTOPUS_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_OCTOPUS_RAISE:if(this._hp==5){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]=3}else{this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]=2}break;case DState.SS_BOSS_OCTOPUS_INK_PREPARE:var D=a.GetRowDataByID(this._params[DParamIndex.BOSS_OCTOPUS_INK_BOMB1]);this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]=D[DParamIndex.POSY];if(this._hp>2){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_COUNT]=2*(4-this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT])+1}else{this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_COUNT]=7}break;case DState.SS_BOSS_OCTOPUS_GO_DOWN_WAIT:this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_COUNT]=2;this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]=this._params[DParamIndex.POSY];this._stateDuration=this._params[DParamIndex.BOSS_OCTOPUS_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_OCTOPUS_TENTACLE_WAIT:this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ATTACK_COUNT]=0;break;case DState.SS_BOSS_OCTOPUS_INK_GO_DOWN:this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]=this._params[DParamIndex.POSY];break;case DState.SS_BOSS_OCTOPUS_REST_PREPARE:var D=LowAPI.Gen_Array([DParamIndex.ANIMID+1],0);var C=a.CreateDynamicEntity(D,DClassID.BOSS_OCTOPUS_HEAD,DAnimID.BOSS_OCTOPUS_REST_LIFT_HEAD,this._posX,this._posY,0);C.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_OCTOPUS_HEAD_RAISE_PRE,0);this._relateEntity=C;break}break;case DClassID.BOSS_OCTOPUS_HEAD:switch(this._subState){case DState.SS_OCTOPUS_HEAD_GO_DOWN:this._zOrder=Z.BOSS_OCTOPUS_REST;a.UpdateDrawList(this);break;case DState.SS_OCTOPUS_HEAD_REST:this._stateDuration=DAI.BOSS_OCTOPUS_SLEEP_TIME;break;case DState.SS_OCTOPUS_HEAD_CRY:case DState.SS_OCTOPUS_HEAD_WAKE:case DState.SS_OCTOPUS_HEAD_SHAKE:this._stateDuration=DAI.BOSS_OCTOPUS_WAKE_TIME;break;case DState.SS_OCTOPUS_HEAD_BACK:this._zOrder=Z.BOSS_OCTOPUS_NORMAL;a.UpdateDrawList(this);break}break;case DClassID.BOSS_OCTOPUS_TENTACLE:if(this._subState==DState.SS_TENTACLE_IDLE){this.SetFlag(DFlags.INVISIBLE);this._tempParams[DTempParamIndex.TENTACLE_MOVE_LIMIT_LEFT]=this._params[DParamIndex.POSX]}else{if(this._subState==DState.SS_TENTACLE_MOVEIN_PRE){this.ClearFlag(DFlags.INVISIBLE)}}break;case DClassID.INK_BOMB:switch(this._subState){case DState.SS_INKBOMB_IDLE:this.SetFlag(DFlags.INVISIBLE);break;case DState.SS_INKBOMB_FLY_IN_PREPARE:this.ClearFlag(DFlags.INVISIBLE);this._stateDuration=this._params[DParamIndex.INK_BOMB_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_INKBOMB_BLAST:if(!a._HeroBeAttackByInkbomb){a._hero._tempParams[DTempParamIndex.HERO_INK_POSX]=this._posX;a._hero._tempParams[DTempParamIndex.HERO_INK_POSY]=this._posY;a._HeroShowInkTime=0;a._HeroBeAttackByInkbomb=true}break;case DState.SS_INKBOMB_DESTORY:a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_EFFECT_INK,0,this._posX,this._posY);break}break;case DClassID.MOBS_BEE:if(this._subState==DState.SS_IDLE){this._hp=1;this.SetPos(Math_IntToFixedPoint(this._params[DParamIndex.POSX]),Math_IntToFixedPoint(this._params[DParamIndex.POSY]))}if(this._subState==DState.SS_RUN){if(this._params[DParamIndex.MOBS_BEE_TRACE]==DAI.NON_TRACE){this._vX=0}}break;case DClassID.RANDOMBONUS:if(this._subState==DState.SS_RANDOMBONUS_BONUS_FLY){this._stateElapsedTime=DAI.RANDOMBONUS_BONUS_EFFECT_INTERVAL+1;this._tempParams[DAI.SVI_RANDOMBONUS_BONUS_COUNTER]=3}break;case DClassID.ELECTRIC_FIELD:if(this._params[DParamIndex.ELECTRIC_FIELD_DURATION]>0&&this._tempParams[DTempParamIndex.ELECTRIC_ELAPSED_TIME]>=this._params[DParamIndex.ELECTRIC_FIELD_DURATION]*DAI.PARAM_INTERVAL_TIME_BASE){this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}break;case DClassID.MOBS_MONSTERINCHEST:if(this._subState==DState.SS_MONSTERINCHEST_HURT){if(this._hp>0){this.DumpBonus(this._params[DParamIndex.MOBS_MONSTERINCHEST_DROP1+(this._hp-1)],this._posX,this._posY+this._boundingBox[DEF.BOX_TOP]-DEF.TILE_H_FLOAT);this._hp--;a.MonsterchestLoseHP(this._id)}}break;case DClassID.BULLET:if(this._subState==DState.SS_ARROW_SHAKE||this._subState==DState.SS_ARROW_ONWALL_SHAKE||this._subState==DState.SS_ARROW_DISAPPEAR_SHAKE){this._stateDuration=DAI.BULLET_SHAKE_TIME;if(this._subState==DState.SS_ARROW_ONWALL_SHAKE){this.ClearFlag(DFlags.COLLIDING_WITH_SEGMENT);a._arrowShakeNum++}}else{if(this._subState==DState.SS_ARROW_ONWALL){this.ClearFlag(DFlags.COLLIDING_WITH_SEGMENT);if(this._preFullState==DState.STATE_SIMPLE+DState.SS_ARROW_ONWALL_SHAKE){this._stateDuration=DAI.BULLET_EXIST_TIME-3*a._arrowShakeNum*DAI.BULLET_SHAKE_TIME}else{this._stateDuration=DAI.BULLET_EXIST_TIME}}else{if(this._subState==DState.SS_ARROW_DROP){a._arrowShakeNum=0}}}break}if((this.CheckExFlag(DFlags.EX_BOSS)||this._classID==DClassID.BOSS_OCTOPUS_HEAD)&&this._subState==DState.SS_DISAPPEAR){this._stateDuration=DAI.BOSS_DIE_DURATION}};a.prototype.AI_Hero_StartMorph=function(d){if(d==DAI.HERO_MORPH_FAT||d==DAI.HERO_MORPH_ESKIMO){a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_FAT_PREPARE,0)}a.AI_Hero_SetMorph(d);CGame._popUpEnded=false;CGame._initArrayForPalette=true;CGame.ShowInterfaceElement(DValueList.BONUS_TYPE_CAKE);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,a._hero._posX-a._hero._boundingBox[DEF.BOX_LEFT],a._hero._posY);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.BONUS,DAnimID.BONUS_EFFECT_GETBONUS_CRYSTAL,0,this._posX,this._posY);a._HeroStateTick=0;a._HeroMorphEnergy=DAI.MORPH_MAX_ENERGY};a.IsStarGot=function(e,m,j,k){var l;var f=CGame._tempLevelId*DAI.STAR_INFO_SIZE;var d=CGame._levelStarInfo[f];if(d<=0){return true}for(var h=d;h<DAI.MAX_STAR_NUM;h++){l=f+(h)*2;if(CGame._levelStarInfo[l+1]==e&&CGame._levelStarInfo[l+2]==m){return true}}if(j){var h=d-1;l=f+(h)*2;if(k){CGame._levelStarInfo[l+1]=0;CGame._levelStarInfo[l+2]=0}else{CGame._levelStarInfo[l+1]=e;CGame._levelStarInfo[l+2]=m}CGame._levelStarInfo[f]--;return true}return false};a.prototype.StateMachineCustomizedUpdate=function(aF){if(this.CheckFlag(DFlags.CENIMATIC)){return DFSM.SMCR_DEFAULT}var aE=this._state+this._subState;var T=DFSM.SMCR_DEFAULT;var an=this._stateIndex;switch(this._classID){case DClassID.HERO:T=this.AI_Hero(aE,aF);break;case DClassID.CAMERA:T=this.AI_Camera(aE,aF);break;case DClassID.BULLET:if(this._subState==DState.SS_BULLET_RUN||this._subState==DState.SS_ARROW_FLY){var aK=LowAPI.Gen_Array([4],0);this._sprite.GetAFrameRect(aK,this._animationPlayer.GetAnim(),this._animationPlayer.GetFrame(),0,0,this._flags);for(var ac=0;ac<4;ac++){aK[ac]<<=8}if(!a._camera.IntersectBox(this.GetAbsoluteBox(aK))){if(this._subState==DState.SS_ARROW_FLY){return DState.STATE_SIMPLE+DState.SS_IDLE}else{return DFSM.SMCR_OVER}}}if(!aF&&(this._subState==DState.SS_BULLET_CLOSE_RUN||this._subState==DState.SS_BULLET_CLOSE_AXE)){if(this._boundingBox[DEF.BOX_RIGHT]-this._boundingBox[DEF.BOX_LEFT]<=0){break}var N=a.root;while(N!=null&&N._zOrderAI<=Z.DEFAULT_COLLIDED_HERO_AI){if((N.CheckExFlag(DFlags.EX_ENEMY|DFlags.EX_BOSS)||N._classID==DClassID.RANDOMBONUS)&&!N.CheckExFlag(DFlags.EX_CANNOT_HIT_BY_BULLET)){var aH=this.IntersectEntity(N);if(N.CheckFlag(DFlags.MULTI_BOUNDING_BOX)){aH=false;var j=N.GetFrameRectCount(-1,-1);for(var ac=2;ac<j;ac++){N.GetFrameRect(N._boundingBox,ac,-1,-1);if(N.IsFlipX()){var aj=N._boundingBox[DEF.BOX_LEFT];N._boundingBox[DEF.BOX_LEFT]=-N._boundingBox[DEF.BOX_RIGHT];N._boundingBox[DEF.BOX_RIGHT]=-aj}N.UpdateDynamicBox();if(this.IntersectEntity(N)){aH=true}if(ac==2&&N.CheckFlag(DFlags.BE_ATTACK_COMPUTE)){break}}}if(aH){N.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0);this.NotifyEvent(N,DEvent.BULLET_HIT,0,0,0)}}else{if(N._classID==DClassID.PHYFIELD){if(this.IntersectEntity(N)){a.DestroyPhyfield(this._posX,this._posY,this.GetAbsoluteBox(this._boundingBox))}}}N=N.next}}break;case DClassID.HINT:switch(this._subState){case DState.SS_HINT_BOOK_IDLE2:case DState.SS_HINT_BOOK_OPENED2:var H,G,J,W;H=Math_IntToFixedPoint(this._params[DParamIndex.HINT_AREA_X]);G=Math_IntToFixedPoint(this._params[DParamIndex.HINT_AREA_Y]);J=Math_IntToFixedPoint(this._params[DParamIndex.HINT_AREA_WIDTH]);W=Math_IntToFixedPoint(this._params[DParamIndex.HINT_AREA_HEIGHT]);if(this._subState==DState.SS_HINT_BOOK_IDLE2){if(J==0&&W==0){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_HINT_BOOK_IDLE,0)}else{if(this.AI_Hero_InEntityArea(H,G,J,W)){return DFSM.SMCR_OVER}}}else{if(J==0&&W==0){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_HINT_BOOK_OPENED,0)}else{if(!this.AI_Hero_InEntityArea(H,G,J,W)){return DFSM.SMCR_OVER}}}break;case DState.SS_HINT_UGH:if(!a._keyLeftHold&&!a._keyRightHold){return DFSM.SMCR_OVER}break;case DState.SS_HINT_TINK_INVISIBLE:case DState.SS_HINT_TINK_SHOW1:case DState.SS_HINT_TINK_SHOW2:case DState.SS_HINT_TINK_SHOW3:this.AI_Hint_ThiefSoundBubbleResetPos();break;case DState.SS_HINT_BOOK_CONTENT:var X=CGame.GetCinematicIndex(this._params[DParamIndex.HINT_CINEMATIC_LINK]);if(X>=0){if(CGame._cinematicsFrameTime[X]<0){CGame.StartCinemitic(X)}CGame._cinematicsStatus[X]|=DCinematic.STATUS_CIRCLE}break}break;case DClassID.DOOR:if(this._subState==DState.SS_DOOR_FINAL_IDLE){this.SetFlag(DFlags.INVISIBLE);if(this._params[DParamIndex.DOOR_LINK_NUM]>0){var aJ=true;for(var ac=0;ac<this._params[DParamIndex.DOOR_LINK_NUM];ac++){if((CGame._levelInfo[this._params[DParamIndex.DOOR_LINK_LEVEL1+ac]]!=1)){aJ=false;break}}if(aJ){if(CGame._levelFinalInfo2!=1){CGame._levelFinalInfo2=1;var N=a.GetEntityByID(this._params[DParamIndex.DOOR_FOCUS_OBJECT],true);N.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}else{this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}}}else{if(this._subState==DState.SS_DOOR_CAN_ENTER||this._subState==DState.SS_DOOR_INSCENE_CAN_ENTER){if((this._params[DParamIndex.DOOR_LINK]!=-2)&&this.PrepareRenderIsOver(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HINT,DAnimID.HINT_PRESS_2)){var s,q;s=this._posX+a.GetBoxMiddleX(this._boundingBox);q=this._posY+this._boundingBox[DEF.BOX_TOP]-Math_IntToFixedPoint(25);a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HINT,DAnimID.HINT_PRESS_2,0,s,q)}if(WasKeyPressed(a.k_up)){if(a._hero._state==DState.STATE_ONGROUND&&(a._hero._subState==DState.SS_IDLE||a._hero._subState==DState.SS_FAT_IDLE)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){a._HeroMorphEnergy=0;a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE)}var v=this._params[DParamIndex.DOOR_LINK];var ae=this._params[DParamIndex.DOOR_TRANSPORT_WORLD];if(v>=0){var z=a.GetRowDataByID(v);z[DParamIndex.DOOR_LINK]=-2;a._hero._tempParams[DTempParamIndex.HERO_DEST_POSX]=z[DParamIndex.POSX]<<DEF.SHIFT;a._hero._tempParams[DTempParamIndex.HERO_DEST_POSY]=z[DParamIndex.POSY]<<DEF.SHIFT;a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_GO_INDOOR,0);CGame.SetPause(DPauseType.FADE_OUT,DPauseType.FADE_EFFECT_CIRCLE);if(this._subState==DState.SS_DOOR_CAN_ENTER){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_HERO_IN,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_INSCENE_HERO_IN,0)}}if(ae>0){a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_GO_INDOOR,0);CGame.SetPause(DPauseType.FADE_OUT,DPauseType.FADE_EFFECT_CIRCLE);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_INSCENE_TRANSPORT,0);this.SetAnim(this._params[DParamIndex.DOOR_ANIMID],0)}}}}else{if(this._subState==DState.SS_DOOR_HERO_IN||this._subState==DState.SS_DOOR_INSCENE_HERO_IN){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);a._hero.SetPos(a._hero._tempParams[DTempParamIndex.HERO_DEST_POSX],a._hero._tempParams[DTempParamIndex.HERO_DEST_POSY]-DEF.TILE_H_FLOAT);a._camera.PreUpdate();a.SetCameraFocus(a._hero,true);a._hero._relateEntity=a.GetEntityByID(this._params[DParamIndex.DOOR_LINK],true);a._hero._relateEntity.ClearFlag(DFlags.INVISIBLE);a._checkDropToGound=true}else{if(this._subState==DState.SS_DOOR_INSCENE_TRANSPORT){var ac=0;while(true){if((this._params[DParamIndex.DOOR_TRANSPORT_WORLD]>>ac)==1){break}ac++}if(ac>DAI.MINI_MAP){CGame._levelInfo[CGame._tempLevelId+1]=1;CGame._worldId=ac-1;CGame._tempLevelId=DAI.WORLD_ID_CASTLE*DAI.LEVELS_NUM_PRE_WORLD+1+CGame._worldId;CGame.needTrans=true}else{CGame.needTrans=false}CGame.GotoNextLevel(false)}}}}break;case DClassID.DOOR_SIGN:if(CGame._levelInfo[this._params[DParamIndex.DOOR_SIGN_FOCUS_LEVEL]]==1){this._flags|=DFlags.INVISIBLE}else{this._flags&=~DFlags.INVISIBLE}break;case DClassID.HIT_BONUS:if(a._HeroKickableEntity==this){a._HeroKickableEntity=null}if(this.CheckFlag(DFlags.COLLIDING_WITH_HERO)){if(this.IsNearEnough(a._hero,DAI.HITBONUS_NEAR_DIS)){a._HeroKickableEntity=this}}break;case DClassID.SPAWN_POINT:if(this._subState==DState.SS_IDLE){if(this._tempParams[DTempParamIndex.SPAWNPOINT_COUNT]<this._params[DParamIndex.SPAWN_POINT_MAXCOUNT]){this._stateDuration=this._params[DParamIndex.SPAWN_POINT_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}else{this._stateDuration=DFSM.DURATION_ENDLESS}}break;case DClassID.MOBS_WHITE:if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_THIEF){if(this._posX<a._camX||this._posX>a._camX+DEF.SCR_W_FLOAT){this.AI_Hint_ShowThiefSoundBubble(this._posX<a._camX,true)}else{this.AI_Hint_ShowThiefSoundBubble(this.IsFlipX(),false)}}if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_RED){if(this._subState==DState.SS_MOBS_RED_INAIR){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(this._vY<=0){return DFSM.SMCR_OVER}}else{if(this._vY>=0){return DFSM.SMCR_OVER}}}if(this._subState!=DState.SS_MOBS_RED_JUMP&&this._subState!=DState.SS_MOBS_RED_IDLE&&this._subState!=DState.SS_DISAPPEAR&&this._subState!=DState.SS_DROP_OUT){if(this.CheckPhysics(DFlags.PHY_BLOCK_UNDERSIDE)){if(this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]==0){return DState.STATE_SIMPLE+DState.SS_MOBS_RED_JUMP}this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_RED_IDLE,0);this._stateDuration=this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}}}switch(this._params[DParamIndex.MOBS_WHITE_TYPE]){case DValueList.MOBS_MOUSE_TYPE_DEATH_PIRATE:if(this._subState==DState.SS_ACTION){if(a._hero.IntersectBox(this.GetAbsoluteBox(this.GetAttackBox()))){a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}break;case DValueList.MOBS_MOUSE_TYPE_LIGHT:if(this._params[DParamIndex.MOBS_WHITE_IDLEINTERVAL]==0){if(this._subState!=DState.SS_LIGHT_IDLE){return DState.STATE_SIMPLE+DState.SS_LIGHT_IDLE}break}if(this._stateDuration>0||this._stateDuration<=DFSM.DURATION_SPECIAL_START){this._stateElapsedTime+=CGame._frameDT}if(this._stateElapsedTime<this._stateDuration){break}if(this._subState==DState.SS_LIGHT_IDLE||this._subState==DState.SS_IDLE){if(this._params[DParamIndex.MOBS_WHITE_AREAWIDTH]!=0){return DState.STATE_SIMPLE+DState.SS_WALK}else{return DState.STATE_SIMPLE+DState.SS_IDLE}}break;case DValueList.MOBS_MOUSE_TYPE_HAT:if(this._subState!=DState.SS_DISAPPEAR&&this._subState!=DState.SS_DISAPPEARING&&this._subState!=DState.SS_DROP_OUT){var af=this.CanSee(a._hero,a.CANSEE_VIEW_AREA|a.CANSEE_VIEW_BACKSEE,-1);if(af!=a.CANSEE_RESULT_NONE){if(af==a.CANSEE_RESULT_FACE){if(this._subState!=DState.SS_WALK){return DState.STATE_SIMPLE+DState.SS_WALK}}else{if(this._subState!=DState.SS_MOBS_WAIT_TURN){return DState.STATE_SIMPLE+DState.SS_MOBS_WAIT_TURN}}}}break}break;case DClassID.MOBS_BEE:if(this.IntersectEntity(a._hero)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}if(this._subState==DState.SS_MOBS_BEE_MOVE_TO_WITCH_CIRCLE){if(this.MoveToDest(DAI.BOSS_WITCH_BEE_MOVE_TO_CIRCLE_VELOCITY,this._tempParams[DTempParamIndex.MOBS_BEE_DESTX],this._tempParams[DTempParamIndex.MOBS_BEE_DESTY])){return DFSM.SMCR_OVER}break}else{if(this._subState==DState.SS_MOBS_BEE_RUSH_TO_HERO){if(this.MoveToDest(DAI.BOSS_WITCH_BEE_CIRCLE_RUSH_VELOCITY,this._tempParams[DTempParamIndex.MOBS_BEE_DESTX],this._tempParams[DTempParamIndex.MOBS_BEE_DESTY])){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY);return DFSM.SMCR_OVER}else{if(aF){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY)}}}}if(this._subState==DState.SS_MOVE_WITH_TRACE){if(this.MoveAndWaitToNextTrace(true)){if(this._vX<0){this.SetFlipX(false)}if(this._vX>0){this.SetFlipX(true)}return DFSM.SMCR_DEFAULT}}else{var au=this.IsFlipX();if(this._subState==DState.SS_IDLE){this._stateDuration=this._params[DParamIndex.MOBS_BEE_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;if(aF&&this._params[DParamIndex.MOBS_BEE_TRACE]!=DAI.NON_TRACE){if(au){this._posX=a._camX+DEF.SCR_W_FLOAT-this._boundingBox[DEF.BOX_LEFT]}else{this._posX=a._camX-this._boundingBox[DEF.BOX_RIGHT]}}}}break;case DClassID.MOBS_UFO:if(this._subState==DState.SS_UFO_MOVE_IDLE||this._subState==DState.SS_MOVE_WITH_TRACE){if(this._params[DParamIndex.MOBS_UFO_FIREINTERVAL]<0){return DFSM.SMCR_NO_OVER}if(aF){return DState.STATE_SIMPLE+DState.SS_UFO_PRE_FIRE_IDLE}}if(this._params[DParamIndex.MOBS_UFO_TRACE]>=0){this.MoveToNextTrace(true)}switch(this._subState){case DState.SS_UFO_MOVE_IDLE:if(this._params[DParamIndex.MOBS_UFO_TRACE]>=0){return DState.STATE_SIMPLE+DState.SS_MOVE_WITH_TRACE}break;case DState.SS_MOVE_WITH_TRACE:break;case DState.SS_UFO_PRE_FIRE_IDLE:break;case DState.SS_UFO_FIRE_LIGHT:if(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]>0){this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]--}if(a._hero._subState!=DState.SS_HURT&&this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]==0){if(this.CheckLightBeamCollisionWithEntity(a._hero,this._posX,this._posY,false)){a._hero.NotifyEvent(this,DEvent.UFO_HIT,this._params[DParamIndex.MOBS_UFO_TYPE],0,0)}}if(aF){if(this._params[DParamIndex.MOBS_UFO_FIREINTERVAL]==0){return DFSM.SMCR_NO_OVER}}break;case DState.SS_UFO_FIRE_LIGHT_END:if(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP]==0){return this._stateFlow[this._stateIndex+DFSM.OFFSET_NEXTSTATE]}break}break;case DClassID.BONUS:if(this._params[DParamIndex.BONUS_TRACE]>0){this.MoveToNextTrace(true)}if(this._state==DState.STATE_BONUS_GOT_EFFECT){if(a._hero._subState==DState.SS_HERO_BROKEN_BIG_CRYSTAL){var ah=0;switch(this._subState){case DState.SS_BONUS_CRYSTALFLOWER_GOT:ah|=DAI.MINIGAME_RESULT_BONUS_FLOWER;break;case DState.SS_BONUS_STAR_GOT:ah|=DAI.MINIGAME_RESULT_BONUS_STAR;break;case DState.SS_BONUS_1UP_GOT:ah|=DAI.MINIGAME_RESULT_BONUS_HP;break;case DState.SS_BONUS_BIG_CRYSTAL_GOT_ALL:ah|=DAI.MINIGAME_RESULT_BONUS_DIAMOND;break}a._hero._tempParams[DTempParamIndex.HERO_MINIGAME_RESULT]=ah;if(this._subState==DState.SS_BONUS_BIG_CRYSTAL_GOT_ALL&&a._hero._subState!=DState.SS_HERO_NO_HIT_BIG_CRYSTAL){a._hero._vX=DAI.MINIGAME_CANNON_BALL_DROP_VELOCITY;if(this.IsFlipX()){a._hero._vX=-a._hero._vX}a._hero.StateMachineGotoNextState(DState.STATE_INAIR+DState.SS_HERO_NO_HIT_BIG_CRYSTAL,DFSM.CSTATEF_KEEP_VX)}}if(this._subState==DState.SS_BONUS_BIG_CRYSTAL_GOT_ALL){var e=5;var Q=null;if(this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]==0){CGame.PlaySound(DSound_Channel.SFX,DATA.SOUND_HIDDEN_BONUS)}if(this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]<(e)){var ao=(30<<DEF.SHIFT);Q=a.CreateDynamicEntity(DClassID.BONUS,DAnimID.BONUS_CRYSTAL_FLOWER,this._posX,this._posY+ao,0,0,DParamIndex.BONUS_SATELLITE3+1);Q.SetFlag(DFlags.GRAVITY|DFlags.COLLIDING_WITH_SEGMENT);Q._vX=a.GetRand(DAI.BONUS_DROP_MIN_VX,DAI.BONUS_DROP_MAX_VX);Q._vY=-a.GetRand(DAI.BONUS_DROP_MIN_VY,DAI.BONUS_DROP_MAX_VY);if(a._hero.IsFlipX()){Q._vX=-Q._vX}Q._tempParams[DTempParamIndex.BONUS_NOT_PLAY_SOUND]=1;Q.StateMachineChangeState(DState.STATE_BONUS_GOT_EFFECT,DState.SS_BONUS_CRYSTALFLOWER_GOT,0);this._tempParams[DTempParamIndex.BONUS_CRYSTAL_FLOWER_COUNT]++}else{return DFSM.SMCR_OVER}break}else{if(this._subState!=DState.SS_BONUS_CRYSTALFLOWER_GOT){CGame.ShowInterfaceElement(this._params[DParamIndex.BONUS_TYPE]);if(this.MoveToDest(DAI.BONUS_GOT_EFFECT_VELOCITY,a._camX+this._destX,a._camY+this._destY)){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}}}else{if(this._subState==DState.SS_BONUS_CRYSTAL_DROPPED){if(this._stateElapsedTime>DAI.HP_BONUS_DROP_EXIST_TIME){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BONUS_CRYSTAL_DISAPPEAR,0)}}else{if(this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE||this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE2){this._zOrderAI=Z.DEFAULT_COLLIDED_HERO_AI}else{if(this._subState==DState.SS_BONUS_POWERUP){this.SetFlipX(this._vX<0)}else{if(this._subState==DState.SS_BONUS_FISH_2){if(this.CheckFlag(DFlags.DYNAMIC_CREATE)){this._vY=-DAI.BONUS_FLOAT_VY}}}}}if(this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE2||this._subState==DState.SS_BONUS_CRYSTAL_DROPPED){var I=DAI.HP_BONUS_RESISTANCE_VELOCITY;var m=true;if(m){if(Math.abs(this._vX)>I){if(this._vX<0){I=-I}this._vX-=I}else{this._vX=0}}}}break;case DClassID.PLATFORM:if(this._subState==DState.SS_RUN||this._subState==DState.SS_PLATFORM_SHAKE){if(this.MoveAndWaitToNextTrace(true)){}}if(this._subState==DState.SS_PLATFORM_HOLD){var N=a.GetEntityByID(this._tempParams[DTempParamIndex.PLATFORM_HOLD_FOR_ENTITY_ID],false);if(N!=null&&N._phyStandOn==this._id){this._stateElapsedTime=0}}if(this._subState==DState.SS_PLATFORM_FALL){this._vY=a.AddAndLimitVelocity(this._vY,DAI.PLATFORM_FALL_AY,DAI.PLATFORM_FALL_MAX_VY,false)}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){if(a._hero._phyStandOn==this._id&&this._subState!=DState.SS_PLATFORM_FALL){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_PLATFORM_FALL,0)}}break;case DClassID.CANNON:if(this._subState==DState.SS_CANNON_LAUNCH){var D=this.GetAttackBox();if(D[DEF.BOX_LEFT]!=D[DEF.BOX_RIGHT]){var O=this._posX+a.GetBoxMiddleX(D);var M=this._posY+a.GetBoxMiddleY(D);var A=0;if(this.IsFlipX()){A|=DFlags.FLIP_X}var Y=a.CreateDynamicEntity(DClassID.CANNONBALL,0,O,M,A,0,DParamIndex.CANNONBALL_AREAHEIGHT+1);Y._params[DParamIndex.POSX]=this._params[DParamIndex.POSX];Y._params[DParamIndex.POSY]=this._params[DParamIndex.POSY];Y._params[DParamIndex.CANNONBALL_AREALEFT]=this._params[DParamIndex.CANNON_AREALEFT];Y._params[DParamIndex.CANNONBALL_AREATOP]=this._params[DParamIndex.CANNON_AREATOP];Y._params[DParamIndex.CANNONBALL_AREAWIDTH]=this._params[DParamIndex.CANNON_AREAWIDTH];Y._params[DParamIndex.CANNONBALL_AREAHEIGHT]=this._params[DParamIndex.CANNON_AREAHEIGHT];Y._vX=(this._params[DParamIndex.CANNON_VX]<<DEF.SHIFT)*DScreen.ZOOM_MUL/DScreen.ZOOM_DIV;Y._vY=(this._params[DParamIndex.CANNON_VY]<<DEF.SHIFT)*DScreen.ZOOM_MUL/DScreen.ZOOM_DIV;if(this.IsFlipX()){Y._vX=-Y._vX}}}break;case DClassID.TRACE_CANNON:if(this._subState==DState.SS_CANNON_LAUNCH){var D=this.GetAttackBox();if(D[DEF.BOX_LEFT]!=D[DEF.BOX_RIGHT]){var O=this._posX+a.GetBoxMiddleX(D);var M=this._posY+a.GetBoxMiddleY(D);var A=DFlags.ACTIVE_BY_TRIGGER;if(this.CheckFlag(DFlags.FLIP_Y)){A|=DFlags.FLIP_Y}var Y=a.CreateDynamicEntity(DClassID.TRACE_CANNON_BALL,0,O,M,A,0,DParamIndex.TRACE_CANNON_BALL_VELOCITY+1);if(this.CheckFlag(DFlags.FLIP_Y)){Y._vY=-Y._vY}Y._params[DParamIndex.TRACE_CANNON_BALL_VELOCITY]=this._params[DParamIndex.TRACE_CANNON_VELOCITY]}}break;case DClassID.TRACE_CANNON_BALL:if(this._subState==DState.SS_CANNONBALL_FLY){if((s_game_currentFrameNB%2)==0){var aC=(this._params[DParamIndex.TRACE_CANNON_BALL_VELOCITY]<<DEF.SHIFT)*DScreen.ZOOM_MUL/DScreen.ZOOM_DIV;this._tempParams[DTempParamIndex.TRACE_CANNON_BALL_ANGLE]=Math_Atan(a._hero._posX+a.GetBoxMiddleX(a._hero._boundingBox)-this._posX,a._hero._posY+a.GetBoxMiddleY(a._hero._boundingBox)-this._posY);this.SetVelocityByAngle(aC,this._tempParams[DTempParamIndex.TRACE_CANNON_BALL_ANGLE])}}break;case DClassID.SEAGULL:if(this._subState==DState.SS_SEAGULL_FLY_HARD){if(this.MoveToDest(DAI.SEQGULL_FLY_HARD_VELOCITY,this._params[DParamIndex.SEAGULL_DESTX]<<DEF.SHIFT,this._params[DParamIndex.SEAGULL_DESTY]<<DEF.SHIFT)){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}else{if(this._curTrace>0){if(this.MoveAndWaitToNextTrace(true)){return DFSM.SMCR_OVER}}}break;case DClassID.MOBS_MONSTERINCHEST:if(this._subState==DState.SS_MONSTERINCHEST_INAIR){if(this._vY>=0){return DFSM.SMCR_OVER}}if(this._subState==DState.SS_MONSTERINCHEST_FALL){if(this.CheckPhysics(DFlags.PHY_BLOCK_UNDERSIDE)){if(this._params[DParamIndex.MOBS_MONSTERINCHEST_IDLEINTERVAL]==0){return DState.STATE_SIMPLE+DState.SS_MONSTERINCHEST_JUMP}this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_IDLE,0);this._stateDuration=this._params[DParamIndex.MOBS_MONSTERINCHEST_IDLEINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}}break;case DClassID.MOBS_BALLOONFISH:if(this.IntersectEntity(a._hero)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)){this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY)}else{if(this._subState==DState.SS_BALLOONFISH_ZOOMINED){a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}}break;case DClassID.REEF:case DClassID.FIRE:if(this.IntersectEntity(a._hero)){a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}break;case DClassID.LIGHTINGBALL:if(this.IntersectEntity(a._hero)){a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}if(this._curTrace>0){if(this.MoveAndWaitToNextTrace(true)){return DFSM.SMCR_DEFAULT}}break;case DClassID.MOBS_FLY:if(this.IntersectEntity(a._hero)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}if(this._subState==DState.SS_MOBS_BEE_MOVE_TO_WITCH_CIRCLE){if(this.MoveToDest(DAI.BOSS_WITCH_BEE_MOVE_TO_CIRCLE_VELOCITY,this._tempParams[DTempParamIndex.MOBS_BEE_DESTX],this._tempParams[DTempParamIndex.MOBS_BEE_DESTY])){return DFSM.SMCR_OVER}}else{if(this._subState==DState.SS_MOBS_BEE_RUSH_TO_HERO){if(this.MoveToDest(DAI.BOSS_WITCH_BEE_CIRCLE_RUSH_VELOCITY,this._tempParams[DTempParamIndex.MOBS_BEE_DESTX],this._tempParams[DTempParamIndex.MOBS_BEE_DESTY])){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY);return DFSM.SMCR_OVER}else{if(aF){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY)}}}else{this.SetFlipX(a._hero._posX<this._posX);if(this._curTrace>0){if(this.MoveAndWaitToNextTrace(true)){return DFSM.SMCR_DEFAULT}}}}break;case DClassID.MOBS_DANDELIONBOMB:if(this._subState==DState.SS_DANDELION_IDLE){if(this._tempParams[DTempParamIndex.DANDELION_SEED_COUNT]<this._params[DParamIndex.MOBS_DANDELIONBOMB_MAXCOUNT]){this._stateDuration=this._params[DParamIndex.MOBS_DANDELIONBOMB_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE}else{this._stateDuration=DFSM.DURATION_ENDLESS}}if(this._subState==DState.SS_DANDELION_BLOW){var D=this.GetAttackBox();if(D[2]>0){var N=null;var aB=LowAPI.Gen_Array([DParamIndex.MOBS_DANDELIONBOMB_INTERVAL+1],0);N=a.CreateDynamicEntity(aB,DClassID.MOBS_DANDELIONBOMB,DAnimID.MOBS_DANDELIONBOMB_SEED_JET,this._posX+a.GetBoxMiddleX(D),this._posY+a.GetBoxMiddleY(D),0);if(N==null){break}this._tempParams[DTempParamIndex.DANDELION_SEED_COUNT]++;N._relateEntity=this;N._vX=a.GetRand(DAI.DANDELION_SEED_MIN_VX,DAI.DANDELION_SEED_MAX_VX);N._vY=-a.GetRand(DAI.DANDELION_SEED_MIN_VY,DAI.DANDELION_SEED_MAX_VY);if(a.GetRand(0,1)==0){N._vX=-N._vX}if(this._params[DParamIndex.MOBS_DANDELIONBOMB_VYMULTIPLE]>0){N._vY*=this._params[DParamIndex.MOBS_DANDELIONBOMB_VYMULTIPLE]}}}if(this._subState==DState.SS_DANDELION_SEED_FALL||this._subState==DState.SS_DANDELION_SEED_JET||this._subState==DState.SS_DANDELION_SEED_OPEN){this._vY+=a.GetVelocity(this._subState==DState.SS_DANDELION_SEED_FALL?DAI.DANDELION_SEED_FALL_GRAVITY:DAI.DANDELION_SEED_JET_GRAVITY);if(this._subState==DState.SS_DANDELION_SEED_FALL){if(this._vY>DAI.DANDELION_SEED_MAX_FALL_VY){this._vY=DAI.DANDELION_SEED_MAX_FALL_VY}}if(this._posY>a._camY+DEF.SCR_H_FLOAT){this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}}break;case DClassID.ROLLING_PLATFORM:if(this._params[DParamIndex.ROLLING_PLATFORM_TYPE]==DValueList.ROLLING_PLATFORM_TYPE_MANUAL){var ay=false;var ap=Math_DegreeToFixedPointAngle(1);var F=Math_Angle90;var S=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY];var V=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE];for(var ac=0;ac<4;ac++){var aa=a.GetEntityByID(this._params[DParamIndex.ROLLING_PLATFORM_PLATFORM1+ac],false);if(aa!=null){if(a._hero.GetPhysicsEntityID()==aa._id){var al=ap;if(aa._posX<this._posX){al=-al}else{if(aa._posX==this._posX){al=0}}if(a._hero.IsPhysicsChanged()){S=al<<3}else{S+=al}ay=true;F=V;F&=Math_AngleMUL-1;break}V+=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE_STEP]}}var E=ap*3/4;S=this.VelocityByDamp(S,E);if(ay){if(F>Math_DegreeToFixedPointAngle(80)&&F<Math_DegreeToFixedPointAngle(100)){if(Math.abs(S)<=E*8){S=0;var B=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE];B=(B+Math_DegreeToFixedPointAngle(15))/Math_Angle90*Math_Angle90;this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE]=B}}}if(S>0){if(this.MoveAndWaitToNextTrace(false)){S=0}this._vX=(this._vX*Math.abs(S))>>6;this._vY=(this._vY*Math.abs(S))>>6}else{if(S<0){if(this.MoveToPreviousTrace(false)){S=0}this._vX=(this._vX*Math.abs(S))>>6;this._vY=(this._vY*Math.abs(S))>>6}else{S=0;this._vX=0;this.SetVY(0)}}this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY]=S}else{if(this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY]>0){this.MoveAndWaitToNextTrace(false)}else{if(this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY]<0){this.MoveToPreviousTrace(false)}else{this._vX=0;this.SetVY(0)}}}break;case DClassID.TRANSFORM_PLATFORM:var aA=Math.min(this._stateElapsedTime,this._params[DParamIndex.TRANSFORM_PLATFORM_TRANSFORM_TIME]*DAI.PARAM_INTERVAL_TIME_BASE);if(this._params[DParamIndex.TRANSFORM_PLATFORM_TYPE]==DValueList.TRANSFORM_PLATFORM_TYPE_FLEXIBLE){var P=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX]-this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MIN])*aA/(this._params[DParamIndex.TRANSFORM_PLATFORM_TRANSFORM_TIME]*DAI.PARAM_INTERVAL_TIME_BASE);if(this._subState==DState.SS_TRANSFORM_PLATFORM_SHRINK){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX])-P}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_EXPAND){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MIN])+P}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MAX){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MAX])}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MIN){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]=Math_IntToFixedPoint(this._params[DParamIndex.TRANSFORM_PLATFORM_DISTANCE_MIN])}}}}}else{var P=Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX]<<1)*aA/(this._params[DParamIndex.TRANSFORM_PLATFORM_TRANSFORM_TIME]*DAI.PARAM_INTERVAL_TIME_BASE);if(this._subState==DState.SS_TRANSFORM_PLATFORM_SHRINK){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE]=Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX])-P}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_EXPAND){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE]=-Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX])+P}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MAX){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE]=Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX])}else{if(this._subState==DState.SS_TRANSFORM_PLATFORM_HALT_MIN){this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE]=-Math_DegreeToFixedPointAngle(this._params[DParamIndex.TRANSFORM_PLATFORM_ANGLE_MAX])}}}}}break;case DClassID.TRIGGER:var at=false;var ah=this._params[DParamIndex.TRIGGER_TYPE];var l=this._params[DParamIndex.TRIGGER_RESULT_TYPE];var aG=null;if((this._params[DParamIndex.TRIGGER_ACTIVE_TYPE]==DAI.TRIGGER_ONLY_ONCE)&&(CGame._checkPointData!=null)){if(this._params[DParamIndex.TRIGGER_REQUIRED_CHECKPOINT]==CGame._checkPointData[0]){break}}if(this._subState==DState.SS_IDLE){switch(ah){case DValueList.TRIGGER_TYPE_TRIGGER_BY_ANY_REQUIRED_ACTOR:for(var ac=0;ac<3;ac++){var N=a.GetEntityByID(this._params[DParamIndex.TRIGGER_REQUIRED_1+ac],false);if(N!=null){if(a.InBox(N._posX,N._posY,this.GetAbsoluteBox(this._boundingBox))){at=true;break}}}break;case DValueList.TRIGGER_TYPE_CIRCULAR_CINEMATIC:var ag=InScreenM2(this._posX,this._posY,Math_IntToFixedPoint(this._params[DParamIndex.TRIGGER_W]),Math_IntToFixedPoint(this._params[DParamIndex.TRIGGER_H]));for(var ac=0;ac<3;ac++){var X=CGame.GetCinematicIndex(this._params[DParamIndex.TRIGGER_RESULT_1+ac]);if(X>=0){if(ag){if(CGame._cinematicsFrameTime[X]<0){CGame.StartCinemitic(X)}else{CGame._cinematicsStatus[X]|=DCinematic.STATUS_CIRCLE}}else{CGame._cinematicsStatus[X]&=~DCinematic.STATUS_CIRCLE;CGame.EndCinemitic(X)}}}break;case DValueList.TRIGGER_TYPE_TRIGGER_BY_DESTROYED_ACTOR:at=true;for(var ac=0;ac<3;ac++){aG=a.GetRowDataByID(this._params[DParamIndex.TRIGGER_REQUIRED_1+ac]);if(aG!=null){if((aG[DParamIndex.FLAGS]&DFlags.DESTROYED)==0){at=false}}}break;case DValueList.TRIGGER_TYPE_ACTIVE_AND_DEACTIVE:var aI=false;for(var ac=0;ac<3;ac++){aG=a.GetRowDataByID(this._params[DParamIndex.TRIGGER_REQUIRED_1+ac]);if(aG!=null){if(a.InBox(Math_IntToFixedPoint(aG[DParamIndex.POSX]),Math_IntToFixedPoint(aG[DParamIndex.POSY]),this.GetAbsoluteBox(this._boundingBox))){aI=true;break}}}at=true;if(aI){l=DValueList.TRIGGER_RESULT_TYPE_ACTIVE}else{l=DValueList.TRIGGER_RESULT_TYPE_INACTIVE}break}if(at){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);this.SetFlag(DFlags.ACTIVE_BY_TRIGGER)}}var C=this._params[DParamIndex.TRIGGER_START_TIME]*100;if(this._subState==DState.SS_TRIGGER_START){if(this._stateElapsedTime>=C){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}var az=this._params[DParamIndex.TRIGGER_INTERVAL_TIME]*100;if(this._subState==DState.SS_TRIGGER_ACTIVED){if(this._stateElapsedTime>=az){this._stateElapsedTime-=az;if(l==DValueList.TRIGGER_RESULT_TYPE_GAME_OVER){}else{if(l==DValueList.TRIGGER_RESULT_TYPE_PASS_LEVEL){CGame.GotoNextLevel(true)}else{var w=false;var h=az==0?2:this._tempParams[DTempParamIndex.TRIGGER_RESULT_INDEX];for(var ac=this._tempParams[DTempParamIndex.TRIGGER_RESULT_INDEX];ac<=h;++ac){var ab=this._params[DParamIndex.TRIGGER_RESULT_1+ac];if(l==DValueList.TRIGGER_RESULT_TYPE_ACTIVE){CGame.ActiveEntityOrCinematic(ab)}else{if(l==DValueList.TRIGGER_RESULT_TYPE_INACTIVE){CGame.InactiveEntityOrCinematic(ab,true)}else{if(l==DValueList.TRIGGER_RESULT_TYPE_DESTROY){aG=a.GetRowDataByID(ab);if(aG!=null){aG[DParamIndex.FLAGS]|=DFlags.DESTROYED}}else{if(l==DValueList.TRIGGER_RESULT_TYPE_SEND_NOTIFY){var N=a.GetEntityByID(ab,false);if(N!=null){N.NotifyEvent(this,DEvent.BE_TRIGGERED,this._params[DParamIndex.TRIGGER_PARAM],0,0)}}}}}if(ac==h){w=true}}if(w){this.ClearFlag(DFlags.ACTIVE_BY_TRIGGER);if(this._params[DParamIndex.TRIGGER_TYPE]!=DValueList.TRIGGER_TYPE_ACTIVE_AND_DEACTIVE){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}}}}}break;case DClassID.MOBS_BARREL:if(this._subState==DState.SS_MOBS_BARREL_IDLE){if(a._hero.GetPhysicsEntityID()==this._id){this._stateDuration=DAI.MOBS_BARREL_IDLE_DURATION}else{this._stateDuration=DFSM.DURATION_ENDLESS;if(this.CanSee(a._hero,a.CANSEE_VIEW_AREA|a.CANSEE_VIEW_BACKSEE,0)!=a.CANSEE_RESULT_NONE){this.SetFlipX(a._hero._posX<this._posX);return DState.STATE_SIMPLE+DState.SS_MOBS_BARREL_OUT}}break}if(this._subState==DState.SS_MOBS_BARREL_RUN){if(this._frameVX<0&&(this._posX>>DEF.SHIFT)<this._params[DParamIndex.MOVE_AREA]||this._frameVX>0&&(this._posX>>DEF.SHIFT)>this._params[DParamIndex.MOVE_AREA+2]){return DState.STATE_SIMPLE+DState.SS_MOBS_BARREL_TURN}if(this.CanSee(a._hero,a.CANSEE_VIEW_AREA,0)==a.CANSEE_RESULT_NONE){return DState.STATE_SIMPLE+DState.SS_MOBS_BARREL_IN}if(this._stateElapsedTime>=DAI.MOBS_BARREL_RUN_MIN_INTERVAL){if(a._hero._posX<this._posX!=this.IsFlipX()&&a._hero._state==DState.STATE_ONGROUND){return DState.STATE_SIMPLE+DState.SS_MOBS_BARREL_TURN}}break}if(this._subState==DState.SS_MOBS_BARREL_TURN){this._vX=this._vX*12/24;if(Math.abs(this._vX)<DAI.MOBS_BARREL_TURN_MIN_VX){return DFSM.SMCR_OVER}break}break;case DClassID.MOBS_ACALEPH:if(this._subState==DState.SS_ACALEPH_RUSH){this._vY=this._vY*3/4;this._vX=this._vX*7/8;if(this._vY>=-4<<DEF.SHIFT){return DFSM.SMCR_OVER}break}break;case DClassID.MOBS_ROLLING_STARFISH:if(this._curTrace>0){if(this.MoveAndWaitToNextTrace(true)){}}break;case DClassID.MOBS_SHELL:if(this._subState==DState.SS_SHELL_OPEN){var D=this.GetAttackBox();if(D[2]>0){var aB=LowAPI.Gen_Array([DParamIndex.MOBS_SHELL_TYPE+1],0);var j=1;var ac;if(this._params[DParamIndex.MOBS_SHELL_TYPE]==DValueList.MOBS_SHELL_SHOOT_TYPE_TWODIRECTORY){j=2}if(this._params[DParamIndex.MOBS_SHELL_TYPE]==DValueList.MOBS_SHELL_SHOOT_TYPE_THREEDIRECTORY){j=3}var n=LowAPI.Gen_Array([3],0);for(ac=0;ac<j;ac++){n[ac]=a.CreateDynamicEntity(aB,DClassID.MOBS_SHELL,DAnimID.MOBS_SHELL_BULLET,this._posX+a.GetBoxMiddleX(D),this._posY+a.GetBoxMiddleY(D),0)}switch(j){case 1:n[0]._vY=-DAI.SHELL_BULLET_VELOCITY;break;case 2:n[0]._vX=-DAI.SHELL_BULLET_VELOCITY/2;n[0]._vY=n[0]._vX*1732/1000;n[1]._vX=-n[0]._vX;n[1]._vY=n[0]._vY;break;case 3:n[1]._vY=-DAI.SHELL_BULLET_VELOCITY;n[0]._vX=-DAI.SHELL_BULLET_VELOCITY*707/1000;n[0]._vY=n[0]._vX;n[2]._vX=-n[0]._vX;n[2]._vY=n[0]._vY;break}for(ac=0;ac<j;ac++){n[ac]=null}}}else{if(this._subState==DState.SS_SHELL_IDLE){if(this.IntersectEntity(a._hero)){a._hero.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}}break;case DClassID.STONE:if(this.IsStartDropping()){if(this._tempParams[DTempParamIndex.STONE_DROP_Y]==0){this._tempParams[DTempParamIndex.STONE_DROP_Y]=this._posY}}break;case DClassID.VIRTUALBLOCK:if(this._params[DParamIndex.VIRTUALBLOCK_OWNERID]>=0){var N=a.GetEntityByID(this._params[DParamIndex.VIRTUALBLOCK_OWNERID],false);if(N==null){this.StateMachineModifyStatus(DFSM.CSF_INACTIVE)}}break;case DClassID.RANDOMBONUS:if(this._subState==DState.SS_RANDOMBONUS_TRIGGER){this.SetFlag(DFlags.ACTIVE_BY_TRIGGER);var k=this._params[DParamIndex.RANDOMBONUS_LINK1+this._tempParams[DTempParamIndex.RANDOMBONUS_TRIGGER_ITEM]];var ax=false;if(this._stateElapsedTime>DAI.RANDOMBONUS_ACTIVE_INTERVAL){this._stateElapsedTime-=DAI.RANDOMBONUS_ACTIVE_INTERVAL;ax=true}var u=true;if(ax){if(k>0){var N=a.GetEntityByID(k,true);if(N!=null){if(N._classID==DClassID.DOOR){N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DOOR_GO_UP,0);this.AI_Hint_ShowSoundEffect(DAnimID.HINT_BOOM_,-1,-1)}else{if(N._classID==DClassID.BONUS){if(DEvent.RESULT_OK==N.NotifyEvent(this,DEvent.BE_TRIGGERED,DEvent.ACTION_ACTIVE_NEXT,0,0)){u=false}}else{a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,N._posX,N._posY)}}if(u){N.ClearFlag(DFlags.ACTIVE_BY_TRIGGER);N._params[DParamIndex.FLAGS]&=~DFlags.ACTIVE_BY_TRIGGER}}}if(u){this._tempParams[DTempParamIndex.RANDOMBONUS_TRIGGER_ITEM]++;if(this._tempParams[DTempParamIndex.RANDOMBONUS_TRIGGER_ITEM]>=3){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);this.ClearFlag(DFlags.ACTIVE_BY_TRIGGER)}}}}if(this._subState==DState.SS_RANDOMBONUS_BONUS_FLY){if(this._stateElapsedTime>=DAI.RANDOMBONUS_BONUS_EFFECT_INTERVAL&&!this.CheckFlag(DFlags.INVISIBLE)){this._stateElapsedTime=0;var N=a.CreateDynamicEntity(DClassID.RANDOMBONUS,0,this._posX,this._posY,0,0,10);N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_EFFECT,0)}if(this._vX<0&&this._posX<=a._camX||this._vX>0&&this._posX>=a._camX+DEF.SCR_W_FLOAT){if(this._tempParams[DAI.SVI_RANDOMBONUS_BONUS_COUNTER]==0){if(a._boss!=null){a._boss._relateEntity=this;this.StateMachineModifyStatus(DFSM.CSF_INVISIBLE);this._posX=a._camX-DEF.TILE_W_FLOAT;this._vX=0}else{this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}}else{this._tempParams[DAI.SVI_RANDOMBONUS_BONUS_COUNTER]--;this._vX=-this._vX}}}break;case DClassID.OBJ_DAMAGE_STONE:if(this._subState==DState.SS_DAMAGE_STONE_TRACE){if(this._curTrace>0){if(this.MoveAndWaitToNextTrace(true)){}}}else{this._vX=0;this.SetVY(0)}break;case DClassID.BLACK_HOLE:if(a._HeroRelateEntity==this){if(a._hero._subState==DState.SS_INBLACK_HOLE_ABSORB){var p=this._posX-(a._hero._posX+a.GetBoxMiddleX(a._hero._boundingBox));var o=this._posY-(a._hero._posY+a.GetBoxMiddleY(a._hero._boundingBox));var d=a.GetDistance(p,o);if(d>=DAI.BLACK_HOLE_AFFECT_DISTANCE){var P=Math_FixedPoint_Divide(Math.max(DAI.BLACK_HOLE_AFFECT_DISTANCE*2-d,DAI.BLACK_HOLE_AFFECT_DISTANCE>>3),DAI.BLACK_HOLE_AFFECT_DISTANCE<<1);a._hero._vX=Math_FixedPoint_Multiply(p,P);a._hero._vY=Math_FixedPoint_Multiply(o,P)}else{a._hero.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);this._tempParams[DTempParamIndex.BLACK_HOLE_START_ANGLE]=Math_Atan(-p,-o);this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]=this._tempParams[DTempParamIndex.BLACK_HOLE_START_ANGLE];this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]=this._params[DParamIndex.BLACK_HOLE_CIRCLES];this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE]=a.GetDistance(p,o)}}else{if(a._hero._subState==DState.SS_INBLACK_HOLE){if(this._animationPlayer.GetAnim()==DEffectAnimID.SPAWN_HOLE_CLOCKWISE){this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]+=DAI.BLACK_HOLE_ANGULAR_VELOCITY;if(this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]>this._tempParams[DTempParamIndex.BLACK_HOLE_START_ANGLE]+Math_Angle360){this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]--;this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]-=Math_Angle360}}else{this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]-=DAI.BLACK_HOLE_ANGULAR_VELOCITY;if(this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]<this._tempParams[DTempParamIndex.BLACK_HOLE_START_ANGLE]-Math_Angle360){this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]--;this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]+=Math_Angle360}}this.GetPositionWithAngle(this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE],this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE],this._posX,this._posY);a._hero.SetPos(a._TempIntArray[DParamIndex.POSX],a._TempIntArray[DParamIndex.POSY]-a.GetBoxMiddleY(a._hero._boundingBox));if(this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]<=0){a._hero.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}var ak=this._params[DParamIndex.BLACK_HOLE_TYPE]==DValueList.BLACK_HOLE_TYPE_CLOCKWISE&&(a._keyUp||a._keyRightUp);ak|=this._params[DParamIndex.BLACK_HOLE_TYPE]==DValueList.BLACK_HOLE_TYPE_ANTI_CLOCKWISE&&(a._keyUp||a._keyLeftUp);if(ak){a._hero.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_ROCKCRAFT_JUMP,0);this.GetPositionWithAngle(DAI.BLACK_HOLE_EXIT_VELOCITY,this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE],0,0);a._hero._vX+=a._TempIntArray[DParamIndex.POSX];a._hero._vY+=a._TempIntArray[DParamIndex.POSY];this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]=this._params[DParamIndex.BLACK_HOLE_CIRCLES]}}else{if(a._hero._subState==DState.SS_INBLACK_HOLE_ABSORB_IN){if(this._animationPlayer.GetAnim()==DEffectAnimID.SPAWN_HOLE_CLOCKWISE){this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]+=DAI.BLACK_HOLE_ANGULAR_VELOCITY<<1}else{this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE]-=DAI.BLACK_HOLE_ANGULAR_VELOCITY<<1}this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE]-=DAI.BLACK_HOLE_ABSORB_VELOCITY;if(this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE]<=0){this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE]=0;a._HeroParams[DAI.HPI_LIVES]--;a._hero.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}this.GetPositionWithAngle(this._tempParams[DTempParamIndex.BLACK_HOLE_DISTANCE],this._tempParams[DTempParamIndex.BLACK_HOLE_ANGLE],this._posX,this._posY);a._hero.SetPos(a._TempIntArray[DParamIndex.POSX],a._TempIntArray[DParamIndex.POSY]-a.GetBoxMiddleY(a._hero._boundingBox))}else{if(!this.IntersectEntity(a._hero)){a._HeroRelateEntity=null}}}}}break;case DClassID.WATER:if(this.IntersectEntity(a._hero)){a._HeroInWater=true;a._HeroInWaterSurfaceY=this._posY}if(s_game_currentFrameNB%30==0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_AIR_BUBBLE,0,this._posX+Math_Rand(DEF.TILE_W_FLOAT,this._boundingBox[DEF.BOX_RIGHT]),this._posY+this._boundingBox[DEF.BOX_BOTTOM])}break;case DClassID.BOSS_EATER:T=this.AI_BOSS_FlowerEater(aE,aF);break;case DClassID.BOSS_OCTOPUS:T=this.AI_BOSS_Octopus();break;case DClassID.BOSS_OCTOPUS_HEAD:var aC=0;var ar=this._posX,aq=0;switch(this._subState){case DState.SS_OCTOPUS_HEAD_RAISE_PRE:aq=a._boss._params[DParamIndex.BOSS_OCTOPUS_AREA_Y]<<DEF.SHIFT;aC=DAI.BOSS_OCTOPUS_RAISE_VY;break;case DState.SS_OCTOPUS_HEAD_GO_DOWN:aq=(a._boss._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]+DEF.TILE_H)<<DEF.SHIFT;aC=DAI.BOSS_OCTOPUS_GO_DOWN_VY;break;case DState.SS_OCTOPUS_HEAD_REST:if(!a._BossOctopusHurt){var X=CGame.GetCinematicIndex(a._boss._params[DParamIndex.BOSS_OCTOPUS_CINEMATIC_LINK]);if(X>=0){if(CGame._cinematicsFrameTime[X]<0){CGame.StartCinemitic(X)}CGame._cinematicsStatus[X]|=DCinematic.STATUS_CIRCLE}}break;case DState.SS_OCTOPUS_HEAD_RAISE:aq=a._boss._params[DParamIndex.BOSS_OCTOPUS_AREA_Y]<<DEF.SHIFT;aC=DAI.BOSS_OCTOPUS_RAISE_VY;break;case DState.SS_OCTOPUS_HEAD_BACK:aq=a._boss._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;aC=DAI.BOSS_OCTOPUS_GO_DOWN_VY;break}if((aC!=0)&&this.MoveToDest(aC,ar,aq)){switch(this._subState){case DState.SS_OCTOPUS_HEAD_RAISE_PRE:return DState.STATE_SIMPLE+DState.SS_OCTOPUS_HEAD_GO_DOWN;case DState.SS_OCTOPUS_HEAD_GO_DOWN:return DState.STATE_SIMPLE+DState.SS_OCTOPUS_HEAD_REST;case DState.SS_OCTOPUS_HEAD_RAISE:return DState.STATE_SIMPLE+DState.SS_OCTOPUS_HEAD_BACK;case DState.SS_OCTOPUS_HEAD_BACK:return DState.STATE_SIMPLE+DState.SS_OCTOPUS_HEAD_IDLE}}break;case DClassID.BOSS_OCTOPUS_TENTACLE:var au=this.IsFlipX();var aC=0;var ar=0,aq=this._posY;switch(this._subState){case DState.SS_TENTACLE_MOVEIN_PRE:if(au){ar=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE_AREA_X+2]<<DEF.SHIFT}else{ar=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE_AREA_X]<<DEF.SHIFT}aC=DAI.TENTACLE_MOVE_SLOW_VX;break;case DState.SS_TENTACLE_MOVEIN:if(au){ar=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE_AREA_X]<<DEF.SHIFT}else{ar=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE_AREA_X+2]<<DEF.SHIFT}aC=DAI.TENTACLE_MOVE_FAST_VX;break;case DState.SS_TENTACLE_MOVEOUT:ar=this._tempParams[DTempParamIndex.TENTACLE_MOVE_LIMIT_LEFT]<<DEF.SHIFT;aC=DAI.TENTACLE_MOVE_FAST_VX;break}if((aC!=0)&&this.MoveToDest(aC,ar,aq)){switch(this._subState){case DState.SS_TENTACLE_MOVEIN_PRE:return DState.STATE_SIMPLE+DState.SS_TENTACLE_MOVEIN;case DState.SS_TENTACLE_MOVEIN:return DState.STATE_SIMPLE+DState.SS_TENTACLE_MOVEOUT;case DState.SS_TENTACLE_MOVEOUT:return DState.STATE_SIMPLE+DState.SS_TENTACLE_IDLE}}break;case DClassID.BOSS_KILLERBEE:var au=this.IsFlipX();var aC=0;var ar=0,aq=0;switch(this._subState){case DState.SS_BOSS_KILLER_BEE_CIRCLE_IDLE_FLY:if(au){ar=this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT]<<DEF.SHIFT}else{ar=this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]<<DEF.SHIFT}aq=this._params[DParamIndex.BOSS_KILLERBEE_AREATOP]<<DEF.SHIFT;aC=DAI.BOSS_KILLER_BEE_CIRCLE_IDLE_FLY_VELOCITY;break;case DState.SS_BOSS_KILLER_BEE_CIRCLE_RUSH:aq=this._params[DParamIndex.BOSS_KILLERBEE_AREABOTTOM]<<DEF.SHIFT;aq+=DAI.BOSS_KILLER_BEE_CIRCLE_RUSH_DEST_DELTA_Y;if(au){ar=this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]<<DEF.SHIFT}else{ar=this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT]<<DEF.SHIFT}aC=DAI.BOSS_KILLER_BEE_CIRCLE_RUSH_VELOCITY;break;case DState.SS_BOSS_KILLER_BEE_BOMB_FLY:ar=(this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]+this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT])<<(DEF.SHIFT-1);aq=this._params[DParamIndex.BOSS_KILLERBEE_AREATOP]<<DEF.SHIFT;aC=DAI.BOSS_KILLER_BEE_BOMB_FLY_VELOCITY;this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_BOMB_COUNT]=DAI.BOSS_KILLER_BEE_BOMB_COUNT*2;break;case DState.SS_BOSS_KILLER_BEE_BOMB_WAIT:this._stateDuration=this._params[DParamIndex.BOSS_KILLERBEE_BOMBINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;if(this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_BOMB_COUNT]<=0){if(this._relateEntity!=null){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_FLY,0)}return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_CIRCLE_IDLE_FLY}if(a._hero._state==DState.STATE_INAIR){return DFSM.SMCR_NO_OVER}break;case DState.SS_BOSS_KILLER_BEE_BOMB_BOMB:var D=this.GetAttackBox();if(D[DEF.BOX_LEFT]!=D[DEF.BOX_RIGHT]){this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_BOMB_COUNT]--;var O=this._posX+a.GetBoxMiddleX(D);var M=this._posY+a.GetBoxMiddleY(D);var A=0;if(this.IsFlipX()){A|=DFlags.FLIP_X}var N=a.CreateDynamicEntity(DClassID.BOSS_KILLERBEE,DAnimID.BOSS_KILLERBEE_KNIFE_1,O,M,A,0,DParamIndex.BOSS_KILLERBEE_STICKINTERVALPOWERED+1);if(this._animationPlayer.GetFrame()>this._animationPlayer.GetNbFrame()/2){N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_1,0)}else{N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1,0)}N.SetFlipX(a._hero._posX<this._posX);if(Math.abs(a._hero._posX-this._posX)*4>Math.abs(a._hero._posY-this._posY)){if(N._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1){N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2,0)}else{N.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_KNIFE_2,0)}}if(N._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_1||N._subState==DState.SS_BOSS_KILLER_BEE_BOMB_FORK_2){N.MoveToDest(DAI.BOSS_KILLER_BEE_BOMB_FORK_VELOCITY,a._hero._posX,a._hero._posY)}else{N.MoveToDest(DAI.BOSS_KILLER_BEE_BOMB_KNIFE_VELOCITY,a._hero._posX,a._hero._posY)}}break;case DState.SS_BOSS_KILLER_BEE_PIERCE_FLY:if(Math.abs(a._hero._posX-this._posX)>(2<<DEF.SHIFT)){this.SetFlipX(a._hero._posX<this._posX);ar=a._hero._posX;aq=this._params[DParamIndex.BOSS_KILLERBEE_AREATOP]<<DEF.SHIFT;this._stateDuration=this._params[DParamIndex.BOSS_KILLERBEE_BOMBINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;aC=DAI.BOSS_KILLER_BEE_PIERCE_FLY_VELOCITY}break;case DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH:this._vY+=a.GetVelocity(DAI.BOSS_KILLER_BEE_PIERCE_RUSH_AV);break;case DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH_BACK:ar=this._posX;aq=this._params[DParamIndex.BOSS_KILLERBEE_AREABOTTOM]<<DEF.SHIFT;aC=DAI.BOSS_KILLER_BEE_PIERCE_RUSH_VELOCITY;break;case DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH_MOVE:if(this._posX<=(this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]<<DEF.SHIFT)||this._posX>=(this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT]<<DEF.SHIFT)){this.TurnOver()}break;case DState.SS_BOSS_KILLER_BEE_HURT_AWAY:if(this._posX<=(this._params[DParamIndex.BOSS_KILLERBEE_AREALEFT]<<DEF.SHIFT)||this._posX>=(this._params[DParamIndex.BOSS_KILLERBEE_AREARIGHT]<<DEF.SHIFT)){this.TurnOver()}break}if(aC>0){if(this.MoveToDest(aC,ar,aq)){switch(this._subState){case DState.SS_BOSS_KILLER_BEE_CIRCLE_IDLE_FLY:return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_CIRCLE_PREPARE;case DState.SS_BOSS_KILLER_BEE_CIRCLE_RUSH:this.TurnOver();this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_CIRCLE_COUNT]--;if(this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_CIRCLE_COUNT]==0){this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_PIERCE_COUNT]=DAI.BOSS_KILLER_BEE_PIERCE_COUNT;if(this._relateEntity!=null){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_FLY,0)}return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_PIERCE_FLY}return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_CIRCLE_IDLE_FLY;case DState.SS_BOSS_KILLER_BEE_BOMB_FLY:this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_CIRCLE_COUNT]=DAI.BOSS_KILLER_BEE_CIRCLE_COUNT;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_BOMB_WAIT,0);this._stateElapsedTime=this._params[DParamIndex.BOSS_KILLERBEE_BOMBINTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE+1;break;case DState.SS_BOSS_KILLER_BEE_PIERCE_FLY:this._posX=a._hero._posX;this._vX=0;this._vY=0;break;case DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH_BACK:this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_PIERCE_COUNT]--;if(this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_PIERCE_COUNT]==0){if(this._relateEntity!=null){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_FLY,0)}return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_BOMB_FLY}this.SetFlipX(a._hero._posX<this._posX);return DState.STATE_SIMPLE+DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH_MOVE}}}break;case DClassID.BOSS_UFO:var ad=this._params[DParamIndex.MOBS_FIRE_AREALEFT]<<DEF.SHIFT;var aw=this._params[DParamIndex.MOBS_FIRE_AREATOP]<<DEF.SHIFT;var ai=this._params[DParamIndex.MOBS_FIRE_AREARIGHT]<<DEF.SHIFT;var t=this._params[DParamIndex.MOBS_FIRE_AREABOTTOM]<<DEF.SHIFT;var aC=0;var ar=0,aq=0;var au=this.IsFlipX();var D=this.GetAttackBox();if(this._tempParams[DTempParamIndex.BOSS_UFO_HURT_TICK]>0){this._tempParams[DTempParamIndex.BOSS_UFO_HURT_TICK]--}if(a._HeroInElectric==0){a._HeroInElectric=DValueList.ELECTRIC_FIELD_TYPE_POSITIVE}switch(this._subState){case DState.SS_BOSS_UFO_ATTACK1_MOVE_TO_ORIGINAL:this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_COUNT]=2;aq=aw;if(au==this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_DIR]>=0){ar=ad}else{ar=ai}aC=DAI.BOSS_UFO_ATTACK1_MOVE_TO_ORIGINAL_VELOCITY;break;case DState.SS_BOSS_UFO_ATTACK1_FLY:this._stateDuration=this._params[DParamIndex.BOSS_UFO_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_UFO_ATTACK1_ATTACK:aq=aw;if(au){ar=ad}else{ar=ai}aC=DAI.BOSS_UFO_ATTACK1_MOVE_TO_ORIGINAL_VELOCITY;if(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]>0){this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_HURT_INTERVER]--}if(true){if(this.CheckLightBeamCollisionWithEntity(a._hero,this._posX+a.GetBoxMiddleX(D),this._posY+a.GetBoxMiddleY(D),false)){a._hero.NotifyEvent(this,DEvent.UFO_HIT,DValueList.UFO_FIRE_TYPE_PURPLE,0,0)}}break;case DState.SS_BOSS_UFO_ATTACK2_MOVE_TO_ORIGINAL:this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE]=DAI.BOSS_UFO_ATTACK2_START_ANGLE;this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_EXPLODE_FRAME]=0;aq=aw;ar=(ad+ai)>>1;aC=DAI.BOSS_UFO_ATTACK2_MOVE_TO_ORIGINAL_VELOCITY;break;case DState.SS_BOSS_UFO_ATTACK2_FLY:this._stateDuration=this._params[DParamIndex.BOSS_UFO_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT:case DState.SS_BOSS_UFO_ATTACK2_ATTACK_RIGHT:this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE]+=DAI.BOSS_UFO_ATTACK2_DELTA_ANGLE;if(this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE]>DAI.BOSS_UFO_ATTACK2_END_ANGLE){if(a._camQuake==0){a.AI_CameraQuake(a.k_camQuake_OffsetY)}var ab=this._params[DParamIndex.BOSS_UFO_EXPLODELEFT1];var aB=a.GetRowDataByID(ab);var M=aB[DParamIndex.POSY];M<<=DEF.SHIFT;if(this._subState==DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT){ab=this._params[DParamIndex.BOSS_UFO_EXPLODELEFT1+a.GetRand(0,2)]}else{ab=this._params[DParamIndex.BOSS_UFO_EXPLODERIGHT1+a.GetRand(0,2)]}this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_EXPLODE_ID]=ab;while(true){var K=a.GetEntityByID(ab,true);if(K==null){break}K.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);K._posY=M;K._stateDuration=K._params[DParamIndex.UFO_DESTROY_WAIT]*DAI.PARAM_INTERVAL_TIME_BASE;ab=K._params[DParamIndex.UFO_DESTROY_NEXT]}this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE]=DAI.BOSS_UFO_ATTACK2_START_ANGLE;if(this._subState==DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT){return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT_WAIT}else{return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK2_ATTACK_RIGHT_WAIT}}break;case DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT_WAIT:case DState.SS_BOSS_UFO_ATTACK2_ATTACK_RIGHT_WAIT:var ab=this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_EXPLODE_ID];var f=false;var U=false;while(true){var K=a.GetEntityByID(ab,true);if(K==null){break}if(K._subState==DState.SS_BOSS_UFO_EXPLODE_BIG_WAIT||K._subState==DState.SS_BOSS_UFO_EXPLODE_SMALL_WAIT||K._subState==DState.SS_BOSS_UFO_EXPLODE_BIG_PREPARE||K._subState==DState.SS_BOSS_UFO_EXPLODE_SMALL_PREPARE){U=true}if(K._subState!=DState.SS_BOSS_UFO_EXPLODE_BIG_IDLE&&K._subState!=DState.SS_BOSS_UFO_EXPLODE_SMALL_IDLE){f=true;break}ab=K._params[DParamIndex.UFO_DESTROY_NEXT]}if(a._camQuake==0&&U){a.AI_CameraQuake(a.k_camQuake_OffsetY)}if(!f){if(this._subState==DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT_WAIT){return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK2_ATTACK_RIGHT}else{return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK3_MOVE_TO_ORIGINAL}}break;case DState.SS_BOSS_UFO_ATTACK3_MOVE_TO_ORIGINAL:this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE]=DAI.BOSS_UFO_ATTACK2_START_ANGLE;aq=aw;ar=(ad+ai)>>1;aC=DAI.BOSS_UFO_ATTACK2_MOVE_TO_ORIGINAL_VELOCITY;break;case DState.SS_BOSS_UFO_ATTACK3_FLY:this._stateDuration=this._params[DParamIndex.BOSS_UFO_INTERVAL]*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_UFO_ATTACK3_ATTACK:if(D[DEF.BOX_LEFT]!=D[DEF.BOX_RIGHT]){var O=this._posX+a.GetBoxMiddleX(D);var M=this._posY+a.GetBoxMiddleY(D);var A=0;var Y=a.CreateDynamicEntity(DClassID.TRACE_CANNON_BALL,0,O,M,A,0,10);Y._vY=-Y._vY;Y._params[DParamIndex.TRACE_CANNON_BALL_VELOCITY]=DAI.BOSS_UFO_ATTACK3_CANNON_VELOCITY;var k=a.GetEntityByID(this._params[DParamIndex.BOSS_UFO_MAGNETICFIELD],true);if(k!=null){}}break;case DState.SS_BOSS_UFO_ATTACK4_PREPARE:case DState.SS_BOSS_UFO_ATTACK4_FLY:case DState.SS_BOSS_UFO_ATTACK4_ATTACK:aq=aw;if(au){ar=ad}else{ar=ai}aC=DAI.BOSS_UFO_ATTACK4_FLY_VELOCITY;break}if(aC>0){if(this.MoveToDest(aC,ar,aq)){switch(this._subState){case DState.SS_BOSS_UFO_ATTACK1_MOVE_TO_ORIGINAL:if(this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_DIR]==0){this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_DIR]=1}this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_DIR]=-this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_DIR];this.TurnOver();return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK1_FLY;case DState.SS_BOSS_UFO_ATTACK1_ATTACK:this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_COUNT]--;if(this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK1_COUNT]<=0){return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK2_MOVE_TO_ORIGINAL}case DState.SS_BOSS_UFO_ATTACK1_FLY:this.TurnOver();break;case DState.SS_BOSS_UFO_ATTACK2_MOVE_TO_ORIGINAL:return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK2_FLY;case DState.SS_BOSS_UFO_ATTACK3_MOVE_TO_ORIGINAL:return DState.STATE_SIMPLE+DState.SS_BOSS_UFO_ATTACK3_FLY;case DState.SS_BOSS_UFO_ATTACK4_PREPARE:case DState.SS_BOSS_UFO_ATTACK4_FLY:case DState.SS_BOSS_UFO_ATTACK4_ATTACK:this.TurnOver();break}}}break;case DClassID.BOSS_WITCH:if(a._boss!=null&&a._boss._classID!=this._id){a._boss=this}T=this.AI_BOSS_Witch(aE,aF);break;case DClassID.BOSS_WITCH_EX_PART:T=this.AI_BOSS_WitchBody(aE,aF);break;case DClassID.MOBS_FIRE:break;case DClassID.ELECTRIC_FIELD:if(this.IntersectEntity(a._hero)){a._HeroInElectricField=this._params[DParamIndex.ELECTRIC_FIELD_TYPE]}this._tempParams[DTempParamIndex.ELECTRIC_ELAPSED_TIME]+=CGame._frameDT;break;case DClassID.BALANCE:if(a._hero._phyStandOn!=this._id){var S=this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY];var ap=Math_DegreeToFixedPointAngle(1);var F=this._tempParams[DTempParamIndex.BALANCE_ANGLE];if(F>0&&F<=DAI.BALANCE_MAX_ANGLE){S-=ap;var aD=F+S;S-=(aD<0)?aD:0}else{if(F>=(-DAI.BALANCE_MAX_ANGLE)&&F<0){S+=ap;var aD=F+S;S-=(aD>0)?aD:0}else{S=0}}this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY]=S}this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY]=this.VelocityByDamp(this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY],Math_DegreeToFixedPointAngle(1)/4);break;case DClassID.FLY_CANNON:T=this.AI_MiniGame_Cannon(aE,aF);break}if(this.CheckExFlag(DFlags.EX_BOSS)){var L=(this._classID==DClassID.BOSS_KILLERBEE&&this._subState==DState.SS_BOSS_KILLER_BEE_HURT)||(this._subState==DState.SS_BOSS_BE_ATTACK||this._subState==DState.SS_BOSS_HURT);var R=(this._state==DState.STATE_SIMPLE&&this._subState==DState.SS_DISAPPEAR)&&(this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_PREPARATORY_STEP)<DAI.BOSS_DEAD_PREPARATORY_DURATION_FRAM);if(L){if(Math_Rand(0,2)==1){a.AI_CameraQuake(a.k_camQuake_OffsetY)}}if(R){var am=Math_Rand(0,5);a.AI_CameraQuake(a.k_camQuake_OffsetY*am)}}return T};a.prototype.LimitVelocity=function(e,d){if(d==0){d=DEF.FLOAT_1}if(e>-d&&e<0){return -d}if(e>0&&e<d){return d}return e};a.prototype.InitTrace=function(e){this._curTrace=e;if(this._curTrace>0){var d=a.GetRowDataByID(this._curTrace);this.SetPos(Math_IntToFixedPoint(d[DParamIndex.POSX]),Math_IntToFixedPoint(d[DParamIndex.POSY]));if(this._classID!=DClassID.PLATFORM&&this._classID!=DClassID.TRACE_RENDER&&this._classID!=DClassID.OBJ_DAMAGE_STONE&&this._classID!=DClassID.MOBS_UFO&&this._classID!=DClassID.CAMERA){this._params[DParamIndex.POSX]=d[DParamIndex.POSX];this._params[DParamIndex.POSY]=d[DParamIndex.POSY]}}};a.prototype.MoveAndWaitToNextTrace=function(d){var h=this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]!=0||this.MoveToNextTrace(d);if(!h){var f=a.GetRowDataByID(this._curTrace);if(f!=null){var e=a.GetRowDataByID(f[DParamIndex.TRACE_WAIT_LINK]);if(e!=null){if((e[DParamIndex.FLAGS]&DFlags.DESTROYED)==0){h=true}}}}if(h){this._vX=0;this._vY=0;if(this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]==0){var f=a.GetRowDataByID(this._curTrace);if(f!=null){this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]=f[DParamIndex.TRACE_WAITTIME]*DAI.PARAM_INTERVAL_TIME_BASE;h=this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]==0}}else{this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]-=CGame._frameDT;if(this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]<=0){this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]=0}else{h=false}}}else{this._tempParams[DTempParamIndex.TRACE_WAIT_TIME]=0}return h};a.prototype.MoveToPreviousTrace=function(d){return this.MoveToTrace(DParamIndex.TRACE_PREVIOUS_TRACE,d)};a.prototype.MoveToNextTrace=function(d){return this.MoveToTrace(DParamIndex.TRACE_NEXT_TRACE,d)};a.prototype.MoveToTrace=function(h,f){if(this._curTrace<0){return true}var i=a.GetRowDataByID(this._curTrace);if(!(i!=null)){Dbg("this._curTrace == null")}var e=i[DParamIndex.TRACE_VELOCITY]*96;var d=null;if(h==DParamIndex.TRACE_NEXT_TRACE){if(i[h]<0){if(f){this._curTrace=-1}return true}else{d=a.GetRowDataByID(i[h])}}else{d=i}if(this.MoveToDest(e,Math_IntToFixedPoint(d[DParamIndex.POSX]),Math_IntToFixedPoint(d[DParamIndex.POSY]))){if(i[h]!=-1||f){this._curTrace=i[h]}return true}return false};a.prototype.MoveToDest=function(i,h,e){var j=a.GetDistance(this._posX-h,this._posY-e);if(j<i/GLLibConfig.FPSLimiter/2){var f=h-this._posX;var d=e-this._posY;this._vX=Math_FixedPoint_Divide(f,CGame._velocityRate);this.SetVY(Math_FixedPoint_Divide(d,CGame._velocityRate));return true}else{if(j<i/GLLibConfig.FPSLimiter){this.SetVelocityByDest(i/2,h-this._posX,e-this._posY)}else{this.SetVelocityByDest(i,h-this._posX,e-this._posY)}}return false};a.prototype.IsNearEnough=function(f,e){var d=false;if(f.IsFlipX()){d=f._posX>this._posX&&(f._posX+f._boundingBox[DEF.BOX_LEFT])-(this._posX+this._boundingBox[DEF.BOX_RIGHT])<e}else{d=f._posX<this._posX&&(this._posX+this._boundingBox[DEF.BOX_LEFT])-(f._posX+f._boundingBox[DEF.BOX_RIGHT])<e}if(d){return Math.abs(this._posY-f._posY)<(8<<DEF.SHIFT)}return false};a.GetDistance=function(f,e){if(f<0){f=-f}if(e<0){e=-e}var h,d;if(f<e){h=f;d=e}else{h=e;d=f}return((d<<8)-(d<<3)-(d<<1)+(h<<6)+(h<<5)+(h<<2)+(h<<1))>>8};a.prototype.NearEnough=function(d,f,e){return a.GetDistance(this._posX-d,this._posY-f)<=e};a._debugCheatNoDecreaseHP;a._debugCheatNoHurt;a._debugCheatLastPressedKey;a.prototype.Debug_Update_Cheating=function(){if(a._debugCheatLastPressedKey==GLKey.k_fire){if(WasKeyPressed(a.k_LeftUp)){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HERO_END_MINIGAME,DFSM.CSTATEF_KEEP_VX)}if(WasKeyPressed(a.k_LeftDown)){a._debugCheatNoDecreaseHP=!a._debugCheatNoDecreaseHP}if(WasKeyPressed(a.k_RightDown)){a._debugCheatNoHurt=!a._debugCheatNoHurt}if(WasKeyPressed(a.k_up)){if(a._boss!=null){if(a._boss._classID==DClassID.BOSS_OCTOPUS&&a._boss._relateEntity!=null){a._boss._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}a._boss.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{if(a._camera._curTrace>0){a._camera._curTrace=-1;a._camera.SetInactived(true)}}}if(IsKeyDown(GLKey.k_down)){a._debugCheatLastPressedKey=GLKey.k_down;ResetKey()}if(WasAnyKeyPressed()!=GLKey.k_invalid&&!IsKeyDown(GLKey.k_fire)&&!IsKeyDown(GLKey.k_down)){a._debugCheatLastPressedKey=0;ResetKey()}return}else{if(a._debugCheatLastPressedKey==GLKey.k_down){if(WasKeyPressed(a.k_LeftUp)){a._HeroPoweredBullet=!a._HeroPoweredBullet}if(WasKeyPressed(a.k_up)){a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_FAT)}if(WasKeyPressed(a.k_RightUp)){a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_ROBIN_HOOD)}if(WasKeyPressed(a.k_LeftDown)){a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_ESKIMO)}if(WasKeyPressed(a.k_RightDown)){a._HeroPoweredBullet=false;this.AI_Hero_StartMorph(DAI.HERO_MORPH_SWORD_FISH)}if(WasAnyKeyPressed()!=GLKey.k_invalid){a._debugCheatLastPressedKey=0;ResetKey()}return}}if(IsKeyDown(GLKey.k_fire)){a._debugCheatLastPressedKey=GLKey.k_fire;ResetKey()}this._vX=0;this.SetVY(0);var d=this._posX,e=this._posY;if(IsKeyDown(GLKey.k_left)){this._posX-=a._FreeMoveDistance}if(IsKeyDown(GLKey.k_right)){this._posX+=a._FreeMoveDistance}if(IsKeyDown(GLKey.k_up)){this._posY-=a._FreeMoveDistance}if(IsKeyDown(GLKey.k_down)){this._posY+=a._FreeMoveDistance}if(WasKeyPressed(GLKey.k_num1)){this._posX-=DEF.FLOAT_1}if(WasKeyPressed(GLKey.k_num3)){this._posX+=DEF.FLOAT_1}if(WasKeyPressed(GLKey.k_num7)){this._posX-=DEF.TILE_W_FLOAT/2}if(WasKeyPressed(GLKey.k_num9)){this._posX+=DEF.TILE_W_FLOAT/2}if(WasKeyPressed(GLKey.k_fire)){this._posX-=this._posX%DEF.TILE_W_FLOAT}if(this._posX<0){this._posX=0}if(this._posY<0){this._posY=0}if(d!=this._posX||e!=this._posY){a._FreeMoveDistance+=64}else{a._FreeMoveDistance=a.FreeMoveDistanceInit}};a.k_LeftUp=GLKey.k_num1;a.k_LeftDown=GLKey.k_num7;a.k_RightDown=GLKey.k_num9;a.k_RightUp=GLKey.k_num3;a.k_up=GLKey.k_up;a.k_down=GLKey.k_down;a.k_num0=GLKey.k_num0;a._keyUp=false;a._keyDown=false;a._keyUpHold=false;a._keyDownHold=false;a._keyLeftHold=false;a._keyRightHold=false;a._Key0Hold=false;a._keyLeft=false;a._keyRight=false;a._keyLeftUp=false;a._keyRightUp=false;a._keyLeftUpHold=false;a._keyRightUpHold=false;a._keyLeftDownHold=false;a._keyRightDownHold=false;a._keyLeftDown=false;a._keyRightDown=false;a._keyAttack=false;a._keyAttackHold=false;a.PrepareHeroKeys=function(){if(a._hero.CheckFlag(DFlags.REVERSAL_GRAVITY)){a.k_LeftUp=GLKey.k_num7;a.k_LeftDown=GLKey.k_num1;a.k_RightDown=GLKey.k_num3;a.k_RightUp=GLKey.k_num9;a.k_up=GLKey.k_down;a.k_down=GLKey.k_up}else{a.k_LeftUp=GLKey.k_num1;a.k_LeftDown=GLKey.k_num7;a.k_RightDown=GLKey.k_num9;a.k_RightUp=GLKey.k_num3;a.k_up=GLKey.k_up;a.k_down=GLKey.k_down}a._keyUp=WasKeyPressed(a.k_up);a._keyDown=WasKeyPressed(a.k_down);a._keyUpHold=IsKeyDown(a.k_up);a._keyDownHold=IsKeyDown(a.k_down);a._Key0Hold=IsKeyDown(a.k_num0);a._keyLeftUp=WasKeyPressed(a.k_LeftUp);a._keyRightUp=WasKeyPressed(a.k_RightUp);a._keyLeftUpHold=IsKeyDown(a.k_LeftUp);a._keyRightUpHold=IsKeyDown(a.k_RightUp);a._keyLeftHold=IsKeyDown(GLKey.k_left);a._keyRightHold=IsKeyDown(GLKey.k_right);a._keyLeft=WasKeyPressed(GLKey.k_left);a._keyRight=WasKeyPressed(GLKey.k_right);a._keyAttack=WasKeyPressed(GLKey.k_fire)||CGame._keyAttack;a._keyAttackHold=IsKeyDown(GLKey.k_fire);a._keyLeftDownHold=IsKeyDown(a.k_LeftDown);a._keyRightDownHold=IsKeyDown(a.k_RightDown);a._keyLeftDown=WasKeyPressed(a.k_LeftDown);a._keyRightDown=WasKeyPressed(a.k_RightDown);a.PrepareHeroKeysMultitouch()};a.PrepareHeroKeysMultitouch=function(){if(Device.isTouchDevice){a._keyUp=a._keyUpHold=(CGame._keyJump);a._keyDown=a._keyDownHold=(CGame._keyCrouch);a._keyLeft=a._keyLeftHold=CGame._keyLeft;a._keyRight=a._keyRightHold=CGame._keyRight;a._keyAttack=a._keyAttackHold=CGame._keyAttack}CGame._keyJump=false;CGame._keyCrouch=false;CGame._keyUp=false;CGame._keyDown=false;CGame._keyLeft=false;CGame._keyRight=false;CGame._keyAttack=false};a.prototype.CheckKeyForward=function(){var d=this.IsFlipX();return a._keyLeftHold&&d||a._keyRightHold&&!d};a.prototype.CheckKeyForwardBeveledDirections=function(){var d=this.IsFlipX();return(a._keyLeftUpHold||a._keyLeftDownHold)&&d||(a._keyRightUpHold||a._keyRightDownHold)&&!d};a.prototype.CheckKeyBackward=function(){var d=this.IsFlipX();return a._keyLeftHold&&!d||a._keyRightHold&&d};a.prototype.CheckKeyBackwardBeveledDirections=function(){var d=this.IsFlipX();return(a._keyLeftUpHold||a._keyLeftDownHold)&&!d||(a._keyRightUpHold||a._keyRightDownHold)&&d};a.prototype.CheakKeyUpward=function(){return a._keyUpHold||a._keyDownHold};a._HurtByTentacle=false;a._TentacleSide=0;a._BossOctopusHurt=false;a._BossOctopusHurtBySit=false;a._HeroFallingStartY=0;a._HeroInStateFlags=0;a._HeroInStateKey=0;a._HeroParams=LowAPI.Gen_Array([10],0);a._HeroInvincibilityFrame=0;a._HeroKickableEntity=null;a._HeroPoweredBullet=false;a._HeroRelateEntity=null;a._HeroInMorph=0;a._HeroInWater=false;a._HeroInWaterSurfaceY=0;a._HeroInElectric=0;a._HeroInElectricAngle=0;a._HeroInElectricField=0;a._HeroBeAttackByInkbomb=false;a._HeroShowInkTime=0;a._HeroOxygen=0;a._HeroMorphEnergy=0;a._HeroStateTick=0;a._HeroDrawInairTurn=false;a._HeroIce=null;a._HeroInAirKey=0;a._HeroInAirKeyTime=0;a.AI_Hero_SetMorph=function(d){a._HeroInMorph=d};a.AI_Hero_GetMorph=function(){return a._HeroInMorph};a.AI_Hero_CheckMorph=function(d){return a._HeroInMorph==d};a.prototype.AI_Hero_CheckAttack=function(){if(a._keyAttack&&this._subState!=DState.SS_SHOOT&&this._subState!=DState.SS_COMBAT&&this._subState!=DState.SS_HERO_TOXOPHILY){if((a._HeroPoweredBullet&&a._bullet[a._lastBulletIndex]._subState==DState.SS_IDLE)||(!a._HeroPoweredBullet&&a._bullet[a._lastBulletIndex]._subState!=DState.SS_ARROW_FLY)){a._lastBulletIndex=a._bulletIndex++;a._bulletIndex=a._bulletIndex%DAI.BULLET_MAX_NUM;return true}}return false};a.prototype.AI_Hero_CheckJump=function(){var f=DFSM.STATE_NONE;var h=this._subState==DState.SS_NOMOVE_VER;var i=this._subState==DState.SS_HERO_ROCKCRAFT;if(a._keyUp&&!h&&!i){a._HeroInStateKey=a.k_up;if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,this._posX,this._posY)}if(this._subState==DState.SS_SLOWDOWN){f=DState.SS_INAIR_JUMP_DIAG_START}else{f=DState.SS_INAIR_JUMP_VER_START;if((this._vX!=0)){f=DState.SS_INAIR_JUMP_DIAG_START}}}if(a._keyLeftUp||a._keyRightUp){if(h||i){if(this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]<0&&a._keyLeftUpHold||this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]>0&&a._keyRightUpHold){return false}}a._HeroInStateKey=a._keyLeftUpHold?a.k_LeftUp:a.k_RightUp;this.SetFlipX(a._keyLeftUpHold);if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,this._posX,this._posY)}if(!h&&!i){f=DState.SS_INAIR_JUMP_DIAG_START}else{f=DState.SS_INAIR_ROCKCRAFT_JUMP}}if(a._keyLeft||a._keyRight){if(h||i){if(this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]<0&&a._keyLeftHold||this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]>0&&a._keyRightHold){return false}}a._HeroInStateKey=a._keyLeftHold?GLKey.k_left:GLKey.k_right;this.SetFlipX(a._keyLeftHold);if(this.CheckPhysics(DFlags.PHY_SEG_BINDING)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,this._posX,this._posY)}if(h||i){f=DState.SS_INAIR_ROCKCRAFT_JUMP}}if(IsKeyDown(a.k_num0)&&!h&&!i){a._HeroInStateKey=a.k_num0;f=DState.SS_INAIR_JUMP_VER_START}if(f!=DFSM.STATE_NONE){if(CGame._worldId!=DAI.WORLD_ID_SPACE&&(h||i)){var e=a.RENDER_TYPE_ANIMATION;var d=this._posX;if(this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]<0){d+=this._boundingBox[DEF.BOX_LEFT]}else{d+=this._boundingBox[DEF.BOX_RIGHT];e|=a.RENDER_FLAG_FLIPX}if(h){a.PrepareRender(e,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_VER_UP,0,d,this._posY)}else{a.PrepareRender(e,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_SNOWBALL_HIT,0,d,this._posY)}}this.StateMachineChangeState(DState.STATE_INAIR,f,0);if(Math.abs(this._vX)>DAI.HERO_INAIR_MAX_RUN_JUMP_VX){this._vX=(this._vX>0?1:-1)*DAI.HERO_INAIR_MAX_RUN_JUMP_VX}return true}return false};a.prototype.AI_Hero_Fat_CheckJump=function(){return this.AI_Hero_CheckJump()};a.prototype.AI_Hero_CheckTransmission=function(){if(this.CheckPhysics(DFlags.PHY_SEGMENT)){var e=this.GetPhysicsEntityID();var d=a.GetEntityByID(e,false);if(d!=null){if(d._classID==DClassID.TRANSMISSION){if(d._subState==DState.SS_TRANSMISSION_CLOCKWISE&&this.IsFlipX()||d._subState==DState.SS_TRANSMISSION_ANTICLOCKWISE&&!this.IsFlipX()){if(this._subState!=DState.SS_WALK){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_WALK,0)}this._vX=DAI.HERO_WALK_ONTRANSMISSION_VX;if(this.IsFlipX()){this._vX=-this._vX}}}}}};a.prototype.AI_Hero_Sync_HeadEntity_Pos=function(){a._HeroRelateEntity._posX=this._posX;a._HeroRelateEntity._posY=this._posY+this._boundingBox[DEF.BOX_TOP];a._HeroRelateEntity._vX=0;a._HeroRelateEntity._vY=0};a.prototype.AI_Hero_IsSmash=function(){return(this._subState==DState.SS_INAIR_SMASH_FALL||this._subState==DState.SS_INAIR_SMASH_FALL_HOLD||this._subState==DState.SS_INAIR_SMASH_FALL_SHAKE)};a.prototype.AI_Hero_SlowDown=function(){if(this.CheckIcePhysics()){if(this._preFullState==DState.STATE_ONGROUND+DState.SS_RUN){this._vX=this._vX-this._vX*6/(11*4)}else{this._vX=this._vX-this._vX*6/(24*3)}}else{this._vX=this._vX-this._vX*6/24}if(Math.abs(this._vX)<DAI.HERO_RUN_SLOW_DOWN_MIN_VX){this._vX=0;if(this._subState==DState.SS_CROUCH){if(this.CheckAheadBlock(0,DAI.HERO_STANDUP_HEIGHT)){this._vX=DAI.HERO_CROUCH_SLOW_DOWN_MIN_VX;if(this.IsFlipX()){this._vX=-this._vX}}}else{return true}}return false};a.prototype.CheckIcePhysics=function(){if(!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){return this.CheckPhysics(DFlags.PHY_SEG_ICE)}return false};a.prototype.AI_Hero_WalkFast=function(){var f=DAI.HERO_WALK_AX;var d=DAI.HERO_WALK_MAX_VX;var e=DAI.HERO_RUN_VX;if(this.CheckIcePhysics()){f=DAI.HERO_ICE_WALK_AX;d=DAI.HERO_ICE_WALK_MAX_VX}if(this.IsFlipX()){f=-f;d=-d}this.AddVX(f);if(this.IsFlipX()?this._vX<=-DAI.HERO_RUN_VX:this._vX>=DAI.HERO_RUN_VX){this._vX=d;return true}return false};a.prototype.AI_Hero_InEntityArea=function(k,i,f,h){var l,e,d,j;l=this._posX+k;e=l+f;d=this._posY+i;j=d+h;if(a._hero._posX<l){return false}else{if(a._hero._posX>e){return false}else{if(a._hero._posY<d){return false}else{if(a._hero._posY>j){return false}}}}return true};a.prototype.AI_Hero=function(p,A){if(CGame.godModeUnlock){if((WasKeyPressed(GLKey.k_star))||(CGame.isPointInRect(0,0,50*DScreen.RATIO,50*DScreen.RATIO))){Dbg("__________________ correct");a.HeroMoveTraceCount=0;a._IsCheating=!a._IsCheating;if(!a._IsCheating){this._sprite=CGame.spriteArray[DSpriteID.HERO];this._animationPlayer.SetSprite(this._sprite);this.SetFlag(DFlags.GRAVITY);this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_FALL_START,0)}}if(a._IsCheating){this.Debug_Update_Cheating();return DFSM.SMCR_DEFAULT}}if(this._state==DState.STATE_DIE){return DFSM.SMCR_DEFAULT}if(a._camera._params[DParamIndex.CAMERA_TYPE]!=DValueList.CAMERA_TYPE_NORMAL){if(a._hero._subState!=DState.SS_GO_INDOOR&&(a._hero._state!=DState.STATE_DIE&&a._hero._subState!=DState.SS_DISAPPEAR)&&!a._inMiniGame){if(a._camera._curTrace>0){a._tempBox=a._camera.GetAbsoluteBox(a._camera._boundingBox);a._tempBox[DEF.BOX_LEFT]+=a._hero._boundingBox[DEF.BOX_LEFT];a._tempBox[DEF.BOX_RIGHT]+=a._hero._boundingBox[DEF.BOX_RIGHT]}else{a._tempBox[DEF.BOX_LEFT]=Math_IntToFixedPoint(a._camera._params[DParamIndex.POSX])+a._hero._boundingBox[DEF.BOX_LEFT];a._tempBox[DEF.BOX_TOP]=Math_IntToFixedPoint(a._camera._params[DParamIndex.POSY]);a._tempBox[DEF.BOX_RIGHT]=a._tempBox[DEF.BOX_LEFT]+Math_IntToFixedPoint(a._camera._params[DParamIndex.CAMERA_WIDTH])+(a._hero._boundingBox[DEF.BOX_RIGHT]-a._hero._boundingBox[DEF.BOX_LEFT]);a._tempBox[DEF.BOX_BOTTOM]=a._tempBox[DEF.BOX_TOP]+Math_IntToFixedPoint(a._camera._params[DParamIndex.CAMERA_HEIGHT])}var o=a.CheckInBox(a._hero._posX,a._hero._posY,a._tempBox);if((o&a._camera._params[DParamIndex.CAMERA_LIMIT])!=0){var E=true;if((o&DValueList.CAMERA_LIMIT_TOP)==DValueList.CAMERA_LIMIT_TOP){if(a._hero._posY>a._camY-DEF.VIEW_H_D2_FLOAT){E=false}}if((o&DValueList.CAMERA_LIMIT_BOTTOM)==DValueList.CAMERA_LIMIT_BOTTOM){if(a._hero._posY-DEF.TILE_H_M2_FLOAT<a._camY+DEF.VIEW_H_FLOAT+DEF.TILE_H_FLOAT){E=false}}if(E){this.NotifyEvent(this,DEvent.HERO_DIE,0,0,0);return DFSM.SMCR_DEFAULT}}}}if(a._HeroInElectricField+a._HeroInElectric==DValueList.ELECTRIC_FIELD_TYPE_NEGATIVE+DValueList.ELECTRIC_FIELD_TYPE_POSITIVE){if(!this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(this._state==DState.STATE_CHANGE&&(this._subState==DState.SS_HERO_CHANGE_FLY_FLY||this._subState==DState.SS_HERO_CHANGE_FLY)){}else{this.SetFlipForReversalGravity(true)}this.SetFlag(DFlags.REVERSAL_GRAVITY);if(this._state!=DState.STATE_CHANGE){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_ABSORB,0)}return DFSM.SMCR_DEFAULT}}else{this.SetFlipForReversalGravity(false);this.ClearFlag(DFlags.REVERSAL_GRAVITY)}if(a._HeroInvincibilityFrame>0){a._HeroInvincibilityFrame--}if(a._HeroInStateKey!=0){if(!IsKeyDown(a._HeroInStateKey)){a._HeroInStateKey=0}}if(this._state==DState.STATE_NO_CONTROL){return DFSM.SMCR_DEFAULT}if(this._subState==DState.SS_HERO_IN_FLY_CANNON||this._subState==DState.SS_HERO_START_MINIGAME){a._HeroInElectric=0;return DFSM.SMCR_DEFAULT}else{if(this._subState==DState.SS_HERO_BROKEN_BIG_CRYSTAL||this._subState==DState.SS_HERO_NO_HIT_BIG_CRYSTAL){this.AI_Hero_EndMiniGame();return DFSM.SMCR_DEFAULT}else{if(this._subState==DState.SS_HERO_END_MINIGAME){if(!a.InScreenM2(this._posX,this._posY)){this._vX=0}return DFSM.SMCR_DEFAULT}}}if(this._state==DState.STATE_ONGROUND&&this._subState!=DState.SS_NOMOVE_VER&&this.IsStartDropping()){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_FALL,DFSM.CSTATEF_NOFOUND_NOCHANGE)}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){a._HeroStateTick+=CGame._frameDT;if(a._HeroMorphEnergy>0){while(a._HeroStateTick>=DAI.MORPH_ENERGY_DECREASE_INTERVAL){a._HeroStateTick-=DAI.MORPH_ENERGY_DECREASE_INTERVAL;a._HeroMorphEnergy--;if(a._HeroMorphEnergy==0){a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX,this._posY);CGame.ShowInterfaceElement(DValueList.BONUS_TYPE_CAKE);this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_FALL,0)}}}}if(this._subState==DState.SS_SHOOT||this._subState==DState.SS_COMBAT||this._subState==DState.SS_HERO_TOXOPHILY||this._subState==DState.SS_HERO_AXE){if(this._state==DState.STATE_ONGROUND){this.AI_Hero_SlowDown()}if(a._bullet[a._lastBulletIndex]!=null&&(this._subState==DState.SS_COMBAT||this._subState==DState.SS_SHOOT||this._subState==DState.SS_HERO_TOXOPHILY||this._subState==DState.SS_HERO_AXE)){if(this._subState==DState.SS_SHOOT){a._BulletShadowIndex=0;for(var z=a._BulletShadowData.length-1;z>=0;z--){a._BulletShadowData[z]=0}}a._bullet[a._lastBulletIndex].SetFlipX(this.IsFlipX());var l=this.GetAttackBox();if(l[DEF.BOX_LEFT]!=l[DEF.BOX_RIGHT]){var e;a._bullet[a._lastBulletIndex].SetPos(this._posX+a.GetBoxMiddleX(l),this._posY+a.GetBoxMiddleY(l));a._bullet[a._lastBulletIndex]._tempParams[DTempParamIndex.BULLET_ORIGIN_POSX]=a._bullet[a._lastBulletIndex]._posX;a._bullet[a._lastBulletIndex].SetFlag(DFlags.COLLIDING_WITH_SEGMENT);if(a._HeroPoweredBullet){a._bullet[a._lastBulletIndex].StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BULLET_RUN,0)}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)){e=DState.SS_ARROW_FLY}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){e=DState.SS_BULLET_CLOSE_AXE}else{e=DState.SS_BULLET_CLOSE_RUN}}a._bullet[a._lastBulletIndex].StateMachineChangeState(DState.STATE_SIMPLE,e,0)}}}}if(this._subState==DState.SS_TOSS){var l=this.GetAttackBox();if(l[DEF.BOX_LEFT]!=l[DEF.BOX_RIGHT]){this._relateEntity.SetPos(this._posX+a.GetBoxMiddleX(l),this._posY+a.GetBoxMiddleY(l));this._relateEntity.ClearFlag(DFlags.INVISIBLE);this._relateEntity.SetFlipX(this.IsFlipX());this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_YETI_SNOW_BALL,0);this._relateEntity._tempParams[DTempParamIndex.SNOW_BALL_HERO]=1;this._relateEntity=null}}if(this._state==DState.STATE_ONGROUND){if(a._inMiniGame&&a._keyAttack){return DFSM.SMCR_DEFAULT}if(this._subState!=DState.SS_HARDMOVE&&this._vX!=0&&this.CheckPhysics(DFlags.PHY_SEG_BINDING)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DState.STATE_ONGROUND+DState.SS_HARDMOVE}if(this._subState==DState.SS_HARDMOVE&&this._vX!=0&&!this.CheckPhysics(DFlags.PHY_SEG_BINDING)){return DState.STATE_ONGROUND+DState.SS_WALK}if(this._subState==DState.SS_WALK||this._subState==DState.SS_RUN||this._subState==DState.SS_SLOWDOWN){this.AI_Hero_CheckTransmission()}if(a._HeroInWater){if(this._vY==0){this.SetVY(DAI.HERO_WATER_FALL_VY)}if(this._posY>a._HeroInWaterSurfaceY+DEF.TILE_H_FLOAT){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FALL,0);return DFSM.SMCR_DEFAULT}}switch(this._subState){case DState.SS_SLOWDOWN:if(this.AI_Hero_SlowDown()){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}case DState.SS_IDLE:case DState.SS_HERO_FALL_END:if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_FAT_IDLE,0)}if(this.AI_Hero_CheckJump()){return DFSM.SMCR_DEFAULT}if(a._keyDown){if(!this.CheckPhysics(DFlags.PHY_SEG_BINDING)){a._HeroInStateKey=a.k_down;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCHDOWN,DFSM.CSTATEF_KEEP_VX)}}if(a._HeroKickableEntity!=null&&a._keyAttack){a._HeroKickableEntity.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);a._HeroKickableEntity=null;return DState.STATE_ONGROUND+DState.SS_KICK}if(this.AI_Hero_CheckAttack()){if(a._HeroPoweredBullet){return this._state+DState.SS_SHOOT}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)){a._bullet[a._lastBulletIndex].StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0)}return this._state+(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)?DState.SS_HERO_TOXOPHILY:DState.SS_HERO_AXE)}else{return this._state+DState.SS_COMBAT}}}if(this.CheckKeyForward()){if(this.CheckIcePhysics()){if(this._subState!=DState.SS_SLOWDOWN){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_WALK,DFSM.CSTATEF_KEEP_VX)}}else{if(!this.CheckPhysics(DFlags.PHY_SEG_BINDING)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){return DState.STATE_ONGROUND+DState.SS_WALK}else{this.AI_Hint_ShowSoundEffect(DAnimID.HINT_UGH_,-1,-1);return DState.STATE_ONGROUND+DState.SS_HARDMOVE}}}if(this.CheckKeyBackward()){if(this._subState==DState.SS_SLOWDOWN&&!this.CheckIcePhysics()){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_RUN_TURN,DFSM.CSTATEF_KEEP_VX)}else{this.SetFlipX(!this.IsFlipX())}}break;case DState.SS_WALK:if(this.AI_Hero_CheckJump()){return DFSM.SMCR_DEFAULT}if(a._keyDown){a._HeroInStateKey=a.k_down;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCHDOWN,DFSM.CSTATEF_KEEP_VX);return DFSM.SMCR_DEFAULT}if(this.AI_Hero_CheckAttack()){if(a._HeroPoweredBullet){return this._state+DState.SS_SHOOT}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){return this._state+(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)?DState.SS_HERO_TOXOPHILY:DState.SS_HERO_AXE)}else{return this._state+DState.SS_COMBAT}}}if(this.CheckKeyForward()){if(this.AI_Hero_WalkFast()){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}else{if(this.CheckKeyBackward()){if(this.CheckIcePhysics()){this.SetFlipX(!this.IsFlipX())}else{return DState.STATE_ONGROUND+DState.SS_IDLE}}else{if(this.CheckIcePhysics()){if(Math.abs(this._vX)>DAI.HERO_ICE_GOTO_SLOW_DOWN_MIN_VX){return DState.STATE_ONGROUND+DState.SS_SLOWDOWN}}return DState.STATE_ONGROUND+DState.SS_IDLE}}break;case DState.SS_HARDMOVE:if(!this.CheckPhysics(DFlags.PHY_SEG_BINDING)){return DState.STATE_ONGROUND+DState.SS_WALK}if(!this.CheckKeyForward()){return DFSM.SMCR_OVER}break;case DState.SS_RUN:if(this.AI_Hero_CheckJump()){return DFSM.SMCR_DEFAULT}if(a._keyDown){a._HeroInStateKey=a.k_down;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCHDOWN,DFSM.CSTATEF_KEEP_VX);return DFSM.SMCR_DEFAULT}if(this.AI_Hero_CheckAttack()){this._subState=DState.SS_WALK;if(a._HeroPoweredBullet){return this._state+DState.SS_SHOOT}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){return this._state+(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)?DState.SS_HERO_TOXOPHILY:DState.SS_HERO_AXE)}else{return this._state+DState.SS_COMBAT}}}if(this.CheckKeyForward()||(a._HeroInStateKey==a.k_LeftUp||a._HeroInStateKey==a.k_RightUp)&&IsKeyDown(a._HeroInStateKey)){return DFSM.SMCR_DEFAULT}else{return DState.STATE_ONGROUND+DState.SS_SLOWDOWN}case DState.SS_CROUCH:this.AI_Hero_SlowDown();if(a._HeroInStateKey==0){if(this.CheckAheadBlock(0,DAI.HERO_STANDUP_HEIGHT)){if(Math.abs(this._vX)<DAI.HERO_CROUCH_SLOW_DOWN_MIN_VX){this._vX=DAI.HERO_CROUCH_SLOW_DOWN_MIN_VX;if(this.IsFlipX()){this._vX=-this._vX}}}else{this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCHUP,DFSM.CSTATEF_KEEP_VX);if(this._vX!=0){this._nextFullState=DState.STATE_ONGROUND+DState.SS_SLOWDOWN}break}}else{if(a._keyLeft||a._keyRight||a._keyUp){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCHUP,DFSM.CSTATEF_KEEP_VX);if(this._vX!=0){this._nextFullState=DState.STATE_ONGROUND+DState.SS_SLOWDOWN}}}break;case DState.SS_SMASH_FALL_SIT:if(!a._keyDownHold){return DState.STATE_ONGROUND+DState.SS_IDLE}break;case DState.SS_NOMOVE_VER:this.AI_Hero_CheckJump();break;case DState.SS_FAT_IDLE:if(this.AI_Hero_Fat_CheckJump()){break}if(this.CheckKeyForward()){return DState.STATE_ONGROUND+DState.SS_FAT_WALK}if(this.CheckKeyBackward()){this.SetFlipX(!this.IsFlipX())}break;case DState.SS_FAT_WALK:if(this.AI_Hero_Fat_CheckJump()){break}if(!this.CheckKeyForward()){return DState.STATE_ONGROUND+DState.SS_FAT_IDLE}break;case DState.SS_FAT_HIT_COOKIE:if(!this.CheckKeyForward()){return DState.STATE_ONGROUND+DState.SS_FAT_IDLE}else{this._vX=DAI.FAT_HIT_COOKIE_VX;if(this.IsFlipX()){this._vX=-this._vX}}break;case DState.SS_FALL_ON_NOMOVE:this.AI_Hero_CheckJump();break;case DState.SS_HERO_ROCKCRAFT:this.AI_Hero_CheckJump();case DState.SS_HERO_ROCKCRAFT_FALL:if(this._tempParams[DTempParamIndex.HERO_ROCKCRAFT]==0){return DState.STATE_INAIR+DState.SS_INAIR_FALL}this._tempParams[DTempParamIndex.HERO_ROCKCRAFT]=0;if(a._keyDownHold){return DState.STATE_ONGROUND+DState.SS_HERO_ROCKCRAFT_FALL}else{if(this._subState==DState.SS_HERO_ROCKCRAFT_FALL){return DFSM.SMCR_OVER}}var w=a.RENDER_TYPE_ANIMATION;var k=this._posX;var j=this._posY+this._boundingBox[DEF.BOX_TOP];if(this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]<0){k+=this._boundingBox[DEF.BOX_LEFT]}else{k+=this._boundingBox[DEF.BOX_RIGHT];w|=a.RENDER_FLAG_FLIPX}a.PrepareRender(w,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_ICE__SPLASH_DOWN,s_game_currentFrameNB%2,k,j);break}return DFSM.SMCR_DEFAULT}if(this._state==DState.STATE_INAIR){var t=this._vY;if(!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)&&(this._subState!=DState.SS_SHOOT)&&(this._subState!=DState.SS_COMBAT)&&(this._subState!=DState.SS_HERO_TOXOPHILY)&&(this._subState!=DState.SS_HERO_AXE)){if((a._HeroInStateFlags&DAI.ISF_INAIR_HAS_EXTEND_JUMPED)==0){if((a._keyUp||WasKeyPressed(GLKey.k_num0))&&t>0&&this._subState!=DState.SS_INAIR_FLOAT_FLY&&this._subState!=DState.SS_INAIR_FLOAT_UP){a._HeroInStateKey=a._keyUp?a.k_up:a.k_num0;a._HeroResidueShadowIndex=0;for(var z=a._HeroResidueShadowData.length-1;z>=0;z--){a._HeroResidueShadowData[z]=0}return this.CheckKeyForward()?DState.STATE_INAIR+DState.SS_INAIR_JUMP_EXTEND_DIAG:DState.STATE_INAIR+DState.SS_INAIR_JUMP_EXTEND_VER}if(a._keyLeftUp||a._keyRightUp){a._HeroInStateKey=a._keyLeftUp?a.k_LeftUp:a.k_RightUp;this.SetFlipX(a._keyLeftUp);a._HeroResidueShadowIndex=0;for(var z=a._HeroResidueShadowData.length-1;z>=0;z--){a._HeroResidueShadowData[z]=0}return DState.STATE_INAIR+DState.SS_INAIR_JUMP_EXTEND_DIAG}}}if(a._HeroInAirKey!=0){if(!IsKeyDown(a._HeroInAirKey)){a._HeroInAirKey=0}}if(a._HeroInAirKey==0){if(a._keyUpHold){a._HeroInAirKey=a.k_up}if(a._Key0Hold){a._HeroInAirKey=a.k_num0}if(a._keyLeftUpHold){a._HeroInAirKey=a.k_LeftUp}if(a._keyRightUpHold){a._HeroInAirKey=a.k_RightUp}if(a._HeroInAirKey!=0){a._HeroInAirKeyTime=s_game_timeWhenFrameStart}}switch(this._subState){case DState.SS_SHOOT:case DState.SS_COMBAT:case DState.SS_TOSS:break;case DState.SS_INAIR_FALL_START:case DState.SS_INAIR_FALL:if(this.IsFlipX()){this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_FALL_FAST_REDUCE_VX,0,false))}else{this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_FALL_FAST_REDUCE_VX,0,true))}case DState.SS_INAIR_JUMP_DIAG_PRE:if((a._HeroInStateKey==0)&&(this._subState==DState.SS_INAIR_JUMP_DIAG_PRE)){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_DIAG_JUMP_DELTA_AY,0,true))}else{this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_DIAG_JUMP_DELTA_AY,0,false))}}case DState.SS_INAIR_JUMP_DIAG:case DState.SS_INAIR_ROCKCRAFT_JUMP:if(this._vX!=0){if(this._vY>=0){this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_JUMP_REDECE_VX,DAI.HERO_DIAG_JUMP_START_VX,false))}else{this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_JUMP_REDECE_VX,DAI.HERO_JUMP_MIN_VX,true))}}case DState.SS_INAIR_JUMP_VER_PRE:case DState.SS_INAIR_JUMP_VER:if(a._keyDownHold){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_SMASH_FALL,0);break}case DState.SS_HURT:case DState.SS_INAIR_ROCKET:case DState.SS_INAIR_JUMP_SPRING_DIAG:if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_VER_JUMP_AY-DAI.GRAVITY,DAI.HERO_FALL_MAX_VY,true))}else{this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_VER_JUMP_AY-DAI.GRAVITY,DAI.HERO_FALL_MAX_VY,false))}if(this._subState==DState.SS_HURT||this._subState==DState.SS_COMBAT){break}if(this.AI_Hero_CheckAttack()){if(a._HeroPoweredBullet){return this._state+DState.SS_SHOOT}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){return this._state+(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)?DState.SS_HERO_TOXOPHILY:DState.SS_HERO_AXE)}else{return this._state+DState.SS_COMBAT}}}if(this._subState==DState.SS_INAIR_JUMP_DIAG||this._subState==DState.SS_INAIR_ROCKCRAFT_JUMP||this._subState==DState.SS_INAIR_JUMP_VER||this._subState==DState.SS_INAIR_FALL){if(a._HeroInAirKey!=0&&(s_game_timeWhenFrameStart-a._HeroInAirKeyTime>50)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){var q=(this.CheckFlag(DFlags.REVERSAL_GRAVITY))?(t>0&&this._vY-a.GetVelocity(DAI.GRAVITY)<=0||t<=0):(t<0&&this._vY+a.GetVelocity(DAI.GRAVITY)>=0||t>=0);if(q){if(a._HeroInAirKey!=a.k_up){if(a._HeroInAirKey==a.k_LeftUp!=this.IsFlipX()){this.SetFlipX(!this.IsFlipX())}}return DState.STATE_INAIR+DState.SS_INAIR_FLOAT_UP}}}if(a._HeroInStateKey!=0){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_VER_JUMP_DELTA_AY,DAI.HERO_VER_JUMP_MAX_VY,false))}else{this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_VER_JUMP_DELTA_AY,DAI.HERO_VER_JUMP_MAX_VY,true))}}if(this.CheckKeyForward()){this._vX=a.AddAndLimitMaxVelocity(this._vX,DAI.HERO_INAIR_KEYHOLD_AX,DAI.HERO_INAIR_MAX_VX,this.IsFlipX())}else{var v=this.CheckKeyBackward();if(!v){if((a._HeroInStateFlags&DAI.ISF_INAIR_HAS_EXTEND_JUMPED)!=0){v=!this.IsFlipX()&&(a._keyLeftUpHold||a._keyLeftDownHold)||this.IsFlipX()&&(a._keyRightUpHold||a._keyRightDownHold)}}if(v){this.SetFlipX(!this.IsFlipX());this._vX=0;a._HeroDrawInairTurn=true}}if((this.CheckFlag(DFlags.REVERSAL_GRAVITY)?this._vY<=0:this._vY>=0)&&(this._subState==DState.SS_INAIR_JUMP_DIAG||this._subState==DState.SS_INAIR_ROCKCRAFT_JUMP||this._subState==DState.SS_INAIR_JUMP_VER||this._subState==DState.SS_INAIR_ROCKET)){return DState.STATE_INAIR+DState.SS_INAIR_FALL_START}break;case DState.SS_INAIR_FLOAT_UP:case DState.SS_INAIR_FLOAT_FLY:if(this.CheckKeyBackward()){if(this.IsFlipX()){this._vX+=a.GetVelocity(DAI.HERO_INAIR_KEYHOLD_BACK_AX);if(this._vX>0){this.SetFlipX(!this.IsFlipX());this._vX=0}}else{this._vX-=a.GetVelocity(DAI.HERO_INAIR_KEYHOLD_BACK_AX);if(this._vX<0){this.SetFlipX(!this.IsFlipX());this._vX=0}}}else{if(this.CheckKeyForward()||a._keyLeftUpHold&&this.IsFlipX()||a._keyRightUpHold&&!this.IsFlipX()){this._vX=a.AddAndLimitMaxVelocity(this._vX,DAI.HERO_INAIR_KEYHOLD_AX,DAI.HERO_INAIR_FLOAT_MAX_VX,this.IsFlipX())}}if(a._HeroInAirKey==0||s_game_timeWhenFrameStart-a._HeroInAirKeyTime==0){return DState.STATE_INAIR+DState.SS_INAIR_FALL_START}if(this._subState==DState.SS_INAIR_FLOAT_UP){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(-DAI.HERO_FLY_AY+DAI.GRAVITY)}else{this.AddVY(DAI.HERO_FLY_AY-DAI.GRAVITY)}}else{if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(+DAI.GRAVITY)}else{this.AddVY(-DAI.GRAVITY)}}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(this._vY<-DAI.HERO_FALL_MAX_VY){this.SetVY(-DAI.HERO_FALL_MAX_VY)}}else{if(this._vY>DAI.HERO_FALL_MAX_VY){this.SetVY(DAI.HERO_FALL_MAX_VY)}}break;case DState.SS_INAIR_JUMP_EXTEND_DIAG:case DState.SS_INAIR_JUMP_EXTEND_VER:case DState.SS_INAIR_JUMP_SPRING_VER:if(this.AI_Hero_CheckAttack()){if(a._HeroPoweredBullet){return this._state+DState.SS_SHOOT}else{if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){return this._state+(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)?DState.SS_HERO_TOXOPHILY:DState.SS_HERO_AXE)}else{return this._state+DState.SS_COMBAT}}}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(-DAI.HERO_VER_JUMP_AY+DAI.GRAVITY)}else{this.AddVY(DAI.HERO_VER_JUMP_AY-DAI.GRAVITY)}if(this.CheckKeyForward()){this._vX=a.AddAndLimitMaxVelocity(this._vX,DAI.HERO_INAIR_KEYHOLD_AX,DAI.HERO_INAIR_MAX_VX,this.IsFlipX())}else{if(this.CheckKeyBackward()){this.SetFlipX(!this.IsFlipX());a._HeroDrawInairTurn=true}}if(a._HeroInStateKey!=0&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(t>=0&&this._vY-a.GetVelocity(DAI.GRAVITY)<=0){return DState.STATE_INAIR+DState.SS_INAIR_FLOAT_UP}}else{if(t<=0&&this._vY+a.GetVelocity(DAI.GRAVITY)>=0){return DState.STATE_INAIR+DState.SS_INAIR_FLOAT_UP}}}else{if(a._HeroInStateKey==0){if(this.IsFlipX()){this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_VER_JUMP_REDUCE_VX,0,false))}else{this.SetVX(a.AddAndLimitVelocity(this._vX,DAI.HERO_VER_JUMP_REDUCE_VX,0,true))}}}break;case DState.SS_INAIR_SMASH_FALL_HOLD:if(!a._keyDownHold||(this.CheckPhysics(DFlags.PHY_SEGMENT))){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}case DState.SS_INAIR_SMASH_FALL:if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(-DAI.HERO_VER_JUMP_AY+DAI.GRAVITY);if(this._vY<-DAI.HERO_SMASH_FALL_MAX_VY){this.SetVY(-DAI.HERO_SMASH_FALL_MAX_VY)}}else{this.AddVY(DAI.HERO_VER_JUMP_AY-DAI.GRAVITY);if(this._vY>DAI.HERO_SMASH_FALL_MAX_VY){this.SetVY(DAI.HERO_SMASH_FALL_MAX_VY)}}break;case DState.SS_FAT_INAIR_FALL:case DState.SS_FAT_INAIR_JUMP_DIAG:case DState.SS_FAT_INAIR_JUMP_VER:if(a._keyDownHold){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_SMASH_FALL,0);break}case DState.SS_FAT_INAIR_ROCKET:if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(-DAI.FAT_VER_JUMP_AY+DAI.GRAVITY)}else{this.AddVY(DAI.FAT_VER_JUMP_AY-DAI.GRAVITY)}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(this._vY<-DAI.FAT_FALL_MAX_VY){this.SetVY(-DAI.FAT_FALL_MAX_VY)}}else{if(this._vY>DAI.FAT_FALL_MAX_VY){this.SetVY(DAI.FAT_FALL_MAX_VY)}}if(this.CheckKeyForward()){this._vX=a.AddAndLimitVelocity(this._vX,DAI.FAT_INAIR_KEYHOLD_AX,DAI.FAT_INAIR_MAX_VX,this.IsFlipX())}else{if(this.CheckKeyBackward()){this.SetFlipX(!this.IsFlipX())}}if((this.CheckFlag(DFlags.REVERSAL_GRAVITY)?this._vY<=0:this._vY>=0)&&(this._subState==DState.SS_FAT_INAIR_JUMP_DIAG||this._subState==DState.SS_FAT_INAIR_JUMP_VER||this._subState==DState.SS_FAT_INAIR_ROCKET)){return DState.STATE_INAIR+DState.SS_FAT_INAIR_FALL}break;case DState.SS_INAIR_ABSORB:if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(-DAI.HERO_ELECTRIC_ABSORB_VELOCITY)}else{this.AddVY(DAI.HERO_ELECTRIC_ABSORB_VELOCITY)}if(this._vX!=0){this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_INAIR_ABSORB_AX,DAI.HERO_INAIR_ABSORB_MAX_VX,this._vX<0)}break}return DFSM.SMCR_DEFAULT}if(this._state==DState.STATE_SWIM){if(a._HeroOxygen>0){while(this._stateElapsedTime>=DAI.HERO_OXYGEN_DECREASE_INTERVAL){this._stateElapsedTime-=DAI.HERO_OXYGEN_DECREASE_INTERVAL;a._HeroOxygen-=1;a._HeroOxygen+=1;var k=0,j=0;var f=a.RENDER_TYPE_ANIMATION|a.RENDER_FLAG_POSITION_RELATIVE;if(this.IsFlipX()){f|=a.RENDER_FLAG_FLIPX}a.PrepareRender(f,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_AIR_BUBBLE,0,k,j)}}else{if(this._stateElapsedTime>=DAI.HERO_OXYGEN_HP_DECREASE_INTERVAL){while(this._stateElapsedTime>=DAI.HERO_OXYGEN_HP_DECREASE_INTERVAL){this._stateElapsedTime-=DAI.HERO_OXYGEN_HP_DECREASE_INTERVAL;this._hp-=1;if(this._hp<0){this.NotifyEvent(this,DEvent.HERO_DIE,0,0,0);return DFSM.SMCR_DEFAULT}}}}if(this._subState==DState.SS_SWIM_FISH_MOVE||this._subState==DState.SS_SWIM_FISH_IDLE){var m=this.CheckKeyForward(),h=this.CheckKeyBackward();var s=this.IsFlipX();if(!m){m=s&&(a._keyLeftUp||WasKeyPressed(a.k_LeftDown))||!s&&(a._keyRightUp||WasKeyPressed(a.k_RightDown))}if(!h){h=!s&&(a._keyLeftUp||WasKeyPressed(a.k_LeftDown))||s&&(a._keyRightUp||WasKeyPressed(a.k_RightDown))}if(m){this._vX=a.AddAndLimitVelocity(this._vX,DAI.FISH_SWIM_SPEEDUP_AX,DAI.FISH_SWIM_MAX_VX,this.IsFlipX())}else{if(h){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FISH_TURN,0);return DFSM.SMCR_DEFAULT}else{if(this._vX<0){this._vX+=a.GetVelocity(DAI.FISH_SWIM_SPEEDDOWN_AX);if(this._vX>0){this._vX=0}}else{this._vX-=a.GetVelocity(DAI.FISH_SWIM_SPEEDDOWN_AX);if(this._vX<0){this._vX=0}}}}if(a._keyUpHold||a._keyLeftUpHold||a._keyRightUpHold){this._vY=a.AddAndLimitVelocity(this._vY,DAI.FISH_SWIM_SPEED_DOWN_AY,DAI.FISH_SWIM_MAX_DOWN_VY,true)}else{if(a._keyDownHold||a._keyLeftDownHold||a._keyRightDownHold){this._vY=a.AddAndLimitVelocity(this._vY,DAI.FISH_SWIM_SPEED_DOWN_AY,DAI.FISH_SWIM_MAX_DOWN_VY,false)}else{if(a._keyAttackHold||a._keyAttack){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FISH_ATTACK_PRE,0)}else{if(this._vY<0){this._vY+=a.GetVelocity(DAI.FISH_SWIM_SPEED_FORCE_AY);if(this._vY>0){this._vY=0}}else{this._vY-=a.GetVelocity(DAI.FISH_SWIM_SPEED_FORCE_AY);if(this._vY<0){this._vY=0}}}}}if(this._subState==DState.SS_SWIM_FISH_IDLE&&(this._vX!=0||this._vY!=0)){return DFSM.SMCR_OVER}if(this._subState==DState.SS_SWIM_FISH_MOVE&&this._vX==0&&this._vY==0){return DFSM.SMCR_OVER}}if(this._subState==DState.SS_SWIM_FISH_ATTACK){this._vX=a.AddAndLimitVelocity(this._vX,DAI.FISH_SWIM_SPEEDUP_AX,DAI.FISH_SWIM_ATTACK_MAX_VX,this.IsFlipX());var u=this._posX;var d;if(this.IsFlipX()){d=this._boundingBox[2]}else{d=this._boundingBox[0]}if(this.PrepareRenderIsOver(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_FISH_BUBBLE)){for(var z=0;z<4;z++){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_FISH_BUBBLE,0,u,this._posY);u+=d}}}if(this._subState==DState.SS_SWIM_FISH_ATTACK_STOP){if(a._keyAttackHold||a._keyAttack){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FISH_ATTACK,0)}this._vX=a.AddAndLimitVelocity(this._vX,DAI.FISH_SWIM_ATTACK_SPEEDDOWN_AX,0,!this.IsFlipX());if(this._vX==0){return DFSM.SMCR_OVER}}if(this._subState==DState.SS_SWIM_MOVE||this._subState==DState.SS_SWIM_ACC||this._subState==DState.SS_SWIM_WALK){var m=this.CheckKeyForward(),h=this.CheckKeyBackward();var s=this.IsFlipX();var C=this._subState==DState.SS_SWIM_WALK;if(!m){m=s&&(a._keyLeftUp||WasKeyPressed(a.k_LeftDown))||!s&&(a._keyRightUp||WasKeyPressed(a.k_RightDown))}if(!h){h=!s&&(a._keyLeftUp||WasKeyPressed(a.k_LeftDown))||s&&(a._keyRightUp||WasKeyPressed(a.k_RightDown))}if(this._subState==DState.SS_SWIM_TURN){m=false;h=false}if(m){if(!C){this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_SWIM_SPEEDUP_AX,DAI.HERO_SWIM_MAX_VX,this.IsFlipX())}else{this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_SWIM_WALK_SPEEDUP_AX,DAI.HERO_SWIM_WALK_MAX_VX,this.IsFlipX())}}else{if(h){this._vX=0;if(!C){this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_SWIM_SPEEDUP_AX,DAI.HERO_SWIM_MAX_VX,!this.IsFlipX());this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_TURN,0)}else{this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_SWIM_WALK_SPEEDUP_AX,DAI.HERO_SWIM_WALK_MAX_VX,!this.IsFlipX());this.SetFlipX(!this.IsFlipX())}return DFSM.SMCR_DEFAULT}else{if(this._vY>=0){this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_SWIM_SPEEDDOWN_AX,0,!this.IsFlipX())}}}if(this._vX!=0){if(C&&this._animationPlayer.GetAnim()!=DAnimID.HERO_WALK_WATER){this._animationPlayer.SetAnim(DAnimID.HERO_WALK_WATER,-1)}}else{if(C&&this._animationPlayer.GetAnim()!=DAnimID.HERO_WAIT){this._animationPlayer.SetAnim(DAnimID.HERO_WAIT,-1)}}if(C&&this._phyStandOn==-1){return DFSM.SMCR_OVER}if(a._keyUp||a._keyLeftUp||a._keyRightUp){this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_SPEEDUP_AY,DAI.HERO_SWIM_MAX_UP_VY,true);if(this._subState!=DState.SS_SWIM_ACC){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_ACC,0)}}else{if(a._keyDown||a._keyLeftDown||a._keyRightDown){if(this._vY<0){this._vY=0}this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_FREE_DOWN_AY,DAI.HERO_SWIM_MAX_FREE_DOWN_VY,false));if(C){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_CROUCHDOWN,0)}}else{if(this._vY<0&&this._vY>-8<<8){this.SetVY(0)}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_FREE_DOWN_AY,DAI.HERO_SWIM_MAX_FREE_DOWN_VY,true))}else{this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_FREE_DOWN_AY,DAI.HERO_SWIM_MAX_FREE_DOWN_VY,false))}const r=DEF.AI_FPS*DEF.FLOAT_1;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){if(this._vY<=0&&this._vY>=r){this.SetVY(r+DEF.AI_FPS+1)}this.SetVY(-this._vY)}else{if(this._vY>=0&&this._vY<=r){this.SetVY(r+DEF.AI_FPS+1)}}}}}if(this._subState==DState.SS_CROUCH){if(!a._keyDownHold){return DFSM.SMCR_OVER}}if(this._subState==DState.SS_SWIM_FALL){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_FREE_DOWN_AY,DAI.HERO_SWIM_MAX_FREE_DOWN_VY,true))}else{this.SetVY(a.AddAndLimitVelocity(this._vY,DAI.HERO_SWIM_FREE_DOWN_AY,DAI.HERO_SWIM_MAX_FREE_DOWN_VY,false))}if(a._keyUpHold||a._keyDownHold||a._keyLeftHold||a._keyRightHold||a._keyLeftUpHold||a._keyRightUpHold||a._keyLeftDownHold||a._keyRightDownHold){return DFSM.SMCR_OVER}}}if(this._state==DState.STATE_CHANGE){a._HeroStateTick+=CGame._frameDT;if(a._HeroMorphEnergy>0){while(a._HeroStateTick>=DAI.CHANGE_MOBS_ENERGY_DECREASE_INTERVAL){a._HeroStateTick-=DAI.CHANGE_MOBS_ENERGY_DECREASE_INTERVAL;a._HeroMorphEnergy-=(1<<DAI.CHANGE_MOBS_ENERGY_DECREASE);if(a._HeroMorphEnergy<=0){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_BACK,0)}}}switch(this._subState){case DState.SS_HERO_CHANGE_MOBS_IDLE:if(this.CheckKeyForward()||this.CheckKeyBackward()){this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_MOBS_WALK,0)}break;case DState.SS_HERO_CHANGE_MOBS_WALK:if(this.CheckKeyForward()){var n=DAI.HERO_WALK_AX;if(this.CheckIcePhysics()){n=DAI.HERO_ICE_WALK_AX}this.AddVX(this.IsFlipX()?-n:n);if(Math.abs(this._vX)>DAI.HERO_WALK_VX){this._vX=DAI.HERO_WALK_VX;if(this.IsFlipX()){this._vX=-this._vX}}this.SetAnim(DAnimID.MOBS_WHITE_WALK,0)}else{if(this.CheckKeyBackward()){this.SetFlipX(!this.IsFlipX())}else{this._vX=0;this.SetAnim(DAnimID.MOBS_WHITE_IDEL,0)}}break;case DState.SS_HERO_CHANGE_FLY_FLY:var B=false;if(this.CheckKeyForward()||this.CheckKeyForwardBeveledDirections()){B=true;this._vX=a.AddAndLimitVelocity(this._vX,DAI.HERO_OWL_AX,DAI.HERO_OWL_MAX_VX,this.IsFlipX())}else{if(this.CheckKeyBackward()||this.CheckKeyBackwardBeveledDirections()){this.SetFlipX(!this.IsFlipX())}else{if(this._vX<0){this._vX+=DAI.HERO_OWL_AX;if(this._vX>0){this._vX=0}}else{this._vX-=DAI.HERO_OWL_AX;if(this._vX<0){this._vX=0}}}}if(a._keyUpHold||a._keyLeftUpHold||a._keyRightUpHold){B=true;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_AY,DAI.HERO_OWL_MAX_UP_VY,false)}else{this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_AY,DAI.HERO_OWL_MAX_UP_VY,true)}}else{if(a._keyDownHold||a._keyLeftDownHold||a._keyRightDownHold){B=true;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_AY,DAI.HERO_OWL_MAX_DOWN_VY,true)}else{this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_AY,DAI.HERO_OWL_MAX_DOWN_VY,false)}}else{if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_GRAVITY,DAI.HERO_OWL_MAX_FREE_DOWN_VY,true)}else{this._vY=a.AddAndLimitVelocity(this._vY,DAI.HERO_OWL_GRAVITY,DAI.HERO_OWL_MAX_FREE_DOWN_VY,false)}}}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(DAI.GRAVITY)}else{this.AddVY(-DAI.GRAVITY)}break}}if(this._state==DState.STATE_FREEZED){this.AI_Hero_SlowDown();if(this._subState==DState.SS_FREEZED){if(a._keyAttack){this._stateElapsedTime+=DAI.HERO_FREEZE_FREE_TIME}}}return DFSM.SMCR_DEFAULT};a.prototype.MiniGameFlyCannonPlayMagic=function(){var e=(this._boundingBox[DEF.BOX_RIGHT]-this._boundingBox[DEF.BOX_LEFT])>>1;var d=(this._boundingBox[DEF.BOX_BOTTOM]-this._boundingBox[DEF.BOX_TOP])>>1;if(this._tempParams[DTempParamIndex.MINIGAME_MAGIC_EFFECT]<=0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX+e,this._posY+d);e=-e;a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX+e,this._posY+d);e=0;a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_RANDOM_MAGIC,0,this._posX+e,this._posY+d);this._tempParams[DTempParamIndex.MINIGAME_MAGIC_EFFECT]++}};a.prototype.AI_MiniGame_Cannon=function(f,e){switch(this._subState){case DState.SS_CANNON_IDLE_FLY_OFF:if(this.AI_Hero_InEntityArea(Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_X]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_Y]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_WIDTH]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_HEIGHT]))){return DFSM.SMCR_OVER}return DFSM.SMCR_NO_OVER;case DState.SS_CANNON_IDLE_FLY_OFF_TO_ON:this.MiniGameFlyCannonPlayMagic();break;case DState.SS_CANNON_IDLE_FLY_ON:if(!this.AI_Hero_InEntityArea(Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_X]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_Y]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_WIDTH]),Math_IntToFixedPoint(this._params[DParamIndex.FLY_CANNON_AREA_HEIGHT]))){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_CANNON_IDLE_FLY_OFF,0)}break;case DState.SS_CANNON_IDLE_FLY_HERO_IN:this.MiniGameFlyCannonPlayMagic();break;case DState.SS_CANNON_IDLE_FLY:var d=this._params[DParamIndex.FLY_CANNON_MAX_DEGREE];if(this._tempParams[DTempParamIndex.MINIGAME_POWER_GROOVE_TURN]==0){this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]+=DAI.MINIGAME_CANNON_DEGREE_UNIT}else{this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]-=DAI.MINIGAME_CANNON_DEGREE_UNIT}if(this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]>=d){this._tempParams[DTempParamIndex.MINIGAME_POWER_GROOVE_TURN]=1}else{if(this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]<=DAI.MINIGAME_CANNON_DEGREE_UNIT){this._tempParams[DTempParamIndex.MINIGAME_POWER_GROOVE_TURN]=0}}if(a._keyAttack){return DFSM.SMCR_OVER}break;case DState.SS_CANNON_IDLE_FLY_FIRE_PRE:break;case DState.SS_CANNON_IDLE_FLY_FIRE:break}return DFSM.SMCR_DEFAULT};a._miniGameTriger;a._miniGameEffectDrawStep;a.prototype.AI_Hero_EndMiniGame=function(){var e=false;var d=false;CGame.needTrans=false;if(a._miniGameTriger!=null){if(this.IsFlipX()){d=true}if((a._hero._posX>=a._miniGameTriger._posX&&!d)||(a._hero._posX<=a._miniGameTriger._posX&&d)||(a._hero._posY<a._camera._posY)||a._hero._stateElapsedTime>2000){e=true;if(a._miniGameTriger._params[DParamIndex.TRIGGER_TRANSPORT_WORLD]>0){CGame.needTrans=true}}}if(e){a._hero._vX=DAI.MINIGAME_CANNON_BALL_DROP_VELOCITY;if(this.IsFlipX()){a._hero._vX=-a._hero._vX}this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_HERO_END_MINIGAME,DFSM.CSTATEF_KEEP_VX)}};a.prototype.drawEndMiniGameEffect=function(){var i=this._tempParams[DTempParamIndex.HERO_MINIGAME_RESULT];var h=TEXT.MENU_XPLAYER_GOOD;var e=false;var f=false;if((i&DAI.MINIGAME_RESULT_BONUS_1UP)!=0){}else{if((i&DAI.MINIGAME_RESULT_BONUS_DIAMOND)!=0){h=TEXT.MENU_XPLAYER_GREAT;f=true;e=true}else{if((i&DAI.MINIGAME_RESULT_BONUS_STAR)!=0){f=true}else{if((i&DAI.MINIGAME_RESULT_BONUS_HP)!=0){f=true}else{if((i&DAI.MINIGAME_RESULT_BONUS_FLOWER)!=0){f=true}}}}}if(f){var d,j;d=DEF.SCR_W_D2;j=a._miniGameEffectDrawStep;if(a._miniGameEffectDrawStep>=DEF.SCR_H_D2){a._miniGameEffectDrawStep=DEF.SCR_H_D2}else{a._miniGameEffectDrawStep+=10}CGame.txtDraw(1,Text_GetString(h),d,j,CGame.TOP|CGame.HCENTER)}if(e){CGame.RenderFireworks(g)}};a.GetRgbFromImg=function(m,o,h,l,s,q,e,u,t){m.getRGB(o,h,l,s,q,e,u);for(var k=0;k<e;k++){for(var f=0;f<u;f++){var d=(o[k+f*e]>>16)&255;var p=o[k+f*e]&255;var n=(o[k+f*e]>>8)&255;if(d==p&&n==0){o[k+f*e]=0}}}};a.GetImageFromAFrame=function(n,i,o,f,m){var e=n.GetAnimFrame(i,o);var l=n.GetFrameWidth(e),h=n.GetFrameHeight(e);var j=Image.createImage(l,h);var k=j.getGraphics();k.setColor(m);k.fillRect(0,0,l,h);var d=LowAPI.Gen_Array([4],0);n.GetAFrameRect(d,i,o,0,0,f&DFlags.SPRITE_FLAG_MASK);n.PaintAFrame(k,i,o,-d[DEF.BOX_LEFT],-d[DEF.BOX_TOP],f&DFlags.SPRITE_FLAG_MASK,0,0);return j};a.prototype.DrawMiniGameCannon=function(e,l){var f=this._animationPlayer.sprite.GetFrameImage(this._animationPlayer.GetAnimFrame());var h=f.getWidth(),j=f.getHeight();var i=this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE];var d=h/3,k=j>>1;if(this.IsFlipX()){i=360-i}if(DEF.dbgEnable){Dbg("-------------- curAnim : "+this._animationPlayer.GetAnim()+"----- curFrame : "+this._animationPlayer.GetFrame()+" GetAnimFrame : "+this._animationPlayer.GetAnimFrame()+"--------------angle : "+i)}DrawImage(g,f.m_image,e-d,l-k,d,k,this._flags&DFlags.SPRITE_FLAG_MASK,-i)};a.prototype.DrawMiniGameCannonLineSight=function(){var n,l;var k,j;var f,e;var h=Math_DegreeToFixedPointAngle(this._tempParams[DTempParamIndex.MINIGAME_CANNON_DEGREE]);k=this._boundingBox[DEF.BOX_RIGHT]+DAI.MINIGAME_CANNON_TARGET_LEN;j=a.GetBoxMiddleY(this._boundingBox);f=this._posX+this._boundingBox[DEF.BOX_LEFT]+a.GetBoxWidth(this._boundingBox)/3;e=this._posY+a.GetBoxMiddleY(this._boundingBox);if(this.IsFlipX()){k=this._boundingBox[DEF.BOX_LEFT]-DAI.MINIGAME_CANNON_TARGET_LEN;f=this._posX+this._boundingBox[DEF.BOX_RIGHT]-a.GetBoxWidth(this._boundingBox)/3}this.GetPositionWithAngularVelocity(this._posX+k,this._posY+j,-h,f,e);n=Math_FixedPointToInt(a._TempIntArray[DParamIndex.POSX]-a._camX);l=Math_FixedPointToInt(a._TempIntArray[DParamIndex.POSY]-a._camY);var o=CGame.spriteArray[DSpriteID.HINT];if(o==null){return}var p=DSpriteID.HINT;var i=DAnimID.HINT_TARGET;var d=CGame.spriteArray[p].GetAFrames(i);var m=this._tempParams[DTempParamIndex.FLY_CANNON_TARGET_FRAM];CGame.spriteArray[p].PaintAFrame(g,i,m%d,n,l,0);this._tempParams[DTempParamIndex.FLY_CANNON_TARGET_FRAM]=((m^d)==0)?(0):(++m)};a.prototype.InitBoss=function(){this._tempParams[DTempParamIndex.BOSS_CHECK_FLAG]=0;this._tempParams[DTempParamIndex.BOSS_DRAW_DEAD_STEP]=0;this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT]=0;a._boss=this};a.prototype.AI_BOSS_SetCheckFlag=function(d){this._tempParams[DTempParamIndex.BOSS_CHECK_FLAG]|=d};a.prototype.AI_BOSS_CheckFlag=function(d){if((this._tempParams[DTempParamIndex.BOSS_CHECK_FLAG]&d)!=0){return true}return false};a.prototype.AI_BOSS_ClearCheckFlag=function(d){this._tempParams[DTempParamIndex.BOSS_CHECK_FLAG]&=~d};a.prototype.AI_BOSS_GetCount=function(f,d){var e=this.IntToByteArray(f);return e[d]};a.prototype.AI_BOSS_AddCount=function(i,d,f,e){f+=e;var h=this.IntToByteArray(i);h[d]=(f&255);return this.ByteArrayToInt(h)};a.prototype.AI_CreatMoveToDestTraceArray=function(d){return LowAPI.Gen_Array([d+1],0)};a.prototype.AI_MoveToDestWithTrace=function(){if(arguments){switch(arguments.length){case 5:return this.AI_MoveToDestWithTrace_5.apply(this,arguments);case 6:return this.AI_MoveToDestWithTrace_6.apply(this,arguments)}}throw new Error("InvalidArguments")};a.prototype.AI_MoveToDestWithTrace_5=function(f,m,l,i,n){var k=Math.min(Math.min(f.length,m.length),l.length);if(i){if(n>=0&&n<k-1){m[k-1]=n}else{m[k-1]=0}}var j=m[k-1];var h,e,d;if(j<k-1){h=f[j];e=m[j];d=l[j];this.MoveToDest(h,e,d);if(this._posX==e&&this._posY==d){j++;m[k-1]=j}else{m[k-1]=0}}};a.prototype.AI_MoveToDestWithTrace_6=function(f,l,k,h,m,n){var j=Math.min(k.length,l.length);if(h){if(m>=0&&m<j-1){l[j-1]=m}else{l[j-1]=0}return l[j-1]}var i=l[j-1];var e,d;if(!n){if(i<j){e=l[i];d=k[i];if(this.MoveToDest(f,e,d)){i++}l[j-1]=Math.min(i,j-2)}else{l[j-1]=0}}else{if(i>=0){e=l[i];d=k[i];if(this.MoveToDest(f,e,d)){i--}l[j-1]=Math.max(i,0)}else{l[j-1]=j-2}}return l[j-1]};a.prototype.AI_BOSS_SnowmanGetSceneLeft=function(){var d=0;d=a._camera._posX+(a.GetBoxWidth(this._boundingBox)>>1)+DEF.TILE_W_D2_FLOAT;return d};a.prototype.AI_BOSS_SnowmanGetSceneRight=function(){var d=0;d=a._camera._posX+DEF.SCR_W_FLOAT-(a.GetBoxWidth(this._boundingBox)>>1)-DEF.TILE_W_D2_FLOAT;return d};a.prototype.AI_BOSS_FlowerEater=function(s,d){var j=a.GetEntityByID(this._params[DParamIndex.BOSS_EATER_LINKTRIGGER],true);if(j!=null){if(j._subState==DState.SS_IDLE){j.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_TRIGGER_ACTIVED,0)}if(this._subState==DState.SS_BOSS_FLOWEREATER_RESUME||this._subState==DState.SS_BOSS_IDLE||this._subState==DState.SS_BOSS_FLOWEREATER_ATTACK_PRE||this._subState==DState.SS_BOSS_FLOWEREATER_ATTACK){j._params[DParamIndex.TRIGGER_RESULT_TYPE]=DValueList.TRIGGER_RESULT_TYPE_ACTIVE}else{if(this._subState==DState.SS_BOSS_FLOWEREATER_TIRE||(this._state==DState.STATE_SIMPLE)){j._params[DParamIndex.TRIGGER_RESULT_TYPE]=DValueList.TRIGGER_RESULT_TYPE_INACTIVE}}}switch(this._subState){case DState.SS_BOSS_IDLE:break;case DState.SS_BOSS_FLOWEREATER_ATTACK_IDLE:break;case DState.SS_BOSS_FLOWEREATER_ATTACK:var l=this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_GOAL_COUNTER];if(l>=DAI.BOSS_FLOWER_ATTACK_PRE_MAX){return DFSM.SMCR_OVER}else{if(this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_COUNTER]!=0&&this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_COUNTER]%(l+1)==0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_IDLE,0)}}var e=this.GetAttackBox();if(e[DEF.BOX_LEFT]==e[DEF.BOX_RIGHT]){break}var k=this._posX+a.GetBoxMiddleX(e);var i=this._posY+a.GetBoxMiddleY(e);var m=null;var o=i-a._hero._posY;var p=k-a._hero._posX;var f=(60<<DEF.SHIFT)*DScreen.RATIO;var n=Math_Rand(0,3);if(n==0){f=0}else{if(n==1){f=-f}}p+=f;if(o==0){o=(1<<DEF.SHIFT)*DScreen.RATIO}m=a.CreateDynamicEntity(DClassID.MOBS_DANDELIONBOMB,DAnimID.MOBS_DANDELIONBOMB_SEED_JET,k,i,0,0,DParamIndex.MOBS_DANDELIONBOMB_VYMULTIPLE+1);this._tempParams[DTempParamIndex.BOSS_FLOWEREATER_COUNTER]++;if(m!=null){var q=DAI.DANDELION_SEED_FALL_GRAVITY;var r=Math.floor(p*q/o);var h=DAI.DANDELION_SEED_JET_GRAVITY>>1;if(Math.abs(r)>h){r=(r>=0)?(h):(-h)}m._vX=r;m._vY=0;m.SetFlipX(true);m._relateEntity=this}break;case DState.SS_BOSS_FLOWEREATER_TIRE:break;case DState.SS_BOSS_BE_ATTACK:break;case DState.SS_BOSS_HURT:if(this._hp<=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}break}return DFSM.SMCR_DEFAULT};a.prototype.AI_BOSS_Octopus=function(){var h=0;var j=this._posX,i=0;switch(this._subState){case DState.SS_BOSS_OCTOPUS_TOSS_WAIT:if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TOSS_COUNT]>0){return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_TOSS_PREPARE}else{return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_GO_DOWN_WAIT}case DState.SS_BOSS_OCTOPUS_TOSS_ATTACK:var k=this.GetAttackBox();if(k[DEF.BOX_LEFT]!=k[DEF.BOX_RIGHT]){var p=(this._posX+k[DEF.BOX_LEFT]);var n=(this._posY-this._boundingBox[DEF.BOX_TOP]-k[DEF.BOX_TOP])/DScreen.RATIO;var f=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_ACTIONINTERVAL+1],0);f[DParamIndex.MOBS_WHITE_TYPE]=DValueList.MOBS_MOUSE_TYPE_NORMAL;f[DParamIndex.MOBS_WHITE_MODULE_MAP]=-1;if(a._BossOctopusHurt){f[DParamIndex.MOBS_WHITE_TYPE]=DValueList.MOBS_MOUSE_TYPE_HAT;f[DParamIndex.MOBS_WHITE_MODULE_MAP]=DValueList.MOBS_MOUSE_MODULE_MAP_ARMET}var q=(this._posX>>DEF.SHIFT);var o=(this._posY>>DEF.SHIFT);f[DParamIndex.MOBS_WHITE_AREALEFT]=(this._params[DParamIndex.BOSS_OCTOPUS_AREA_X]-q);f[DParamIndex.MOBS_WHITE_AREATOP]=(this._params[DParamIndex.BOSS_OCTOPUS_AREA_Y]-o);f[DParamIndex.MOBS_WHITE_AREAWIDTH]=(this._params[DParamIndex.BOSS_OCTOPUS_AREA_WIDTH]-this._params[DParamIndex.BOSS_WITCH_AREALEFT]);f[DParamIndex.MOBS_WHITE_AREAHEIGHT]=(this._params[DParamIndex.BOSS_OCTOPUS_AREA_HEIGHT]-this._params[DParamIndex.BOSS_WITCH_AREATOP]);var e=DFlags.FLIP_X;var m=a.CreateDynamicEntity(f,DClassID.MOBS_WHITE,0,p,n,e);m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_FLY,0);m._vX=-DAI.BOSS_OCTOPUS_MOBS_BETHROW_VX;p=this._posX+k[DEF.BOX_RIGHT];e=0;m=a.CreateDynamicEntity(f,DClassID.MOBS_WHITE,0,p,n,e);m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_FLY,0);m._vX=DAI.BOSS_OCTOPUS_MOBS_BETHROW_VX;this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TOSS_COUNT]--}break;case DState.SS_BOSS_OCTOPUS_GO_DOWN:i=this._params[DParamIndex.BOSS_OCTOPUS_AREA_Y+2]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_GO_DOWN_VY;break;case DState.SS_BOSS_OCTOPUS_TENTACLE_WAIT:if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_COUNT]<=0){return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_RAISE}else{this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_TYPE]=a.GetRand(0,1);if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_TYPE]==DAI.BOSS_OCTOPUS_TENTACLE_ATTACK_NORMAL){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_FIRST]=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE1+a.GetRand(0,1)];this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_SECEND]=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE2-a.GetRand(0,1)];var m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_FIRST],true);m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TENTACLE_MOVEIN_PRE,0)}else{this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_FIRST]=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE1];this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_SECEND]=this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE2];var m=a.GetEntityByID(this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE1],true);m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TENTACLE_MOVEIN_PRE,0);m=a.GetEntityByID(this._params[DParamIndex.BOSS_OCTOPUS_TENTACLE2],true);m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TENTACLE_MOVEIN_PRE,0)}return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_TENTACLE_ATTACK}case DState.SS_BOSS_OCTOPUS_TENTACLE_ATTACK:var m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_FIRST],true);if(m._subState==DState.SS_TENTACLE_IDLE){m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ORDER_SECEND],true);if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_TYPE]==DAI.BOSS_OCTOPUS_TENTACLE_ATTACK_NORMAL){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ATTACK_COUNT]++;if((m._subState==DState.SS_TENTACLE_IDLE)&&(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_ATTACK_COUNT]<2)){m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_TENTACLE_MOVEIN_PRE,0)}}if(m._subState==DState.SS_TENTACLE_IDLE){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_TENTACLE_COUNT]--;return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_TENTACLE_WAIT}}break;case DState.SS_BOSS_OCTOPUS_RAISE:var d=(Math_Rand(0,5)<<1);i=this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_RAISE_VY;a.AI_CameraQuake(a.k_camQuake_OffsetY*d);break;case DState.SS_BOSS_OCTOPUS_INK_PREPARE:if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]<=0){return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_GO_DOWN}else{this.StateMachineGotoNextState(DState.SS_BOSS_OCTOPUS_INK_WAIT,0)}break;case DState.SS_BOSS_OCTOPUS_INK_WAIT:if(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_COUNT]<=0){var m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID],true);var r=-1;if(m==null){r=DState.SS_INKBOMB_IDLE}else{if(m._subState==DState.SS_INKBOMB_IDLE){r=DState.SS_INKBOMB_IDLE}}if(r==DState.SS_INKBOMB_IDLE){if((this._hp>2)&&(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]>1)){this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID]=this._params[DParamIndex.BOSS_OCTOPUS_INK_BOMB1-this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]+3]}else{this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID]=this._params[DParamIndex.BOSS_OCTOPUS_INK_BOMB3+a.GetRand(0,2)]}return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_ATTACK}}else{return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_SHOOT}case DState.SS_BOSS_OCTOPUS_INK_SHOOT:var k=this.GetAttackBox();if(k[DEF.BOX_LEFT]!=k[DEF.BOX_RIGHT]){var p=this._posX+a.GetBoxMiddleX(k);var n=this._posY+a.GetBoxMiddleY(k);var f=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_ACTIONINTERVAL+1],0);var e=0;var m=a.CreateDynamicEntity(f,DClassID.INK_BOMB,DAnimID.BOSS_OCTOPUS_INK_UP,p,n,e);this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID]=m._params[DParamIndex.ID];m.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_INKBOMB_FLY_OUT,0);this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_COUNT]--;return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_WAIT}break;case DState.SS_BOSS_OCTOPUS_INK_ATTACK:var l;var m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID],true);while(true){if(m._subState==DState.SS_INKBOMB_IDLE){m._posY=this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;m.StateMachineGotoNextState(DState.SS_INKBOMB_FLY_IN_PREPARE,0)}if(m._params[DParamIndex.INK_BOMB_NEXT_BOMB]!=-1){m=a.GetEntityByID(m._params[DParamIndex.INK_BOMB_NEXT_BOMB],true)}else{break}}if(m._subState==DState.SS_INKBOMB_BLAST||m._subState==DState.SS_INKBOMB_DESTORY){m=a.GetEntityByID(this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ID],true);while(m!=null&&m._subState!=DState.SS_INKBOMB_IDLE){m._posY=this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;m.StateMachineGotoNextState(DState.SS_INKBOMB_IDLE,0);m=a.GetEntityByID(m._params[DParamIndex.INK_BOMB_NEXT_BOMB],true)}this._tempParams[DTempParamIndex.BOSS_OCTOPUS_BOMB_ATTACK_COUNT]--;return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_PREPARE}break;case DState.SS_BOSS_OCTOPUS_INK_GO_DOWN:i=this._params[DParamIndex.BOSS_OCTOPUS_AREA_Y+2]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_GO_DOWN_VY;break;case DState.SS_BOSS_OCTOPUS_REST_RAISE:var d=(Math_Rand(0,5)<<1);i=this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_RAISE_VY;a.AI_CameraQuake(a.k_camQuake_OffsetY*d);break;case DState.SS_BOSS_OCTOPUS_REST_PREPARE:if(this._relateEntity._subState==DState.SS_OCTOPUS_HEAD_REST){return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_REST}break;case DState.SS_BOSS_OCTOPUS_REST:switch(this._relateEntity._subState){case DState.SS_OCTOPUS_HEAD_BE_ATTACK:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_CRY;case DState.SS_OCTOPUS_HEAD_CRY:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_CRY;case DState.SS_OCTOPUS_HEAD_WAKE:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_WAKE;case DState.SS_OCTOPUS_HEAD_SHAKE:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_SHAKE}break;case DState.SS_BOSS_OCTOPUS_CRY:if(this._hp<=0){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}break;case DState.SS_BOSS_OCTOPUS_RECOVER_GO_DOWN:i=this._params[DParamIndex.BOSS_OCTOPUS_AREA_Y+2]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_GO_DOWN_VY;break;case DState.SS_BOSS_OCTOPUS_RECOVER_RAISE:var d=(Math_Rand(0,5)<<1);i=this._tempParams[DTempParamIndex.BOSS_OCTOPUS_ORIGINAL_POSITION_Y]<<DEF.SHIFT;h=DAI.BOSS_OCTOPUS_RAISE_VY;a.AI_CameraQuake(a.k_camQuake_OffsetY*d);break}if((h!=0)&&this.MoveToDest(h,j,i)){switch(this._subState){case DState.SS_BOSS_OCTOPUS_GO_DOWN:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_TENTACLE_WAIT;case DState.SS_BOSS_OCTOPUS_RAISE:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_INK_PREPARE;case DState.SS_BOSS_OCTOPUS_INK_GO_DOWN:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_REST_RAISE;case DState.SS_BOSS_OCTOPUS_REST_RAISE:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_REST_PREPARE;case DState.SS_BOSS_OCTOPUS_RECOVER_GO_DOWN:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_RECOVER_RAISE;case DState.SS_BOSS_OCTOPUS_RECOVER_RAISE:return DState.STATE_SIMPLE+DState.SS_BOSS_OCTOPUS_IDLE}}return DFSM.SMCR_DEFAULT};a.prototype.AI_BOSS_WitchInitFlyTrace=function(j,h,f){var d=Math.min(f.length,h.length)-1;if(d>=DAI.BOSS_WITCH_MOVE_TRACE_NUM){var i=this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]&255;var e=a._camera._posY+DEF.VIEW_H_FLOAT-DAI.BOSS_WITCH_BEE_RADIUS;if(this._params[DParamIndex.BOSS_WITCH_GROUND_TRACE]!=-1){var k=a.GetEntityByID(this._params[DParamIndex.BOSS_WITCH_GROUND_TRACE],true);if(k!=null){e=k._posY}}h[0]=this.AI_BOSS_SnowmanGetSceneRight()-DEF.TILE_W_M2_FLOAT;f[0]=a._camera._posY+this._boundingBox[DEF.BOX_BOTTOM]+DAI.BOSS_WITCH_BEE_RADIUS+DEF.TILE_H_M2_FLOAT;h[1]=h[0];f[1]=e+this._boundingBox[DEF.BOX_TOP];h[2]=this.AI_BOSS_SnowmanGetSceneLeft()+DEF.TILE_W_M2_FLOAT;f[2]=f[1];h[3]=h[2];f[3]=a._camera._posY+this._boundingBox[DEF.BOX_BOTTOM]+DAI.BOSS_WITCH_BEE_RADIUS+DEF.TILE_H_M2_FLOAT;h[4]=h[0];f[4]=f[0];if(!this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK)){if(this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]==3){this.AI_BOSS_SetCheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK)}}else{if(this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]==0){this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK);this.AI_BOSS_SetCheckFlag(DFlags.BOSS_WITCH_TRACE_CIRCLE_END_MASK)}}this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]=this.AI_MoveToDestWithTrace(j,h,f,true,this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX],this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK));if(this._subState==DState.SS_BOSS_HURT){if(this._posX<=a._hero._posX){h[0]=a._camera._posX-(DEF.TILE_W_M2_FLOAT<<1)}else{h[0]=this.AI_BOSS_SnowmanGetSceneRight()+(DEF.TILE_W_M2_FLOAT<<1)}f[0]=this._posY}else{if(this._subState==DState.SS_BOSS_WITCH_IDLE||this._subState==DState.SS_BOSS_WITCH_SHIFT){if(i==DAI.BOSS_WITCH_CALL_MOBS){if(this._posX<=a._hero._posX){h[0]=this.AI_BOSS_SnowmanGetSceneLeft()+DEF.TILE_W_M2_FLOAT;f[0]=e-DEF.TILE_H_FLOAT}else{h[0]=this.AI_BOSS_SnowmanGetSceneRight()-DEF.TILE_W_M2_FLOAT;f[0]=e-DEF.TILE_H_FLOAT}}}}}};a.prototype.IntToByteArray=function(e){var d=LowAPI.Gen_Array([4],0);d[0]=(e&255);d[1]=((e&65280)>>8);d[2]=((e&16711680)>>16);d[3]=((e&4278190080)>>24);return d};a.prototype.ByteArrayToInt=function(d){return((d[3]&255)<<24)+((d[2]&255)<<16)+((d[1]&255)<<8)+(d[0]&255)};a.prototype.drawBossWitchShadow=function(q){var h=a._BossResidueShadowData;var e=a._BossResidueShadowIndex;var l=(e<<2);var r=h[l+2]-this._posX;var p=h[l+3]-this._posY;var o=DAI.BOSS_WITCH_PAL_SHADOW1;if(Math.abs(r)<(DEF.FLOAT_1<<1)&&Math.abs(p)<(DEF.FLOAT_1<<1)){}else{for(var m=0;m<DAI.BOSS_WITCH_PAL_SHADOWMAX;m++){var n=(e+m)%DAI.BOSS_WITCH_PAL_SHADOWMAX;l=(n<<2);var k=h[l++];var j=h[l++];var f=h[l++];var d=h[l++];if(Math.abs(f-this._posX)<(DEF.FLOAT_1<<1)&&Math.abs(d-this._posY)<(DEF.FLOAT_1<<1)){break}if(k>=0){this._sprite.SetCurrentPalette(o+m);CGame.DrawAFrame_FixedPoint(q,k,j,f,d,this._flags)}}}this._sprite.SetCurrentPalette(DAI.BOSS_WITCH_PAL_NORMAL);a._BossResidueShadowIndex=(++a._BossResidueShadowIndex)%DAI.BOSS_WITCH_PAL_SHADOWMAX;l=(a._BossResidueShadowIndex<<2);h[l++]=this._animationPlayer.GetAnim();h[l++]=this._animationPlayer.GetFrame();h[l++]=this._posX;h[l++]=this._posY};a.prototype.DrawBossWitchLightBeam=function(q,o,p){var d=12,e=0;var n,k;var f=LowAPI.Gen_Array([d+1],0);var m;m=Math.min(this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_STEP],d);m=Math.max(m,0);e=DEF.VIEW_W-Math_FixedPointToInt(q-a._camX);var l=0;f[l++]=16777215;f[l++]=16777215;f[l++]=16510206;f[l++]=16443389;f[l++]=16310269;f[l++]=16177406;f[l++]=16109309;f[l++]=15975422;f[l++]=15309821;f[l++]=15109117;f[l++]=14571774;f[l++]=14035454;f[l++]=13633790;n=Math_FixedPointToInt(q-a._camX);k=Math_FixedPointToInt(o-a._camY);var j=3355443200;var h=0;var s=0,r=0;for(l=1;l<=m;l++){s=n;r=k;if(l<=d){h=f[l]}else{h=f[d]}h=j|h;CGame.DrawArgbLine(s,r-l,s+e,r-l,h)}h=f[0];h=j|h;CGame.DrawArgbLine(s,r,s+e,r,h);for(l=1;l<=m;l++){s=n;r=k;if(l<=d){h=f[l]}else{h=f[d]}h=j|h;CGame.DrawArgbLine(s,r+l,s+e,r+l,h)}switch(p){case DAI.BOSS_WITCH_LIGHT_BEAM_LIGHT_TYPE:if(m<d){this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_STEP]+=3}break;case DAI.BOSS_WITCH_LIGHT_BEAM_LIGHT_END_TYPE:if(m>0){this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_STEP]-=3}break}this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_WH]=(e<<16)+this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_STEP]};a.prototype.AI_BOSS_WitchCheckLightBeamCollision=function(k,i,f){var e,o,d,m;var p=Math_IntToFixedPoint((this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_WH]&4294901760)>>16);var j=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.BOSS_WITCH_LIGHT_BEAM_WH]&65535);var q=i+p;var n=f;e=i;o=f;d=q;m=n;var l=k.GetAbsoluteBox(k._boundingBox);if(a.LineClipping(e,o,d,m,l)){return true}o=f-j;m=n-j;if(a.LineClipping(e,o,d,m,l)){return true}o=f+j;m=n+j;if(a.LineClipping(e,o,d,m,l)){return true}return false};a.prototype.AI_BOSS_Witch=function(w,H){var A=this.IsFlipX();var v=this.GetAttackBox();var F=0;var J=0;var C=this._subState==DState.SS_BOSS_WITCH_BEE_FLY||this._subState==DState.SS_BOSS_WITCH_BEE_CALL||this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY||this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_RUSH||this._subState==DState.SS_BOSS_WITCH_BEE_WAIT_CIRCLE||this._subState==DState.SS_BOSS_WITCH_BEE_NO_BEE;if(C||this._subState==DState.SS_BOSS_WITCH_MOBS_CALL){this.SetFlipX(a._hero._posX<this._posX);A=this.IsFlipX()}var j=a.root;while(j!=null){if(j._classID==DClassID.MOBS_WHITE){F++}if(j._classID==DClassID.MOBS_BEE||j._classID==DClassID.MOBS_FLY){J++;if(C){j.SetFlipX(A)}}j=j.next}var E=(this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE])&255;var D=(this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]&4294967040)>>8;var q=this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_ENTITY);var h=this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_GOAL);var f=this.AI_CreatMoveToDestTraceArray(DAI.BOSS_WITCH_MOVE_TRACE_NUM);var d=this.AI_CreatMoveToDestTraceArray(DAI.BOSS_WITCH_MOVE_TRACE_NUM);this.AI_BOSS_WitchInitFlyTrace(DAI.BOSS_WITCH_MOVE_VELOCITY,f,d);var K=null;var M=false;if(!M&&this._subState!=DState.SS_BOSS_HURT){this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_ENTER_DRAGON_MASK);var L=LowAPI.Gen_Array([DParamIndex.BOSS_WITCH_EX_PART_BOSS_WITCH+1],0);if(this._params[DParamIndex.BOSS_WITCH_BOSS_WITCH_SHIELD]<0){L[DParamIndex.BOSS_WITCH_EX_PART_BOSS_WITCH]=this._id;L[DParamIndex.BOSS_WITCH_EX_PART_EX_PART_TYPE]=DValueList.BOSS_WITCH_EX_PART_TYPE_SHIELD;K=a.CreateDynamicEntity(L,DClassID.BOSS_WITCH_EX_PART,DAnimID.BOSS_WATCH_SHIELD,this._posX,this._posY,DFlags.ACTIVE_BY_TRIGGER);this._params[DParamIndex.BOSS_WITCH_BOSS_WITCH_SHIELD]=K._id}else{K=a.GetEntityByID(this._params[DParamIndex.BOSS_WITCH_BOSS_WITCH_SHIELD],true)}K.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_BODY_SHIELD_DISAPPEAR,0);var e=this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);if(!e&&(C||this._subState==DState.SS_BOSS_WITCH_FLAME_CALL||this._subState==DState.SS_BOSS_WITCH_IDLE)&&this._subState!=DState.SS_BOSS_WITCH_BEE_CIRCLE_RUSH&&J>0){K._posX=this._posX;K._posY=this._posY;K.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_BODY_SHIELD_APPEAR,0)}}switch(this._subState){case DState.SS_BOSS_HURT:this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);if(this._stateElapsedTime<=10*DEF.ANIMATION_FRAME_TICK){return DFSM.SMCR_DEFAULT}if(this._hp<=0){return DState.STATE_SIMPLE+DState.SS_DISAPPEAR}else{if(this.MoveToDest(DAI.BOSS_WITCH_SHIFT_VELOCITY,f[0],d[0])){return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_SHIFT}else{return DFSM.SMCR_NO_OVER}}case DState.SS_BOSS_WITCH_SHIFT:if(this.MoveToDest(DAI.BOSS_WITCH_SHIFT_VELOCITY,f[0],d[0])){return DFSM.SMCR_OVER}break;case DState.SS_BOSS_WITCH_IDLE:this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);if(this._preFullState!=DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_SHIFT_APPEAR&&E!=DAI.BOSS_WITCH_CALL_FLAME){if(this._posX!=f[0]||this._posY!=d[0]){return DFSM.SMCR_OVER}}this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=0;this.ClearFlag(DFlags.GRAVITY);if(E==DAI.BOSS_WITCH_CALL_MOBS){this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_GOAL,DAI.BOSS_WITCH_MOBS_COUNT1,0);this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]|=(DClassID.MOBS_WHITE<<8)&4294967040;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_MAGIC_IN_MOBS,0);this.SetFlag(DFlags.GRAVITY)}else{if(E==DAI.BOSS_WITCH_CALL_BEE){this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_GOAL,DAI.BOSS_WITCH_BEE_COUNT,0);this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]|=(DClassID.MOBS_BEE<<8)&4294967040;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_MAGIC_IN_BEE,0)}else{if(E==DAI.BOSS_WITCH_CALL_FLY){this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_GOAL,DAI.BOSS_WITCH_BEE_COUNT,0);this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]|=(DClassID.MOBS_FLY<<8)&4294967040;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_MAGIC_IN_BEE,0)}else{if(E==DAI.BOSS_WITCH_CALL_FLAME){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]|=(DClassID.MOBS_FIRE<<8)&4294967040;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_FLAME_CALL,0)}else{this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_BEE}}}}break;case DState.SS_BOSS_WITCH_MOBS_IDLE:if(F<=h){this.AI_BOSS_SetCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_MOBS_CALL}else{this.AI_BOSS_SetCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_MOBS_ATTACKED}case DState.SS_BOSS_WITCH_MOBS_CALL:if(v[DEF.BOX_LEFT]!=v[DEF.BOX_RIGHT]){var u=this._posX+a.GetBoxMiddleX(v);var s=this._posY+a.GetBoxMiddleY(v);var n=false;var L=LowAPI.Gen_Array([DParamIndex.MOBS_WHITE_ACTIONINTERVAL+1],0);L[DParamIndex.MOBS_WHITE_TYPE]=DValueList.MOBS_MOUSE_TYPE_NORMAL;L[DParamIndex.MOBS_WHITE_MODULE_MAP]=-1;if(q%2==0){L[DParamIndex.MOBS_WHITE_TYPE]=DValueList.MOBS_MOUSE_TYPE_RED;n=true}else{if(this._hp<=2&&q%3==0){L[DParamIndex.MOBS_WHITE_TYPE]=DValueList.MOBS_MOUSE_TYPE_HAT;L[DParamIndex.MOBS_WHITE_MODULE_MAP]=DValueList.MOBS_MOUSE_MODULE_MAP_ARMET}}var B=(this._posX>>DEF.SHIFT);var z=(this._posY>>DEF.SHIFT);L[DParamIndex.MOBS_WHITE_AREALEFT]=(this._params[DParamIndex.BOSS_WITCH_AREALEFT]-B);L[DParamIndex.MOBS_WHITE_AREATOP]=(this._params[DParamIndex.BOSS_WITCH_AREATOP]-z);L[DParamIndex.MOBS_WHITE_AREAWIDTH]=(this._params[DParamIndex.BOSS_WITCH_AREARIGHT]-this._params[DParamIndex.BOSS_WITCH_AREALEFT]);L[DParamIndex.MOBS_WHITE_AREAHEIGHT]=(this._params[DParamIndex.BOSS_WITCH_AREABOTTOM]-this._params[DParamIndex.BOSS_WITCH_AREATOP]);var p=0;var I=a.CreateDynamicEntity(L,DClassID.MOBS_WHITE,0,u,s,p);I._vX=DAI.BOSS_WITCH_MOBS_RUSH_VELOCITY;if(n){I.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_RED_JUMP,DFSM.CSTATEF_KEEP_VX)}else{I.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_RUSH,DFSM.CSTATEF_KEEP_VX)}if(this.IsFlipX()){I.TurnBack()}this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_ENTITY,q,1)}break;case DState.SS_BOSS_WITCH_MOBS_ATTACKED:if(F==0){return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_MAGIC_OUT_MOBS}break;case DState.SS_BOSS_WITCH_BEE_IDLE:this._stateDuration=DAI.BOSS_WITCH_INTERVAL*DAI.PARAM_INTERVAL_TIME_BASE;break;case DState.SS_BOSS_WITCH_BEE_FLY:if(q<h){this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_BEE_CALL}break;case DState.SS_BOSS_WITCH_BEE_CALL:if(v[DEF.BOX_LEFT]!=v[DEF.BOX_RIGHT]){var u=this._posX;var s=this._posY;var G;for(G=0;G<DAI.BOSS_WITCH_BEE_COUNT;G++){var L=LowAPI.Gen_Array([DParamIndex.MOBS_BEE_MODULEMAP+1],0);var p=0;var I=a.CreateDynamicEntity(L,D,0,u,s,p);I.SetFlipX(A);I.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BEE_MOVE_TO_WITCH_CIRCLE,0);I._relateEntity=this;var o=DAI.BOSS_WITCH_BEE_RADIUS,m=DAI.BOSS_WITCH_BEE_RADIUS;switch(G){case 0:m=0;break;case 1:o=0;m=-m;break;case 2:o=-o;m=0;break;case 3:o=0;break}I._tempParams[DTempParamIndex.MOBS_BEE_DESTX]=u+o;I._tempParams[DTempParamIndex.MOBS_BEE_DESTY]=s+m;I._tempParams[DTempParamIndex.MOBS_BEE_ANGLE]=Math_DegreeToFixedPointAngle(G*90);this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_WITCH_COUNT],DAI.BOSS_WITCH_COUNT_ENTITY,q,1)}}break;case DState.SS_BOSS_WITCH_BEE_WAIT_CIRCLE:var t=a.root;var l=false;while(t!=null){if(t._classID==DClassID.MOBS_BEE||t._classID==DClassID.MOBS_FLY){if(t._subState==DState.SS_MOBS_BEE_MOVE_TO_WITCH_CIRCLE){l=true;break}}t=t.next}if(!l){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY,0)}break;case DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY:if(J==0){this.AI_BOSS_SetCheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK);return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_BEE_NO_BEE}if(this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK)){var r=DAI.BOSS_WITCH_MOVE_VELOCITY;if(this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]==1){r=r<<1}this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]=this.AI_MoveToDestWithTrace(r,f,d,false,0,true)}else{var r=DAI.BOSS_WITCH_MOVE_VELOCITY;if(this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]==2){r=r<<1}this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]=this.AI_MoveToDestWithTrace(r,f,d,false,0,false)}if(this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_TRACE_CIRCLE_END_MASK)){return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_BEE_CIRCLE_RUSH}if(this._hp<=2&&this._stateElapsedTime>=40*DEF.ANIMATION_FRAME_TICK){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_FLAME;return DState.STATE_SIMPLE+DState.SS_BOSS_WITCH_IDLE}break;case DState.SS_BOSS_WITCH_BEE_CIRCLE_RUSH:var u=this.AI_BOSS_SnowmanGetSceneRight();var s=a._camera._posY+this._boundingBox[DEF.BOX_BOTTOM]+DAI.BOSS_WITCH_BEE_RADIUS+DEF.TILE_H_M2_FLOAT;if(!this.MoveToDest(DAI.BOSS_WITCH_BEE_CIRCLE_RUSH_VELOCITY,u,s)){return DFSM.SMCR_DEFAULT}t=a.root;var k=false;while(t!=null){if(t._classID==DClassID.MOBS_BEE||t._classID==DClassID.MOBS_FLY){if(t._subState==DState.SS_MOBS_BEE_RUSH_TO_HERO){return DFSM.SMCR_NO_OVER}if(t._subState==DState.SS_MOBS_BEE_ON_WITCH_CIRCLE){l=true;t._tempParams[DTempParamIndex.MOBS_BEE_DESTX]=a._hero._posX;t._tempParams[DTempParamIndex.MOBS_BEE_DESTY]=a._hero._posY;t.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BEE_RUSH_TO_HERO,0);return DFSM.SMCR_NO_OVER}}t=t.next}if(!k){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_MOBS;this.AI_BOSS_ClearCheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK|DFlags.BOSS_WITCH_TRACE_CIRCLE_END_MASK);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_IDLE,0)}break;case DState.SS_BOSS_WITCH_BEE_NO_BEE:this._tempParams[DTempParamIndex.BOSS_WITCH_TRACE_INDEX]=this.AI_MoveToDestWithTrace(DAI.BOSS_WITCH_MOVE_VELOCITY,f,d,false,0,this.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_TRACE_CONVERSE_MASK));break;case DState.SS_BOSS_WITCH_MAGIC_OUT_BEE:case DState.SS_BOSS_WITCH_MAGIC_OUT_MOBS:this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]++;if(this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]>=DAI.BOSS_WITCH_MAGIC_OUT_MAX_COUNT){if(this._subState==DState.SS_BOSS_WITCH_MAGIC_OUT_BEE){this.SetFlipX(true);this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_MOBS}else{this.ClearFlag(DFlags.GRAVITY);if(this._hp<=2){this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_FLY}else{this._tempParams[DTempParamIndex.BOSS_WITCH_ATTACK_TYPE]=DAI.BOSS_WITCH_CALL_BEE}}return DFSM.SMCR_OVER}break;case DState.SS_BOSS_WITCH_MAGIC_IN_BEE:case DState.SS_BOSS_WITCH_MAGIC_IN_MOBS:this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]--;if(this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT]<=0){if(this._subState==DState.SS_BOSS_WITCH_MAGIC_IN_MOBS){this.SetFlag(DFlags.GRAVITY);this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_MOBS_IDLE,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_WITCH_BEE_FLY,0)}}break;case DState.SS_BOSS_WITCH_FLAME_CALL:if(v[DEF.BOX_RIGHT]!=v[DEF.BOX_LEFT]){var L=LowAPI.Gen_Array([DParamIndex.MOBS_FIRE_AREABOTTOM+1],0);var p=0;u=this._posX+a.GetBoxMiddleX(v);s=this._posY+a.GetBoxMiddleY(v);var I=a.CreateDynamicEntity(L,D,DAnimID.FIRE_BURN,u,s,p);I.SetFlipX(A);I.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_FIRE_DROP,0)}break}return DFSM.SMCR_DEFAULT};a.prototype.AI_BOSS_WitchBody=function(h,e){var d=a.GetEntityByID(this._params[DParamIndex.BOSS_WITCH_EX_PART_BOSS_WITCH],false);if(d==null){return DFSM.SMCR_DEFAULT}var f=0;var i=this.GetAttackBox();switch(this._subState){case DState.SS_BOSS_WITCH_BODY_SHIELD_APPEAR:break}return DFSM.SMCR_DEFAULT};a.prototype.AI_Hint_ShowSoundEffect=function(h,d,i){if(d<0){d=this._posX}if(i<0){i=this._posY+this._boundingBox[DEF.BOX_TOP]}var e=0;var f=a.CreateDynamicEntity(DClassID.HINT,h,d,i,e,0,10);f.StateMachineSetStateFlow(a.GetStateFlow(DStateFlowID.STATEFLOW_HINT),DFSM.SSF_MATCH_ANIM);f._zOrder=Z.MAX;a.UpdateDrawList(f)};a.prototype.AI_Hint_ShowThiefSoundBubble=function(f,d){var e=null;if(f){e=a._ThiefSoundBubbleLeft}else{e=a._ThiefSoundBubbleRight}if(e==null){e=a.CreateDynamicEntity(DClassID.HINT,DAnimID.HINT_TINK___,0,0,0,0,10);e.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_HINT_TINK_INVISIBLE,0);if(f){a._ThiefSoundBubbleLeft=e}else{a._ThiefSoundBubbleRight=e}}if(d){if(e._subState==DState.SS_HINT_TINK_INVISIBLE){e.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}e.ClearFlag(DFlags.INVISIBLE);e.AI_Hint_ThiefSoundBubbleResetPos()}else{if(e._subState!=DState.SS_HINT_TINK_INVISIBLE){e.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_HINT_TINK_INVISIBLE,0)}}};a.prototype.AI_Hint_ThiefSoundBubbleResetPos=function(){var d=30<<DEF.SHIFT;var e=DEF.SCR_H_FLOAT-(60<<DEF.SHIFT);switch(this._subState){case DState.SS_HINT_TINK_SHOW2:e-=(60<<DEF.SHIFT);break;case DState.SS_HINT_TINK_SHOW3:e-=2*(60<<DEF.SHIFT);break}if(this!=a._ThiefSoundBubbleLeft){d=DEF.SCR_W_FLOAT-d}this.SetPos(d+a._camX,e+a._camY)};a.SlotMachineItems=[DAnimID.MISC_CRYSTAL_FLOWER,DAnimID.MISC_STAR,DAnimID.MISC_1UP,DAnimID.MISC_GOLD];a.prototype.DumpBonus=function(e,d,i){var h=-1;switch(e){case DValueList.BONUS_TYPE_1UP:h=DAnimID.BONUS_1UP;break;case DValueList.BONUS_TYPE_CRYSTAL:h=DAnimID.BONUS_CRYSTAL;break;case DValueList.BONUS_TYPE_GOLD_COIN:h=DAnimID.BONUS_GOLDEN_COIN;break;case DValueList.BONUS_TYPE_HP:h=DAnimID.BONUS_HEALTH_BONUS;break;case DValueList.BONUS_TYPE_STAR:h=DAnimID.BONUS_STAR;break;case DValueList.BONUS_TYPE_CRYSTALFLOWER:h=DAnimID.BONUS_CRYSTAL_FLOWER;break;case DValueList.BONUS_TYPE_POWERUP:h=DAnimID.BONUS_POWERUP;break;case DValueList.BONUS_TYPE_ROBIN_HOOD:h=DAnimID.BONUS_FEATHER;break;case DValueList.BONUS_TYPE_ESKIMO:h=DAnimID.BONUS_ICE_LOLLY;break;case DValueList.BONUS_TYPE_SWORD_FISH:h=DAnimID.BONUS_FISH;break}if(!(h>=0)){Dbg("Can't find bonus type")}var f=a.CreateDynamicEntity(DClassID.BONUS,h,d,i,DFlags.COLLIDING_WITH_SEGMENT|DFlags.GRAVITY,0,DParamIndex.BONUS_SATELLITE3+1);f.ClearFlag(DFlags.COLLIDING_WITH_HERO);f.SetFlag(DFlags.GRAVITY|DFlags.COLLIDING_WITH_SEGMENT);f._vX=a.GetRand(DAI.BONUS_DROP_MIN_VX,DAI.BONUS_DROP_MAX_VX);if(a.GetRand(0,1)==0){f._vX=-f._vX}f._vY=-a.GetRand(DAI.BONUS_DROP_MIN_VY,DAI.BONUS_DROP_MAX_VY);return f};a.CANSEE_VIEW_SCOPE=1<<0;a.CANSEE_VIEW_AREA=1<<1;a.CANSEE_VIEW_BACKSEE=1<<2;a.CANSEE_VIEW_INSCREEN=1<<3;a.CANSEE_VIEW_NO_BLOCK=1<<4;a.CANSEE_VIEW_SELF_INSCREEN=1<<5;a.CANSEE_RESULT_NONE=0;a.CANSEE_RESULT_FACE=1;a.CANSEE_RESULT_BACK=2;a.prototype.CanSee=function(k,e,l){var j=this.IsFlipX();var i=j&&this._posX<=k._posX||!j&&this._posX>=k._posX;if(i&&(e&a.CANSEE_VIEW_BACKSEE)==0){return a.CANSEE_RESULT_NONE}if((e&a.CANSEE_VIEW_SELF_INSCREEN)!=0){if(!this.InScreen()){return a.CANSEE_RESULT_NONE}}var h=a.GetDistance((k._posX-this._posX)>>DEF.SHIFT,(k._posY-this._posY)>>DEF.SHIFT);if(l>0&&h>l){return a.CANSEE_RESULT_NONE}var f=Math.abs((k._posX-this._posX)>>DEF.SHIFT);var d=Math.abs((k._posY-this._posY)>>DEF.SHIFT);if((e&a.CANSEE_VIEW_SCOPE)!=0){if(f<d*3){return a.CANSEE_RESULT_NONE}}if((e&a.CANSEE_VIEW_INSCREEN)!=0){if(k.InScreen()){if((e&a.CANSEE_VIEW_NO_BLOCK)!=0){if(a.CheckSightBlock(this._posX,this._posY+this._boundingBox[DEF.BOX_TOP],k._posX,k._posY+k._boundingBox[DEF.BOX_TOP])){return a.CANSEE_RESULT_NONE}}return i?a.CANSEE_RESULT_BACK:a.CANSEE_RESULT_FACE}return a.CANSEE_RESULT_NONE}if((e&a.CANSEE_VIEW_AREA)!=0){if(!this.PointInMoveArea(k._posX,k._posY)){return a.CANSEE_RESULT_NONE}}if((e&a.CANSEE_VIEW_NO_BLOCK)!=0){if(a.CheckSightBlock(this._posX,this._posY+this._boundingBox[DEF.BOX_TOP],k._posX,k._posY+k._boundingBox[DEF.BOX_TOP])){return a.CANSEE_RESULT_NONE}}return i?a.CANSEE_RESULT_BACK:a.CANSEE_RESULT_FACE};a.prototype.PointInMoveArea=function(d,h){d>>=DEF.SHIFT;h>>=DEF.SHIFT;const f=0,e=0;return this._params[DParamIndex.MOVE_AREA+2]!=this._params[DParamIndex.MOVE_AREA]&&d>=f+this._params[DParamIndex.MOVE_AREA]&&d<=f+this._params[DParamIndex.MOVE_AREA+2]&&h>=e+this._params[DParamIndex.MOVE_AREA+1]&&h<=e+this._params[DParamIndex.MOVE_AREA+3]};a.prototype.DrawElectricField=function(){if(this._subState==DState.SS_ELECTRIC_FIELD_DISAPPEAR){return}var r,q;var p,o;var m,d;var n=(7<<1)*DScreen.RATIO*2,e=(3<<2)*DScreen.RATIO*2;var f,s;r=q=0;p=Math_FixedPointToInt(this._posX-a._camX);o=Math_FixedPointToInt(this._posY-a._camY);m=this._params[DParamIndex.ELECTRIC_FIELD_WIDTH];d=this._params[DParamIndex.ELECTRIC_FIELD_HEIGHT];f=(m/n).castToInt()+1;s=(d/e).castToInt()+1;var h=1;for(var l=0;l<s;l++){q=l*e+o;if(q<0){continue}else{if(q>DEF.SCR_H){break}}h=(h==0)?(1):(0);for(var k=0;k<f;k++){if(k%2==h){continue}r=k*n+p;if(r<0){continue}else{if(r>DEF.SCR_W){break}}if((Math_Rand()%2)==0){this._animationPlayer.curFlags|=DFlags.FLIP_X}else{this._animationPlayer.curFlags&=~DFlags.FLIP_X}this._animationPlayer.SetPos(r,q);this._animationPlayer.Render()}}};a.prototype.DrawProgressBar=function(e){var j,i;var k=30,f=4;var d=-(k>>1);var l=Math_FixedPointToInt(this._boundingBox[DEF.BOX_TOP])-10;var h=GetColor();j=Math_FixedPointToInt(e._posX-a._camX)+d;i=Math_FixedPointToInt(e._posY-a._camY)+l;if(this.CheckFlag(DFlags.FLIP_Y)){l=Math_FixedPointToInt(this._boundingBox[DEF.BOX_BOTTOM])+10;i=Math_FixedPointToInt(e._posY-a._camY)+l}SetColor(0);g.drawRect(j-1,i-1,k+1,f+1);SetColor(65280);g.fillRect(j,i,(k*a._HeroMorphEnergy)>>DAI.CHANGE_MOBS_MAX_ENERGY,f);SetColor(h)};a.prototype.DrawLightBeam=function(m,l,S,q,o,D){if(!this.InScreen()){return}var d=7,p=0;if(this._classID==DClassID.BOSS_UFO&&D==DValueList.UFO_FIRE_TYPE_PURPLE){d=12}else{if(this._classID==DClassID.BOSS_UFO&&D==DValueList.UFO_FIRE_TYPE_YELLOW){d=5}}var Q=d;var B,A;var G=0,F=-4;var v=LowAPI.Gen_Array([d+1],0);var f;var M;var z=0;var s=0;M=this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP];p=DEF.VIEW_H-Math_FixedPointToInt(l-a._camY)-F;if(q==0&&o==0){f=m-Math_IntToFixedPoint(d);var C=a.CheckRayBlock(f,l,f,l+DEF.VIEW_H_FLOAT);if(C){p=Math_FixedPointToInt(a._TempIntArray[DParamIndex.POSY]-l)-F}f=m+Math_IntToFixedPoint(d);C=a.CheckRayBlock(f,l,f,l+DEF.VIEW_H_FLOAT);if(C){var J=Math_FixedPointToInt(a._TempIntArray[DParamIndex.POSY]-l)-F;p=Math.min(p,J)}else{var J=DEF.VIEW_H-Math_FixedPointToInt(l-a._camY)-F;p=Math.min(p,J)}}else{p=p<<1;var E=Math_IntToFixedPoint(p);q=Math_DegreeToFixedPointAngle(q);o=Math_DegreeToFixedPointAngle(o);var k,j,T,R;var n=q+(o>>1);var L=Math_FixedPoint_Multiply(E,Math_Cos(n));var K=Math_FixedPoint_Multiply(E,Math_Sin(n));k=m;j=k+L;T=l;R=T+K;var C=a.CheckRayBlock(k,T,j,R);if(C){p=Math_FixedPointToInt(a._TempIntArray[DParamIndex.POSY]-l)-F}if(q!=0){E=Math_IntToFixedPoint(p);n=q;z=Math_FixedPointToInt(Math_FixedPoint_Divide(E,Math_Tan(n)))}if(o!=0){E=Math_IntToFixedPoint(p);n=q+o;s=Math_FixedPointToInt(Math_FixedPoint_Divide(E,Math_Tan(n)))-z;s=(Math.abs(s))>>1}}if(p<=0&&q==0){return}if(D==DValueList.UFO_FIRE_TYPE_PURPLE){var O=0;if(this._classID!=DClassID.BOSS_UFO){v[O++]=16777215;v[O++]=16575487;v[O++]=16436735;v[O++]=16100351;v[O++]=15763455;v[O++]=15427583;v[O++]=14765823;v[O++]=13191167}else{v[O++]=16777215;v[O++]=16777215;v[O++]=16510206;v[O++]=16443389;v[O++]=16310269;v[O++]=16177406;v[O++]=16109309;v[O++]=15975422;v[O++]=15309821;v[O++]=15109117;v[O++]=14571774;v[O++]=14035454;v[O++]=13633790}}else{var O=0;if(this._classID!=DClassID.BOSS_UFO){v[O++]=16777215;v[O++]=16776683;v[O++]=16776397;v[O++]=16775850;v[O++]=16775047;v[O++]=16773735;v[O++]=16771919;v[O++]=16765767}else{var u=15744530;var e=16445400;v[O++]=e;v[O++]=e;v[O++]=e;v[O++]=u;v[O++]=u;v[O++]=u}}B=Math_FixedPointToInt(m-a._camX)+G;A=Math_FixedPointToInt(l-a._camY)+F;var N=3355443200;var w=0;var I=0,H=0;var r=0;if(s>d){Q=s}if(M>Q){M=Q}for(var O=1;O<=M;O++){if(s==0){I=B-O;H=A;w=v[O]}else{I=B;H=A;if(O<=d){w=v[O]}else{w=v[d]}}w=N|w;CGame.DrawArgbLine(I,H,I+z-r,H+p,w);if(s!=0){r++}}I=B;H=A;w=v[0];w=N|w;CGame.DrawArgbLine(I,H,I+z+r,H+p,w);if(s!=0){r=1}for(var O=1;O<=M;O++){if(s==0){I=B+O;H=A;w=v[O]}else{I=B;H=A;if(O<=d){w=v[O]}else{w=v[d]}}w=N|w;CGame.DrawArgbLine(I,H,I+z+r,H+p,w);if(s!=0){r++}}switch(S){case DAI.UFO_LIGHT_BEAM_LIGHT_TYPE:if(M<Q){this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP]++;this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_CurAnm]=0}else{var h=DAnimID.EFFECT_LASER;if(s!=0){h=DAnimID.EFFECT_LASER}var t=CGame.spriteArray[DSpriteID.EFFECT].GetAFrames(h);var P=this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_CurAnm];CGame.spriteArray[DSpriteID.EFFECT].PaintAFrame(g,h,P%t,B+z,A+p,0);this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_CurAnm]=((P^t)==0)?(0):(++P)}break;case DAI.UFO_LIGHT_BEAM_LIGHT_END_TYPE:if(M>0){this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP]--}break;case DAI.UFO_LIGHT_BEAM_LIGHT_START_TYPE:this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP]=0;this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_CurAnm]=0;break}this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_H]=p+F;this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_W]=this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_STEP];this._tempParams[DTempParamIndex.UFO_LIGHT_DIP_X]=z;v=null};a.prototype.GetLightBeamCollisionBox=function(){var d=this.GetAbsoluteBox(this.GetAttackBox());d[1]=d[3];d[0]-=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_W]);d[2]+=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_W]);d[3]+=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_H]);return d};a.prototype.CheckLightBeamCollisionWithEntity=function(l,j,i,o){var f,r,d,n;var q=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_W]);var k=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_H]);var e=Math_IntToFixedPoint(this._tempParams[DTempParamIndex.UFO_LIGHT_DIP_X]);var s=j+e;var p=i+k;f=j;r=i;d=s;n=p;var m=l.GetAbsoluteBox(l._boundingBox);if(a.LineClipping(f,r,d,n,m)){return true}if(!o){f=j-q}d=s-q;if(a.LineClipping(f,r,d,n,m)){return true}if(!o){f=j+q}d=s+q;if(a.LineClipping(f,r,d,n,m)){return true}return false};a.prototype.GetLightBeamIntersectPos=function(e,d){var j=LowAPI.Gen_Array([2],0);var f=this._tempParams[DTempParamIndex.UFO_LIGHT_BEAM_H];var i=this._tempParams[DTempParamIndex.UFO_LIGHT_DIP_X];j[0]=e+(i<<DEF.SHIFT);j[1]=d+(f<<DEF.SHIFT);return j};a.DrawBlackWhiteLine=function(i,p,f,o){i=Math_FixedPointToInt(i-a._camX);p=Math_FixedPointToInt(p-a._camY);f=Math_FixedPointToInt(f-a._camX);o=Math_FixedPointToInt(o-a._camY);var e=(f-i)*(f-i)+(o-p)*(o-p);e=Math_Sqrt(e);var m=((f-i)<<16)/(e);var l=((o-p)<<16)/(e);var n=5*2*DScreen.RATIO;var k=n;var h=i;var d=p;var j=false;while(k<=e){f=(i+((((m*k)>>15)+1)>>1));o=(p+((((l*k)>>15)+1)>>1));if(j){SetColor(2236962)}else{SetColor(16777215)}j=!j;DrawLine(h,d,f,o);h=f;d=o;if(k==e){break}k+=n;if(k>e){k=e}}};a._HeroResidueShadowIndex;a._HeroResidueShadowData=LowAPI.Gen_Array([5*3],0);a._BulletShadowIndex;a._BulletShadowData=LowAPI.Gen_Array([5*3],0);a._BossResidueShadowIndex;a._BossResidueShadowData=LowAPI.Gen_Array([5*5],0);a._btmLayerX;a._btmLayerY;a.prototype.Draw=function(){if(this._zOrderAI>=Z.NONE_MOVE){if(this.CheckInActive()){return}}if(this._classID==DClassID.BOSS_WITCH&&this.CheckExFlag(DFlags.EX_BOSS)&&this.CheckFlag(DFlags.INVISIBLE)&&this.CheckFlag(DFlags.CENIMATIC)){this.ClearFlag(DFlags.INVISIBLE)}if(this.CheckFlag(DFlags.INVISIBLE)||this._animationPlayer==null){var K=this._classID-DClassID.BTM;if(this._classID>DClassID.PHY&&this._classID%5!=2){GLLibPlayer.Tileset_Draw(g,K)}this.DrawDebug();return}this._animationPlayer.curFlags&=~DFlags.SPRITE_FLAG_MASK;this._animationPlayer.curFlags|=this._flags&DFlags.SPRITE_FLAG_MASK;var T=Math_FixedPointToInt(this._posX-a._camX);var R=Math_FixedPointToInt(this._posY-a._camY);if(this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){T-=this.GetAFramesOX();R-=this.GetAFramesOY()}if(this.CheckFlag(DFlags.CENIMATIC)&&this.CheckExFlag(DFlags.EX_BOSS)&&(this._classID==DClassID.HERO||this._classID==DClassID.GIRL)){if(this._state==DState.STATE_SIMPLE&&this._subState==DState.SS_DISAPPEAR){if(this._tempParams[DTempParamIndex.BOSS_DRAW_DEAD_STEP]>=0){this.DrawBossDead(this._posX,this._posY,0,3);return}}this._animationPlayer.SetPos(T,R);this._animationPlayer.Render();return}if(this._classID==DClassID.HERO){this.DrawHero(T,R);if(!CGame._popUpEnded){var v=12*DScreen.RATIO,e=2*DScreen.RATIO,ag=60,ae=2;var J=0;if(a._HeroPoweredBullet){J=TEXT.MENU_MOR_POWERUP}else{if(!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_NONE)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)){J=TEXT.MENU_MOR_ROBINHOOD+a._HeroInMorph-DAI.HERO_MORPH_ROBIN_HOOD}else{if(this._subState==DState.SS_HERO_CHANGE_MOBS_IDLE){J=TEXT.MENU_MOR_MOBS}else{if(this._subState==DState.SS_HERO_CHANGE_FLY_FLY){J=TEXT.MENU_MOR_BEE}}}}if(J!=0){CGame.txtDrawSpecialEffectPopUp(ae,Text_GetString(J),Math_FixedPointToInt(this._posX-a._camX),Math_FixedPointToInt(this._posY-a._camY+this._boundingBox[DEF.BOX_TOP]),v,e,ag,Graphics.HCENTER|Graphics.BOTTOM)}}if(this._subState==DState.SS_HERO_END_MINIGAME){this.drawEndMiniGameEffect()}if(a._HeroBeAttackByInkbomb){CGame.blendSpriteArray[DATA.EFFECT_INK].PaintAFrame(g,DEffectAnimID.INK_INK,0,Math_FixedPointToInt(this._tempParams[DTempParamIndex.HERO_INK_POSX]-a._camX),Math_FixedPointToInt(this._tempParams[DTempParamIndex.HERO_INK_POSY]-a._camY),0);if(a._HeroShowInkTime==DAI.BOSS_OCTOPUS_INK_SHOW_TIME){a._HeroBeAttackByInkbomb=false;a._HeroShowInkTime=0}if(!CGame.bIsPaused){a._HeroShowInkTime++}}}else{if(this._classID==DClassID.HINT){this._animationPlayer.SetPos(T,R);this._animationPlayer.Render();if(this._subState==DState.SS_HINT_BOOK_CONTENT&&this._params[DParamIndex.HINT_HERO_FRAME]>0){CGame.spriteArray[DSpriteID.HERO].SetCurrentPalette(DAI.HERO_PAL_HINT);CGame.spriteArray[DSpriteID.HERO].PaintFrame(g,this._params[DParamIndex.HINT_HERO_FRAME],T,R,0)}}else{if(this._classID==DClassID.BULLET){if(this._subState==DState.SS_BULLET_RUN){var Y=a._BulletShadowData;var p=a._BulletShadowIndex;var U=(p<<2);var l=Y[U+2]-this._posX;var k=Y[U+3]-this._posY;if(Math.abs(l)<(DEF.FLOAT_1<<1)&&Math.abs(k)<(DEF.FLOAT_1<<1)){}else{var X=0;for(var af=0;af<3;af++){var L=(p+af+1)%3;U=(L<<2);var O=Y[U++];var d=Y[U++];var P=Y[U++];var N=Y[U++];if(Math.abs(P-this._posX)<(DEF.FLOAT_1<<1)&&Math.abs(N-this._posY)<(DEF.FLOAT_1<<1)){break}if(O>=0){var I=DSpriteID.EFFECT;CGame.DrawAFrame_FixedPoint(I,DAnimID.EFFECT_MAGIC_BALL_TAIL_3-X,this._animationPlayer.GetFrame(),P,N,this._flags)}X++}}this._sprite.SetCurrentPalette(DAI.HERO_PAL_NORMAL);a._BulletShadowIndex=(++a._BulletShadowIndex)%3;U=(a._BulletShadowIndex<<2);Y[U++]=this._animationPlayer.GetAnim();Y[U++]=this._animationPlayer.GetFrame();Y[U++]=this._posX;Y[U++]=this._posY}this._animationPlayer.SetPos(T,R);this._animationPlayer.Render()}else{if(this._classID==DClassID.DECOR||this._classID==DClassID.LIGHTINGBALL){var l=0;var k=0;var f=0;if(this._classID==DClassID.DECOR){this._sprite.SetCurrentPalette(this._params[DParamIndex.DECOR_PALETTE])}if(this._classID==DClassID.LIGHTINGBALL){f=DParamIndex.LIGHTINGBALL_CLONE_X-DParamIndex.DECOR_CLONE_X}else{if((this._params[DParamIndex.DECOR_PARAM]&DValueList.DECOR_PARAM_MOVING_WITH_BTM)!=0){T=this._params[DParamIndex.POSX]-a._btmLayerX;R=this._params[DParamIndex.POSY]-a._btmLayerY}}for(var af=0;af<this._params[DParamIndex.DECOR_CLONE_X+f];af++){for(var ad=0;ad<this._params[DParamIndex.DECOR_CLONE_Y+f];ad++){l=this._params[DParamIndex.DECOR_DISTANCE_X+f]*af;k=this._params[DParamIndex.DECOR_DISTANCE_Y+f]*ad;this._animationPlayer.SetPos(T+l,R+k);this._animationPlayer.Render()}}if(this._classID==DClassID.DECOR&&this._params[DParamIndex.DECOR_SPRITE]==DSpriteID.LV1_ACTORS&&this._params[DParamIndex.DECOR_ANIMID]==DAnimID.LV1_ACTORS_2){if((a._hero._vX!=0||a._hero._vY!=0)&&this.IntersectEntity(a._hero)){var z=CGame.spriteArray[DSpriteID.EFFECT].GetAFrames(DAnimID.EFFECT_WATER);CGame.DrawAFrame_FixedPoint(DSpriteID.EFFECT,DAnimID.EFFECT_WATER,s_game_currentFrameNB%z,a._hero._posX,this._posY+this._boundingBox[DEF.BOX_TOP],a._hero._flags)}}}else{if(this._classID==DClassID.WATER){this.DrawWater(0,Math_FixedPointToInt(this._posX),Math_FixedPointToInt(this._posY),this._params[DParamIndex.WATER_WIDTH],this._params[DParamIndex.WATER_HEIGHT])}else{if(this._classID==DClassID.TRANSMISSION){CGame.spriteArray[DSpriteID.TRANSMISSION].PaintAFrame(g,this._animationPlayer.GetAnim()-2,this._animationPlayer.GetFrame(),T,R,this._flags);CGame.spriteArray[DSpriteID.TRANSMISSION].PaintAFrame(g,this._animationPlayer.GetAnim()-1,this._animationPlayer.GetFrame(),T+(this._params[DParamIndex.TRANSMISSION_CLONE]-1)*this._params[DParamIndex.TRANSMISSION_DISTANCE],R,this._flags);for(var af=1;af<this._params[DParamIndex.TRANSMISSION_CLONE]-1;af++){var l=this._params[DParamIndex.TRANSMISSION_DISTANCE]*af;this._animationPlayer.SetPos(T+l,R);this._animationPlayer.Render()}}else{if(this._classID==DClassID.TRACE_RENDER){var S=this._params[DParamIndex.TRACE_RENDER_OFFSET_Y];var B=this._params[DParamIndex.TRACE_RENDER_FIRST_TRACE];var o=this._params[DParamIndex.TRACE_RENDER_LAST_TRACE];var F=a.GetRowDataByID(B);var n=a.GetRowDataByID(o);var ai=B;var aa=F;while(ai>0){var A=aa[DParamIndex.TRACE_NEXT_TRACE];var ab=a.GetRowDataByID(A);if(ai==o){break}a.DrawBlackWhiteLine(Math_IntToFixedPoint(aa[DParamIndex.POSX]),Math_IntToFixedPoint(aa[DParamIndex.POSY]+S),Math_IntToFixedPoint(ab[DParamIndex.POSX]),Math_IntToFixedPoint(ab[DParamIndex.POSY]+S));ai=aa[DParamIndex.TRACE_NEXT_TRACE];aa=a.GetRowDataByID(ai);if(ai==B){break}}if(F!=null){this._animationPlayer.SetPos(F[DParamIndex.POSX]-Math_FixedPointToInt(a._camX),F[DParamIndex.POSY]+S-Math_FixedPointToInt(a._camY));this._animationPlayer.Render()}if(n!=null){this._animationPlayer.SetPos(n[DParamIndex.POSX]-Math_FixedPointToInt(a._camX),n[DParamIndex.POSY]+S-Math_FixedPointToInt(a._camY));this._animationPlayer.Render()}}else{if(this._classID==DClassID.BALANCE){var u=this._animationPlayer.sprite.GetFrameImage(this._animationPlayer.GetAnimFrame());var ah=u.getWidth(),m=u.getHeight();var D=Math_FixedPointAngleToDegree(this._tempParams[DTempParamIndex.BALANCE_ANGLE]);var H=ah>>1,G=DAI.BALANCE_HEIGHT>>DEF.SHIFT;if(DEF.dbgEnable){Dbg("-------------- curAnim : "+this._animationPlayer.GetAnim()+"----- curFrame : "+this._animationPlayer.GetFrame()+" GetAnimFrame : "+this._animationPlayer.GetAnimFrame()+"--------------angle : "+D)}DrawImage(g,u.m_image,T,R,H,G,this._flags&DFlags.SPRITE_FLAG_MASK,D)}else{if(this._classID==DClassID.SPAWN_POINT||this._classID==DClassID.BLACK_HOLE){if(this._classID==DClassID.SPAWN_POINT&&(this._params[DParamIndex.FLAGS]&DFlags.INVISIBLE)!=0){return}var ac=this._sprite;var w=1;if(this._classID==DClassID.BLACK_HOLE){w=2}ac.SetCurrentPalette(w);ac._blend=CBlendSprite.BLEND_NONE;this._animationPlayer.SetPos(T,R);this._animationPlayer.Render();if(GLLibConfig.useSoftwareDoubleBuffer){ac.SetCurrentPalette(0);ac._blend=CBlendSprite.BLEND_DISPLACEMENT;this._animationPlayer.Render()}if(this._classID==DClassID.BLACK_HOLE){if(this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES]<=1){CGame._interface.SetCurrentPalette(1)}CGame.DrawInterfaceNumber(this._tempParams[DTempParamIndex.BLACK_HOLE_CIRCLES],T,R,1,GRPH.HCENTER_VCENTER);CGame._interface.SetCurrentPalette(0)}}else{if(this._classID==DClassID.MOBS_WHITE){this._sprite.SetCurrentPalette(0);if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_RED){this._sprite.SetCurrentPalette(1)}else{if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_BLOW){if(this._subState==DState.SS_MOBS_BLOW_HARD){this._sprite.SetCurrentPalette(1)}}}this._sprite.SetCurrentMMapping(this._params[DParamIndex.MOBS_WHITE_MODULE_MAP])}else{if(this._classID==DClassID.MOBS_FLY){this._sprite.SetCurrentMMapping(-1)}else{if(this._classID==DClassID.MOBS_BEE){this._sprite.SetCurrentMMapping(0)}else{if(this._classID==DClassID.ROLLING_PLATFORM){var D=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE];for(var af=0;af<4;af++){if(this._params[DParamIndex.ROLLING_PLATFORM_PLATFORM1+af]>0){for(var ad=1;ad<4;ad++){var W=Math_IntToFixedPoint(this._params[DParamIndex.ROLLING_PLATFORM_RADIUS]*ad)/3;this.GetPositionWithAngle(W,D,this._posX,this._posY);CGame.DrawAFrame_FixedPoint(DSpriteID.ACTOR_PLATFORM,DAnimID.ACTOR_PLATFORM_CIRCLE_CONNECT_POINT,0,a._TempIntArray[DParamIndex.POSX],a._TempIntArray[DParamIndex.POSY],0)}}D+=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE_STEP]}}else{if(this._classID==DClassID.MOBS_UFO){var E=0;var C=0;switch(this._subState){case DState.SS_UFO_FIRE_LIGHT:this.DrawLightBeam(this._posX,this._posY,DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,E,C,this._params[DParamIndex.MOBS_UFO_TYPE]);break;case DState.SS_UFO_FIRE_LIGHT_END:this.DrawLightBeam(this._posX,this._posY,DAI.UFO_LIGHT_BEAM_LIGHT_END_TYPE,E,C,this._params[DParamIndex.MOBS_UFO_TYPE]);break;case DState.SS_UFO_PRE_FIRE_IDLE:this.DrawLightBeam(this._posX,this._posY,DAI.UFO_LIGHT_BEAM_LIGHT_START_TYPE,E,C,this._params[DParamIndex.MOBS_UFO_TYPE]);break}if(this._params[DParamIndex.MOBS_UFO_TYPE]==DValueList.UFO_FIRE_TYPE_PURPLE){this._sprite.SetCurrentPalette(1)}else{this._sprite.SetCurrentPalette(0)}}else{if(this._classID==DClassID.TRACE_CANNON_BALL){if(this._subState==DState.SS_CANNONBALL_FLY||this._subState==DState.SS_CANNONBALL_START_FLY){var D=Math_Atan(this._vX,this._vY);if(D>=0&&D<=Math_Angle180){this._animationPlayer.curFlags&=~DFlags.FLIP_Y}else{this._animationPlayer.curFlags|=DFlags.FLIP_Y}if(D>=0&&D<Math_Angle90||D>=Math_Angle270&&D<Math_Angle360){this._animationPlayer.curFlags&=~DFlags.FLIP_X}else{this._animationPlayer.curFlags|=DFlags.FLIP_X}var M=this._animationPlayer.curFlags&(DFlags.FLIP_X|DFlags.FLIP_Y);D=(D%Math_Angle90);if(M==DFlags.FLIP_X||M==DFlags.FLIP_Y){D=Math_Angle90-D}var O=DAnimID.TRACE_CANNON_0;if(D>=Math_DegreeToFixedPointAngle(15)&&D<Math_DegreeToFixedPointAngle(45)){O=DAnimID.TRACE_CANNON_30}else{if(D>=Math_DegreeToFixedPointAngle(45)&&D<Math_DegreeToFixedPointAngle(75)){O=DAnimID.TRACE_CANNON_60}else{if(D>=Math_DegreeToFixedPointAngle(75)){O=DAnimID.TRACE_CANNON_90}}}this._animationPlayer.SetAnim(O,-1)}}else{if(this._classID==DClassID.LIGHTINGBALL_CENTER){var r=null;var V=0;for(var af=0;af<4;af++){var t=a.GetEntityByID(this._params[DParamIndex.LIGHTINGBALL_CENTER_SATELLITE1+af],false);if(t!=null){if(V<t._params[DParamIndex.LIGHTINGBALL_DISTANCE]){V=t._params[DParamIndex.LIGHTINGBALL_DISTANCE];r=t}}}if(r!=null){a.DrawBlackWhiteLine(this._posX,this._posY,r._posX,r._posY)}}else{if(this._classID==DClassID.ELECTRIC_FIELD){this.DrawElectricField()}else{if(this._classID==DClassID.FLY_CANNON){if(this._subState==DState.SS_CANNON_IDLE_FLY||this._subState==DState.SS_CANNON_IDLE_FLY_FIRE_PRE||this._subState==DState.SS_CANNON_IDLE_FLY_FIRE){if(this._subState==DState.SS_CANNON_IDLE_FLY){this.DrawMiniGameCannonLineSight()}this.DrawMiniGameCannon(T,R);return}}else{if(this._classID==DClassID.INK_BOMB){}else{if(this.CheckExFlag(DFlags.EX_BOSS)||this._classID==DClassID.BOSS_OCTOPUS_HEAD){this._tempParams[DTempParamIndex.BOSS_ATTACK_CUR_PALETTE]++;var h=this._tempParams[DTempParamIndex.BOSS_ATTACK_CUR_PALETTE];if((h%4<=1)){h=0}else{h=1}if(this._classID==DClassID.BOSS_EATER){if(this._subState==DState.SS_BOSS_BE_ATTACK||this._subState==DState.SS_BOSS_HURT){this._sprite.SetCurrentPalette(h)}else{this._sprite.SetCurrentPalette(0)}}else{if(this._classID==DClassID.BOSS_OCTOPUS){if(this._subState==DState.SS_BOSS_OCTOPUS_CRY){this._sprite.SetCurrentPalette(h)}else{this._sprite.SetCurrentPalette(0)}if(a._BossOctopusHurt){this._sprite.SetCurrentMMapping(DATA.MODULE_MAP_BOSS_OCTOPUS_BOSS_OCTOPUS_BEATTACK)}else{this._sprite.SetCurrentMMapping(-1)}}else{if(this._classID==DClassID.BOSS_UFO){this._animationPlayer.curFlags&=~DFlags.FLIP_X}}}if(this._classID==DClassID.BOSS_KILLERBEE){if(this._subState==DState.SS_BOSS_KILLER_BEE_HURT){this._sprite.SetCurrentPalette(h)}else{this._sprite.SetCurrentPalette(0)}}if(this._classID==DClassID.BOSS_UFO){if(this._tempParams[DTempParamIndex.BOSS_UFO_HURT_TICK]>0){this._sprite.SetCurrentPalette(h)}else{this._sprite.SetCurrentPalette(0)}}if(this._classID==DClassID.BOSS_WITCH){if(this._subState==DState.SS_BOSS_HURT){this._sprite.SetCurrentPalette(h)}else{this._sprite.SetCurrentPalette(0)}if(this._subState==DState.SS_BOSS_WITCH_MAGIC_OUT_BEE||this._subState==DState.SS_BOSS_WITCH_MAGIC_OUT_MOBS||this._subState==DState.SS_BOSS_WITCH_MAGIC_IN_BEE||this._subState==DState.SS_BOSS_WITCH_MAGIC_IN_MOBS){var Q=DAI.BOSS_WITCH_MAGIC_OUT_DISTANCE;if(this._subState==DState.SS_BOSS_WITCH_MAGIC_IN_BEE||this._subState==DState.SS_BOSS_WITCH_MAGIC_IN_MOBS){Q=DAI.BOSS_WITCH_MAGIC_IN_DISTANCE}var l=Q*this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT];var k=Q*this._tempParams[DTempParamIndex.BOSS_WITCH_MAGIC_COUNT];this._sprite.SetCurrentPalette(DAI.BOSS_WITCH_PAL_SHADOW1);this._animationPlayer.SetPos(T+l,R+k);this._animationPlayer.Render();l=-l;this._animationPlayer.SetPos(T+l,R+k);this._animationPlayer.Render();k=-k;this._animationPlayer.SetPos(T+l,R+k);this._animationPlayer.Render();l=-l;this._animationPlayer.SetPos(T+l,R+k);this._animationPlayer.Render();this._sprite.SetCurrentPalette(0);return}else{if(this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY){this.drawBossWitchShadow(DSpriteID.BOSS_WATCH)}}}if((this._tempParams[DTempParamIndex.CINEMATIC_PALETTE]>0)&&this.CheckFlag(DFlags.CENIMATIC)){this._sprite.SetCurrentPalette(this._tempParams[DTempParamIndex.CINEMATIC_PALETTE])}if(this._state==DState.STATE_SIMPLE&&this._subState==DState.SS_DISAPPEAR){this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_PREPARATORY_STEP,this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_PREPARATORY_STEP),1);this._sprite.SetCurrentPalette(h)}if(this._state==DState.STATE_SIMPLE&&this._subState==DState.SS_DIE){if(this.AI_BOSS_CheckFlag(DFlags.BOSS_SHARE_DEAD_PROCESS_END_MASK)){if(this._classID!=DClassID.HERO&&this._classID!=DClassID.GIRL){var P=DEF.VIEW_W_D2;var N=100*DScreen.RATIO;var ae=0;CGame.txtDrawSpecialEffectFlowFromTheSky(ae,Text_GetString(TEXT.MENU_BOSS_DISAPPEAR),P,N,BOTTOM|HCENTER);if(this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP)>=DAI.BOSS_DEAD_END_DURATION_FRAM){this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}else{this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP,this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP),1)}}return}}}else{if(this._classID==DClassID.DOOR){if(this._subState==DState.SS_DOOR_CAN_ENTER||this._subState==DState.SS_DOOR_INSCENE_CAN_ENTER){if(!CGame.bIsPaused){var s=(this._params[DParamIndex.ANIMID]>=DAnimID.HINT_DOOR_LABYRINTH_OPEN&&this._params[DParamIndex.ANIMID]<=DAnimID.HINT_DOOR_SPACE_OPEN);if(s){var af=0;while(true){if((this._params[DParamIndex.DOOR_TRANSPORT_WORLD]>>af)==1){break}af++}if(af>DAI.MINI_MAP){CGame.DrawLevelStars(DAI.WORLD_ID_CASTLE*DAI.LEVELS_NUM_PRE_WORLD+af,true,true)}else{CGame.DrawLevelStars(-1,true,true)}}else{if(this._params[DParamIndex.ANIMID]==DAnimID.HINT_DOOR_WIZARD_CLOSE||this._params[DParamIndex.ANIMID]==DAnimID.HINT_DOOR_WIZARD_OPEN||this._params[DParamIndex.ANIMID]==DAnimID.HINT_DOOR_MINIMAP_OPEN){CGame.DrawLevelStars(-1,false,false)}}}}}}}}}}}}}}}}this._animationPlayer.SetPos(T,R);this._animationPlayer.Render()}}}}}}}}}if(this._classID==DClassID.BOSS_UFO){this._animationPlayer.curFlags&=~DFlags.FLIP_X;var q=this.GetAttackBox();switch(this._subState){case DState.SS_BOSS_UFO_ATTACK1_ATTACK:if(q[DEF.BOX_LEFT]!=q[DEF.BOX_RIGHT]){this.DrawLightBeam(this._posX+a.GetBoxMiddleX(q),this._posY+a.GetBoxMiddleY(q),DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,0,0,DValueList.UFO_FIRE_TYPE_PURPLE)}break;case DState.SS_BOSS_UFO_ATTACK2_ATTACK_LEFT:if(q[DEF.BOX_LEFT]!=q[DEF.BOX_RIGHT]){this.DrawLightBeam(this._posX+q[DEF.BOX_LEFT],this._posY+q[DEF.BOX_BOTTOM],DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,180-this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE],DAI.BOSS_UFO_ATTACK2_CONIC_ANGLE,0)}break;case DState.SS_BOSS_UFO_ATTACK2_ATTACK_RIGHT:if(q[DEF.BOX_LEFT]!=q[DEF.BOX_RIGHT]){this.DrawLightBeam(this._posX+q[DEF.BOX_RIGHT],this._posY+q[DEF.BOX_BOTTOM],DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,this._tempParams[DTempParamIndex.BOSS_UFO_ATTACK2_ANGLE],DAI.BOSS_UFO_ATTACK2_CONIC_ANGLE,0)}break;case DState.SS_BOSS_UFO_ATTACK4_ATTACK:if(q[DEF.BOX_LEFT]!=q[DEF.BOX_RIGHT]){this.DrawLightBeam(this._posX+q[DEF.BOX_LEFT],this._posY+q[DEF.BOX_BOTTOM],DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,180-DAI.BOSS_UFO_ATTACK4_ANGLE,0,0);this.DrawLightBeam(this._posX+q[DEF.BOX_RIGHT],this._posY+q[DEF.BOX_BOTTOM],DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,DAI.BOSS_UFO_ATTACK4_ANGLE,0,0)}break}if(this.CheckFlag(DFlags.CENIMATIC)){switch(this._animationPlayer.GetAnim()){case DAnimID.BOSS_UFO_ATTACK_1:if(q[DEF.BOX_LEFT]!=q[DEF.BOX_RIGHT]){this.DrawLightBeam(this._posX+a.GetBoxMiddleX(q),this._posY+a.GetBoxMiddleY(q),DAI.UFO_LIGHT_BEAM_LIGHT_TYPE,0,0,DValueList.UFO_FIRE_TYPE_PURPLE)}break}}}a.DrawRender(this._id);this.DrawDebug()};a.prototype.DrawHero=function(r,p){var f=this._classID==DClassID.HERO&&this._state==DState.STATE_INAIR&&(this._subState==DState.SS_INAIR_JUMP_EXTEND_VER||this._subState==DState.SS_INAIR_JUMP_EXTEND_DIAG);var D=this._classID==DClassID.HERO&&this._state==DState.STATE_INAIR&&(this._subState==DState.SS_HERO_BROKEN_BIG_CRYSTAL);if(f||D){var e=a._HeroResidueShadowData;var z=a._HeroResidueShadowIndex;var h=(z<<2);var t=e[h+2]-this._posX;var s=e[h+3]-this._posY;var A=DAI.HERO_PAL_SHADOW1+2;if(a._HeroPoweredBullet){A=DAI.HERO_PAL_POWERUP_SHADOW1+2}if(f){if(this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FRAME_NUM]<=5){if(this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FRAME_NUM]==0){this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FLAG]=this._flags}var l=this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FLAG];this._sprite.SetCurrentPalette(A-1);CGame.DrawAFrame_FixedPoint(DSpriteID.HERO,DAnimID.HERO_JUMP_READY,0,this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_POSX],this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_POSY],l);this._tempParams[DTempParamIndex.HERO_RESIDUE_READY_FRAME_NUM]++}}if(Math.abs(t)<(DEF.FLOAT_1<<1)&&Math.abs(s)<(DEF.FLOAT_1<<1)){}else{for(var C=0;C<3;C++){var j=(z+C+1)%3;h=(j<<2);var B=e[h++];var v=e[h++];var n=e[h++];var m=e[h++];if(Math.abs(n-this._posX)<(DEF.FLOAT_1<<1)&&Math.abs(m-this._posY)<(DEF.FLOAT_1<<1)){break}if(B>=0){this._sprite.SetCurrentPalette(A-C);var k=DSpriteID.HERO;CGame.DrawAFrame_FixedPoint(k,B,v,n,m,this._flags)}}}this._sprite.SetCurrentPalette(DAI.HERO_PAL_NORMAL);a._HeroResidueShadowIndex=(++a._HeroResidueShadowIndex)%3;h=(a._HeroResidueShadowIndex<<2);e[h++]=this._animationPlayer.GetAnim();e[h++]=this._animationPlayer.GetFrame();e[h++]=this._posX;e[h++]=this._posY}var E=DAI.HERO_PAL_NORMAL;if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){E=s_game_currentFrameNB%DAI.HERO_PAL_FAT2}else{if(a._HeroInvincibilityFrame>0){E=(a._HeroInvincibilityFrame%2)*DAI.HERO_PAL_HURT}else{if(a._HeroPoweredBullet){E=DAI.HERO_PAL_POWERUP}}}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ROBIN_HOOD)){this._sprite.SetCurrentMMapping(DATA.MODULE_MAP_HERO_HERO_ROBIN_HOOD)}else{this._sprite.SetCurrentMMapping(-1)}if(this._subState==DState.SS_HERO_CHANGE_MOBS||this._subState==DState.SS_HERO_CHANGE_MOBS_WALK||this._subState==DState.SS_HERO_CHANGE_MOBS_IDLE){this._sprite.SetCurrentMMapping(DValueList.MOBS_MOUSE_MODULE_MAP_NORMAL___RED)}if(this._state==DState.STATE_CHANGE){this.DrawProgressBar(this)}var u=Math_AngleMUL/3;var q=DAnimID.EFFECT_POS_SMALL;var F=0;if(a._HeroInElectric!=0){if(a._HeroInElectric==DValueList.ELECTRIC_FIELD_TYPE_NEGATIVE){q=DAnimID.EFFECT_NEG_SMALL;F=1}CGame.blendSpriteArray[DATA.EFFECT_ATMOSPHERE].SetCurrentPalette(F);for(var C=0;C<3;C++){this.GetPositionWithAngle(DAI.HERO_ELECTRONIC_RADIUS,a._HeroInElectricAngle+C*u,0,0);var d=(a._TempIntArray[DParamIndex.POSY]+DAI.HERO_ELECTRONIC_RADIUS)*3;var w=(DAI.HERO_ELECTRONIC_RADIUS<<1)+1;var B=Math.floor(q-d/w);if(a._TempIntArray[DParamIndex.POSY]<0){a._TempIntArray[DParamIndex.POSY]>>=2;if(this.CheckFlag(DFlags.FLIP_Y)){a._TempIntArray[DParamIndex.POSY]+=DAI.HERO_ELECTRONIC_HEIGHT}else{a._TempIntArray[DParamIndex.POSY]-=DAI.HERO_ELECTRONIC_HEIGHT}CGame.DrawAFrame_FixedPoint(DSpriteID.EFFECT,B,0,this._posX+a._TempIntArray[DParamIndex.POSX],this._posY+a._TempIntArray[DParamIndex.POSY],DFlags.FLIP_X);CGame.blendSpriteArray[DATA.EFFECT_ATMOSPHERE].PaintAFrame(g,2-(q-B),0,Math_FixedPointToInt(this._posX+a._TempIntArray[DParamIndex.POSX]-a._camX),Math_FixedPointToInt(this._posY+a._TempIntArray[DParamIndex.POSY]-a._camY),DFlags.FLIP_X)}}}this._sprite.SetCurrentPalette(E);this._animationPlayer.SetPos(r,p);if(a._HeroDrawInairTurn){CGame.DrawAFrame_FixedPoint(DSpriteID.HERO,DAnimID.HERO_AIR_TURN,0,this._posX,this._posY,this._flags);a._HeroDrawInairTurn=false}else{this._animationPlayer.Render()}if(a._HeroInElectric!=0){for(var C=0;C<3;C++){this.GetPositionWithAngle(DAI.HERO_ELECTRONIC_RADIUS,a._HeroInElectricAngle+C*u,0,0);var d=(a._TempIntArray[DParamIndex.POSY]+DAI.HERO_ELECTRONIC_RADIUS)*3;var w=(DAI.HERO_ELECTRONIC_RADIUS<<1)+1;var B=Math.floor(q-d/w);if(a._TempIntArray[DParamIndex.POSY]>=0){a._TempIntArray[DParamIndex.POSY]>>=2;if(this.CheckFlag(DFlags.FLIP_Y)){a._TempIntArray[DParamIndex.POSY]+=DAI.HERO_ELECTRONIC_HEIGHT}else{a._TempIntArray[DParamIndex.POSY]-=DAI.HERO_ELECTRONIC_HEIGHT}CGame.DrawAFrame_FixedPoint(DSpriteID.EFFECT,B,0,this._posX+a._TempIntArray[DParamIndex.POSX],this._posY+a._TempIntArray[DParamIndex.POSY],0);CGame.blendSpriteArray[DATA.EFFECT_ATMOSPHERE].PaintAFrame(g,2-(q-B),0,Math_FixedPointToInt(this._posX+a._TempIntArray[DParamIndex.POSX]-a._camX),Math_FixedPointToInt(this._posY+a._TempIntArray[DParamIndex.POSY]-a._camY),0)}}a._HeroInElectricAngle-=DAI.HERO_ELECTRONIC_VELOCITY;a._HeroInElectricAngle%=Math_Angle360}if(this._state==DState.STATE_ONGROUND&&this._subState==DState.SS_NOMOVE_VER){var B=DAnimID.EFFECT_NOMOVE_VER;if(CGame._worldId==DAI.WORLD_ID_SPACE){B=DAnimID.EFFECT_ELECTRICITY}var o=CGame.spriteArray[DSpriteID.EFFECT].GetAFrames(B);CGame.DrawAFrame_FixedPoint(DSpriteID.EFFECT,B,Math.floor(s_game_currentFrameNB/3)%o,this._posX,this._posY,this._flags&DFlags.FLIP_X)}};a._meteoriteRandomPosX=LowAPI.Gen_Array([DAI.METEORITE_NUM],0);a.meteoriteRandomPosY=LowAPI.Gen_Array([DAI.METEORITE_NUM],0);a.prototype.DrawBossDead=function(q,o,n,f){this.ClearFlag(DFlags.COLLIDING_WITH_HERO);var u=(this._tempParams[DTempParamIndex.BOSS_DEAD_EFFECT_FADE_DIRECTION]&2)!=0;if(this.AI_BOSS_CheckFlag(DFlags.BOSS_SHARE_DEAD_PROCESS_END_MASK)){if(this._classID!=DClassID.HERO&&this._classID!=DClassID.GIRL){var e=DEF.VIEW_W_D2;var d=100*DScreen.RATIO;var j=0;CGame.txtDrawSpecialEffectFlowFromTheSky(j,Text_GetString(TEXT.MENU_BOSS_DISAPPEAR),e,d,BOTTOM|HCENTER);if(this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP)>=DAI.BOSS_DEAD_END_DURATION_FRAM){this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}else{this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT]=this.AI_BOSS_AddCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP,this.AI_BOSS_GetCount(this._tempParams[DTempParamIndex.BOSS_SHARED_COUNT],DAI.BOSS_SHARED_COUNT_TYPE_DEAD_END_STEP),1)}}else{if(!u){this.SetFlag(DFlags.INVISIBLE)}else{this._animationPlayer.SetPos(Math_FixedPointToInt(q-a._camX),Math_FixedPointToInt(o-a._camY));this._animationPlayer.Render()}}return}var i=this._tempParams[DTempParamIndex.BOSS_DRAW_DEAD_STEP];var k=this._animationPlayer.GetAnim(),p=this._animationPlayer.GetFrame();var s=4294902015;var l=a.GetImageFromAFrame(this._sprite,k,p,this._flags,s);var r=l.getWidth()+n,m=l.getHeight();var t=r;var v=10;if(u){if(i<=0){i=t+r}}if(!u){if(i<(r+t)){if(i>r){i+=f}i+=f}else{i=0;this.AI_BOSS_SetCheckFlag(DFlags.BOSS_SHARE_DEAD_PROCESS_END_MASK)}}else{if(i<=r){i-=f}i-=f;if(i<=0){i=0;this.AI_BOSS_SetCheckFlag(DFlags.BOSS_SHARE_DEAD_PROCESS_END_MASK)}}if(!CGame.bIsPaused){this._tempParams[DTempParamIndex.BOSS_DRAW_DEAD_STEP]=i}if(DEF.dbgEnable){Dbg("WARNING : Ignore DrawRGB right now instead of DrawImage, will update later")}};a.prototype.DrawDebug=function(){if(DEF.dbgDrawBoundingBox){var j=this.GetAbsoluteBox(this._boundingBox);SetColor(65280);CGame.DrawRect_FixedPoint(j[0],j[1],j[2]-j[0],j[3]-j[1]);if(this.CheckFlag(DFlags.MULTI_BOUNDING_BOX)){var v=false;var k=this.GetFrameRectCount(-1,-1);j=LowAPI.Gen_Array([4],0);for(var f=2;f<k;f++){this.GetFrameRect(j,f,-1,-1);if(this.IsFlipX()){var t=j[DEF.BOX_LEFT];j[DEF.BOX_LEFT]=-j[DEF.BOX_RIGHT];j[DEF.BOX_RIGHT]=-t}j=this.GetAbsoluteBox(j);SetColor(65280);CGame.DrawRect_FixedPoint(j[0],j[1],j[2]-j[0],j[3]-j[1])}}if(DEF.dbgDrawAttackBox){j=this.GetAbsoluteBox(this.GetAttackBox());SetColor(16711680);CGame.DrawRect_FixedPoint(j[0],j[1],j[2]-j[0],j[3]-j[1])}SetColor(16711680);CGame.DrawLine_FixedPoint(this._posX,this._posY,this._posX,this._posY)}if(DEF.dbgEnableTouchBox&&(this._classID==DClassID.RANDOMBONUS||(this.CheckExFlag(DFlags.EX_ENEMY|DFlags.EX_BOSS)&&!this.CheckExFlag(DFlags.EX_CANNOT_HIT_BY_BULLET)))&&(this._classID!=DClassID.BOSS_OCTOPUS&&this._classID!=DClassID.BOSS_OCTOPUS_HEAD&&this._classID!=DClassID.BOSS_OCTOPUS_TENTACLE&&this._classID!=DClassID.BOSS_UFO)){if(this._classID==DClassID.BOSS_EATER&&this._subState!=DState.SS_BOSS_FLOWEREATER_TIRE){return}var j=this.GetAbsoluteBox(this._boundingBox);j[DEF.BOX_LEFT]-=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;j[DEF.BOX_TOP]-=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;j[DEF.BOX_RIGHT]+=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;j[DEF.BOX_BOTTOM]+=CGame.TOUCH_ENEMY_BOUNDING_OFFSET;SetColor(255);CGame.DrawRect_FixedPoint(j[0],j[1],j[2]-j[0],j[3]-j[1]);if(this.CheckFlag(DFlags.MULTI_BOUNDING_BOX)){var v=false;var k=this.GetFrameRectCount(-1,-1);j=LowAPI.Gen_Array([4],0);for(var f=2;f<k;f++){this.GetFrameRect(j,f,-1,-1);if(this.IsFlipX()){var t=j[DEF.BOX_LEFT];j[DEF.BOX_LEFT]=-j[DEF.BOX_RIGHT];j[DEF.BOX_RIGHT]=-t}j=this.GetAbsoluteBox(j);SetColor(255);CGame.DrawRect_FixedPoint(j[0],j[1],j[2]-j[0],j[3]-j[1])}}}if(DEF.dbgDrawSegment){if(this.CheckExFlag(DFlags.EX_SEGMENT)){var r=CGame._segments[this._params[DParamIndex.SEGMENT_SEGMENT_ID]];if(r.length>=4){var e=r[0];var q=r[1];var d=0;var o=0;for(var f=2;f<r.length;f+=2){d=r[f];o=r[f+1];SetColor(255);CGame.DrawLine_FixedPoint(this._posX+e,this._posY+q,this._posX+d,this._posY+o);SetColor(65280);CGame.DrawLine_FixedPoint(this._posX+e,this._posY+q,this._posX+e,this._posY+q);e=d;q=o}SetColor(16711680);CGame.DrawLine_FixedPoint(this._posX+r[0],this._posY+r[1],this._posX+r[0],this._posY+r[1]);SetColor(16777215);CGame.DrawLine_FixedPoint(this._posX+r[r.length-2],this._posY+r[r.length-1],this._posX+r[r.length-2],this._posY+r[r.length-1])}}var n=a.GetVelocity(this._vX);var l=a.GetVelocity(this._vY);if(this.CheckFlag(DFlags.GRAVITY)){l=a.GetVelocity((this._vY+a.GetVelocity(DAI.GRAVITY)))}if(n!=0||l!=0){SetColor(255);CGame.DrawLine_FixedPoint(this._posX+this._boundingBox[DEF.BOX_LEFT],this._posY,this._posX+this._boundingBox[DEF.BOX_LEFT]+n,this._posY+l);CGame.DrawLine_FixedPoint(this._posX+this._boundingBox[DEF.BOX_RIGHT],this._posY,this._posX+this._boundingBox[DEF.BOX_RIGHT]+n,this._posY+l)}}g.setFont("bold",10*DScreen.RATIO,"Arial");if(DEF.dbgDrawEntityFlags&&!this.CheckExFlag(DFlags.EX_SEGMENT)){var u="F: ";u=u+Math.floor(this._id);u=u+"-";u=u+Math.floor(this._posX>>DEF.SHIFT);u=u+"-";u=u+Math.floor(this._posY>>DEF.SHIFT);u=u+"-";u=u+(this._flags).toString(16);u=u+"-";u=u+(this._exFlags).toString(16);u=u+"-";u=u+Math.floor(this._id);var p=this._posX+this._boundingBox[DEF.BOX_LEFT]-a._camX;var m=this._posY+this._boundingBox[DEF.BOX_TOP]-a._camY;p>>=DEF.SHIFT;m>>=DEF.SHIFT;m-=16;SetColor(16777215);SetClip(0,0,DEF.SCR_W,DEF.SCR_H);DrawString(u,p,m,LEFT|TOP)}if(DEF.dbgEnableCheat){if(this==a._hero&&a._IsCheating){const h=10*DScreen.RATIO;var p=10*DScreen.RATIO,m=50*DScreen.RATIO;var u;SetColor(16711935);SetClip(0,0,DEF.SCR_W,DEF.SCR_H);u="NoDropHP: "+(a._debugCheatNoDecreaseHP?"On":"Off");DrawString(u,p,m,LEFT|TOP);m+=h;u="Bullet: "+(a._HeroPoweredBullet?"On":"Off");DrawString(u,p,m,LEFT|TOP);m+=h;u="NoHurt: "+(a._debugCheatNoHurt?"On":"Off");DrawString(u,p,m,LEFT|TOP);m+=h;u="NoHurt: "+(a._debugCheatNoHurt?"On":"Off");DrawString(u,p,m,LEFT|TOP);m+=h;if(a._debugCheatLastPressedKey==GLKey.k_fire){u="Key LeftUp (1) to switch Pass Level";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key Up (2) to Kill Boss or camera";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key LeftDown (7) to switch NoDropHP";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key Down (8) to switch Morph";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key RightDown (9) to switch NoHurt";DrawString(u,p,m,LEFT|TOP);m+=h}else{if(a._debugCheatLastPressedKey==GLKey.k_down){u="Key LeftUp (1) to switch Power Up";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key Up (2) to switch Fat";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key RightUo (3) to switch Robin Hood";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key LeftDown (7) to switch Eskimo";DrawString(u,p,m,LEFT|TOP);m+=h;u="Key RightDown (9) to switch Sword Fish";DrawString(u,p,m,LEFT|TOP);m+=h}else{u="Key 5 to advance switching";DrawString(u,p,m,LEFT|TOP);m+=h}}}}};a.prototype.DrawWater=function(o,r,p,d,t){var i=Math_FixedPointToInt(a._camX);var f=Math_FixedPointToInt(a._camY);var l=CGame.spriteArray[DSpriteID.OBJ_WAVE];var n=l.GetFrameWidth(l.GetAnimFrame(DAnimID.OBJ_WAVE_UNDERSURFACE,0));var q=l.GetFrameHeight(l.GetAnimFrame(DAnimID.OBJ_WAVE_UNDERSURFACE,0));var e=this._animationPlayer.GetFrame();if(this._params[DParamIndex.WATER_TYPE]==DValueList.WATER_TYPE_NORAML){l.SetCurrentPalette(1)}else{l.SetCurrentPalette(0)}var m=Math.max(r-i,(r-i)%n)+i;var k=Math.max(p-f,(p-f)%q)+f;var u=Math.min(i+DEF.VIEW_W,r+d);var s=Math.min(f+DEF.VIEW_H,p+t);l.SetCurrentPalette(1);for(var h=m;h<u;h+=n){l.PaintAFrame(g,DAnimID.OBJ_WAVE_SURFACE,e,h-i,p-f,0,0,0)}};a.FreeMoveDistanceInit=16<<8;a._IsCheating=false;a._FreeMoveDistance=a.FreeMoveDistanceInit;a.HeroMoveTraceMax=30;a.HeroMoveTraceRecordSize=2;a.HeroMoveTrace=LowAPI.Gen_Array([a.HeroMoveTraceMax*a.HeroMoveTraceRecordSize],0);a.HeroMoveTraceCount=0;a.DrawHeroMoveTrace=function(){for(var j=0;j<a.HeroMoveTraceCount-1;j++){var h=j;var e=a.HeroMoveTrace[h*a.HeroMoveTraceRecordSize]>>DEF.SHIFT;var l=a.HeroMoveTrace[h*a.HeroMoveTraceRecordSize+1]>>DEF.SHIFT;h++;var d=a.HeroMoveTrace[h*a.HeroMoveTraceRecordSize]>>DEF.SHIFT;var k=a.HeroMoveTrace[h*a.HeroMoveTraceRecordSize+1]>>DEF.SHIFT;var o=(a._camX>>8);var m=(a._camY>>8);e-=o;d-=o;l-=m;k-=m;SetClip(0,0,DEF.SCR_W,DEF.SCR_H);SetColor(16711935);DrawLine(e,l,d,k);SetColor(0);const f=1;FillRect(e-f,l-f,f*2,f*2)}};a.RENDER_DATA_LIMIT=64;a.s_levelRenderDatas=LowAPI.Gen_Array([a.RENDER_DATA_LIMIT,8],0);a.s_levelRenderCount=0;a.RENDER_TYPE_ANIMATION=256;a.RENDER_TYPE_LINE=512;a.RENDER_TYPE_FLOAT_TEXT=768;a.RENDER_FLAG_FLIPX=1<<0;a.RENDER_FLAG_FLIPY=1<<1;a.RENDER_FLAG_LOOP_ANIMATION=1<<2;a.RENDER_FLAG_POSITION_RELATIVE=1<<3;a.RENDER_FLAG_CAMERA_RELATIVE=1<<4;a.RENDER_FLAG_BLEND_SPRITE=1<<5;a.PrepareRender=function(f,k,e,h,i,d,j){if(a.s_levelRenderCount<a.RENDER_DATA_LIMIT){a.s_levelRenderDatas[a.s_levelRenderCount][0]=f;a.s_levelRenderDatas[a.s_levelRenderCount][1]=k;a.s_levelRenderDatas[a.s_levelRenderCount][2]=e;a.s_levelRenderDatas[a.s_levelRenderCount][3]=h;a.s_levelRenderDatas[a.s_levelRenderCount][4]=i;a.s_levelRenderDatas[a.s_levelRenderCount][5]=d;a.s_levelRenderDatas[a.s_levelRenderCount][6]=j;a.s_levelRenderDatas[a.s_levelRenderCount][7]=0;a.s_levelRenderCount++}};a.RemoveRender=function(d){a.s_levelRenderCount--;if(d<a.s_levelRenderCount){System.arraycopy(a.s_levelRenderDatas[a.s_levelRenderCount],0,a.s_levelRenderDatas[d],0,a.s_levelRenderDatas[a.s_levelRenderCount].length);--d}return d};a.RemoveObjectRender=function(f,e){for(var d=0;d<a.s_levelRenderCount;d++){if(a.s_levelRenderDatas[d][1]==f&&(e==-1||e==(a.s_levelRenderDatas[d][0]&16776960))){d=a.RemoveRender(d)}}};a.show_hint_Press2=false;a.DrawRender=function(e){if(a.s_levelRenderCount<1){a.show_hint_Press2=false}for(var l=0;l<a.s_levelRenderCount;l++){if(e!=-1&&a.s_levelRenderDatas[l][1]!=e){continue}var o=a.s_levelRenderDatas[l][0]&255;var p=a.s_levelRenderDatas[l][0]&16776960;if(p==a.RENDER_TYPE_ANIMATION){var s=a.s_levelRenderDatas[l][2];var d=null;if((o&a.RENDER_FLAG_BLEND_SPRITE)==0){d=CGame.spriteArray[s]}else{d=CGame.blendSpriteArray[s]}var k=a.s_levelRenderDatas[l][3];var f=a.s_levelRenderDatas[l][4];if(a.s_levelRenderDatas[l][1]==e){if(f>=0){var r=a.s_levelRenderDatas[l][5];var q=a.s_levelRenderDatas[l][6];if((o&a.RENDER_FLAG_POSITION_RELATIVE)!=0){var n=a.GetEntityByID(e,false);if(n!=null){r+=n._posX;q+=n._posY}}if((o&a.RENDER_FLAG_CAMERA_RELATIVE)==0){r-=a._camX;q-=a._camY}var m=o&(a.RENDER_FLAG_FLIPX|a.RENDER_FLAG_FLIPY);if(s==DSpriteID.HINT&&k==DAnimID.HINT_PRESS_2){a.show_hint_Press2=true}d.PaintAFrame(g,k,f,Math_FixedPointToInt(r),Math_FixedPointToInt(q),m)}}if(e==-1){var h=a.s_levelRenderDatas[l][7]+CGame._frameDT;a.s_levelRenderDatas[l][7]=h;var j=d.GetAFrameTime(k,f)*(1000/GLLibConfig.sprite_animFPS);while(h>=j){h-=j;a.s_levelRenderDatas[l][7]=h;if(f<d.GetAFrames(k)-1){f++;a.s_levelRenderDatas[l][4]=f}else{if((o&a.RENDER_FLAG_LOOP_ANIMATION)!=0){f=0;a.s_levelRenderDatas[l][4]=f}else{l=a.RemoveRender(l);break}}j=d.GetAFrameTime(k,f)*(1000/GLLibConfig.sprite_animFPS)}}}}};a.FindObjectRender=function(f,j,e,h){for(var d=0;d<a.s_levelRenderCount;d++){if((f==(a.s_levelRenderDatas[d][0]&16776960))&&a.s_levelRenderDatas[d][1]==j&&a.s_levelRenderDatas[d][2]==e&&a.s_levelRenderDatas[d][3]==h){return d}}return -1};a.prototype.PrepareRenderIsOver=function(e,h,d,f){return a.s_levelRenderCount<=0||(a.FindObjectRender(a.RENDER_TYPE_ANIMATION,h,d,f)<0)};a._camera=null;a._cameraDefault=null;a._camX=0;a._camY=0;a._camLastX=0;a._camLastY=0;a._camMaxSpeedX=0;a._camMaxSpeedY=0;a._camFocus=null;a._camFocusA=null;a._camFocusB=null;a._camCircularScroll=false;a._camScrollVX=0;a._camScrollPosX=0;a.prototype.AI_CameraInitCircularScroll=function(){a._camCircularScroll=true;a._camScrollVX=DAI.CAMERA_CIRCULAR_SCROLL_VX;a._camScrollPosX=a._camX};a.prototype.AI_CameraAvailable=function(i,h){var d=0;var f=this._destX;var e=this._destY;if((i-a._camera._posX)<(DEF.VIEW_W_FLOAT/4)){f=i-(DEF.VIEW_W_FLOAT/4);f+=DEF.VIEW_W_D2_FLOAT;this._destX=Math.min(f,this._destX);d|=DFlags.PHY_BLOCK_BACK}if((i-a._camera._posX)>(DEF.VIEW_W_FLOAT*3/4)){f=i-(DEF.VIEW_W_FLOAT*3/4);f+=DEF.VIEW_W_D2_FLOAT;this._destX=Math.max(f,this._destX);d|=DFlags.PHY_BLOCK_FRONT}if((h-a._camera._posY)<(DEF.VIEW_H_FLOAT/3)){e=h-(DEF.VIEW_H_FLOAT/3);e+=DEF.VIEW_H_D2_FLOAT;this._destY=Math.min(e,this._destY);d|=DFlags.PHY_BLOCK_TOPSIDE}if((h-a._camera._posY)>(DEF.VIEW_H_FLOAT*3/4)){e=h-(DEF.VIEW_H_FLOAT*3/4);e+=DEF.VIEW_H_D2_FLOAT;this._destY=Math.max(e,this._destY);d|=DFlags.PHY_BLOCK_UNDERSIDE}return d};a.prototype.AI_CameraTractor=function(i){if(i==null){return false}var f=this._posX;var e=this._posY;this.SetPos(this._destX-DEF.VIEW_W_D2_FLOAT,this._destY-DEF.VIEW_H_D2_FLOAT);var d=this.AI_CameraAvailable(i._posX,i._posY);if(d!=0){var j=0;var h=0;if((d&DFlags.PHY_BLOCK_FRONTBACK)!=0){j=i._posX;j=Math.max(j,this._posX+(DEF.VIEW_W_FLOAT/6));j=Math.min(j,this._posX+(DEF.VIEW_W_FLOAT*5/6));j=i._posX-j}else{if((d&DFlags.PHY_BLOCK_TOPUNDER)!=0){h=i._posY;h=Math.max(h,this._posY+(DEF.VIEW_H_FLOAT/6));h=Math.min(h,this._posY+(DEF.VIEW_H_FLOAT*5/6));h=i._posY-h}}this.SetPos(this._destX-DEF.VIEW_W_D2_FLOAT+j,this._destY-DEF.VIEW_H_D2_FLOAT+h);if(a._camFocus!=null){d=this.AI_CameraAvailable(a._camFocus._posX,a._camFocus._posY);if(d==0){this._destX+=j;this._destY+=h}}}this.SetPos(this._posX,this._posY);return true};a.prototype.AI_CameraDest=function(){this._destX+=DEF.VIEW_W_D2_FLOAT;this._destY+=DEF.VIEW_H_D2_FLOAT;if(a._camFocus==null){a._camFocus=a._hero}if(a._camFocus!=null){var e=a._camFocus.IsFlipX();if(a._boss!=null){e=(a._boss._posX-a._camFocus._posX)<0}if(a._camFocus._state==DState.STATE_ONGROUND){this._destY=a._camFocus._posY+(a._camFocus.CheckFlag(DFlags.REVERSAL_GRAVITY)?-DAI.CAMERA_OFFSET_Y:DAI.CAMERA_OFFSET_Y);if(a._camFocus._subState==DState.SS_HERO_IN_FLY_CANNON){this._destX=a._camFocus._posX+(e?-((DAI.CAMERA_OFFSET_X<<1)+(DAI.CAMERA_OFFSET_X>>1)):((DAI.CAMERA_OFFSET_X<<1)+(DAI.CAMERA_OFFSET_X>>1)));this._destY=a._camFocus._posY+((DAI.CAMERA_OFFSET_Y<<1))}else{if(a._camFocus._frameVX!=0){this._destX=a._camFocus._posX+(e?-DAI.CAMERA_OFFSET_X:DAI.CAMERA_OFFSET_X)}else{this._destX=this._posX+DEF.VIEW_W_D2_FLOAT}}}else{if(a._camFocus._state==DState.STATE_SWIM){this._destX=a._camFocus._posX;this._destY=a._camFocus._posY}else{if(a._camFocus._state==DState.STATE_INAIR){this._destX=a._camFocus._posX+(e?-DAI.CAMERA_OFFSET_X:DAI.CAMERA_OFFSET_X);if((a._camFocus._subState==DState.SS_INAIR_FALL_START||a._camFocus._subState==DState.SS_INAIR_FALL||a._camFocus._subState==DState.SS_INAIR_SMASH_FALL)&&a._camFocus._stateElapsedTime>=580){this._destY=a._camFocus._posY+a.GetBoxMiddleY(a._camFocus._boundingBox)}else{this._destY=this._posY+DEF.VIEW_H_D2_FLOAT}}else{if(a._camFocus._state==DState.STATE_INBLACK_HOLE){this._destX=a._camFocus._posX+(e?-DAI.CAMERA_OFFSET_X:DAI.CAMERA_OFFSET_X);this._destY=this._posY+DEF.VIEW_H_D2_FLOAT}else{this._destX=a._camFocus._posX+(e?-DAI.CAMERA_OFFSET_X:DAI.CAMERA_OFFSET_X);this._destY=a._camFocus._posY+(a._camFocus.CheckFlag(DFlags.REVERSAL_GRAVITY)?-DAI.CAMERA_OFFSET_Y:DAI.CAMERA_OFFSET_Y)}}}}if(a._camFocus._subState!=DState.SS_HERO_IN_FLY_CANNON){var d=this.AI_CameraAvailable(a._camFocus._posX,a._camFocus._posY)}}this.AI_CameraTractor(a._camFocusA);this.AI_CameraTractor(a._camFocusB);this._destX-=DEF.VIEW_W_D2_FLOAT;this._destY-=DEF.VIEW_H_D2_FLOAT};a._camQuake=0;a._camOffsetX=0;a._camOffsetY=0;a.k_camQuake_OffsetY=2<<DEF.SHIFT;a.AI_CameraQuake=function(d){a._camQuake=1;a._camOffsetY=d};a.prototype.AI_CameraLimit=function(){if((this._params[DParamIndex.CAMERA_LIMIT]&DValueList.CAMERA_LIMIT_RIGHT)!=0&&this._posX>Math_IntToFixedPoint(this._params[DParamIndex.POSX]+this._params[DParamIndex.CAMERA_WIDTH]-DEF.VIEW_W)){this._posX=Math.min(this._posX,Math_IntToFixedPoint(this._params[DParamIndex.POSX]+this._params[DParamIndex.CAMERA_WIDTH]-DEF.VIEW_W));this._destX=Math.min(this._destX,Math_IntToFixedPoint(this._params[DParamIndex.POSX]+this._params[DParamIndex.CAMERA_WIDTH]-DEF.VIEW_W));if(this._vX>0){this._vX=0}}if((this._params[DParamIndex.CAMERA_LIMIT]&DValueList.CAMERA_LIMIT_LEFT)!=0&&this._posX<Math_IntToFixedPoint(this._params[DParamIndex.POSX])){this._posX=Math.max(this._posX,Math_IntToFixedPoint(this._params[DParamIndex.POSX]));this._destX=Math.max(this._destX,Math_IntToFixedPoint(this._params[DParamIndex.POSX]));if(this._vX<0){this._vX=0}}if((this._params[DParamIndex.CAMERA_LIMIT]&DValueList.CAMERA_LIMIT_BOTTOM)!=0&&this._posY>Math_IntToFixedPoint(this._params[DParamIndex.POSY]+this._params[DParamIndex.CAMERA_HEIGHT]-DEF.VIEW_H)){this._posY=Math.min(this._posY,Math_IntToFixedPoint(this._params[DParamIndex.POSY]+this._params[DParamIndex.CAMERA_HEIGHT]-DEF.VIEW_H));this._destY=Math.min(this._destY,Math_IntToFixedPoint(this._params[DParamIndex.POSY]+this._params[DParamIndex.CAMERA_HEIGHT]-DEF.VIEW_H));if(this._vY>0){this._vY=0}}if((this._params[DParamIndex.CAMERA_LIMIT]&DValueList.CAMERA_LIMIT_TOP)!=0&&this._posY<Math_IntToFixedPoint(this._params[DParamIndex.POSY])){this._posY=Math.max(this._posY,Math_IntToFixedPoint(this._params[DParamIndex.POSY]));this._destY=Math.max(this._destY,Math_IntToFixedPoint(this._params[DParamIndex.POSY]));if(this._vY<0){this._vY=0}}};a.prototype.AI_Camera=function(q,e){if(a._camera!=this){this._vX=0;this.SetVY(0);return DFSM.SMCR_DEFAULT}a.AI_CameraQuakeUpdate();if(this.CheckFlag(DFlags.CENIMATIC)){a.SetCameraPos(this._posX+a._camOffsetX,this._posY+a._camOffsetY);return DFSM.SMCR_DEFAULT}a._camMaxSpeedX=DAI.MAX_CAMERA_SPEED_X;a._camMaxSpeedY=DAI.MAX_CAMERA_SPEED_Y;if(a._hero._subState==DState.SS_HERO_BROKEN_BIG_CRYSTAL||a._hero._subState==DState.SS_HERO_NO_HIT_BIG_CRYSTAL){a._camMaxSpeedX=DAI.MAX_CAMERA_SPEED_X<<1;a._camMaxSpeedY=DAI.MAX_CAMERA_SPEED_Y<<1}else{if(a._hero._subState==DState.SS_HERO_END_MINIGAME){a._camMaxSpeedX=0;a._camMaxSpeedY=0}}this.AI_CameraDest();var n=(this._destX-this._posX);var m=(this._destY-this._posY);if(this._vX*n<0){this._vX=0}if(Math.abs(n)>Math_FixedPoint_Multiply(a._camMaxSpeedX<<1,CGame._velocityRate)){}else{if(Math.abs(n)>DEF.FLOAT_1){if(CGame._velocityRate==0){a._camMaxSpeedX=0}else{a._camMaxSpeedX=Math_FixedPoint_Divide(Math.abs(n)>>1,CGame._velocityRate)}}else{if(CGame._velocityRate==0){a._camMaxSpeedX=0}else{a._camMaxSpeedX=Math_FixedPoint_Divide(Math.abs(n),CGame._velocityRate)}}}var l=DAI.CAMERA_ACCELERATION_X;var h=a.GetVelocity(l);this._vX+=n>0?h:-h;this._vX=Math.max(this._vX,-a._camMaxSpeedX);this._vX=Math.min(this._vX,a._camMaxSpeedX);if(!Math_SameSign(this._vY,m)){this.SetVY(0)}if(Math.abs(m)>Math_FixedPoint_Multiply(a._camMaxSpeedY<<1,CGame._velocityRate)){}else{if(Math.abs(n)>DEF.FLOAT_1){if(CGame._velocityRate==0){a._camMaxSpeedY=0}else{a._camMaxSpeedY=Math_FixedPoint_Divide(Math.abs(m)>>1,CGame._velocityRate)}}else{if(CGame._velocityRate==0){a._camMaxSpeedY=0}else{a._camMaxSpeedY=Math_FixedPoint_Divide(Math.abs(m),CGame._velocityRate)}}}var j=DAI.CAMERA_ACCELERATION_Y;h=a.GetVelocity(j);var o=this._vY+(m>0?h:-h);o=Math.max(o,-a._camMaxSpeedY);o=Math.min(o,a._camMaxSpeedY);this.SetVY(o);if(a._IsCheating&&this._curTrace<=0){this._destX=a._hero._posX;this._destY=a._hero._posY+DAI.CAMERA_OFFSET_Y;this._destX-=DEF.VIEW_W_D2_FLOAT;this._destY-=DEF.VIEW_H_D2_FLOAT;this.SetPos(this._destX,this._destY);this._vX=0;this.SetVY(0)}if(this._curTrace>0){this._posX+=DEF.VIEW_W_D2_FLOAT;this._posY+=DEF.VIEW_H_D2_FLOAT;var f=this._vX;var d=this._vY;if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_VERTICAL||this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_HORIZONTAL){var p=a.GetRowDataByID(this._curTrace);if(p!=null){var i=a.GetRowDataByID(p[DParamIndex.TRACE_NEXT_TRACE]);if(i!=null){if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_VERTICAL){i[DParamIndex.POSX]=Math_FixedPointToInt(this._posX)}else{i[DParamIndex.POSY]=Math_FixedPointToInt(this._posY)}}}}if(this.MoveAndWaitToNextTrace(false)){if(this._curTrace==-1){}}if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_HORIZONTAL){this.SetVY(d)}else{if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_VERTICAL){this._vX=f}}this._posX-=DEF.VIEW_W_D2_FLOAT;this._posY-=DEF.VIEW_H_D2_FLOAT;if(this._params[DParamIndex.CAMERA_TYPE]==DValueList.CAMERA_TYPE_MOVE_VERTICAL){this.AI_CameraLimit()}}else{if(this._params[DParamIndex.CAMERA_LIMIT]!=0){this.AI_CameraLimit()}}var k=this._params;this._params=a._cameraDefault._params;this.AI_CameraLimit();this._params=k;if(this._curTrace>0&&this._params[DParamIndex.CAMERA_TYPE]!=DValueList.CAMERA_TYPE_MOVE_VERTICAL){this._params[DParamIndex.POSX]=Math_FixedPointToInt(this._posX);this._params[DParamIndex.POSY]=Math_FixedPointToInt(this._posY)}a.SetCameraPos(this._posX+Math_IntToFixedPoint(this._params[DParamIndex.CAMERA_OFFSET_X])+a._camOffsetX,this._posY+Math_IntToFixedPoint(this._params[DParamIndex.CAMERA_OFFSET_Y])+a._camOffsetY);return DFSM.SMCR_DEFAULT};a.AI_CameraQuakeUpdate=function(){if(a._camQuake!=0){a._camQuake=-a._camQuake;a._camOffsetY=-a._camOffsetY;if(a._camOffsetY==(DEF.FLOAT_1<<1)){a._camOffsetY=0}else{if(a._camOffsetY>0){a._camOffsetY>>=1}}if(a._camOffsetY==0){a._camQuake=0}}};a.ClearCameraTractor=function(d){if(!(d!=null)){Dbg("ClearCameraTractor(): obj is null")}if(a._camFocusA==d){a._camFocusA=a._camFocusB;a._camFocusB=null}else{if(a._camFocusB==d){a._camFocusB=null}}};a.SetCameraTractor=function(d){if(!(d!=null)){Dbg("SetCameraTractor(): obj is null")}if(a._camFocusA==null){a._camFocusA=d}else{if(a._camFocusB==null){if(a._camFocusA!=d){a._camFocusB=d}}else{if(a._camFocusB!=d){a._camFocusA=d}}}};a.SetCameraFocus=function(e,d){if(e==null){a._camFocus=a._hero}else{if(e!=a._camFocus){a._camFocus=e}}if(d&&a._camera!=null){a._camera._posX=a._camFocus._posX+(a._hero.IsFlipX()?-DAI.CAMERA_OFFSET_X:DAI.CAMERA_OFFSET_X);a._camera._posX-=DEF.VIEW_W_D2_FLOAT;a._camera._posY=a._camFocus._posY+DAI.CAMERA_OFFSET_Y;a._camera._posY-=DEF.VIEW_W_D2_FLOAT;a._camera.AI_CameraDest();a._camera.AI_CameraLimit();a._camera.SetPos(a._camera._destX,a._camera._destY);a._camera._vX=0;a._camera.SetVY(0);a.SetCameraPos(a._camera._posX+a._camOffsetX,a._camera._posY+a._camOffsetY)}};a.SetCameraPos=function(m,l){a._camLastX=a._camX;a._camLastY=a._camY;var f=Math_FixedPointToInt(m);var e=Math_FixedPointToInt(l);a._camX=Math_IntToFixedPoint(f);a._camY=Math_IntToFixedPoint(e);if(a._camCircularScroll){f=Math_FixedPointToInt(a._camScrollPosX);a._camScrollPosX+=a.GetVelocity(a._camScrollVX)}for(var h=2;h<GLLibConfig.tileset_maxLayerCount;h++){if(CGame.level2Tiled(CGame._tempLevelId,h)!=-1){GLLibPlayer.Tileset_SetCamera(h,f,e)}}var j=Math_IntToFixedPoint(GLLibPlayer.Tileset_GetLayerWidth(2)-DEF.VIEW_W);var d=Math_IntToFixedPoint(GLLibPlayer.Tileset_GetLayerHeight(2)-DEF.VIEW_H);var n=0;if(GLLibPlayer.Tileset_GetLayerWidth(0)>DEF.VIEW_W){n=Math_FixedPoint_Divide(j,Math_IntToFixedPoint(GLLibPlayer.Tileset_GetLayerWidth(0)-DEF.VIEW_W));n=Math_FixedPointToInt(Math_FixedPoint_Divide(m,n))}var k=0;if(GLLibPlayer.Tileset_GetLayerHeight(0)>DEF.VIEW_H){k=Math_FixedPoint_Divide(d,Math_IntToFixedPoint(GLLibPlayer.Tileset_GetLayerHeight(0)-DEF.VIEW_H));k=Math_FixedPointToInt(Math_FixedPoint_Divide(l,k))}a._btmLayerX=n;a._btmLayerY=k;GLLibPlayer.Tileset_SetCamera(0,n,k)};a.SetCurrentCamera=function(d){if(d==null){d=a.GetDefaultCamera()}if(a._camera!=d){if(a._camera!=null){d.SetPos(a._camera._posX,a._camera._posY);d._destX=a._camera._destX;d._destY=a._camera._destY;d.AI_CameraLimit()}a._camera=d}};a.GetDefaultCamera=function(){if(a._cameraDefault==null){var d=LowAPI.Gen_Array([DParamIndex.CAMERA_TRACE+1],0);d[DParamIndex.CLASS_ID]=DClassID.CAMERA;d[DParamIndex.ID]=CGame._entityMaxId++;d[DParamIndex.FLAGS]=DFlags.INVISIBLE|DFlags.ACTIVE_BY_TRIGGER|DFlags.DYNAMIC_CREATE;if(GLLibConfig.tileset_useTileShift){d[DParamIndex.CAMERA_WIDTH]=(CGame._mapTileCountWidth<<DEF.TILE_W_SHIFT);d[DParamIndex.CAMERA_HEIGHT]=(CGame._mapTileCountHeight<<DEF.TILE_H_SHIFT)}else{d[DParamIndex.CAMERA_WIDTH]=(CGame._mapTileCountWidth*DEF.TILE_W);d[DParamIndex.CAMERA_HEIGHT]=(CGame._mapTileCountHeight*DEF.TILE_H)}d[DParamIndex.CAMERA_TYPE]=DValueList.CAMERA_TYPE_DEAD;d[DParamIndex.CAMERA_LIMIT]=DValueList.CAMERA_LIMIT_LEFT|DValueList.CAMERA_LIMIT_RIGHT|DValueList.CAMERA_LIMIT_TOP|DValueList.CAMERA_LIMIT_BOTTOM;d[DParamIndex.CAMERA_TRACE]=-1;a._cameraDefault=a.Create(d)}return a._cameraDefault};a.prototype.InScreen=function(){return this._posX+this._boundingBox[DEF.BOX_RIGHT]>a._camX&&this._posX+this._boundingBox[DEF.BOX_LEFT]<a._camX+DEF.SCR_W_FLOAT&&this._posY+this._boundingBox[DEF.BOX_BOTTOM]>a._camY&&this._posY+this._boundingBox[DEF.BOX_TOP]<a._camY+DEF.SCR_H_FLOAT};a.InScreenM2LimitBox=function(f){var i=Math_IntToFixedPoint(f[DParamIndex.POSX]+f[DParamIndex.CANNON_AREALEFT]);var h=Math_IntToFixedPoint(f[DParamIndex.POSY]+f[DParamIndex.CANNON_AREATOP]);var e=Math_IntToFixedPoint(f[DParamIndex.CANNON_AREAWIDTH]);var d=Math_IntToFixedPoint(f[DParamIndex.CANNON_AREAHEIGHT]);return a.InScreenM2(i,h,e,d)};a.InScreenM2=function(){if(arguments){switch(arguments.length){case 2:return a.InScreenM2_2.apply(this,arguments);case 4:return a.InScreenM2_4.apply(this,arguments)}}throw new Error("InvalidArguments")};a.InScreenM2_4=function(h,f,e,d){if(h+e<a._camX-DEF.VIEW_W_D2_FLOAT){return false}if(h>a._camX+(DEF.VIEW_W_FLOAT+DEF.VIEW_W_D2_FLOAT)){return false}if(f+d<a._camY-DEF.VIEW_H_D2_FLOAT){return false}if(f>a._camY+(DEF.VIEW_H_FLOAT+DEF.VIEW_H_D2_FLOAT)){return false}return true};a.InScreenM2_2=function(e,d){if(e<a._camX-DEF.VIEW_W_D2_FLOAT){return false}if(e>a._camX+(DEF.VIEW_W_FLOAT+DEF.VIEW_W_D2_FLOAT)){return false}if(d<a._camY-DEF.VIEW_H_D2_FLOAT){return false}if(d>a._camY+(DEF.VIEW_H_FLOAT+DEF.VIEW_H_D2_FLOAT)){return false}return true};a.MAX_MONSTER_CHEST=4;a._monsterchestHP=LowAPI.Gen_Array([a.MAX_MONSTER_CHEST<<1],0);a.MonsterchestInitHP=function(){if(a._monsterchestHP==null){a._monsterchestHP=LowAPI.Gen_Array([a.MAX_MONSTER_CHEST<<1],0)}var e=0;for(var d=0;d<CGame._entityRowDataCount;d++){var f=CGame._entitiesRowData[d];if(f==null||f[DParamIndex.CLASS_ID]!=DClassID.MOBS_MONSTERINCHEST){continue}if(e<a._monsterchestHP.length-1){a._monsterchestHP[e++]=f[DParamIndex.ID];a._monsterchestHP[e++]=3}}};a.MonsterchestLoseHP=function(e){for(var d=0;d<a._monsterchestHP.length;d+=2){if(a._monsterchestHP[d]==e){a._monsterchestHP[d+1]--;return}}};a.MonsterchestGetHP=function(e){for(var d=0;d<a._monsterchestHP.length;d+=2){if(a._monsterchestHP[d]==e){return a._monsterchestHP[++d]}}return 0};a._returnState=0;a._returnSubState=0;a.prototype.StateMachineFindIndex=function(l,e){if(this._stateFlow==null){return -1}var j=l,h=e&DFSM.SS_MASK;var f;var d=this._stateFlow.length;var k=-1;if(j==DFSM.STATE_NONE){j=this._state}for(f=0;f<d;f+=DFSM.STATE_RECORD_LEN){if((this._stateFlow[f+DFSM.OFFSET_STATE]&DFSM.STATE_MASK)==j){if(e==DFSM.SUBSTATE_NONE){k=f}else{if((this._stateFlow[f+DFSM.OFFSET_STATE]&DFSM.SS_MASK)==h){k=f}}}if(k>=0){break}}return k};a.prototype.StateMachineModifyStatus=function(d){if((d&DFSM.CSF_INACTIVE)!=0){this.SetInactived(false);return false}if((d&DFSM.CSF_DESTROY)!=0){this.SetInactived(true);return false}if((d&DFSM.CSF_NO_UPDATEAI)!=0){this.SetFlag(DFlags.NO_UPDATE_AI);return false}if((d&DFSM.CSF_INVISIBLE)!=0){this.SetFlag(DFlags.INVISIBLE)}else{this.ClearFlag(DFlags.INVISIBLE)}if((d&DFSM.CSF_ACTIVATE_ACTOR)!=0){}return true};a.prototype.StateMachineResetAnim=function(d,f){if(this._state==DFSM.STATE_CHANGESTATUS){this.SetAnim(0,a.SETANIM_ONCE);return}var e;if((d&DFSM.CSTATEF_AI_ANIM)!=0){e=d&~DFSM.CSTATEF_AI_ANIM}else{if((this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&DFSM.SF_AI_ANIM)==0){e=this._stateFlow[this._stateIndex+DFSM.OFFSET_ANIM]}else{e=this.StateMachineGetAnim(f);if(e==DFSM.ANIM_NONE){e=this._stateFlow[this._stateIndex+DFSM.OFFSET_ANIM]}}}if(e==DFSM.ANIM_NONE){return}this.SetAnim(e&DFSM.ANIM_MASK,(e&~DFSM.ANIM_MASK)|a.SETANIM_ONCE|a.SETANIM_FORCE)};a.prototype.StateMachineSetStateFlow=function(l,e){this._stateIndex=-1;this._stateFlow=l;if(this._stateFlow==null){return false}if(DEF.dbgEnable){var d=this._stateFlow.length;if(d%DFSM.STATE_RECORD_LEN!=0){if(!(false)){Dbg("State flow length must be multiply of "+DFSM.STATE_RECORD_LEN)}}for(var h=0;h<d;h+=DFSM.STATE_RECORD_LEN){for(var f=h+DFSM.STATE_RECORD_LEN;f<d;f+=DFSM.STATE_RECORD_LEN){if(this._stateFlow[h+DFSM.OFFSET_STATE]==this._stateFlow[f+DFSM.OFFSET_STATE]){if(!(false)){Dbg("There are duplicate fullstate in the state flow.")}}}if(this._stateFlow[h+DFSM.OFFSET_DURATION]==0){if(!(false)){Dbg("Invalid state duration 0 classID: "+this._classID+" index: "+(h/DFSM.STATE_RECORD_LEN))}}if(this._stateFlow[h+DFSM.OFFSET_DURATION]==-1){if(!(false)){Dbg("Invalid state duration -1 classID: "+this._classID+" index: "+(h/DFSM.STATE_RECORD_LEN))}}}}if((e&DFSM.SSF_MATCH_ANIM)!=0){var d=this._stateFlow.length;var j=this._animationPlayer.GetAnim();for(var h=0;h<d;h+=DFSM.STATE_RECORD_LEN){if(this._stateFlow[h+DFSM.OFFSET_ANIM]==j){this.StateMachineGotoNextState(this._stateFlow[h+DFSM.OFFSET_STATE],0);return true}}return false}return this.StateMachineGotoNextState(this._stateFlow[DFSM.OFFSET_STATE],0)};a.prototype.StateMachineChangeState=function(e,f,j){if(this.StateMachineTranslateState(e,f)){e=a._returnState;f=a._returnSubState}var r=e,d=f;var q=-1;var o=this._state,h=this._subState,k=this._stateIndex;if(r==DFSM.STATE_NONE){r=this._state}var p=r+d;if(p!=DFSM.FULLSTATE_DESTROY){q=this.StateMachineFindIndex(r,d);if(q<0){if((j&DFSM.CSTATEF_NOFOUND_NOCHANGE)==0){if(DEF.dbgEnable){Dbg("WARNING: Can't find state "+e+" sub "+f+" ClassID "+this._classID+"\n")}this._preFullState=this._state+this._subState;this._state=r;this._subState=d;this._nextFullState=DFSM.FULLSTATE_NONE;this._stateIndex=-1}return false}if(r==DFSM.STATE_CHANGESTATUS){var l=this._stateFlow[q+DFSM.OFFSET_CHANGESTATUS];if(!this.StateMachineModifyStatus(l)){return true}}}if(!this.CheckFlag(DFlags.STATE_IS_CHANGING)){this.SetFlag(DFlags.STATE_IS_CHANGING);if(this._stateIndex>=0&&!this.StateMachineNotifyExit(r,d,q)){this.ClearFlag(DFlags.STATE_IS_CHANGING);return false}this.ClearFlag(DFlags.STATE_IS_CHANGING)}if(!this.CheckFlag(DFlags.STATE_IS_CHANGING)){this.SetFlag(DFlags.STATE_IS_CHANGING);if(!this.StateMachineNotifyEnter(r,d,q)){this.ClearFlag(DFlags.STATE_IS_CHANGING);return false}this.ClearFlag(DFlags.STATE_IS_CHANGING)}if(p==DFSM.FULLSTATE_DESTROY){this.StateMachineModifyStatus(DFSM.CSF_DESTROY);return true}this._preFullState=this._state+this._subState;this._state=r;this._subState=d;this._nextFullState=this._stateFlow[q+DFSM.OFFSET_NEXTSTATE];this._stateIndex=q;this._stateDuration=this.StateMachineGetData(DFSM.OFFSET_DURATION);if(this._stateDuration==DFSM.DURATION_UNTIL_NEXT_FRAME){this._stateFlow[q+DFSM.OFFSET_FLAGS]|=DFSM.SF_DURATION_NEXT_FRAME}if((this._stateFlow[q+DFSM.OFFSET_FLAGS]&DFSM.SF_DURATION_NEXT_FRAME)!=0){this._stateDuration=s_game_currentFrameNB}this.StateMachineResetAnim(j,true);var i=this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS];if((i&DFSM.SF_KEEP_ELAPSED_TIME)==0){this._stateElapsedTime=0}var n=this._vX,m=this._vY;if(this._stateFlow[q+DFSM.OFFSET_VX]!=DFSM.VELOCITY_NONE&&(j&DFSM.CSTATEF_KEEP_VX)==0){this._vX=this._stateFlow[q+DFSM.OFFSET_VX];if(this.IsFlipX()){this._vX=-this._vX}if((i&DFSM.SF_ACCUMULATE_VX)!=0){this._vX+=n}}if(this._stateFlow[q+DFSM.OFFSET_VY]!=DFSM.VELOCITY_NONE&&(j&DFSM.CSTATEF_KEEP_VY)==0){this.SetVY(this._stateFlow[q+DFSM.OFFSET_VY]);if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._vY=-this._vY}if((i&DFSM.SF_ACCUMULATE_VY)!=0){this._vY+=m}}if(this._state==DFSM.STATE_CHANGESTATUS){if(this._stateDuration==0){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);return true}}if((i&DFSM.SF_INVISIBLE)==0){if(this.CheckFlag(DFlags.INVISIBLE)){this.ClearFlag(DFlags.INVISIBLE);this.UpdateBoundingBox()}}else{this.SetFlag(DFlags.INVISIBLE);this.UpdateBoundingBox()}if((i&DFSM.SF_RANDOM_DURATION)!=0){this._stateDuration=a.GetRand(this._stateDuration>>16,this._stateDuration&65535)}if((j&DFSM.CSTATEF_FLIP_X)!=0){this.SetFlipX(!this.IsFlipX())}this.StateMachineNotifyHasEntered(o,h,k);if(this._stateDuration==DFSM.DURATION_IMMEDIATELY){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);return true}if((i&DFSM.SF_CLEAR_COLLIDING_WITH_HERO)!=0){this.ClearFlag(DFlags.COLLIDING_WITH_HERO)}if((i&DFSM.SF_SET_COLLIDING_WITH_HERO)!=0){this.SetFlag(DFlags.COLLIDING_WITH_HERO)}if((i&DFSM.SF_CLEAR_COLLIDING_WITH_SEGMENT)!=0){this.ClearFlag(DFlags.COLLIDING_WITH_SEGMENT)}return true};a.prototype.StateMachineGotoNextState=function(h,e){if(h==DFSM.FULLSTATE_NONE){h=this._nextFullState}if(h==DFSM.FULLSTATE_NONE){}else{var f=h&DFSM.STATE_MASK;var d=h&DFSM.SUBSTATE_MASK;return this.StateMachineChangeState(f,d,e)}return false};a.prototype.StateMachineGetData=function(e){var d=this._stateFlow[this._stateIndex+e];if(e==DFSM.OFFSET_DURATION){if(this._stateSequence!=null){d=this._stateSequence[this._curSequenceIndex+DFSM.SEQUENCE_OFFSET_DURATION];if(d==DFSM.SEQUENCE_NO_DURATION){d=this._stateFlow[this._stateIndex+DFSM.OFFSET_DURATION]}}}return d};a.prototype.StateMachineUpdateState=function(){var n=this.IsAnimOver();var i=this._stateDuration;var o=false;if(this._stateIndex<0||this._stateFlow==null){this.StateMachineCustomizedUpdate(false);return}if(i>=0||this._stateDuration<=DFSM.DURATION_SPECIAL_START||this._stateDuration==DFSM.DURATION_ENDLESS){this._stateElapsedTime+=CGame._frameDT}else{if(n&&this._stateDuration>DFSM.DURATION_SPECIAL_START){this._stateElapsedTime--}}if(n){if((this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&DFSM.SF_ANIM_NO_LOOP)==0){this.StateMachineResetAnim(0,false)}}if((this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&DFSM.SF_DURATION_NEXT_FRAME)!=0){o=this._stateDuration!=s_game_currentFrameNB}else{if(i==DFSM.DURATION_ANIM_OVER){o=n}else{if(i!=DFSM.DURATION_ENDLESS&&this._stateDuration>DFSM.DURATION_SPECIAL_START){if(i>=0){if(this._stateElapsedTime>=i){o=true;if((this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&DFSM.SF_END_AT_ANIMATION_OVER)!=0){o=n}}}else{if(this._stateElapsedTime<=i){o=true}}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_COLLIDE_HERO){if(this.IntersectEntity(a._hero)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_NOT_COLLIDE_HERO){if(!this.IntersectEntity(a._hero)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_IN_CAMERA){if(this.IntersectEntity(a._camera)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_OUT_CAMERA){if(!this.IntersectEntity(a._camera)&&(this._vX!=0||this._vY!=0)&&!Math_SameSign(this._vX-a._camera._vX,(a._camera._posX+DEF.VIEW_W_D2_FLOAT)-this._posX)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_VY_NOT_NEGATIVE){if(this._vY>=0){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_IN_SCREEN){if(a.InScreenM2(this._posX,this._posY)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_OUT_SCREEN){if(!a.InScreenM2(this._posX,this._posY)){o=true}}else{if(this._stateDuration==DFSM.DURATION_UNTIL_HERO_NOT_STAND_ON){if(a._hero._phyStandOn!=this._id){o=true}}}}}}}}}}}}var d=this._stateIndex;var m=this._stateSequence;var h=this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS];if((h&DFSM.SF_NO_UPDATE_CALLBACK)==0){var e=this.StateMachineCustomizedUpdate(o);if(d!=this._stateIndex||e==DFSM.SMCR_BREAK){return}if(e==DFSM.SMCR_NO_OVER){o=false}else{if(e==DFSM.SMCR_OVER){o=true}else{if(e!=DFSM.SMCR_DEFAULT){this._nextFullState=e;o=true}}}}if((h&DFSM.SF_CHECK_MOVE_AREA)!=0){var k=(this._params[DParamIndex.MOVE_AREA+2]!=this._params[DParamIndex.MOVE_AREA])&&(this._vX<0&&(this._posX>>DEF.SHIFT)<this._params[DParamIndex.MOVE_AREA]||this._vX>0&&(this._posX>>DEF.SHIFT)>this._params[DParamIndex.MOVE_AREA+2]);if(k){if(this._stateDuration==DFSM.DURATION_UNTIL_OUT_AREA){o=true}else{this.TurnOver();return}}}if(o){if((h&DFSM.SF_FLIP_X)!=0){this.SetFlipX(!this.IsFlipX())}var j=this._stateFlow[this._stateIndex+DFSM.OFFSET_CHANGESTATUS];var l=this._state;var p=false;if(this._stateSequence!=null){p=this.StateMachineGotoNextSequenceState()}else{var s=DFSM.FULLSTATE_NONE;var f=0;if((h&DFSM.SF_GOTO_PRE_STATE)!=0){s=this._preFullState;f|=DFSM.CSTATEF_KEEP_VX|DFSM.CSTATEF_KEEP_VY}p=this.StateMachineGotoNextState(s,f)}if(p){if(l==DFSM.STATE_CHANGESTATUS){if((j&DFSM.CSF_RESET_WHEN_OVER)!=0){var q=0;this.StateMachineModifyStatus(q)}}}}if((h&DFSM.SF_GRAVITY)!=0){if(!this.CheckFlag(DFlags.GRAVITY)){this.AddVY(DAI.GRAVITY);if(this._stateDuration==DFSM.DURATION_UNTIL_VY_NOT_NEGATIVE){if(this._vY>=0){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}}}if((h&DFSM.SF_NO_GRAVITY)!=0){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this.AddVY(DAI.GRAVITY)}else{this.AddVY(-DAI.GRAVITY)}}};a.prototype.StateMachineSetCurrentSequence=function(e,d){this._stateSequence=e;if(e==null){return}this.StateMachineGotoNextSequence(d)};a.prototype.StateMachineGotoNextSequenceState=function(){if(this._nextFullState!=DFSM.FULLSTATE_NONE){return this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}this._curSequenceIndex+=DFSM.SEQUENCE_RECORD_LEN;if(this._curSequenceIndex<this._stateSequence.length){if((this._stateSequence[this._curSequenceIndex]&DFSM.SEQUENCE_START_MASK)!=DFSM.SEQUENCE_START){return this.StateMachineGotoNextState(this._stateSequence[this._curSequenceIndex+DFSM.SEQUENCE_OFFSET_STATE],0)}}return this.StateMachineGotoNextSequence(-1)};a.prototype.StateMachineGotoNextSequence=function(e){var f=-1;var d=this._stateSequence.length;var h=-1;if(e<0){e=this._stateSequence[this._curSequenceHeaderIndex+DFSM.SEQUENCE_HEADER_OFFSET_NEXTID]}if(e==DFSM.SEQUENCE_NEXTID_LOOP){h=this._curSequenceHeaderIndex}else{while(true){f++;if(f>=d){break}if((this._stateSequence[f]&DFSM.SEQUENCE_START_MASK)==DFSM.SEQUENCE_START){var j=this._stateSequence[f]&DFSM.SEQUENCE_ID_MASK;if(j==e){h=f;break}f+=DFSM.SEQUENCE_HEADER_LEN}else{f+=DFSM.SEQUENCE_RECORD_LEN}}}if(h<0){if((!false)){Dbg("Can't found sequence id "+e)}return false}this._curSequenceHeaderIndex=h;this._curSequenceIndex=h+DFSM.SEQUENCE_HEADER_LEN;return this.StateMachineGotoNextState(this._stateSequence[this._curSequenceIndex+DFSM.SEQUENCE_OFFSET_STATE],0)};a._collideDataTemp=LowAPI.Gen_Array([20],0);a._collideDataTempCount=0;a._collideRetryCount=0;a.prototype.PreUpdate=function(){if(this.CheckInActive()){return}if(!this.CheckFlag(DFlags.FIXED)){var d=DAI.GRAVITY;if(this.CheckFlag(DFlags.GRAVITY)){switch(this._classID){case DClassID.HERO:this.ClearFlag(DFlags.OUTSIDE_FORCE);if(a._HeroInWater&&this._state==DState.STATE_ONGROUND){d=0}else{if(this._state==DState.STATE_ONGROUND&&(this._subState==DState.SS_HERO_ROCKCRAFT||this._subState==DState.SS_HERO_ROCKCRAFT_FALL)){d=0}else{if(this._state==DState.STATE_INAIR&&this._subState==DState.SS_INAIR_ABSORB){d=0}else{if(this._state==DState.STATE_SWIM){d=0}else{if(this._state==DState.STATE_INBLACK_HOLE){d=0}else{if(this._state==DState.STATE_INAIR&&(this._subState==DState.SS_SHOOT||this._subState==DState.SS_COMBAT||this._subState==DState.SS_HURT_LIGHTENED||this._subState==DState.SS_HERO_TOXOPHILY||this._subState==DState.SS_HERO_AXE)){d=0}else{if(this._subState==DState.SS_RUN||this._subState==DState.SS_CROUCH||this._subState==DState.SS_CROUCHUP||this._subState==DState.SS_CROUCHDOWN){d=DAI.HERO_RUN_GRAVITY}else{if(this._subState==DState.SS_HERO_IN_FLY_CANNON||this._subState==DState.SS_HERO_NO_HIT_BIG_CRYSTAL||this._subState==DState.SS_HERO_BROKEN_BIG_CRYSTAL||this._subState==DState.SS_HERO_END_MINIGAME){d=0}}}}}}}}if(DEF.dbgEnableCheat){if(a._IsCheating){d=0}}break;case DClassID.BONUS:if(this._subState==DState.SS_BONUS_CRYSTAL_DROPPED||this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE||this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE2){d=DAI.HP_BONUS_DROP_GRAVITY}break;case DClassID.INK_BOMB:if(this._subState!=DState.SS_INKBOMB_FLY_IN&&this._subState!=DState.SS_INKBOMB_FLY_OUT){d=0}else{d=DAI.BOSS_OCTOPUS_INK_BOMB_GRAVITY}break;default:if(this._phyStandOn==-1){d=DAI.DROP_GRAVITY}break}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){d=-d}this.AddVY(d)}this._frameVX=a.GetVelocity(this._vX);this._frameVY=a.GetVelocity(this._vY);if(this.CheckFlag(DFlags.CUSTOM_VELOCITY)){this.CustomVelocityCallback()}if(this.CheckExFlag(DFlags.EX_USE_AFRAME_OX_OY)){this._frameVX+=Math_IntToFixedPoint(this.GetAFramesOX())-this._pos_ox;this._frameVY+=Math_IntToFixedPoint(this.GetAFramesOY())-this._pos_oy}if(a._camCircularScroll){this._frameVX-=a.GetVelocity(a._camScrollVX)}this.UpdateDynamicBox()}};a.prototype.CheckInActive=function(){if(!this.CheckFlag(DFlags.ACTIVE_BY_TRIGGER|DFlags.CENIMATIC)&&!this.CheckExFlag(DFlags.EX_BOSS)){var d=a.NeedActive(this._params,this._posX,this._posY);if(!d){this.SetInactived(false);return true}}return false};a.prototype.CustomVelocityCallback=function(){if(this._classID==DClassID.ROLLING_PLATFORM){this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE]+=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGULAR_VELOCITY];var f=Math_IntToFixedPoint(this._params[DParamIndex.ROLLING_PLATFORM_RADIUS]);var A=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE];for(var w=0;w<4;w++){var C=a.GetEntityByID(this._params[DParamIndex.ROLLING_PLATFORM_PLATFORM1+w],false);if(C!=null){this.GetPositionWithAngle(f,A,this._posX,this._posY);C._frameVX=a._TempIntArray[DParamIndex.POSX]-C._posX;C._frameVY=a._TempIntArray[DParamIndex.POSY]-C._posY-a.GetBoxMiddleY(C._boundingBox);A+=this._tempParams[DTempParamIndex.ROLLING_PLATFORM_ANGLE_STEP]}}}else{if(this._classID==DClassID.TRANSFORM_PLATFORM){var s=this._params[DParamIndex.TRANSFORM_PLATFORM_CLONE_X];if(this._params[DParamIndex.TRANSFORM_PLATFORM_TYPE]==DValueList.TRANSFORM_PLATFORM_TYPE_FLEXIBLE){var p=this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X]-this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]*(s/2);for(var w=0;w<s;w++){var B=a.GetEntityByID(this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_INDEX_START+w],true);if(B!=null){B._frameVX=p-B._posX}p+=this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]}}else{var p=this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X]-this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]*(s/2);var A=this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ANGLE];for(var w=0;w<s;w++){var n=((p-this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_ORIGIN_X])*Math_Sin(A)/Math_Cos(A));n=n+this._posY;var B=a.GetEntityByID(this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_INDEX_START+w],true);if(B!=null){B._frameVY=n-B._posY}p+=this._tempParams[DTempParamIndex.TRANSFORM_PLATFORM_DISTANCE]}}}else{if(this._classID==DClassID.PLATFORM||this._classID==DClassID.TRANSMISSION){var e=DParamIndex.PLATFORM_SATELLITE;if(this._classID==DClassID.TRANSMISSION){e=DParamIndex.TRANSMISSION_SATELLITE}var v=a.GetEntityByID(this._params[e],true);if(v!=null){var m=a.GetVelocity(Math_IntToFixedPoint(v._params[DParamIndex.LIGHTINGBALL_VELOCITY]));if(v.CheckFlag(DFlags.FLIP_X)){m=-m}var h=this._tempParams[DTempParamIndex.PLATFORM_TRANSMISSION_SATELLITE_LOCALITY];var t=this._boundingBox[DEF.BOX_RIGHT]-this._boundingBox[DEF.BOX_LEFT]+Math_IntToFixedPoint(v._params[DParamIndex.LIGHTINGBALL_DISTANCE]<<1);var k=this._boundingBox[DEF.BOX_BOTTOM]-this._boundingBox[DEF.BOX_TOP]+Math_IntToFixedPoint(v._params[DParamIndex.LIGHTINGBALL_DISTANCE]<<1);var q=(t<<1)+(k<<1);this._tempParams[DTempParamIndex.PLATFORM_TRANSMISSION_SATELLITE_LOCALITY]+=m+q;this._tempParams[DTempParamIndex.PLATFORM_TRANSMISSION_SATELLITE_LOCALITY]%=q;var l=0;var j=0;if(h<t){l=this._posX-(t>>1)+h;j=this._posY-(k>>1)}else{if(h<t+k){h-=t;l=this._posX+(t>>1);j=this._posY-(k>>1)+h}else{if(h<t+t+k){h-=t+k;l=this._posX+(t>>1)-h;j=this._posY+(k>>1)}else{if(h<t+t+k+k){h-=t+k+t;l=this._posX-(t>>1);j=this._posY+(k>>1)-h}}}}v._frameVX=l+a.GetBoxMiddleX(this._boundingBox)-v._posX;v._frameVY=j+a.GetBoxMiddleY(this._boundingBox)-v._posY;v.UpdatePosition()}}else{if(this._classID==DClassID.BALANCE){if(this._tempParams[DTempParamIndex.BALANCE_FRAME_ANGLE]!=0){var A=this._tempParams[DTempParamIndex.BALANCE_ANGLE];var r=this._params[DParamIndex.BALANCE_SEGMENT_ID];CGame._segmentAngles[r][0]=A&(Math_AngleMUL-1);this.GetPositionWithAngularVelocity(Math_IntToFixedPoint(-this._params[DParamIndex.BALANCE_RADIUS]),-DAI.BALANCE_HEIGHT,A,0,0);CGame._segments[r][0]=a._TempIntArray[DParamIndex.POSX];CGame._segments[r][1]=a._TempIntArray[DParamIndex.POSY];this.GetPositionWithAngularVelocity(Math_IntToFixedPoint(this._params[DParamIndex.BALANCE_RADIUS]),-DAI.BALANCE_HEIGHT,A,0,0);CGame._segments[r][2]=a._TempIntArray[DParamIndex.POSX];CGame._segments[r][3]=a._TempIntArray[DParamIndex.POSY];this._tempParams[DTempParamIndex.BALANCE_FRAME_ANGLE]=0;this.UpdateBoundingBox()}this._tempParams[DTempParamIndex.BALANCE_FRAME_ANGLE]=this._tempParams[DTempParamIndex.BALANCE_ANGLE];this._tempParams[DTempParamIndex.BALANCE_ANGLE]+=this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY];if(this._tempParams[DTempParamIndex.BALANCE_ANGLE]>=DAI.BALANCE_MAX_ANGLE){this._tempParams[DTempParamIndex.BALANCE_ANGLE]=DAI.BALANCE_MAX_ANGLE;this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY]=0}else{if(this._tempParams[DTempParamIndex.BALANCE_ANGLE]<=-DAI.BALANCE_MAX_ANGLE){this._tempParams[DTempParamIndex.BALANCE_ANGLE]=-DAI.BALANCE_MAX_ANGLE;this._tempParams[DTempParamIndex.BALANCE_ANGULAR_VELOCITY]=0}}var A=this._tempParams[DTempParamIndex.BALANCE_ANGLE];this._tempParams[DTempParamIndex.BALANCE_FRAME_ANGLE]=A-this._tempParams[DTempParamIndex.BALANCE_FRAME_ANGLE]}else{if(this._classID==DClassID.BLACK_HOLE){var d=DParamIndex.BLACK_HOLE_SATELLITE;var z=DTempParamIndex.BLACK_HOLE_SATELLITE_ANGLE;var v=a.GetEntityByID(this._params[d],true);if(v!=null){this._tempParams[z]+=Math_DegreeToFixedPointAngle(v._params[DParamIndex.LIGHTINGBALL_VELOCITY]);var f=Math_IntToFixedPoint(v._params[DParamIndex.LIGHTINGBALL_DISTANCE]);var A=this._tempParams[z];this.GetPositionWithAngle(f,A,this._posX,this._posY);v._frameVX=a._TempIntArray[DParamIndex.POSX]-v._posX;v._frameVY=a._TempIntArray[DParamIndex.POSY]-v._posY;v.UpdatePosition()}}else{if(this._classID==DClassID.LIGHTINGBALL_CENTER){for(var w=0;w<4;w++){var v=a.GetEntityByID(this._params[DParamIndex.LIGHTINGBALL_CENTER_SATELLITE1+w],true);if(v!=null){this._tempParams[DTempParamIndex.LIGHTINGBALL_CENTER_SATELLITE1_ANGLE+w]+=Math_DegreeToFixedPointAngle(v._params[DParamIndex.LIGHTINGBALL_VELOCITY]);var f=Math_IntToFixedPoint(v._params[DParamIndex.LIGHTINGBALL_DISTANCE]);var A=this._tempParams[DTempParamIndex.LIGHTINGBALL_CENTER_SATELLITE1_ANGLE+w];this.GetPositionWithAngle(f,A,this._posX,this._posY);v._frameVX=a._TempIntArray[DParamIndex.POSX]-v._posX;v._frameVY=a._TempIntArray[DParamIndex.POSY]-v._posY;v.UpdatePosition()}}}else{if(this._classID==DClassID.BOSS_WITCH){if(this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY||this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_RUSH){var o=a.root;while(o!=null){if(o._classID==DClassID.MOBS_BEE||o._classID==DClassID.MOBS_FLY){if(o._subState==DState.SS_MOBS_BEE_ON_WITCH_CIRCLE){if(this._subState==DState.SS_BOSS_WITCH_BEE_CIRCLE_FLY){o._tempParams[DTempParamIndex.MOBS_BEE_ANGLE]+=Math_DegreeToFixedPointAngle(DAI.BOSS_WITCH_BEE_CIRCLE_ANGLE_VELOCITY)}this.GetPositionWithAngle(DAI.BOSS_WITCH_BEE_RADIUS,o._tempParams[DTempParamIndex.MOBS_BEE_ANGLE],this._posX,this._posY);o._frameVX=a._TempIntArray[DParamIndex.POSX]-o._posX;o._frameVY=a._TempIntArray[DParamIndex.POSY]-o._posY}}o=o.next}}}else{if(this._classID==DClassID.BONUS){for(var w=0;w<3;w++){if(this._params[DParamIndex.BONUS_SATELLITE1+w]<0){continue}var u=false;if(this._tempParams[DTempParamIndex.BONUS_SATELLITE_FIRST_ACTIVE]<=0){u=true;this._tempParams[DTempParamIndex.BONUS_SATELLITE_FIRST_ACTIVE]=1}var v=a.GetEntityByID(this._params[DParamIndex.BONUS_SATELLITE1+w],u);if(v!=null&&v._state!=DState.STATE_BONUS_GOT_EFFECT){if(v._tempParams[DTempParamIndex.BONUS_SATELLITE_ANGLE]==0){v._tempParams[DTempParamIndex.BONUS_SATELLITE_ANGLE]=Math_Atan(this._posX-v._posX,this._posY-v._posY)}v._tempParams[DTempParamIndex.BONUS_SATELLITE_ANGLE]+=Math_DegreeToFixedPointAngle(v._params[DParamIndex.BONUS_VELOCITY]);var f=Math_IntToFixedPoint(v._params[DParamIndex.BONUS_DISTANCE]);var A=v._tempParams[DTempParamIndex.BONUS_SATELLITE_ANGLE];this.GetPositionWithAngle(f,A,this._posX,this._posY);v._posX=a._TempIntArray[DParamIndex.POSX];v._posY=a._TempIntArray[DParamIndex.POSY]}}}}}}}}}}};a.prototype.SetFlipForReversalGravity=function(d){if(this.CheckFlag(DFlags.FLIP_Y)==d){return}if(d){this.SetPos(this._posX,this._posY+this._boundingBox[DEF.BOX_TOP]);this.SetFlag(DFlags.FLIP_Y)}else{this.SetPos(this._posX,this._posY+this._boundingBox[DEF.BOX_BOTTOM]);this.ClearFlag(DFlags.FLIP_Y)}this.UpdateBoundingBox()};a.CreatePlatformSegment=function(){if(arguments){switch(arguments.length){case 1:return a.CreatePlatformSegment_1.apply(this,arguments);case 2:return a.CreatePlatformSegment_2.apply(this,arguments);case 5:return a.CreatePlatformSegment_5.apply(this,arguments)}}throw new Error("InvalidArguments")};a.CreatePlatformSegment_1=function(d){return a.CreatePlatformSegment(d[DEF.BOX_LEFT],d[DEF.BOX_TOP],d[DEF.BOX_RIGHT],d[DEF.BOX_TOP],-1)};a.CreatePlatformSegment_2=function(e,d){return a.CreatePlatformSegment(e[DEF.BOX_LEFT],e[DEF.BOX_TOP],e[DEF.BOX_RIGHT],e[DEF.BOX_TOP],d)};a.CreatePlatformSegment_5=function(i,h,f,d,j){var e=j;if(e==-1){e=CGame._segmentCount}CGame._segmentParams[e]=DFlags.PHY_BLOCK_UNDERSIDE|DFlags.PHY_SEG_PLATFORM;CGame._segmentAngles[e]=LowAPI.Gen_Array([1],0);CGame._segments[e]=LowAPI.Gen_Array([4],0);CGame._segmentAngles[e][0]=0;CGame._segments[e][0]=i;CGame._segments[e][1]=h;CGame._segments[e][2]=f;CGame._segments[e][3]=d;if(j==-1){return CGame._segmentCount++}else{return j}};a.prototype.SetPhysicsEntityID=function(d){this._phyEntity=d};a.prototype.GetPhysicsEntityID=function(){return this._phyEntity};a.prototype.IsStartDropping=function(){return !a._HeroInWater&&(this._lastPhyStandOn>0&&this._phyStandOn<0)};a.prototype.IsPhysicsChanged=function(){return this._lastPhyStandOn!=this._phyStandOn};a.prototype.SetPhyFlags=function(d){this._phyInfo|=d};a.prototype.SetPhyInfo=function(f,e,d){e=this.TransformEntityCollideFlags(e);if((e&(DFlags.PHY_SEGMENT|DFlags.PHY_ENTITY|DFlags.PHY_PHYFIELD))!=0&&(e&DFlags.PHY_BLOCK_UNDERSIDE)!=0){this._phyStandOn=f;this.SetPhyFlags(e);this.SetPhyInfoLine(d)}if(this._phyStandOn<=0){this.SetPhyFlags(e);this.SetPhyInfoLine(d)}else{this.SetPhyFlags(e&DFlags.PHY_BLOCK_MASK)}this.SetPhysicsEntityID(f)};a.prototype.TransformEntityCollideFlags=function(d){var e=0;if((d&DFlags.PHY_ENTITY)!=0){d&=~DFlags.PHY_COLLIDE_MASK;if((d&DFlags.PHY_BLOCK_TOPSIDE)!=0){d&=~DFlags.PHY_BLOCK_TOPSIDE;e|=DFlags.PHY_BLOCK_UNDERSIDE}if((d&DFlags.PHY_BLOCK_UNDERSIDE)!=0){d&=~DFlags.PHY_BLOCK_UNDERSIDE;e|=DFlags.PHY_BLOCK_TOPSIDE}d&=~DFlags.PHY_COLLIDE_MASK;d|=e}return d};a.prototype.SetPhyInfoLine=function(d){this._phyInfo|=d<<DFlags.PHY_LINE_SHIFT};a.prototype.GetPhyInfoLine=function(){return this._phyInfo>>DFlags.PHY_LINE_SHIFT};a.prototype.PreCollideSegment=function(e,k){var d=false;var l=k._params[DParamIndex.SEGMENT_SEGMENT_ID];var h=CGame._segments[l];var j=(h.length-2)>>1;for(var f=0;f<j;f++){d|=this.PreCollideLine(e,k,f)}return d};a.prototype.PreCollideLine=function(e,f,i){var d=false;if(this.IntersectBoxLine(e,f,i)){var h=DFlags.PHY_SEGMENT|f._id<<DFlags.PHY_ID_SHIFT|i;d=true;if(this.GetPhysicsEntityID()!=f._id){this.AddToCollideData(h);return d}}return d};a.prototype.GetAngleBetweenLine=function(h,f,e){var d=h;if(e==0){if(f>0){if(d>Math_Angle90&&d<Math_Angle270){d+=Math_Angle180}d-=0}else{if(f<0){if(d<Math_Angle90||d>Math_Angle270){d+=Math_Angle180}d-=Math_Angle180}}}if(f==0){if(e>0){if(d>=Math_Angle180){d+=Math_Angle180}d-=0}else{if(e<0){if(d<Math_Angle180){d+=Math_Angle180}d-=Math_Angle180}}}return(d+Math_Angle360)};a.k_segmentOffsetHorizontal=[128,-128,128,-128];a.k_segmentOffsetVertical=[-128,-128,128,128];a.prototype.CollideSegment=function(C,k,o){var w=0;var t=k._params[DParamIndex.SEGMENT_SEGMENT_ID];var L=CGame._segments[t];if(L.length<4){return false}var I=CGame._segmentParams[t];var D=DFlags.PHY_SEGMENT|I&~(DFlags.PHY_BLOCK_TOPUNDER|DFlags.PHY_BLOCK_FRONTBACK);var j=o<<1;var s=L[j];var T=L[j+1];var r=L[j+2];var R=L[j+3];var f=this._frameVX-k._frameVX;var e=this._frameVY-k._frameVY;var B=C._posX;var A=C._posY;var h=C.CheckFlag(DFlags.REVERSAL_GRAVITY);for(var P=0;P<4;P++){var N=P>=2;var x=!N;var G=false;var S=false;var K=(P&1)<<1;var H=3-(P&2);if(h){H=4-H}var v=K==0;var M=!v;if(N){if((I&DFlags.PHY_SEG_PLATFORM)!=0){continue}}B=C._posX+C._boundingBox[K];if(x){A=C._posY+C._boundingBox[H]}else{A=C._posY+C._boundingBox[H]}var p=B+C._frameVX;var n=A+C._frameVY;var J=k._frameVX!=0||k._frameVY!=0;if(J){B+=k._frameVX;A+=k._frameVY}if(k._classID==DClassID.BALANCE){if(P==0){continue}else{B=C._posX;p=B+C._frameVX}}w=Math_SegmentIntersect(s+k._posX,T+k._posY,r+k._posX,R+k._posY,B,A,p,n);if(w==MATH_SEGMENTINTERSECT_DO_INTERSECT){var E=CGame._segmentAngles[k._params[DParamIndex.SEGMENT_SEGMENT_ID]][(j+j+2)>>2]&(Math_AngleMUL-1);var m=Math_DegreeToFixedPointAngle(20);if(N){m=Math_DegreeToFixedPointAngle(40)}if(E>Math_Angle90-m&&E<Math_Angle90+m){G=true}else{if(E>Math_Angle270-m&&E<Math_Angle270+m){G=true}}var F=Math_DegreeToFixedPointAngle(45);if(k._classID==DClassID.BALANCE){F=Math_DegreeToFixedPointAngle(60)}if(C.GetPhysicsEntityID()!=k._id&&E>=Math_Angle90-F&&E<=Math_Angle90+F){S=true}else{if(C.GetPhysicsEntityID()!=k._id&&E>=Math_Angle270-F&&E<=Math_Angle270+F){S=true}}if(G){var q=(B+C._frameVX)-(s_Math_intersectX);var Q=(A+C._frameVY)-(s_Math_intersectY);var u=this.GetAngleBetweenLine(E,0,Q);C._frameVX=(s_Math_intersectX-B)+Math_FixedPoint_Multiply(Q,Math_Cos(u));C._frameVY=(s_Math_intersectY-A)+Math_FixedPoint_Multiply(Q,Math_Sin(u));C._frameVX+=a.k_segmentOffsetHorizontal[P];if(C.IsFlipX()?M:v){D|=DFlags.PHY_BLOCK_BACK}else{D|=DFlags.PHY_BLOCK_FRONT}C.UpdateDynamicBox();if(this.CheckDynamicBoxExpand()){return true}C.NotifyPhysicsEvent(k,DEvent.BLOCKED,D,r-s,R-T,true);C.SetPhyInfo(k._id,D,o)}else{var l=h?e<=0:e>=0;if(k._classID==DClassID.BALANCE){l=e>=-4<<DEF.SHIFT}if((I&DFlags.PHY_SEG_PLATFORM)==0||l){var q=(B+C._frameVX)-(s_Math_intersectX);var Q=(A+C._frameVY)-(s_Math_intersectY);var u=this.GetAngleBetweenLine(E,q,0);if(x){if(h){if(S){var d=DAI.HERO_SLIDE_FACE_GRAVITY;if(k._classID==DClassID.BALANCE){d=DAI.HERO_BALANCE_SLIDE_GRAVITY}q+=Math_FixedPoint_Multiply(-d,Math_Sin(u))}else{if(q>DAI.HERO_BEVEL_FACE_GRAVITY||q<-DAI.HERO_BEVEL_FACE_GRAVITY){q+=Math_FixedPoint_Multiply(-DAI.HERO_BEVEL_FACE_GRAVITY,Math_Sin(u))}}}else{if(S){var d=DAI.HERO_SLIDE_FACE_GRAVITY;if(k._classID==DClassID.BALANCE){d=DAI.HERO_BALANCE_SLIDE_GRAVITY}if(d<C._frameVY){q+=Math_FixedPoint_Multiply(d,Math_Sin(u))}}else{if(q>DAI.HERO_BEVEL_FACE_GRAVITY||q<-DAI.HERO_BEVEL_FACE_GRAVITY){q+=Math_FixedPoint_Multiply(DAI.HERO_BEVEL_FACE_GRAVITY,Math_Sin(u))}}}}else{q=0}var z=(s_Math_intersectX-B)+Math_FixedPoint_Multiply(q,Math_Cos(u));var y=(s_Math_intersectY-A)+Math_FixedPoint_Multiply(q,Math_Sin(u));if(x){D|=DFlags.PHY_BLOCK_UNDERSIDE}else{D|=DFlags.PHY_BLOCK_TOPSIDE}if(h){y-=a.k_segmentOffsetVertical[P]}else{y+=a.k_segmentOffsetVertical[P]}C.UpdateDynamicBox(z,y,false);var O=C.NotifyPhysicsEvent(k,DEvent.BLOCKED,D,r-s,R-T,true);if(O!=DEvent.RESULT_PHY_KEEP_VELOCITY&&O!=DEvent.RESULT_PHY_CANCEL_BLOCK){if(x){if(h){if(this._vY<0){C.SetVY(0)}}else{if(this._vY>0){C.SetVY(0)}}}else{if(h){if(this._vY>0){C.SetVY(0)}}else{if(this._vY<0){C.SetVY(0)}}}}if(O!=DEvent.RESULT_PHY_CANCEL_BLOCK){C._frameVX=z;C._frameVY=y;if(x&&k.CheckExFlag(DFlags.EX_CAN_TRANSPORT)&&C.GetPhysicsEntityID()!=k._id){this.TransportCallback(k)}C.UpdateDynamicBox();C.SetPhyInfo(k._id,D,o);if(k._classID!=DClassID.SEGMENT&&C.IsPhysicsChanged()){k.NotifyPhysicsEvent(C,DEvent.ENTITY_DROP_ON,0,E,0,true)}if(this.CheckDynamicBoxExpand()){return true}}C.UpdateDynamicBox()}}}}return false};a.prototype.CheckDynamicBoxExpand=function(){if(a._collideRetryCount>4){return false}if(this._dynamicBox[DEF.BOX_LEFT]<a._tempBox[DEF.BOX_LEFT]){a._tempBox[DEF.BOX_LEFT]=this._dynamicBox[DEF.BOX_LEFT];return true}else{if(this._dynamicBox[DEF.BOX_RIGHT]>a._tempBox[DEF.BOX_RIGHT]){a._tempBox[DEF.BOX_RIGHT]=this._dynamicBox[DEF.BOX_RIGHT];return true}else{if(this._dynamicBox[DEF.BOX_TOP]<a._tempBox[DEF.BOX_TOP]){a._tempBox[DEF.BOX_TOP]=this._dynamicBox[DEF.BOX_TOP];return true}else{if(this._dynamicBox[DEF.BOX_BOTTOM]>a._tempBox[DEF.BOX_BOTTOM]){a._tempBox[DEF.BOX_BOTTOM]=this._dynamicBox[DEF.BOX_BOTTOM];return true}}}}return false};a.prototype.TransportCallback=function(d){if(d._classID==DClassID.TRANSMISSION){var n=a.GetVelocity(d._params[DParamIndex.TRANSMISSION_VX]<<DEF.SHIFT);this._frameVX+=a.GetVelocity(n)}else{if(d._classID==DClassID.BALANCE){var h=d._params[DParamIndex.BALANCE_SEGMENT_ID];var j=d._tempParams[DTempParamIndex.BALANCE_ANGLE];this.GetPositionWithAngularVelocity(Math_IntToFixedPoint(-d._params[DParamIndex.BALANCE_RADIUS]),-DAI.BALANCE_HEIGHT,j,0,0);var i=a._TempIntArray[DParamIndex.POSX];var m=a._TempIntArray[DParamIndex.POSY];this.GetPositionWithAngularVelocity(Math_IntToFixedPoint(d._params[DParamIndex.BALANCE_RADIUS]),-DAI.BALANCE_HEIGHT,j,0,0);var f=a._TempIntArray[DParamIndex.POSX];var l=a._TempIntArray[DParamIndex.POSY];var p=f-i;var o=l-m;var e=((this._posX+this._frameVX-d._posX)*o/p)+(d._posY-Math_FixedPoint_Divide(DAI.BALANCE_HEIGHT,Math_Sin(Math_Angle90-j)));this._frameVY=e-this._posY-128}else{this._frameVX+=d._frameVX;if(d.CheckExFlag(DFlags.EX_SEGMENT)){this._frameVY+=d._frameVY}if(this._classID==DClassID.MOBS_WHITE&&this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_BLOW){var k=a.GetEntityByID(this._params[DParamIndex.MOBS_WHITE_DROP1],true);if(k!=null){k.SetPos(this._posX,this._posY);k._frameVX=this._frameVX;k._frameVY=this._frameVY}}}}this.SetFlag(DFlags.OUTSIDE_FORCE)};a.PixelToTileW=function(d){if(GLLibConfig.tileset_useTileShift){return d>>DEF.TILE_W_SHIFT}else{if(d<0){return(d/DEF.TILE_W).castToInt()-1}else{return(d/DEF.TILE_W).castToInt()}}};a.PixelToTileH=function(d){if(GLLibConfig.tileset_useTileShift){return d>>DEF.TILE_H_SHIFT}else{if(d<0){return(d/DEF.TILE_H).castToInt()-1}else{return(d/DEF.TILE_H).castToInt()}}};a.prototype.CheckAheadBlock=function(t,r){var s=(t>=0)?DEF.BOX_RIGHT:DEF.BOX_LEFT;var m=(r>=0)?DEF.BOX_BOTTOM:DEF.BOX_TOP;System.arraycopy(this._boundingBox,0,a._tempBox,0,4);a._tempBox[0]+=this._posX;a._tempBox[1]+=this._posY;a._tempBox[2]+=this._posX;a._tempBox[3]+=this._posY;if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){m=4-m;r=-r}if(t!=0){a._tempBox[2-s]=a._tempBox[s];a._tempBox[s]=a._tempBox[s]+t}if(r!=0){a._tempBox[4-m]=a._tempBox[m];a._tempBox[m]=a._tempBox[m]+r}var k=a.root;while(k!=null&&k._zOrderAI<Z.DEFAULT_NORMAL_AI){if(k.CheckExFlag(DFlags.EX_SEGMENT)){var f=k._params[DParamIndex.SEGMENT_SEGMENT_ID];var l=CGame._segmentParams[f];if((l&DFlags.PHY_SEG_PLATFORM)==0){var q=CGame._segments[f];var j=(q.length-2)>>1;for(var h=0;h<j;h++){var p=h<<1;var e=k._posX+q[p];var o=k._posY+q[p+1];var d=k._posX+q[p+2];var n=k._posY+q[p+3];if(a.LineClipping(e,o,d,n,a._tempBox)){return true}}}}k=k.next}return false};a.CheckSegmentBlock=function(w,f,v,e,x,d){var y=a.root;var p=false;var j=0;var h=0;while(y!=null&&y._zOrderAI<Z.DEFAULT_NORMAL_AI){if(y.CheckExFlag(DFlags.EX_SEGMENT)){var l=y._params[DParamIndex.SEGMENT_SEGMENT_ID];var s=CGame._segments[l];var k=(s.length-2)>>1;for(var u=0;u<k;u++){if(s.length<4){continue}if(d&&(CGame._segmentParams[l]&(DFlags.PHY_SEG_WATER_SURFACE|DFlags.PHY_SEG_RAIN_BLOCK|DFlags.PHY_SEG_PLATFORM))==0){continue}if(x&&(CGame._segmentParams[l]&DFlags.PHY_SEG_PLATFORM)!=0){continue}var q=u<<1;var n=s[q];var t=s[q+1];var m=s[q+2];var r=s[q+3];var o=Math_SegmentIntersect(n+y._posX,t+y._posY,m+y._posX,r+y._posY,w,f,v,e);if(o==MATH_SEGMENTINTERSECT_DO_INTERSECT){if(!x){if(p){if(h>s_Math_intersectY){j=s_Math_intersectX;h=s_Math_intersectY}}else{j=s_Math_intersectX;h=s_Math_intersectY}p=true}else{return true}}}}y=y.next}a._TempIntArray[DParamIndex.POSX]=j;a._TempIntArray[DParamIndex.POSY]=h;return p};a.CheckRayBlock=function(e,h,d,f){return a.CheckSegmentBlock(e,h,d,f,false,false)};a.CheckSightBlock=function(e,h,d,f){return a.CheckSegmentBlock(e,h,d,f,true,false)};a.CheckRainBlock=function(e,h,d,f){return a.CheckSegmentBlock(e,h,d,f,false,true)};a.k_tileOffset=[1,1,0,0];a.k_blockPixelOffset=[1,1,-1,-1];a.prototype.CollidePhyfield=function(v){var z=0;var h,f;var k,i;k=(this._frameVX>=0)?DEF.BOX_RIGHT:DEF.BOX_LEFT;i=(this._frameVY>=0)?DEF.BOX_BOTTOM:DEF.BOX_TOP;if(this._frameVX==0&&this.IsFlipX()){k=0}h=k>>1;f=i>>1;var C,n,B,m,x,j;C=Math_FixedPointToInt(this._posX+this._boundingBox[k]-(a.k_blockPixelOffset[k]*127))-h;n=Math_FixedPointToInt(this._posY+this._boundingBox[i]-(a.k_blockPixelOffset[i]*127))-f;B=Math_FixedPointToInt(this._posX+this._boundingBox[2-k]-(a.k_blockPixelOffset[2-k]*127))-1+h;m=Math_FixedPointToInt(this._posY+this._boundingBox[4-i]-(a.k_blockPixelOffset[4-i]*127))-1+f;x=Math_FixedPointToInt(this._dynamicBox[k]-(a.k_blockPixelOffset[k]*127))-h;j=Math_FixedPointToInt(this._dynamicBox[i]-(a.k_blockPixelOffset[i]*127))-f;C=a.PixelToTileW(C);B=a.PixelToTileW(B);x=a.PixelToTileW(x);n=a.PixelToTileH(n);m=a.PixelToTileH(m);j=a.PixelToTileH(j);h=k-1;f=i-2;var s,w;var r;var u;var A=-1;var q=this._frameVX;var p=this._frameVY;var d,e;d=(n==j);s=d?(C+h):B;x+=h;j+=f;if((x-s)*h<0){h=-h}var l=0;while(s!=x){if(!d){d=(s==C+h)}e=!d;w=d?m:(n+f);while(w!=j){l++;if(!e){e=(w==n+f)}r=a.GetPhyByTile(s,w);var o=r==DEF.PHY_DESTORY;if(CGame._worldId==DAI.WORLD_ID_CAKE){o=r>=DEF.PHY_DESTORY&&r<DEF.PHY_CAKE_DESTORY}if(e&&o){A=w;z|=1<<(i);var t=this._frameVY;if(GLLibConfig.tileset_useTileShift){p=Math_IntToFixedPoint(((w+a.k_tileOffset[i])<<DEF.TILE_H_SHIFT)+a.k_blockPixelOffset[i])}else{p=Math_IntToFixedPoint(((w+a.k_tileOffset[i])*DEF.TILE_H)+a.k_blockPixelOffset[i])}p-=this._posY+this._boundingBox[i];j=w+f;break}else{if(d&&o){z|=1<<(k);if(GLLibConfig.tileset_useTileShift){q=Math_IntToFixedPoint(((s+a.k_tileOffset[k])<<DEF.TILE_W_SHIFT)+a.k_blockPixelOffset[k])}else{q=Math_IntToFixedPoint(((s+a.k_tileOffset[k])*DEF.TILE_W)+a.k_blockPixelOffset[k])}q-=this._posX+this._boundingBox[k];s=x-h;break}}w+=f;if(l>100){break}}s+=h;if(l>100){break}}if(z!=0){this.UpdateDynamicBox(q,p,false);var y=this.NotifyPhysicsEvent(v,DEvent.BLOCKED,z|DFlags.PHY_PHYFIELD,0,0,true);if(y!=DEvent.RESULT_PHY_CANCEL_BLOCK){this._frameVX=q;this._frameVY=p}this.UpdateDynamicBox();if((z&DFlags.PHY_BLOCK_TOPUNDER)!=0){if(y!=DEvent.RESULT_PHY_KEEP_VELOCITY&&y!=DEvent.RESULT_PHY_CANCEL_BLOCK){this.SetVY(0)}}this.SetPhyInfo(v._id,DFlags.PHY_PHYFIELD|z,0)}return false};a.destoryTileData=[-1,0,0,-1,1,0,0,1];a.destoryTileTable=[4,256+8,7,256+5,8,1,5,6,512+7,768+5,0,256+2,512+5,512+6,2,3];a.DestroyPhyfield=function(o,m,p){var u=false;var h,t,d,s;if(p[2]-p[0]==0){return}if(p[3]-p[1]==0){return}h=Math_FixedPointToInt(p[0]-127);t=Math_FixedPointToInt(p[1]-127);d=Math_FixedPointToInt(p[2]+127);s=Math_FixedPointToInt(p[3]+127);h=a.PixelToTileW(h);t=a.PixelToTileH(t);d=a.PixelToTileW(d);s=a.PixelToTileH(s);for(var n=t;n<=s;n++){for(var l=h;l<=d;l++){var r=a.GetPhyByTile(l,n);var f=r==DEF.PHY_DESTORY;if(CGame._worldId==DAI.WORLD_ID_CAKE){f=r>=0&&r<DEF.PHY_CAKE_DESTORY}if(f){a.SetPhyByTile(l,n,-1);if(GLLibConfig.tileset_useTileShift){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_EFFECT_COOKIE,0,Math_IntToFixedPoint(l<<DEF.TILE_W_SHIFT),Math_IntToFixedPoint(n<<DEF.TILE_H_SHIFT))}else{a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_EFFECT_COOKIE,0,Math_IntToFixedPoint(l*DEF.TILE_W),Math_IntToFixedPoint(n*DEF.TILE_H))}u=true}}}if(CGame._worldId==DAI.WORLD_ID_CAKE){--t;++s;--h;++d;for(var n=t;n<=s;n++){for(var l=h;l<=d;l++){var r=a.GetPhyByTile(l,n);if(r<0||r>=DEF.PHY_CAKE_DESTORY){continue}var q=0;for(var e=0;e<4;e++){r=a.GetPhyByTile(l+a.destoryTileData[e<<1],n+a.destoryTileData[(e<<1)+1]);if(r>=0&&r<DEF.PHY_CAKE_DESTORY){q|=1<<e}}a.SetPhyByTile(l,n,a.destoryTileTable[q]&255);a.SetPhyFlipByTile(l,n,(a.destoryTileTable[q]>>DEF.SHIFT)&255)}}}if(u){CGame.PlaySound(DSound_Channel.SFX,DATA.SOUND_BREAK_BLOCK)}};a.SetPhyFlipByTile=function(e,d,f){CGame._topLayerFlip[d*CGame._mapTileCountWidth+e]=f};a.SetPhyByTile=function(f,d,e){if(GLLibConfig.tileset_useIndexAsShort){Mem_SetShort(CGame._topLayerData,(d*CGame._mapTileCountWidth+f)<<1,e)}else{Mem_SetByte(CGame._topLayerData,(d*CGame._mapTileCountWidth+f),e)}};a.GetPhyByTile=function(f,d){if((f<0)||(f>=CGame._mapTileCountWidth)){return DEF.PHY_OUTMAP}else{if((d<0)||(d>=CGame._mapTileCountHeight)){return DEF.PHY_OUTMAP}}var e;if(GLLibConfig.tileset_useIndexAsShort){e=Mem_GetShort(CGame._topLayerData,(d*CGame._mapTileCountWidth+f)<<1)}else{e=Mem_GetByte(CGame._topLayerData,(d*CGame._mapTileCountWidth+f))}return e};a.prototype.CollideEntityMultiBox=function(h,m,d){var o=true;var p=false;h.ClearFlag(DFlags.MULTI_BOUNDING_BOX);var k=h.GetFrameRectCount(-1,-1);var f=LowAPI.Gen_Array([4],0);for(var e=2;e<k;e++){if(e!=2&&h.CheckFlag(DFlags.BE_ATTACK_COMPUTE)){o=false}var l=h._frameVX;var j=h._frameVY;h.GetFrameRect(f,e,h._tempParams[DTempParamIndex.LAST_ANIMATION],h._tempParams[DTempParamIndex.LAST_FRAME]);h.GetFrameRect(h._boundingBox,e,-1,-1);if(h.IsFlipX()){var n=h._boundingBox[DEF.BOX_LEFT];h._boundingBox[DEF.BOX_LEFT]=-h._boundingBox[DEF.BOX_RIGHT];h._boundingBox[DEF.BOX_RIGHT]=-n;n=f[DEF.BOX_LEFT];f[DEF.BOX_LEFT]=-f[DEF.BOX_RIGHT];f[DEF.BOX_RIGHT]=-n}h._frameVX+=a.GetBoxMiddleX(h._boundingBox)-a.GetBoxMiddleX(f);h._frameVY+=a.GetBoxMiddleY(h._boundingBox)-a.GetBoxMiddleY(f);h.UpdateDynamicBox();if(a.IntersectBox(this._dynamicBox,h._dynamicBox)){p|=this.CollideEntity(h,m,d,o)}h._frameVX=l;h._frameVY=j}h.UpdateBoundingBox();h.UpdateDynamicBox();h.SetFlag(DFlags.MULTI_BOUNDING_BOX);return p};a.prototype.CollideEntity=function(j,o,f,n){if(j.CheckFlag(DFlags.MULTI_BOUNDING_BOX)){return this.CollideEntityMultiBox(j,o,f)}var t=this._frameVX-j._frameVX;var p=this._frameVY-j._frameVY;var i=0;var h=0;var e=0;var s,m;s=(t>=0)?DEF.BOX_RIGHT:DEF.BOX_LEFT;m=(p>=0)?DEF.BOX_BOTTOM:DEF.BOX_TOP;if(p!=0&&(o&DFlags.PHY_BLOCK_TOPUNDER|DFlags.PHY_COLLIDE_TOPUNDER)!=0){if(f){h=j._dynamicBox[4-m]-(this._posY+this._boundingBox[m])+a.k_blockPixelOffset[m]}else{h=(j._posY+j._boundingBox[m]+j._frameVY)-(this._posY+this._boundingBox[m])}if(Math.abs(p)>=Math.abs(h)||Math.abs(j._frameVY)>=Math.abs(h)){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)||!f){if(p<=0){e|=DFlags.PHY_COLLIDE_TOPSIDE|DFlags.PHY_BLOCK_TOPSIDE}else{e|=DFlags.PHY_COLLIDE_UNDERSIDE|DFlags.PHY_BLOCK_UNDERSIDE}}else{if(p>=0){e|=DFlags.PHY_COLLIDE_TOPSIDE|DFlags.PHY_BLOCK_TOPSIDE}else{e|=DFlags.PHY_COLLIDE_UNDERSIDE|DFlags.PHY_BLOCK_UNDERSIDE}}}}if(t!=0&&(o&DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_COLLIDE_FRONTBACK)!=0){if(f){i=j._dynamicBox[2-s]-(this._posX+this._boundingBox[s])+a.k_blockPixelOffset[s]}else{i=(j._posX+j._boundingBox[s]+j._frameVX)-(this._posX+this._boundingBox[s])}var q=false;if(f){if(Math.abs(t)>=Math.abs(i)||Math.abs(j._frameVX)>=Math.abs(i)){q=true}else{if((e&DFlags.PHY_BLOCK_TOPUNDER)==0){if(Math_SameSign(this._posX-j._posX,i)){q=true}}}}else{if(Math.abs(t)>=Math.abs(i)||Math.abs(j._frameVX)>=Math.abs(i)){q=true}else{q=false}}if(q){if(f){if(j.CheckFlag(DFlags.FLIP_X)?s==DEF.BOX_LEFT:s==DEF.BOX_RIGHT){e|=DFlags.PHY_COLLIDE_BACK|DFlags.PHY_BLOCK_BACK}else{e|=DFlags.PHY_COLLIDE_FRONT|DFlags.PHY_BLOCK_FRONT}}else{if(s==DEF.BOX_LEFT){e|=DFlags.PHY_COLLIDE_BACK|DFlags.PHY_BLOCK_BACK}else{e|=DFlags.PHY_COLLIDE_FRONT|DFlags.PHY_BLOCK_FRONT}}}}e=o&e;if((e&DFlags.PHY_BLOCK_MASK)!=0){var l=this._frameVX;var k=this._frameVY;if((e&DFlags.PHY_BLOCK_TOPUNDER)!=0){k=h}else{if((e&DFlags.PHY_BLOCK_FRONTBACK)!=0){l=i}}this.UpdateDynamicBox(l,k,false);if(this.CheckDynamicBoxExpand()){return true}if((e&DFlags.PHY_BLOCK_FRONTBACK)!=0){e&=~DFlags.PHY_BLOCK_FRONTBACK;if(this.IsFlipX()?s==DEF.BOX_RIGHT:s==DEF.BOX_LEFT){e|=DFlags.PHY_BLOCK_BACK}else{e|=DFlags.PHY_BLOCK_FRONT}}var d=this.NotifyPhysicsEvent(j,DEvent.BLOCKED_BY_ENTITY,DFlags.PHY_ENTITY|e,0,0,n);if(d!=DEvent.RESULT_PHY_CANCEL_BLOCK){this._frameVX=l;this._frameVY=k;if(d!=DEvent.RESULT_PHY_KEEP_VELOCITY){if((e&DFlags.PHY_BLOCK_TOPUNDER)!=0){this.SetVY(0)}}if((e&DFlags.PHY_BLOCK_TOPSIDE)!=0){if(j.CheckExFlag(DFlags.EX_CAN_TRANSPORT)){this.TransportCallback(j);this.UpdateDynamicBox();if(this.CheckDynamicBoxExpand()){this.SetPhyInfo(j._id,DFlags.PHY_ENTITY|(e),0);return true}}}this.SetPhyInfo(j._id,DFlags.PHY_ENTITY|(e),0)}this.UpdateDynamicBox()}else{if((e&DFlags.PHY_COLLIDE_MASK)!=0||(o&DFlags.PHY_COLLIDE_MASK)!=0){this.NotifyPhysicsEvent(j,DEvent.COLLIDE_ENTITY,DFlags.PHY_ENTITY|e,0,0,n)}}return false};a.prototype.PreCollide=function(i,h,j){var e=false;if(i._classID!=DClassID.CAMERA){e=a.IntersectBox(this._dynamicBox,i._dynamicBox)}else{e=!a.InBox(this._dynamicBox,i._dynamicBox)}if(e){if(i.CheckExFlag(DFlags.EX_SEGMENT)){var f=null;var d=null;if(this.CheckExFlag(DFlags.EX_SEGMENT)){f=this;d=i}else{d=this;f=i}if(j==-1){return this.PreCollideSegment(d._dynamicBox,f)}else{return this.PreCollideLine(d._dynamicBox,f,j)}}else{if(i._classID==DClassID.PHYFIELD){this.AddToCollideData(DFlags.PHY_PHYFIELD|(i._id<<DFlags.PHY_ID_SHIFT));return true}else{this.AddToCollideData(DFlags.PHY_ENTITY|(i._id<<DFlags.PHY_ID_SHIFT)|h);return true}}}return false};a.HeroDropToGround=function(){if(a.CheckSegmentBlock(a._hero._posX,a._hero._posY,a._hero._posX,a._hero._posY+DAI.FRAME_GRAVITY,false,false)){a._hero.SetPos(a._hero._posX,a._TempIntArray[DParamIndex.POSY])}};a.prototype.IntersectBoxLine=function(h,i,p){var f=i._params[DParamIndex.SEGMENT_SEGMENT_ID];var j=CGame._segmentParams[f];var n=CGame._segments[f];var m=p<<1;if(m+4>n.length){return false}var e=i._posX+n[m];var l=i._posY+n[m+1];var d=i._posX+n[m+2];var k=i._posY+n[m+3];if(i._frameVX>=0){d+=i._frameVX}else{e+=i._frameVX}if(i._frameVY>=0){k+=i._frameVY}else{l+=i._frameVY}if(e>d){var o=d;d=e;e=o}if(l>k){var o=k;k=l;l=o}return a.IntersectBoxLine(h,e,l,d,k)};a.IntersectBoxLine=function(i,e,h,d,f){if(i[2]<e){return false}if(i[0]>d){return false}if(i[3]<h){return false}if(i[1]>f){return false}return true};a.prototype.CollideDetect=function(){var e;if(this._lastPhyEntity>0){e=a.GetEntityByID(this._lastPhyEntity,false);if(e!=null){var d=this.CanCollide(e);if(d!=0&&e!=this&&this.PreCollide(e,d,this._lastLineIndex)){}}}e=a.root;while(e!=null&&e._zOrderAI<=Z.DEFAULT_COLLIDED_HERO_AI){var d=this.CanCollide(e);if(d!=0&&e!=this&&this.PreCollide(e,d,-1)){}e=e.next}};a.prototype.CollideResetPhyInfo=function(){a._collideDataTempCount=0;this._lastPhyEntity=this.GetPhysicsEntityID();this._lastLineIndex=this.GetPhyInfoLine();this._lastPhyInfo=this._phyInfo;this._lastPhyStandOn=this._phyStandOn;this._phyInfo=0;this._phyEntity=-1;this._phyStandOn=-1};a.prototype.AddToCollideData=function(e){for(var d=a._collideDataTempCount-1;d>=0;d--){if(a._collideDataTemp[d]==e){return}}a._collideDataTemp[a._collideDataTempCount++]=e};a.prototype.CollideCompute=function(){var l;var e=1;var h=0;for(var k=0;k<2;k++){while(h>=0&&h<a._collideDataTempCount){var d=a._collideDataTemp[h]>>DFlags.PHY_ID_SHIFT;var m=a._collideDataTemp[h]&65535;l=a.GetEntityByID(d,false);if(l==null){h+=e;continue}var n=this.GetPhysicsEntityID();var p=false;var f=true;if(l._classID!=DClassID.CAMERA){p=a.IntersectBox(this._dynamicBox,l._dynamicBox)}else{p=!a.InBox(this._dynamicBox,l._dynamicBox);f=false}if(p){if((m&DFlags.PHY_SEGMENT)!=0){var o=(a._collideDataTemp[h]&31);if(this.CollideSegment(this,l,o)){return true}}else{if((m&DFlags.PHY_PHYFIELD)!=0){this.CollidePhyfield(l)}else{if((m&DFlags.PHY_ENTITY)!=0){if(this.CollideEntity(l,m,f,true)){return true}}}}}h+=e}h-=1;e*=-1}return false};a.prototype.CanBeAttack=function(f,e){var h=f._subState;var d=f._classID;if(this._classID==DClassID.HERO){if((f._exFlags&DFlags.EX_ATTACK_HERO_WHEN_COLLIDE)!=0){return true}else{if(d==DClassID.INK_BOMB){if(h==DState.SS_INKBOMB_FLY_IN){return true}}else{if(d==DClassID.CANNONBALL){if(h==DState.SS_CANNONBALL_FLY){return true}}else{if(d==DClassID.STONE){return h!=DState.SS_DISAPPEAR&&h!=DState.SS_DISAPPEARING}else{if(d==DClassID.MOBS_MONSTERINCHEST){if(h==DState.SS_MONSTERINCHEST_JUMP||h==DState.SS_MONSTERINCHEST_INAIR||h==DState.SS_MONSTERINCHEST_FALL){return true}}else{if(d==DClassID.MOBS_DANDELIONBOMB){if(h!=DState.SS_DANDELION_STONE_IN&&h!=DState.SS_DANDELION_STONE_BLOCKED&&h!=DState.SS_DANDELION_BE_WEAK&&h!=DState.SS_DANDELION_WEAKING){return true}}else{if(f.CheckExFlag(DFlags.EX_ENEMY)){if(!f.CheckExFlag(DFlags.EX_CAN_STANDON)){if((e&DFlags.PHY_ENTITY)!=0){return true}}}}}}}}}}return false};a.prototype.CanCollide=function(d){if(this._classID==DClassID.BULLET&&(this.CheckFlag(DFlags.INVISIBLE)||this._subState==DState.SS_BULLET_CLOSE_AXE||this._subState==DState.SS_BULLET_CLOSE_RUN)){return 0}if(this.CheckExFlag(DFlags.EX_SEGMENT)){return 0}if(this.CheckFlag(DFlags.COLLIDING_WITH_SEGMENT)&&d._classID==DClassID.PHYFIELD){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_UNDERSIDE}if(this._classID==DClassID.BULLET){if(d.CheckFlag(DFlags.COLLIDING_WITH_HERO)&&d.CheckExFlag(DFlags.EX_ENEMY)){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE}if(d._classID==DClassID.CANNON){return DFlags.PHY_BLOCK_FRONT}if(d._classID==DClassID.CANNONBALL||d._classID==DClassID.TRACE_CANNON_BALL){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE}if(d.CheckExFlag(DFlags.EX_BOSS)){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE}if(d._classID==DClassID.HERO&&(this._subState==DState.SS_ARROW_ONWALL||this._subState==DState.SS_ARROW_DISAPPEAR)){return DFlags.PHY_COLLIDE_UNDERSIDE}if(d._classID==DClassID.RANDOMBONUS&&d._subState==DState.SS_RANDOMBONUS_B_IDLE){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_UNDERSIDE}}else{if(this._classID==DClassID.MOBS_UFO){if(d._classID==DClassID.HIT_BONUS){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}}}if(d._classID==DClassID.STONE||d._classID==DClassID.OBJ_DAMAGE_STONE||d._classID==DClassID.MOBS_UFO){if(d._subState==DState.SS_DISAPPEAR||d._subState==DState.SS_DISAPPEARING){return 0}if(this._subState==DState.SS_DISAPPEAR||this._subState==DState.SS_DISAPPEARING){return 0}if(this._classID==DClassID.STONE&&d._classID==DClassID.STONE){if(this._vX!=0){return 0}else{return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}}else{if(this._classID==DClassID.HERO&&d._classID==DClassID.STONE){if(d._phyStandOn!=-1){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}else{return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPSIDE}}else{if(this._classID==DClassID.MOBS_FLY||this._classID==DClassID.MOBS_BEE||this._classID==DClassID.HIT_BONUS){return 0}else{if(this.CheckExFlag(DFlags.EX_ENEMY)||this._classID==DClassID.MOBS_BARREL){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}else{if(this.CheckFlag(DFlags.GRAVITY)&&(this._classID==DClassID.STONE||this._classID==DClassID.JELLY||this._classID==DClassID.LEAF||this._classID==DClassID.BONUS||this._classID==DClassID.TRACE_CANNON_BALL||this._classID==DClassID.CANNONBALL)){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}else{if(this._classID==DClassID.MOBS_DANDELIONBOMB&&(this._subState==DState.SS_DANDELION_BLOW||this._subState==DState.SS_DANDELION_IDLE)){return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_TOPUNDER}}}}}}}if(this._classID==DClassID.HERO&&d.CheckFlag(DFlags.COLLIDING_WITH_HERO)){return d._phyFlags}if(this._classID==DClassID.EXPLOSION){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER}if(this._classID==DClassID.CANNONBALL||this._classID==DClassID.TRACE_CANNON_BALL){if(d._subState==DState.SS_DISAPPEAR||d._subState==DState.SS_DISAPPEARING){return 0}else{if(d._classID==DClassID.MOBS_FLY||d._classID==DClassID.MOBS_BEE){return 0}else{if(d.CheckExFlag(DFlags.EX_ENEMY)||d._classID==DClassID.MOBS_BARREL){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER}else{if(d._classID==DClassID.STONE||d._classID==DClassID.OBJ_DAMAGE_STONE){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER}else{if(d._classID==DClassID.MOBS_DANDELIONBOMB&&(d._subState==DState.SS_DANDELION_BLOW||d._subState==DState.SS_DANDELION_IDLE)){return DFlags.PHY_COLLIDE_FRONTBACK|DFlags.PHY_COLLIDE_TOPUNDER}}}}}}if(this._classID==DClassID.BONUS){if(!this.CheckFlag(DFlags.GRAVITY)){if(this._subState!=DState.SS_BONUS_FISH_2){return 0}}}if(this._classID==DClassID.BOSS_OCTOPUS_TENTACLE){if(d._classID==DClassID.MOBS_WHITE){if(d._subState==DState.SS_DISAPPEAR||d._subState==DState.SS_DROP_OUT){return 0}else{return d._phyFlags}}}if(d._classID==DClassID.BULLET&&(d._subState==DState.SS_ARROW_ONWALL||d._subState==DState.SS_ARROW_ONWALL_SHAKE||d._subState==DState.SS_ARROW_DISAPPEAR||d._subState==DState.SS_ARROW_DISAPPEAR_SHAKE)){return DFlags.PHY_BLOCK_TOPSIDE}if(this.CheckFlag(DFlags.COLLIDING_WITH_SEGMENT)&&d.CheckExFlag(DFlags.EX_SEGMENT)){var e=d._params[DParamIndex.SEGMENT_SEGMENT_ID];if((CGame._segmentParams[e]&DFlags.PHY_SEG_WATER_SURFACE)!=0){if(this._classID==DClassID.BONUS&&this._subState!=DState.SS_BONUS_FISH_2){return 0}}return DFlags.PHY_BLOCK_FRONTBACK|DFlags.PHY_BLOCK_UNDERSIDE}return 0};a.prototype.NotifyPhysicsEvent=function(r,l,f,e,d,p){var k=DEvent.RESULT_OK;if(l==DEvent.BLOCKED&&r._classID==DClassID.BALANCE){r.NotifyEvent(this,DEvent.ENTITY_DROP_ON,f,e,d)}if(this._classID==DClassID.TRACE_CANNON_BALL){if(this._subState==DState.SS_CANNONBALL_FLY){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_CANNONBALL_EXPLODE,0);return DEvent.RESULT_OK}else{if(this._subState==DState.SS_CANNONBALL_START_FLY){return DEvent.RESULT_PHY_CANCEL_BLOCK}}}else{if(r._classID==DClassID.TRACE_CANNON_BALL){if(r._subState==DState.SS_CANNONBALL_FLY||r._subState==DState.SS_CANNONBALL_START_FLY){r.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_CANNONBALL_EXPLODE,0)}return k}}if(this._classID==DClassID.CANNONBALL){if(this._subState==DState.SS_CANNONBALL_FLY){this.StateMachineGotoNextState(DState.STATE_SIMPLE+DState.SS_CANNONBALL_EXPLODE,0);return DEvent.RESULT_OK}}if(l==DEvent.BLOCKED_BY_ENTITY){if(r._classID==DClassID.VIRTUALBLOCK){if(r._params[DParamIndex.VIRTUALBLOCK_OWNERID]>=0){var v=a.GetEntityByID(r._params[DParamIndex.VIRTUALBLOCK_OWNERID],false);if(v!=null){v.NotifyEvent(this,DEvent.BLOCK_VIRTUALBLOCK,f,e,d)}}}if(this._classID==DClassID.MOBS_WHITE){if(this._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_RED){if(this._vX>0&&this._vX!=DAI.MOBS_WHITE_WALK_VX){this._vX-=DAI.MOBS_WHITE_WALK_VX;if(this._vX<0){this._vX=0}}if(this._vX<0&&this._vX!=-DAI.MOBS_WHITE_WALK_VX){this._vX+=DAI.MOBS_WHITE_WALK_VX;if(this._vX>0){this._vX=0}}}}return this.NotifyEventBlockEntity(r,l,f,e,p)}else{if(l==DEvent.COLLIDE_ENTITY){if(r._classID==DClassID.VIRTUALBLOCK){if(r._params[DParamIndex.VIRTUALBLOCK_OWNERID]>=0){var v=a.GetEntityByID(r._params[DParamIndex.VIRTUALBLOCK_OWNERID],false);if(v!=null){v.NotifyEvent(this,DEvent.COLLIDE_VIRTUALBLOCK,f,e,d)}}}if(this._classID==DClassID.HERO&&r.CheckExFlag(DFlags.EX_ENEMY)){var j=LowAPI.Gen_Array([4],0);System.arraycopy(this._boundingBox,0,j,0,this._boundingBox.length);j[DEF.BOX_BOTTOM]=j[DEF.BOX_TOP]+(j[DEF.BOX_BOTTOM]-j[DEF.BOX_TOP])*2/3;if(!r.IntersectBox(this.GetAbsoluteBox(j))){return k}}this.NotifyEventCollideEntity(r,l,f,e);return k}}var y=(f&DFlags.PHY_BLOCK_UNDERSIDE)!=0;var n=(f&DFlags.PHY_BLOCK_TOPSIDE)!=0;var w=(f&DFlags.PHY_BLOCK_FRONTBACK)!=0;if(l==DEvent.BLOCKED&&y){if(this._stateDuration==DFSM.DURATION_UNTIL_GROUND){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);return k}switch(this._classID){case DClassID.STONE:if(this._lastPhyStandOn!=r._id&&this._subState!=DState.SS_DISAPPEARING&&this._subState!=DState.SS_DISAPPEAR){if((f&DFlags.PHY_SEG_WATER_SURFACE)!=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_STONE_DISAPPEAR_ON_WATER,0)}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0);if(this._tempParams[DTempParamIndex.STONE_DROP_Y]>0&&this._posY-this._tempParams[DTempParamIndex.STONE_DROP_Y]>4*DEF.TILE_H_FLOAT){a.AI_CameraQuake(a.k_camQuake_OffsetY)}}}this._tempParams[DTempParamIndex.STONE_DROP_Y]=0;return DEvent.RESULT_OK;case DClassID.MOBS_WHITE:if((f&DFlags.PHY_SEG_WATER_SURFACE)!=0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY+a.GetBoxMiddleY(this._boundingBox));this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}return DEvent.RESULT_OK;case DClassID.BOSS_KILLERBEE:if(this._subState==DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_PIERCE_RUSH_BACK,0);this._posY=s_Math_intersectY-this._boundingBox[DEF.BOX_BOTTOM];if((f&DFlags.PHY_SEG_BINDING)!=0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_BOSS_HONEY,0,this._posX,s_Math_intersectY)}}if(this._subState==DState.SS_BOSS_KILLER_BEE_BOMB_BOMB){this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0)}if(this._subState==DState.SS_BOSS_KILLER_BEE_CIRCLE_RUSH){this.TurnOver();this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_CIRCLE_COUNT]--;if(this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_CIRCLE_COUNT]==0){this._tempParams[DTempParamIndex.BOSS_KILLER_BEE_PIERCE_COUNT]=DAI.BOSS_KILLER_BEE_PIERCE_COUNT;this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_PIERCE_FLY,0);if(this._relateEntity!=null){this._relateEntity.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_RANDOMBONUS_BONUS_FLY,0)}break}this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BOSS_KILLER_BEE_CIRCLE_IDLE_FLY,0)}break}}if(l==DEvent.BLOCKED){if((f&DFlags.PHY_BLOCK_FRONTBACK)!=0&&this._stateFlow!=null&&(this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&(DFSM.SF_CHECK_MOVE_AREA|DFSM.SF_TURN_ON_BLOCK))!=0){this.TurnOver();return DEvent.RESULT_OK}switch(this._classID){case DClassID.MOBS_BARREL:if((f&DFlags.PHY_BLOCK_FRONTBACK)!=0){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BARREL_TURN,0)}break;case DClassID.STONE:a.AI_CameraQuake(a.k_camQuake_OffsetY<<2);if(r._classID==DClassID.PHYFIELD&&(f&DFlags.PHY_BLOCK_FRONTBACK)!=0&&this._vX!=0){var q=DEF.BOX_RIGHT;var m=DEF.TILE_W_M2_FLOAT;if(this._vX<0){q=DEF.BOX_LEFT;m=-m}this._dynamicBox[q]+=m;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[q]-=m;return DEvent.RESULT_PHY_CANCEL_BLOCK}else{if(this._subState!=DState.SS_DISAPPEARING&&this._subState!=DState.SS_DISAPPEAR){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_IDLE,0)}}return DEvent.RESULT_OK;case DClassID.CANNONBALL:if(this._subState==DState.SS_CANNONBALL_FLY){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNONBALL_EXPLODE,0);if(r._classID==DClassID.PHYFIELD){var q=DEF.BOX_RIGHT;var m=DEF.TILE_W_D2_FLOAT;if(this._vX<0){q=DEF.BOX_LEFT;m=-m}this._dynamicBox[q]+=m;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[q]-=m}}return DEvent.RESULT_OK;case DClassID.OBJ_DAMAGE_STONE:var s=a.GetRowDataByID(this._curTrace);if(s!=null){this._curTrace=s[DParamIndex.TRACE_NEXT_TRACE]}a.AI_CameraQuake(a.k_camQuake_OffsetY);this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);return DEvent.RESULT_OK}}switch(this._classID){case DClassID.HERO:switch(l){case DEvent.BLOCKED:if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)&&r._classID==DClassID.PHYFIELD){n=!n;y=!y}if(this.CheckHeroCrush(r,f)){return DEvent.RESULT_OK}if((f&DFlags.PHY_SEG_HURT)!=0){if(this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return DEvent.RESULT_PHY_KEEP_VELOCITY}}if((f&DFlags.PHY_SEG_BINDING)!=0&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){if((f&DFlags.PHY_BLOCK_FRONTBACK)!=0){this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]=-1;if(s_Math_intersectX>this._posX){this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]=1}this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_NOMOVE_VER,0);var t=a.RENDER_TYPE_ANIMATION;var i=this._posX;if(this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]<0){i+=this._boundingBox[DEF.BOX_LEFT];this.SetFlipX(true)}else{i+=this._boundingBox[DEF.BOX_RIGHT];t|=a.RENDER_FLAG_FLIPX;this.SetFlipX(false)}if(CGame._worldId!=DAI.WORLD_ID_SPACE){a.PrepareRender(t,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_NOMOVE_VER_UP,0,i,this._posY)}return DEvent.RESULT_OK}}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_ESKIMO)&&((f&DFlags.PHY_BLOCK_FRONT)!=0)&&((f&DFlags.PHY_PHYFIELD)==0)){if(this._state==DState.STATE_INAIR&&(this._subState==DState.SS_INAIR_FALL||this._subState==DState.SS_INAIR_FALL_START)){this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]=-1;if(s_Math_intersectX>this._posX){this._tempParams[DTempParamIndex.HERO_NOMOVE_VER_DIR]=1}this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_HERO_ROCKCRAFT,0)}this._tempParams[DTempParamIndex.HERO_ROCKCRAFT]=1}if(w){if(this._state==DState.STATE_ONGROUND&&this._subState!=DState.SS_HERO_ROCKCRAFT&&this._subState!=DState.SS_HERO_ROCKCRAFT_FALL){this._vX=0}if(r._classID==DClassID.PHYFIELD){if(this._state==DState.STATE_SWIM&&a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)){var q=DEF.BOX_RIGHT;var m=DEF.TILE_W_D2_FLOAT;if(this._vX<0){q=DEF.BOX_LEFT;m=-m}this._dynamicBox[q]+=m;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[q]-=m}}else{if(r._classID==DClassID.SEGMENT){if(this._state==DState.STATE_SWIM&&this._subState==DState.SS_SWIM_FISH_ATTACK){this._vX=-DAI.FISH_SWIM_ATTACK_MAX_VX*3/2;if(this.IsFlipX()){this._vX=-this._vX}}else{if(this._state==DState.STATE_SWIM&&this._subState==DState.SS_SWIM_FISH_ATTACK_STOP){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FISH_MOVE,0)}}}}}if(this._state==DState.STATE_SWIM){if(n&&(f&DFlags.PHY_SEG_WATER_SURFACE)!=0){if(a._keyUpHold||a._keyLeftUpHold||a._keyRightUpHold||a._keyAttackHold){if(a._keyUpHold){a._keyUp=true}if(a._keyLeftUpHold){a._keyLeftUp=true}if(a._keyRightUpHold){a._keyRightUp=true}if(a._keyAttackHold){a._keyUp=true}if(this._state==DState.STATE_SWIM&&this._subState==DState.SS_SWIM_FISH_MOVE){if(a._keyUp||a._keyRightUp||a._keyLeftUp){CGame._popUpEnded=false;a._HeroMorphEnergy=0;a.AI_Hero_SetMorph(DAI.HERO_MORPH_NONE);this.StateMachineChangeState(DState.STATE_CHANGE,DState.SS_HERO_CHANGE_BACK,0)}}if(this.AI_Hero_CheckJump()){this._posY-=DAI.HERO_FALL_SWIM_DELTA_Y;a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_WATER,0,this._posX,s_Math_intersectY);return DEvent.RESULT_PHY_CANCEL_BLOCK}}else{if(this.CheckFlag(DFlags.OUTSIDE_FORCE)){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT_WATER,DAnimID.EFFECT_WATER_WATER,0,this._posX,s_Math_intersectY);this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0);this.ClearFlag(DFlags.OUTSIDE_FORCE)}}}else{if(y&&r._classID==DClassID.SEGMENT){if(!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH)&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)&&this._subState!=DState.SS_SWIM_WALK){this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_WALK,0)}}}}if(y){if(this._state==DState.STATE_FREEZED){return k}if((f&DFlags.PHY_SEG_WATER_SURFACE)!=0){if((this._state==DState.STATE_SWIM&&this._subState==DState.SS_SWIM_FALL)||(this._state==DState.STATE_INAIR&&this._vY<=0)){return DEvent.RESULT_PHY_CANCEL_BLOCK}else{if(this._state==DState.STATE_INAIR){if(((this._subState==DState.SS_INAIR_FALL||this._subState==DState.SS_INAIR_FALL_START)&&this._stateElapsedTime>DAI.HERO_SWIM_FALL_IN_WATER_DURATION)||this.AI_Hero_IsSmash()){this._posY=s_Math_intersectY+DAI.HERO_FALL_SWIM_DELTA_Y;this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FALL,0);return DEvent.RESULT_PHY_CANCEL_BLOCK}}}this._posY=s_Math_intersectY+DAI.HERO_FALL_SWIM_DELTA_Y;this.StateMachineChangeState(DState.STATE_SWIM,DState.SS_SWIM_FALL,0);return DEvent.RESULT_PHY_CANCEL_BLOCK}if(this._state==DState.STATE_INAIR){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){if((f&DFlags.PHY_SEG_BINDING)!=0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,this._posX,this._posY)}else{a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_SMOKE,0,this._posX,this._posY)}}if((f&DFlags.PHY_SEG_BINDING)!=0&&!a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)&&this._subState!=DState.SS_INAIR_JUMP_VER_START&&this._subState!=DState.SS_INAIR_JUMP_VER_PRE&&this._subState!=DState.SS_INAIR_JUMP_DIAG_START&&this._subState!=DState.SS_INAIR_JUMP_DIAG_PRE){a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.HERO,DAnimID.HERO_NOMOVE_UP,0,(this._dynamicBox[DEF.BOX_LEFT]+this._dynamicBox[DEF.BOX_RIGHT])>>1,this._dynamicBox[DEF.BOX_BOTTOM]);this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_FALL_ON_NOMOVE,DFSM.CSTATEF_NOFOUND_NOCHANGE)}else{if(r._classID==DClassID.PLATFORM&&this._subState!=DState.SS_INAIR_JUMP_VER_START&&this._subState!=DState.SS_INAIR_JUMP_DIAG_START){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0);if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_PLATFORM_FALL,0)}}else{if((this._vX!=0||this._subState==DState.SS_COMBAT||this._subState==DState.SS_SHOOT||this._subState==DState.SS_INAIR_FALL||this._subState==DState.SS_INAIR_JUMP_EXTEND_DIAG||this._subState==DState.SS_INAIR_JUMP_EXTEND_VER||this._subState==DState.SS_INAIR_JUMP_SPRING_DIAG||this._subState==DState.SS_INAIR_JUMP_SPRING_VER||this._subState==DState.SS_INAIR_FLOAT_FLY)){if(this._subState==DState.SS_INAIR_FLOAT_FLY){if(this.IsFlipX()&&a._keyLeftUpHold||!this.IsFlipX()&&a._keyRightUpHold){a._HeroInStateKey=this.IsFlipX()?a.k_LeftUp:a.k_RightUp;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_RUN,0);return DEvent.RESULT_OK}}if(this._subState==DState.SS_INAIR_FALL){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);return DEvent.RESULT_OK}this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_SLOWDOWN,0);return DEvent.RESULT_OK}else{if(this._subState==DState.SS_INAIR_SMASH_FALL||this._subState==DState.SS_INAIR_SMASH_FALL_HOLD){if(r._classID==DClassID.PHYFIELD){if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._dynamicBox[DEF.BOX_TOP]-=DEF.TILE_H_D2_FLOAT;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[DEF.BOX_TOP]+=DEF.TILE_H_D2_FLOAT}else{this._dynamicBox[DEF.BOX_BOTTOM]+=DEF.TILE_H_D2_FLOAT;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[DEF.BOX_BOTTOM]-=DEF.TILE_H_D2_FLOAT}if(this._subState==DState.SS_INAIR_SMASH_FALL){this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_SMASH_FALL_HOLD,DFSM.CSTATEF_NOFOUND_NOCHANGE)}a.AI_CameraQuake(a.k_camQuake_OffsetY);return DEvent.RESULT_PHY_KEEP_VELOCITY}else{var u=Math_Atan(e,d);if(u>Math_DegreeToFixedPointAngle(40)&&u<=Math_Angle90){this.SetFlipX(false);this._vX=DAI.HERO_FAST_SLIDE_VX;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCH,0);a._HeroInStateKey=a.k_down}else{if(u<Math_DegreeToFixedPointAngle(360-40)&&u>=Math_Angle270){this.SetFlipX(true);this._vX=-DAI.HERO_FAST_SLIDE_VX;this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_CROUCH,0);a._HeroInStateKey=a.k_down}else{a.AI_CameraQuake(a.k_camQuake_OffsetY);this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_SMASH_FALL_SIT,0);a.PrepareRender(a.RENDER_TYPE_ANIMATION,this._id,DSpriteID.EFFECT,DAnimID.EFFECT_BUMP_EFFECT_H,0,this._posX,s_Math_intersectY)}}}}else{if(this._subState!=DState.SS_INAIR_JUMP_VER_START&&this._subState!=DState.SS_INAIR_JUMP_DIAG_START&&this._subState!=DState.SS_HURT_LIGHTENED&&this._subState!=DState.SS_TOSS){this.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_IDLE,0)}}}}}}}else{if(this._state==DState.STATE_INAIR){if(n){if(r._classID==DClassID.PHYFIELD){var o=DEF.TILE_H_D2_FLOAT;if(this._subState==DState.SS_INAIR_ROCKET||this._subState==DState.SS_FAT_INAIR_ROCKET){o=DEF.TILE_H_FLOAT+DEF.TILE_H_D2_FLOAT}if(this.CheckFlag(DFlags.REVERSAL_GRAVITY)){this._dynamicBox[DEF.BOX_BOTTOM]+=o;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[DEF.BOX_BOTTOM]-=o}else{this._dynamicBox[DEF.BOX_TOP]-=o;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[DEF.BOX_TOP]+=o}if(this._subState==DState.SS_INAIR_ROCKET||this._subState==DState.SS_FAT_INAIR_ROCKET){return DEvent.RESULT_PHY_CANCEL_BLOCK}a.AI_CameraQuake(a.k_camQuake_OffsetY);this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_FALL,0);this._vY=DAI.GRAVITY}}}}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)&&r._classID==DClassID.PHYFIELD&&a._hero.CheckKeyForward()){if((f&DFlags.PHY_BLOCK_FRONTBACK)!=0&&a._hero._state==DState.STATE_ONGROUND){var q=DEF.BOX_RIGHT;var m=DEF.TILE_W_D2_FLOAT;if(this.IsFlipX()){q=DEF.BOX_LEFT;m=-m}this._dynamicBox[q]+=m;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[q]-=m;if(a._hero._subState!=DState.SS_FAT_HIT_COOKIE){a._hero.StateMachineChangeState(DState.STATE_ONGROUND,DState.SS_FAT_HIT_COOKIE,0)}}}}break;case DClassID.MOBS_ACALEPH:if(n){this._posY=s_Math_intersectY;a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY);this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}break;case DClassID.BULLET:if(l==DEvent.BLOCKED){var h=true;if(this._subState==DState.SS_BULLET_RUN||this._subState==DState.SS_ARROW_FLY){if(r._classID==DClassID.PHYFIELD){var q=DEF.BOX_RIGHT;var m=DEF.TILE_W_D2_FLOAT;if(this._vX<0){q=DEF.BOX_LEFT;m=-m}this._dynamicBox[q]+=m;a.DestroyPhyfield(this._posX,this._posY,this._dynamicBox);this._dynamicBox[q]-=m;if(this._subState==DState.SS_BULLET_RUN){h=false}}if(r.CheckExFlag(DFlags.EX_SEGMENT)){if(this._subState==DState.SS_ARROW_FLY&&r._classID!=DClassID.PLATFORM){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_ARROW_SHAKE,0)}else{if(this._tempParams[DTempParamIndex.BULLET_REBOUND_FRAME]!=s_game_currentFrameNB){this._tempParams[DTempParamIndex.BULLET_REBOUND_FRAME]=s_game_currentFrameNB;if(this._tempParams[DTempParamIndex.BULLET_REBOUND_COUNTER]++<3){this.SetReboundVelocity(e,d);return DEvent.RESULT_PHY_KEEP_VELOCITY}}else{return DEvent.RESULT_PHY_KEEP_VELOCITY}}}if(h&&this._subState==DState.SS_BULLET_RUN){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BULLET_DISAPPEAR_NOEFFECT,0)}}}break;case DClassID.BONUS:if(this.CheckFlag(DFlags.GRAVITY)){if(l==DEvent.BLOCKED&&y){this.SetFlag(DFlags.COLLIDING_WITH_HERO);if(this._tempParams[DTempParamIndex.BONUS_DROP_BY_HERO]!=0){this._vY=0;return DEvent.RESULT_PHY_KEEP_VELOCITY}if(this._vY>0){this._vY=-this._vY*3/4}if(Math.abs(this._vY)<=a.GetVelocity(DAI.HP_BONUS_DROP_GRAVITY)+DEF.FLOAT_1){if(this._subState!=DState.SS_BONUS_POWERUP){this._vX=0}this._vY=0}return DEvent.RESULT_PHY_KEEP_VELOCITY}if(l==DEvent.BLOCKED&&(f&DFlags.PHY_BLOCK_FRONTBACK)!=0){this.SetFlag(DFlags.COLLIDING_WITH_HERO);this._vX=-this._vX;return DEvent.RESULT_PHY_KEEP_VELOCITY}}if((this._state==DState.STATE_SIMPLE&&this._subState==DState.SS_BONUS_FISH_2)&&this.CheckFlag(DFlags.DYNAMIC_CREATE)){if(n){this._posY=s_Math_intersectY;a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,this._posX,this._posY);this.StateMachineModifyStatus(DFSM.CSF_DESTROY)}}break;case DClassID.LAYERSTONE:if(l==DEvent.ENTITY_DROP_ON){if(r._classID==DClassID.HERO&&this._subState==DState.SS_LAYERSTONE_IDLE){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}break;case DClassID.SEAGULL:if(l==DEvent.ENTITY_DROP_ON&&r==a._hero){if(this._subState==DState.SS_SEAGULL_FLY||this._subState==DState.SS_SEAGULL_TURN){if(((this._posX>>DEF.SHIFT)<this._params[DParamIndex.SEAGULL_DESTX])==this.IsFlipX()){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_SEAGULL_TURN,0);this._nextFullState=DState.STATE_SIMPLE+DState.SS_SEAGULL_FLY_HARD}else{this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_SEAGULL_FLY_HARD,0)}}}break;case DClassID.PLATFORM:if(l==DEvent.ENTITY_DROP_ON){if(r==a._hero&&this._params[DParamIndex.PLATFORM_TYPE]==DValueList.PLATFORM_TYPE_WAITING){if(this._subState==DState.SS_IDLE){this.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}}}break}return DEvent.RESULT_OK};a.prototype.CheckHeroCrush=function(k,f){var d=this._phyInfo|f;if(k.CheckExFlag(DFlags.EX_CAN_CRUSH_HERO)){this.SetPhyFlags(DFlags.PHY_CRUSH_HERO)}if(this.CheckFlag(DFlags.OUTSIDE_FORCE)&&((d&DFlags.PHY_BLOCK_TOPUNDER)==DFlags.PHY_BLOCK_TOPUNDER||(d&DFlags.PHY_BLOCK_FRONTBACK)==DFlags.PHY_BLOCK_FRONTBACK)){var h=false;var j=a.GetEntityByID(this.GetPhysicsEntityID(),false);if(this.CheckPhysics(DFlags.PHY_CRUSH_HERO)){h=true}else{if(k.CheckExFlag(DFlags.EX_CAN_CRUSH_HERO)){h=true}else{if(j!=null&&j.CheckExFlag(DFlags.EX_CAN_CRUSH_HERO)){h=true}}if(j!=null){var e=k.CheckExFlag(DFlags.EX_SEGMENT)&&k._classID!=DClassID.PLATFORM;var i=j.CheckExFlag(DFlags.EX_SEGMENT)&&j._classID!=DClassID.PLATFORM;if(e&&i){h=false}else{if(e&&j._classID==DClassID.PHYFIELD||i&&k._classID==DClassID.PHYFIELD){h=false}}}else{h=false}}if(h){this.NotifyEvent(this,DEvent.HERO_DIE,0,0,0);return true}}return false};a.prototype.NotifyEventBlockEntity=function(r,l,i,h,o){var k=DEvent.RESULT_OK;var v=this._classID==DClassID.HERO;var n=(i&DFlags.PHY_BLOCK_TOPSIDE)!=0;var t=(i&DFlags.PHY_BLOCK_UNDERSIDE)!=0;if(v&&(n||t)&&(r._classID==DClassID.RANDOMBONUS||r._classID==DClassID.BOSS_EATER||r._classID==DClassID.BOSS_WITCH)&&(t||this.AI_Hero_IsSmash())){r.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0);if(r._classID==DClassID.BOSS_EATER||r._classID==DClassID.BOSS_WITCH){return k}}else{if(v&&(n)&&r._classID==DClassID.BOSS_WITCH){if(this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0&&r._subState!=DState.SS_BOSS_HURT&&r.AI_BOSS_CheckFlag(DFlags.BOSS_WITCH_CAN_BE_ATTACK_MASK)){r.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0);return a._hero.NotifyEvent(r,DEvent.SPRING_JUMP,i,0,0)}else{return DEvent.RESULT_PHY_CANCEL_BLOCK}}}if(v&&n&&r._classID==DClassID.BOSS_OCTOPUS_HEAD&&this.AI_Hero_IsSmash()&&o){r.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0);this.StateMachineChangeState(DState.STATE_INAIR,DState.SS_INAIR_ROCKET,0);this.SetVY(-DAI.OCTOPUS_ROCKET_START_VY1);return DEvent.RESULT_PHY_KEEP_VELOCITY}if(this._classID==DClassID.LEAF&&r._classID==DClassID.STONE){return DEvent.RESULT_PHY_CANCEL_BLOCK}if(r._classID==DClassID.OBJ_DAMAGE_STONE){if((i&DFlags.PHY_BLOCK_TOPUNDER)==0&&(i&DFlags.PHY_BLOCK_FRONTBACK)!=0){var j=this.GetAbsoluteBox(this._boundingBox);j[DEF.BOX_LEFT]+=this._frameVX;j[DEF.BOX_RIGHT]+=this._frameVX;j[DEF.BOX_TOP]+=this._frameVY;j[DEF.BOX_BOTTOM]+=this._frameVY;r._boundingBox[DEF.BOX_LEFT]+=r._frameVX;r._boundingBox[DEF.BOX_RIGHT]+=r._frameVX;r._boundingBox[DEF.BOX_TOP]+=r._frameVY;r._boundingBox[DEF.BOX_BOTTOM]+=r._frameVY;var m=false;if(!r.IntersectBox(j)){m=true}else{m=false}r.UpdateBoundingBox();if(m){return DEvent.RESULT_PHY_CANCEL_BLOCK}}}if(r._classID==DClassID.FLY_CANNON){if(v&&r._subState==DState.SS_CANNON_IDLE_FLY_ON){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return k}}if(v&&n&&((r.CheckExFlag(DFlags.EX_CAN_STANDON)&&r._classID!=DClassID.MOBS_MONSTERINCHEST))){if(r._classID==DClassID.STONE){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)||a._hero.AI_Hero_IsSmash()){if(r._subState!=DState.SS_DISAPPEAR&&r._subState!=DState.SS_DISAPPEARING){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}return DEvent.RESULT_PHY_CANCEL_BLOCK}}if(r._classID==DClassID.HIT_BONUS&&r._subState!=DState.SS_DISAPPEAR){if(a._hero.AI_Hero_IsSmash()&&a._hero._state==DState.STATE_INAIR){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_LINK3,0);r.NotifyEvent(a._bullet[a._lastBulletIndex],DEvent.BE_ATTACKED,0,0,0);this.NotifyPhysicsEvent(r,DEvent.BLOCKED,DFlags.PHY_BLOCK_UNDERSIDE,0,0,o);return k}}this.NotifyEvent(r,DEvent.STAND_ON_ENTITY,i,0,0);return k}var s=r._classID;var e=r._subState;var q=v&&n&&r.CheckExFlag(DFlags.EX_ENEMY);var f=(this.CheckExFlag(DFlags.EX_ENEMY)&&this._classID!=DClassID.MOBS_DANDELIONBOMB&&this._classID!=DClassID.BOSS_OCTOPUS_HEAD&&this._classID!=DClassID.BOSS_OCTOPUS_TENTACLE&&this._classID!=DClassID.INK_BOMB||this._classID==DClassID.MOBS_BARREL);var u=this.CheckExFlag(DFlags.EX_BOSS);var w=(s==DClassID.STONE||s==DClassID.OBJ_DAMAGE_STONE)&&f;if(q||w){var d=r;if(w){if(t||((i&DFlags.PHY_BLOCK_FRONTBACK)!=0&&r._vX!=0)){d=this;if(this._classID==DClassID.MOBS_BARREL){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BARREL_BE_STONED,0);r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);return k}}else{if(this._classID==DClassID.BOSS_WITCH||this._classID==DClassID.BOSS_WITCH_EX_PART){return DEvent.RESULT_PHY_CANCEL_BLOCK}else{if(this._stateFlow!=null&&(this._stateFlow[this._stateIndex+DFSM.OFFSET_FLAGS]&DFSM.SF_CHECK_MOVE_AREA)!=0||this._classID==DClassID.MOBS_BARREL&&this._vX!=0){if(r._classID==DClassID.STONE){if(r._posX<this._posX&&this.IsFlipX()||r._posX>this._posX&&!this.IsFlipX()){this.TurnOver()}}}}return k}}else{if(s==DClassID.BOSS_EATER){if(v&&this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){this.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}return k}}if(d._hp>0){if(q&&a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){d._hp=0;d.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);return k}if(d._classID==DClassID.MOBS_WHITE){if(d._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_THIEF){d.DumpBonus(d._params[DParamIndex.MOBS_WHITE_DROP1+(d._hp-1)],d._posX,d._posY+d._boundingBox[DEF.BOX_TOP]-DEF.TILE_H_FLOAT);d.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_THIEF_BE_HURT,0)}if(d._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_HAT){if(v&&this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return k}else{if(v&&(this._subState==DState.SS_INAIR_FALL||this._subState==DState.SS_INAIR_FALL_START)&&a._HeroInvincibilityFrame!=0){return DEvent.RESULT_PHY_CANCEL_BLOCK}else{if(v&&this._subState==DState.SS_HURT){return k}}}}if((d._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_LIGHT)&&d._subState==DState.SS_LIGHT_IDLE){if(v&&(this._subState!=DState.SS_HURT&&this._subState!=DState.SS_HURT_LIGHTENED)&&(a._HeroInvincibilityFrame==0)){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return k}}}if(d._classID==DClassID.MOBS_UFO){if(v&&this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){this.NotifyEvent(d,DEvent.UFO_HIT,0,0,0)}return k}if(d._classID==DClassID.MOBS_MONSTERINCHEST){if(a._HeroInWater){return k}if(v&&d._subState==DState.SS_MONSTERINCHEST_BONUS&&!this.AI_Hero_IsSmash()){this.NotifyEvent(r,DEvent.STAND_ON_ENTITY,i,0,0);return k}if(d._subState==DState.SS_MONSTERINCHEST_BONUS){d._hp=1}if(d._hp<=1){d.DumpBonus(d._params[DParamIndex.MOBS_MONSTERINCHEST_DROP1],d._posX,d._posY+d._boundingBox[DEF.BOX_TOP]-DEF.TILE_H_FLOAT);d.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{d.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_HURT,0)}if(v){return a._hero.NotifyEvent(d,DEvent.SPRING_JUMP,i,0,0)}return k}if(v&&(this._state==DState.STATE_CHANGE||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH))){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return k}if(u&&r._classID==DClassID.STONE){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return DEvent.RESULT_PHY_CANCEL_BLOCK}d._hp--;if(w){if(r._classID==DClassID.STONE){if(d._classID==DClassID.STONE){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}if(d._classID!=DClassID.OBJ_DAMAGE_STONE){d._hp=0}}else{if(r._classID==DClassID.OBJ_DAMAGE_STONE){d._hp=0}}}if(d._hp<=0){d.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0);d.SetFlag(DFlags.GRAVITY);if(d._classID!=DClassID.STONE&&d._classID!=DClassID.HIT_BONUS){this.AI_Hint_ShowSoundEffect(DAnimID.HINT_AAAAH_,-1,-1)}}if(v){return a._hero.NotifyEvent(d,DEvent.SPRING_JUMP,i,0,0)}}}if(this._classID==DClassID.BONUS&&this._subState==DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE){var p=n;if(p){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_BONUS_CRYSTAL_DROPPED_NO_COLLIDE2,0)}}if(this._classID==DClassID.HERO){switch(s){case DClassID.CAMERA:case DClassID.OBJ_DAMAGE_STONE:this.SetFlag(DFlags.OUTSIDE_FORCE);if(this.CheckHeroCrush(r,this.TransformEntityCollideFlags(i))){return DEvent.RESULT_OK}break;case DClassID.MOBS_WHITE:if(r._params[DParamIndex.MOBS_WHITE_TYPE]==DValueList.MOBS_MOUSE_TYPE_SHIELD&&(i&DFlags.PHY_BLOCK_FRONTBACK)!=0){if(r.IsFlipX()?this._posX-r._posX>0:this._posX-r._posX<=0){this.NotifyEventCollideEntity(r,l,DFlags.PHY_COLLIDE_FRONTBACK,h)}}break;case DClassID.STONE:if(this.CheckHeroCrush(r,this.TransformEntityCollideFlags(i))){return DEvent.RESULT_OK}if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)){if(r._subState!=DState.SS_DISAPPEAR&&r._subState!=DState.SS_DISAPPEARING){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}break}if(n){this.NotifyEvent(this,DEvent.STAND_ON_ENTITY,i,0,0);break}break;case DClassID.MOBS_BARREL:if(e!=DState.SS_MOBS_BARREL_IDLE){if((i&DFlags.PHY_BLOCK_FRONTBACK)!=0){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0)}r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MOBS_BARREL_IDLE,0)}break;case DClassID.COTTONCLOUD:if(e==DState.SS_COTTON_IDLE){r.NotifyEvent(this,DEvent.ENTITY_DROP_ON,0,0,0)}this.NotifyEvent(r,DEvent.STAND_ON_ENTITY,0,0,0);break;case DClassID.MOBS_MONSTERINCHEST:if(this._state==DState.STATE_SWIM&&a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)){if(r._subState==DState.SS_MONSTERINCHEST_BONUS){r._hp=1}if(r._hp<=1){r.DumpBonus(r._params[DParamIndex.MOBS_MONSTERINCHEST_DROP1],r._posX,r._posY);r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}else{r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_MONSTERINCHEST_HURT,0)}}break;case DClassID.BULLET:if(n&&(e==DState.SS_ARROW_ONWALL||e==DState.SS_ARROW_ONWALL_SHAKE||e==DState.SS_ARROW_DISAPPEAR||e==DState.SS_ARROW_DISAPPEAR_SHAKE)){if(!this.CheckPhysics(DFlags.PHY_BLOCK_TOPSIDE)){this.NotifyEvent(this,DEvent.STAND_ON_ENTITY,i,0,0);if(this._lastPhyStandOn!=r._id){if((e==DState.SS_ARROW_ONWALL||e==DState.SS_ARROW_DISAPPEAR)){r.StateMachineChangeState(DState.STATE_SIMPLE,e+1,0)}}}else{return DEvent.RESULT_PHY_CANCEL_BLOCK}}break;case DClassID.BOSS_OCTOPUS_HEAD:if(t&&this._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){this.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}}else{if(this._classID==DClassID.BULLET){if(s==DClassID.BULLET){return DEvent.RESULT_PHY_CANCEL_BLOCK}this.NotifyEvent(r,DEvent.BULLET_HIT,0,0,0)}else{if(this._classID==DClassID.MOBS_DANDELIONBOMB){if(s==DClassID.STONE){if(this._subState!=DState.SS_DANDELION_SEED_JET&&this._subState!=DState.SS_DANDELION_SEED_OPEN&&this._subState!=DState.SS_DANDELION_SEED_FALL){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0);return DEvent.RESULT_PHY_CANCEL_BLOCK}else{this.StateMachineGotoNextState(DFSM.FULLSTATE_DESTROY,0);a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_HIT_EFFECT_NOUSE,0,r._posX,r._posY)}}}else{if(this._classID==DClassID.EXPLOSION){if(s==DClassID.HERO){if(r._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){r.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0)}}else{if(r.CheckExFlag(DFlags.EX_ENEMY)){this.NotifyEvent(r,DEvent.BE_ATTACKED,0,0,0)}}}else{if(this._classID==DClassID.CANNONBALL){if(this._subState==DState.SS_CANNONBALL_FLY){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_CANNONBALL_EXPLODE,0)}}else{if(this._classID==DClassID.BOSS_OCTOPUS_TENTACLE){if((this._subState==DState.SS_TENTACLE_MOVEIN_PRE||this._subState==DState.SS_TENTACLE_MOVEIN)&&r._classID==DClassID.STONE){if(r._subState!=DState.SS_DISAPPEAR&&r._subState!=DState.SS_DISAPPEARING){r.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}}}else{if(this._classID==DClassID.INK_BOMB){if(this._subState==DState.SS_INKBOMB_FLY_IN&&r._classID==DClassID.STONE){this.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_INKBOMB_DESTORY,0)}}}}}}}}if(s==DClassID.JELLY){if(e==DState.SS_IDLE){if(n&&this._frameVY>0){r.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);if(this._classID==DClassID.HERO){a._hero.StateMachineChangeState(DState.STATE_NO_CONTROL,DState.SS_PRE_ROCKET,0)}}}}else{if(s==DClassID.LEAF){if(e==DState.SS_IDLE){if(n&&this._frameVY>0){r.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0);if(this._classID==DClassID.HERO){a._hero.StateMachineChangeState(DState.STATE_NO_CONTROL,DState.SS_PRE_ROCKET,0)}}}}}return k};a.prototype.NotifyEventCollideEntity=function(f,d,j,h){var i=f._subState;var e=f._classID;if(this._classID==DClassID.HERO){if(f._stateDuration==DFSM.DURATION_UNTIL_COLLIDE_HERO){f.StateMachineGotoNextState(DFSM.FULLSTATE_NONE,0)}else{if(this.CanBeAttack(f,j)){if(a.AI_Hero_CheckMorph(DAI.HERO_MORPH_FAT)||a.AI_Hero_CheckMorph(DAI.HERO_MORPH_SWORD_FISH_ATTACK)){if(f._classID!=DClassID.FIRE&&f._classID!=DClassID.LIGHTINGBALL){if((f._exFlags&DFlags.EX_ATTACK_HERO_WHEN_COLLIDE)!=0){a.PrepareRender(a.RENDER_TYPE_ANIMATION,-1,DSpriteID.EFFECT,DAnimID.EFFECT_MOBS_DISAPPEAR,0,f._posX,f._posY);f.StateMachineModifyStatus(DFSM.CSF_DESTROY)}else{if(f._subState!=DState.SS_DISAPPEAR){f._hp=0;f.StateMachineChangeState(DState.STATE_SIMPLE,DState.SS_DISAPPEAR,0)}}}return}this.NotifyEvent(f,DEvent.BE_ATTACKED,0,0,0)}else{if(e==DClassID.BLACK_HOLE){if(a._HeroRelateEntity!=f){this.StateMachineChangeState(DState.STATE_INBLACK_HOLE,DState.SS_INBLACK_HOLE_ABSORB,0);this.SetFlipX(f._params[DParamIndex.BLACK_HOLE_TYPE]==DValueList.BLACK_HOLE_TYPE_ANTI_CLOCKWISE);a._HeroRelateEntity=f}}else{if(e==DClassID.BONUS){if(i==DState.SS_BONUS_CRYSTAL_DISAPPEAR){f.StateMachineChangeState(DState.STATE_BONUS_GOT_EFFECT,DState.SS_BONUS_CRYSTAL_GOT,0)}}}}}}else{if(this._classID==DClassID.BULLET){if(this._subState==DState.SS_BULLET_RUN||this._subState==DState.SS_ARROW_FLY){if(f._classID==DClassID.RANDOMBONUS||(f.CheckExFlag(DFlags.EX_ENEMY|DFlags.EX_BOSS)&&!f.CheckExFlag(DFlags.EX_CANNOT_HIT_BY_BULLET))){f.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0);this.NotifyEvent(f,DEvent.BULLET_HIT,0,0,0)}}}else{if(this._classID==DClassID.BOSS_OCTOPUS_TENTACLE){if(e==DClassID.MOBS_WHITE){if(this._vX>0){a._TentacleSide=DAI.TENTACLE_LEFT}else{a._TentacleSide=DAI.TENTACLE_RIGHT}a._HurtByTentacle=true;f.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}else{if(this._classID==DClassID.EXPLOSION){if(e==DClassID.HERO){if(f._subState!=DState.SS_HURT&&a._HeroInvincibilityFrame==0){f.NotifyEvent(this,DEvent.BE_ATTACKED,0,0,0)}}else{if(f.CheckExFlag(DFlags.EX_ENEMY)){this.NotifyEvent(f,DEvent.BE_ATTACKED,0,0,0)}}}}}}};LowAPI.extendObject(b,{CEntity:a,},true)})(window);